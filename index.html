<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <link rel="dns-prefetch" href="http://example.com">
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternative" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" type="text/css" href="/./main.0cf68a.css">
  <style type="text/css">
  
    #container.show {
      background: linear-gradient(200deg,#a0cfe4,#e8c37e);
    }
  </style>
  

  

<meta name="generator" content="Hexo 5.3.0"></head>

<body>
  <div id="container" q-class="show:isCtnShow">
    <canvas id="anm-canvas" class="anm-canvas"></canvas>
    <div class="left-col" q-class="show:isShow">
      
<div class="overlay" style="background: #4d4d4d"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			<img src="" class="js-avatar">
		</a>
		<hgroup>
		  <h1 class="header-author"><a href="/"></a></h1>
		</hgroup>
		

		<nav class="header-menu">
			<ul>
			
				<li><a href="/">主页</a></li>
	        
				<li><a href="/tags/%E9%9A%8F%E7%AC%94/">随笔</a></li>
	        
			</ul>
		</nav>
		<nav class="header-smart-menu">
    		
    			
    			<a q-on="click: openSlider(e, 'innerArchive')" href="javascript:void(0)">所有文章</a>
    			
            
    			
    			<a q-on="click: openSlider(e, 'friends')" href="javascript:void(0)">友链</a>
    			
            
    			
    			<a q-on="click: openSlider(e, 'aboutme')" href="javascript:void(0)">关于我</a>
    			
            
		</nav>
		<nav class="header-nav">
			<div class="social">
				
					<a class="github" target="_blank" href="#" title="github"><i class="icon-github"></i></a>
		        
					<a class="weibo" target="_blank" href="#" title="weibo"><i class="icon-weibo"></i></a>
		        
					<a class="rss" target="_blank" href="#" title="rss"><i class="icon-rss"></i></a>
		        
					<a class="zhihu" target="_blank" href="#" title="zhihu"><i class="icon-zhihu"></i></a>
		        
			</div>
		</nav>
	</header>		
</div>

    </div>
    <div class="mid-col" q-class="show:isShow,hide:isShow|isFalse">
      
<nav id="mobile-nav">
  	<div class="overlay js-overlay" style="background: #4d4d4d"></div>
	<div class="btnctn js-mobile-btnctn">
  		<div class="slider-trigger list" q-on="click: openSlider(e)"><i class="icon icon-sort"></i></div>
	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img src="" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author js-header-author"></h1>
			</hgroup>
			
			
			
				
			
				
			
			
			
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="#" title="github"><i class="icon-github"></i></a>
			        
						<a class="weibo" target="_blank" href="#" title="weibo"><i class="icon-weibo"></i></a>
			        
						<a class="rss" target="_blank" href="#" title="rss"><i class="icon-rss"></i></a>
			        
						<a class="zhihu" target="_blank" href="#" title="zhihu"><i class="icon-zhihu"></i></a>
			        
				</div>
			</nav>

			<nav class="header-menu js-header-menu">
				<ul style="width: 50%">
				
				
					<li style="width: 50%"><a href="/">主页</a></li>
		        
					<li style="width: 50%"><a href="/tags/%E9%9A%8F%E7%AC%94/">随笔</a></li>
		        
				</ul>
			</nav>
		</header>				
	</div>
	<div class="mobile-mask" style="display:none" q-show="isShow"></div>
</nav>

      <div id="wrapper" class="body-wrap">
        <div class="menu-l">
          <div class="canvas-wrap">
            <canvas data-colors="#eaeaea" data-sectionHeight="100" data-contentId="js-content" id="myCanvas1" class="anm-canvas"></canvas>
          </div>
          <div id="js-content" class="content-ll">
            
  
    <article id="post-2021-02-13-洞穴奇案笔记" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="《洞穴奇案》笔记"><a href="#《洞穴奇案》笔记" class="headerlink" title="《洞穴奇案》笔记"></a>《洞穴奇案》笔记</h1><p>始于2021年2月13日，大年初二，刚结了一把麻局，做完了一次拉伸。</p>
<p>感受到自己真该多读写书了，过去一年耐心看完的书只有两本。且一本是为了应付秋招，一本是为了应付项目工作，少有认真读过技术类书籍外的书了。</p>
<p>希望这本书会是一个好的开始 :)</p>
<h2 id="命题"><a href="#命题" class="headerlink" title="命题"></a>命题</h2><p>如题目所说，洞穴奇案指代的是一个特殊的案子，富勒的洞穴探索者案：</p>
<p>洞穴中五人被困，没有食物将可能死亡。其中一人提议掷骰子选出一个，由同伴们杀死食之。</p>
<p>在掷骰子前，这位提议者后悔了，但同伴们坚持掷完了骰子，并恰好选中了提议者。</p>
<p>这位提议者被同伴们杀死，分而食之。同伴们最终也得以坚持到了救援到来，出去后，他们被以杀人罪提起诉讼。</p>
<h2 id="各个观点"><a href="#各个观点" class="headerlink" title="各个观点"></a>各个观点</h2><p>这本书说的其实是5+9两代人的法律哲学观，每个观点看上去都符合它自身的逻辑，在各自的流派中都站得住脚，得出的结论却大不相同。</p>
<p>而不同的法律哲学，影响着法官们对法律和事实的解读。</p>
<p>这里导言中提到的一句话很有趣：</p>
<p>我们对<strong>法律</strong>和<strong>司法</strong>，经常有两种矛盾的情绪：</p>
<p>一方面，我们期待它是客观中立的，因此法官不应有任何价值判断（按条例判案）；</p>
<p>另一方面，许多人却幻想法律与司法应该代表正义，不应拘泥于法律条文（不愿恶人逍遥法外）。</p>
<p>这是两个有些矛盾的情绪，之前在罗翔老师的课中也看到，法律保障的首先是<strong>人</strong>的权益，而不是<strong>受害者</strong>的权益，也有类似的感觉。</p>
<p>我们很难说哪一个才是正确答案，这里确实拓宽了我们思考的广度。</p>
<h3 id=""><a href="#" class="headerlink" title=""></a></h3>
      

      
    </div>
    <div class="article-info article-info-index">
      
      
      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2021/02/14/2021-02-13-%E6%B4%9E%E7%A9%B4%E5%A5%87%E6%A1%88%E7%AC%94%E8%AE%B0/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-hello-world" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/02/14/hello-world/">Hello World</a>
    </h1>
  

        
        <a href="/2021/02/14/hello-world/" class="archive-article-date">
  	<time datetime="2021-02-14T03:02:27.425Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2021-02-14</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Welcome to <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a target="_blank" rel="noopener" href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a target="_blank" rel="noopener" href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a target="_blank" rel="noopener" href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>
<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2021/02/14/hello-world/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-2020-12-07-JAVA秋招总结" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/12/07/2020-12-07-JAVA%E7%A7%8B%E6%8B%9B%E6%80%BB%E7%BB%93/">JAVA秋招总结</a>
    </h1>
  

        
        <a href="/2020/12/07/2020-12-07-JAVA%E7%A7%8B%E6%8B%9B%E6%80%BB%E7%BB%93/" class="archive-article-date">
  	<time datetime="2020-12-06T16:00:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2020-12-07</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="JAVA秋招总结"><a href="#JAVA秋招总结" class="headerlink" title="JAVA秋招总结"></a>JAVA秋招总结</h1><p>简单讲一下秋招的一些事项和JAVA秋招相关的东西。</p>
<p>以及最后有几份相关的文档（带笔记版本）。</p>
<h2 id="时间结点"><a href="#时间结点" class="headerlink" title="时间结点"></a>时间结点</h2><p>一般需要注意两个时间节点：开始准备刷题和开始投递简历。</p>
<p>先讲刷题。</p>
<p>刷题的时间一般按懒狗来算，一天一道，一般能有充足的刷题能力需要刷大概200道（其中简单和中等为大部分，困难题除了很经典的题目，一般不多刷）。</p>
<p>所以这么算的话大概要六个月多，加上这个刷题需要覆盖整个秋招期，所以一般寒假回来就可以开始组队刷题了（组队刷题有什么隐晦的优势我就不说了），等到提前批开始也基本上有个100道的积累。</p>
<ul>
<li> <strong>关于为什么不多刷困难？</strong>首先面试考不到（考到只能说太背，而且有的公司看到你困难题，你如果真不会，可以申请换题）；其次笔试困难题一般一道或者无，做不出来不影响进面试其实。</li>
</ul>
<p>然后是投递简历。</p>
<p>一般是六月中旬就开始提前批投递，提前批是性价比最高的批次。因为这个批次里投的人少，HC充足，刚开始难度低。</p>
<p>所以一般六月中旬就可以考虑投递简历了，投递的时候同时每天牛客高强度刷对应公司的面经，一般会有大佬分享面经的。</p>
<p>简历方面的话，可以看看超级简历这个网站，现在基本上都是直接套模板，然后针对性的写自己的经历。主要还是实习+项目+奖学金打出自己的亮点。</p>
<p>项目和实习的简历细节可以按照面向场景+具体方法+实验结果+落地实践等的思路去写，并且<strong>分点写清楚</strong>，保存本地一份pdf，和证件照啥的一起归档在一个文件夹，毕竟每次投都要交这俩东西。</p>
<h2 id="公司选择"><a href="#公司选择" class="headerlink" title="公司选择"></a>公司选择</h2><p>只讲杭州，只讲我有印象的。</p>
<p>互联网相关的第一梯队有字节、网易、网易游戏（和网易独立的）、阿里、华为、oppo之类的，不一定齐，但是一般都会投上面的，其中阿里的正式批是最早也是面涉及知识点最广的，今年七月就开始了，可以提前准备。</p>
<p>第二梯队海康、大华、各类银行。</p>
<p>其他的比如中心蓝剑计划、滴滴、快手、拼多多balabala。</p>
<h2 id="JAVA开发技术栈"><a href="#JAVA开发技术栈" class="headerlink" title="JAVA开发技术栈"></a>JAVA开发技术栈</h2><p>JAVA技术栈很复杂，分为前端、后端和客户端。现在的行情是客户端人下人，前端渐渐成为后端选手需要了解的内容，即后端人上人，HC也多，当然竞争也很激烈。</p>
<p>后端的话：</p>
<ul>
<li><p>计算机基础：操作系统 / 计算机网络 / 数据结构与算法（堆栈、队列、链表、排序之类） / 设计模式</p>
</li>
<li><p>语言：Java基础 / Java并发 / JVM</p>
</li>
<li><p>数据库：MySQL</p>
</li>
<li><p>框架：Spring家族(Spring / SpringMVC / MyBatis / SpringBoot / SpringCloud)</p>
</li>
<li><p>中间件（次要）：Redis / Dubbo / 消息队列(RocketMQ / RabbitMQ等) / ElasticSearch</p>
</li>
<li><p>其它（次要）：Zookeeper / Netty / Tomcat / 系统设计(分布式 / 高并发)</p>
</li>
</ul>
<p>大部分公司在后端开发时，需要用到的所有技术栈，对于应届生来说，知道的越多越好，当然要使用过并且熟悉，不能随便玩过那种，最好的方式当然是结合<strong>开源项目</strong>，github直接搜或者百度直接搜相关知识点的项目。</p>
<p>当然最好是跟了后端技术栈的项目，没有的话面试就只能跟面试官聊自己实验室做的项目了，很可能鸡同鸭讲，面试体验很差。</p>
<h2 id="怎么刷题"><a href="#怎么刷题" class="headerlink" title="怎么刷题"></a>怎么刷题</h2><p>首先学习好语言基础，然后开始学习数据结构与算法，通过自己去实现一些数据结构和写算法题目，来巩固语言基础。这里的算法题通过leetcode来写，等leetcode刷到100来道之后开始看剑指offer。</p>
<p>如果开始的慢，建议直接剑指offer+leetcode高频题（leetcode开个会员，或者找网上别人开会员的高频截图），有了感觉之后每天刷几道巩固一下，准备期最重要的还是保持手感，然后牛客网跟进公司的面经。</p>
<p>因为每次简单的公司都会考察。</p>
<h2 id="杂的东西"><a href="#杂的东西" class="headerlink" title="杂的东西"></a>杂的东西</h2><p>讲一些现在还记得东西，也就是很重要的东西，基本会问。</p>
<p>后端开发，一般的面试都包括JAVA相关（其中以JAVA高并发、JVM、Hashmap、concurrentHashMap为高频考点）、计算机基础（操作系统、设计模式）、Mysql（或者涉及redis的话也会问）框架（Spring基本会问，虽然我当时啥都不会，所以跳过了框架这一块）、数据结构与算法（以刷题的形式，一般会有队列、树、链表、数组、回溯、动规，但是不会太难，因为需要半小时左右结束）</p>
<p>刷题的时候有一些套路可以学，比如迪特斯特拉，并查集，这种可以看labuladong这个公众号，有很多特辑。</p>
<p>面试的手撕代码，整套的流程实际上应当是：编写测试用例，编写代码，测试是否通过。所以自己写的时候最好也是测试用例写一下，不要只写函数，要做到你的用例可以输进函数里运行出正确结果这样。</p>
<p>然后关于树和链表，这类数据结构要自己会写，就是从零重新构建，面试的时候大部分需要自己，笔试的时候倒是可以直接用（题干里一般会注释出来）。</p>
<p>排序算法以及复杂度，基本都会提一嘴，要会快写，其中以归并和快排考察的最多。</p>
<p>秋招的时候牛客会出个各大公司高频，这个是秋招时期的一个很重要的参考，链接：</p>
<p><a target="_blank" rel="noopener" href="https://www.nowcoder.com/ta/job-code-high-week">https://www.nowcoder.com/ta/job-code-high-week</a></p>
<h2 id="下载链接"><a href="#下载链接" class="headerlink" title="下载链接"></a>下载链接</h2><p>我秋招的md文件我全放在博客里边了，很杂，选择性看，主要还是云计算方向的，不一定对口。</p>
<p>然后还有个JAVA的文档，带了笔记，链接：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/Liccol/CodeNotes/blob/master/2020%E6%9C%80%E6%96%B0Java%E9%9D%A2%E8%AF%95%E9%A2%98%E5%8F%8A%E7%AD%94%E6%A1%88V3.0.pdf">https://github.com/Liccol/CodeNotes/blob/master/2020%E6%9C%80%E6%96%B0Java%E9%9D%A2%E8%AF%95%E9%A2%98%E5%8F%8A%E7%AD%94%E6%A1%88V3.0.pdf</a></p>
<p>推荐的话公众号就labuladong、github的话CS-Notes（这个是比较规整的），包括了大部分的详细内容，但是更详细的还需要你们根据其他人的面经临时去补，我自己的git仓里也有，但是可能只有我自己看得懂:)，md的文档也没有弄好排版哈哈哈哈。</p>
<p>我自己的：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/Liccol/CodeNotes">https://github.com/Liccol/CodeNotes</a></p>
<p>上面那个pdf的JAVA文档，我其实就是放在这个仓下面。</p>
<p>还有一些98求职板块的上岸贴，也可以参考。</p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color5">JAVA</a>
        		</li>
      		 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">秋招</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2020/12/07/2020-12-07-JAVA%E7%A7%8B%E6%8B%9B%E6%80%BB%E7%BB%93/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-2020-09-11-Kubernetes" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/09/11/2020-09-11-Kubernetes/">Kubernetes详解</a>
    </h1>
  

        
        <a href="/2020/09/11/2020-09-11-Kubernetes/" class="archive-article-date">
  	<time datetime="2020-09-10T16:00:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2020-09-11</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Kubernetes"><a href="#Kubernetes" class="headerlink" title="Kubernetes"></a>Kubernetes</h1><h1 id="Kubernetes核心组件-重要"><a href="#Kubernetes核心组件-重要" class="headerlink" title="Kubernetes核心组件(重要)"></a>Kubernetes核心组件(重要)</h1><h2 id="最重要的API-Server"><a href="#最重要的API-Server" class="headerlink" title="最重要的API Server"></a>最重要的API Server</h2><p>提供K8S各类<strong>资源对象的增删改查+Watch+K8S Proxy API的HTTP Rest接口</strong>，是集群内<strong>各模块间数据交互和通信的中心枢纽</strong>。</p>
<p>还提供<strong>集群管理</strong>API/<strong>资源配额控制</strong>API/<strong>集群安全</strong>机制。</p>
<p>在8080端口提供REST服务，6443端口提供HTTPS安全端口加强接口访问安全性。</p>
<p>curl localhost:8080/api查看版本信息。此后的一系列地址可以查看更多细节。</p>
<p>kubectl proxy命令可以启动内部代理 设置访问白名单 设置服务不可访问–reject-paths</p>
<p>API Server需要很高性能，因为是集群核心，主要运用这些方式：</p>
<ul>
<li><p>高性能底层代码，协程+队列来做并发，超强多核处理能力，快速并发处理。</p>
</li>
<li><p>List接口结合异步Watch接口，解决同步问题，提升响应灵敏度。</p>
</li>
<li><p>高性能etcd数据库，而不是传统关系型数据库。</p>
</li>
</ul>
<h3 id="最重要的List-Watch"><a href="#最重要的List-Watch" class="headerlink" title="最重要的List-Watch"></a>最重要的List-Watch</h3><p>Etcd存储集群的数据信息，apiserver作为统一入口，任何对数据的操作都必须经过apiserver。</p>
<p>客户端(kubelet/scheduler/controller-manager)通过list-watch监听apiserver中资源(pod/rs/rc等等)的create,update和delete事件，并针对事件类型调用相应的事件处理函数。</p>
<p>各模块间需要和API Server轮询资源对象状态，API Server需要向各模块发出通知，这两块怎么实现，通过List-Watch。</p>
<p>针对这个场景，会发现几个问题：</p>
<p>轮询，怎么保证apiserver压力不会太大，保证实时性？</p>
<p>通知各模块，怎么保证消息可靠，解决端口占用问题？</p>
<p>List-Watch = List + Watch</p>
<p>list就是调用资源的list API罗列资源，基于<strong>HTTP短链接</strong>实现；watch则是调用资源的watch API监听资源变更事件，基于<strong>HTTP 长链接</strong>实现</p>
<p>K8S的informer模块封装list-watch API，用户需要指定资源，编写事件处理函数AddFunc,UpdateFunc和DeleteFunc等。</p>
<p>informer首先通过list API罗列资源，然后调用watch API监听资源的变更事件，并将结果放入到一个FIFO 队列。</p>
<p>队列的另一头有协程从中取出事件，并调用对应的注册函数处理事件。</p>
<p>Informer还维护了一个只读的Map Store缓存，主要为了提升查询的效率，降低apiserver的负载。</p>
<div align="center"> <img src="https://pic4.zhimg.com/80/v2-5263be53b45fdbea59e9812d9df627b7_720w.jpg" width=""> </div><br>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">c.NodeLister.Store, c.nodePopulator &#x3D; framework.NewInformer(</span><br><span class="line">    c.createNodeLW(),                                            ...(1) LW操作函数</span><br><span class="line">    &amp;api.Node&#123;&#125;,                                                 ...(2) </span><br><span class="line">    0,                                                           ...(3)</span><br><span class="line">    framework.ResourceEventHandlerFuncs&#123;                         ...(4) 事件处理函数触发入口</span><br><span class="line">        AddFunc:    c.addNodeToCache,                            ...(5)</span><br><span class="line">        UpdateFunc: c.updateNodeInCache,</span><br><span class="line">        DeleteFunc: c.deleteNodeFromCache,</span><br><span class="line">    &#125;,</span><br><span class="line">)  </span><br></pre></td></tr></table></figure>
<ul>
<li>消息可靠性</li>
</ul>
<p>避免因消息丢失而造成状态不一致场景。</p>
<p>list API可以查询当前的资源及其对应的状态(即期望的状态)，客户端通过拿期望的状态和实际的状态进行对比，纠正状态不一致的资源。</p>
<p>Watch API和apiserver保持一个长链接，接收资源的状态变更事件并做相应处理。</p>
<p>若某个时间点连接中断，就有可能导致消息丢失，所以需要通过list API解决消息丢失问题。</p>
<p>我们可以认为list API获取全量数据，watch API获取增量数据。虽然仅仅通过轮询list API，也能达到同步资源状态的效果，存在上面提到轮询的缺点：开销大，实时性不足的问题。</p>
<p>list实际上是用于辅助修正的，避免watch出问题了。</p>
<ul>
<li>消息实时性</li>
</ul>
<p>每当apiserver的资源产生状态变更事件，都会将事件及时的推送给客户端，从而保证消息的实时性。</p>
<ul>
<li>顺序性</li>
</ul>
<p>K8S在每个资源事件中都带一个resourceVersion的标签，这个标签是递增的数字。</p>
<p>所以当客户端并发处理同一个资源事件时，它就可以对比resourceVersion来保证最终的状态和最新的事件所期望的状态保持一致。</p>
<ul>
<li>高性能</li>
</ul>
<p>List-watch通过异步通知达到高性能的特点，watch作为异步消息通知机制，复用一条长链接，保证实时性的同时也保证了性能。</p>
<h3 id="API-Server架构"><a href="#API-Server架构" class="headerlink" title="API Server架构"></a>API Server架构</h3><p>API层-&gt;访问控制层-&gt;注册表层-&gt;etcd数据库</p>
<ul>
<li>API层</li>
</ul>
<p>提供一系列REST接口，如资源对象CRUD和Watch这五类主要API，还有/healthz、/logs、/ui(dashboard)、/metrics等运维监控相关接口。</p>
<ul>
<li>访问控制层</li>
</ul>
<p>对用户验明身份，鉴权，核准用户的资源对象访问权限（这些是针对用户的）；准入控制（针对资源，根据配置的资源访问逻辑判断能否允许访问）。</p>
<ul>
<li>注册表层</li>
</ul>
<p>保存所有资源对象在注册表中。包括对象的类型、创建方法、版本转换方式、如何把资源编解码为JSON或ProtoBuf格式存储。</p>
<ul>
<li>etcd数据库</li>
</ul>
<p>KV数据库，持久化存储资源对象。<strong>etcd Watch API 十分重要</strong>。，List-Watch是高性能的资源对象实时同步机制。</p>
<ul>
<li>其他设计细节：</li>
</ul>
<p>版本迭代和版本数据转换。处理的是同一对象不同版本的数据转换问题以及API接口版本兼容问题。</p>
<p>使用版本号控制接口兼容区分，数据转换使用internal版本，各个版本对象都能转换成internal版本对象，做各个版本对象的数据转换中介，从两两连接的混乱拓扑变成星状图。</p>
<h3 id="API-Server提供的另一个独特接口——K8S-Proxy-API接口"><a href="#API-Server提供的另一个独特接口——K8S-Proxy-API接口" class="headerlink" title="API Server提供的另一个独特接口——K8S Proxy API接口"></a>API Server提供的另一个独特接口——K8S Proxy API接口</h3><p>是作为代理，把收到的REST请求转发到Node上的kubelet的ERST接口，由kubelet响应。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;获取节点上所有Pods, 获取的信息是来自Node的,可能与etcd的有时间偏差</span><br><span class="line">curl localhost:8080&#x2F;api&#x2F;v1&#x2F;proxy&#x2F;node&#x2F;node1&#x2F;pods</span><br><span class="line">&#x2F;&#x2F;访问pod</span><br><span class="line">curl localhost:8080&#x2F;api&#x2F;v1&#x2F;proxy&#x2F;node&#x2F;node1&#x2F;pods&#x2F;&#123;name&#125;</span><br><span class="line">&#x2F;&#x2F;访问接口</span><br><span class="line">curl localhost:8080&#x2F;api&#x2F;v1&#x2F;proxy&#x2F;node&#x2F;node1&#x2F;pods&#x2F;&#123;path:&#125;</span><br></pre></td></tr></table></figure>
<p>这类接口主要是用来在外部冯文某个Pod容器的HTTP服务，用Proxy API实现，比如用来逐一排查Service的Pod哪个异常了。</p>
<p>同时service也可以使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl localhost:8080&#x2F;api&#x2F;v1&#x2F;provy&#x2F;namespace&#x2F;&#123;namespace&#125;&#x2F;services&#x2F;&#123;name&#125;</span><br></pre></td></tr></table></figure>
<h3 id="集群模块间通信"><a href="#集群模块间通信" class="headerlink" title="集群模块间通信"></a>集群模块间通信</h3><ul>
<li>kubelet与API server</li>
</ul>
<p>kubelet定期调用REST接口报告自身状态，API server把节点信息更新到etcd。</p>
<p>kubelet通过Watch接口监听Pod信息，如果有心副本调度到本节点，则执行Pod创建启动逻辑;若删除,则删除,若修改,则修改。</p>
<ul>
<li>kube-controller-manager与API server</li>
</ul>
<p>Node controller通过Watch接口实时监控Node信息，并做处理。</p>
<ul>
<li>kube-scheduler与API server</li>
</ul>
<p>通过Watch接口监听，如果有新建Pod副本的信息，会检索符合的Node列表，执行Pod调度，绑定Pod到Node上。</p>
<ul>
<li>优化</li>
</ul>
<p>各模块都采用本地缓存，缓存数据，各模块定时使用List-Watch方法获得想要的信息，缓存在本地缓存。</p>
<p>某些情况下通过访问缓存来直接操作，而不用直接访问API Server。从而降低API Server的访问压力。</p>
<h2 id="Controller-manager"><a href="#Controller-manager" class="headerlink" title="Controller manager"></a>Controller manager</h2><p>各个controller通过LW接口实时监控特定资源变化，并应对故障，保持状态为期望状态。共有8类。</p>
<h3 id="Replication-Controller"><a href="#Replication-Controller" class="headerlink" title="Replication Controller"></a>Replication Controller</h3><p>副本控制器，不同于资源对象RC，确保任何时候与RC关联的Pod副本数保持在预设值。但注意RC的重启策略必须是always。</p>
<p>因为有了副本控制器，所以最好不要直接创建Pod，而使用deploymengt等来构建。</p>
<p>综上：</p>
<p>副本控制器做的是：</p>
<ol>
<li><p>保持集群中有且只有N个Pod实例</p>
</li>
<li><p>调整RC的replicas属性来实现扩缩容</p>
</li>
<li><p>通过改变Pod模板来实现滚动升级</p>
</li>
</ol>
<p>场景：</p>
<ol>
<li><p>重新调度，即Node故障或Pod副本异常终止，能提供RC副本数保证</p>
</li>
<li><p>弹性伸缩，手动的扩缩容修改</p>
</li>
<li><p>滚动更新，副本控制器的流程是逐个替换Pod的方式，通过依次增新Pod，减旧Pod来实现所有副本的更新。直到旧RC副本为0，然后删除。</p>
</li>
</ol>
<h3 id="Node-Controller"><a href="#Node-Controller" class="headerlink" title="Node Controller"></a>Node Controller</h3><p>kubelet启动时会在API Server注册Node信息，并定时汇报状态，API Server更新信息到etcd中，包括健康状态，资源，名称，地址信息，OS版本，docker版本，kubelet版本。</p>
<p>Node Controller通过API Server获取Node信息，管理和监控集群中各个Node。</p>
<p>工作流程：</p>
<ol>
<li><p>如果设置了–cluster-cidr，回味Node生成CIDR地址，防止地址冲突。</p>
</li>
<li><p>逐个读取Node信息，和本地保存的nodeStatusMap的节点信息比较。</p>
</li>
</ol>
<p>2.1. 如果没有收到信息或第一次收到或过程中节点变得非健康：则保存信息，记录当前探测时间和节点变化时间</p>
<p>2.2. 收到新节点信息，保存新状态，记录当前探测时间和节点变化时间</p>
<p>2.3. 收到节点信息，但节点状态没变化，保存上次节点的变化时间</p>
<ol start="3">
<li><p>如果没有收到节点信息，则设置节点状态为Unknown</p>
</li>
<li><p>逐个读取节点信息，未就绪节点入队列，准备删除；并同步正常节点更新的信息。</p>
</li>
</ol>
<h3 id="ResourceQuota-Controller-资源配额管理器"><a href="#ResourceQuota-Controller-资源配额管理器" class="headerlink" title="ResourceQuota Controller 资源配额管理器"></a>ResourceQuota Controller 资源配额管理器</h3><p>确保指定资源对象任何时候都不会超量占用系统物理资源，避免某些设计缺陷导致系统紊乱/宕机。</p>
<p>层次为：容器级别、Pod级别、namespace（多租户）级别(pod数量,RC数量,Service数量,ResourceQuota数量,Secret数量,PV数量)</p>
<p>资源配额通过API Server的准入控制来控制（ResourceQuota(作用于namespace)和LimitRanger(作用于Pod和容器)两种方式）。</p>
<p>每次请求创建资源时，准入控制会计算当前配额使用情况，从etcd里读，不符合那就创建失败。</p>
<p>符合那就更新目前配置的资源量到etcd。而这些信息从ResourceQuota Controller中更新得到，最后存入etcd。</p>
<h3 id="Namespace-Controller"><a href="#Namespace-Controller" class="headerlink" title="Namespace Controller"></a>Namespace Controller</h3><p>定时读取namespace信息，如果有namespace要优雅删除，则标记，更新到etcd。准入控制里同时会组织改namespace继续创建新资源。</p>
<h3 id="Service-controller-和-endpoint-controller"><a href="#Service-controller-和-endpoint-controller" class="headerlink" title="Service controller 和 endpoint controller"></a>Service controller 和 endpoint controller</h3><p>service/endpoint/pod关系：endpoint为service对应的所有Pod副本的访问地址(具体为PODIP:PORTS)</p>
<p>endpoints对象在Node的kube-proxy上使用，proxy获取每个endpoints，实现Service负载均衡。</p>
<p>endpoint controller负责生成和维护所有endpoints对象信息。监听service和Pod副本变化，变化则同步更新service，Pod对应的endpoints对象。</p>
<p>Service controller监听service，如果是loadbalance类型，那么确保在外部云平台上对应的loadbalance实例更新正确，并更新路由转发表（根据endpoint）</p>
<h3 id="ServiceCount-controller-和-Token-controller"><a href="#ServiceCount-controller-和-Token-controller" class="headerlink" title="ServiceCount controller 和 Token controller"></a>ServiceCount controller 和 Token controller</h3><p>ServiceCount controller保证每个namespace至少有一个default service account。</p>
<p>如果启动了APIserver私钥，Token controller会被创建，也监听serviceaccount。确保serviceaccount至少有一个secret对象。</p>
<p>如果没有secret对象，那么就会用私钥创建一个Token，用token+CA证书+namespace名称产生secret，放入对应serviceaccount中。</p>
<p>此外token controller监听secret对象和处理。</p>
<h2 id="Scheduler原理"><a href="#Scheduler原理" class="headerlink" title="Scheduler原理"></a>Scheduler原理</h2><p>承上：负责接收Controller manager创建的新Pod，为他确定目标Node</p>
<p>启下：安置ok后，Node上kubelet接管后续工作。</p>
<p>具体的，Scheduler通过调度算法和策略把待调度Pod列表中的Pod从可用Node列表里选择合适Node并调度过去，同时更新到etcd。</p>
<p>设计待调度Pod列表，可用Node列表，调度算法和策略三大内容。</p>
<p>!!!调度流程两步：预选调度(列出合适候选,预选策略)+确定最优节点(优选策略,高分者胜出)，实际上用了预选策略+优选策略。</p>
<p>预选策略：NoDiskConflict(gcePersistentDisk和AWSElasticBlovkStore两类挂在卷类型,看看有没有磁盘冲突)/PodFitsResource(是否满足Pod需求,如内存CPU资源)/PodSelectorMatches(Pod的nodeSelector标签选择器要求是否满足,如node必须要被打伤某个k-v标签值才能作为目标)/PodFitsHost(nodeName域指定的节点名称是否一致)/CheckNodeLablePresence/CheckServiceAffinity/PodFitsPorts(端口列表是否占用)</p>
<p>优选策略:LeastRequestPriority(选出资源CPU和内存消耗最小的节点,计算使用率的剩余量之和)/CalculateNodeLabelPriority(对配置的标签的匹配度)/BalencedResourceAllocation(选出CPU和内存使用率最均衡的,计算二者差值,要使用率尽可能近,不能不平衡)</p>
<h2 id="kubelet原理"><a href="#kubelet原理" class="headerlink" title="kubelet原理"></a>kubelet原理</h2><p>每个Node都有kubelet进程，用于处理下发到本节点的任务，管理Pod和容器。每个kubelet都在API Server注册节点信息，定期汇报，使用cAdvisor监控容器和节点资源。</p>
<ul>
<li>节点管理</li>
</ul>
<p>自注册节点信息到API server，定时更新状态给API server</p>
<ul>
<li> Pod管理</li>
</ul>
<p>监听etcd-API server的Pod信息变化。</p>
<p>如果要删除Pod:</p>
<p>那就删除，并通过Dokcer Client删除Pod中的容器。</p>
<p>如果是创建或修改Pod任务：</p>
<p>为Pod创建数据目录-&gt;从API Server读取Pod清单-&gt;为该Pod挂载卷-&gt;下载Pod用到的secret-&gt;检查已经运行在节点上的pod,如果没有容器或者Pause容器没有启动(即未就绪),则停止Pod内所有容器进程.-&gt;每个Pod创建pause容器,Pause容器接管所有业务容器的网络.-&gt;为Pod中的每个容器做这些(为容器计算hash值,查看名称对应的容器hash,不一样则停止容器和与之关联的Pause容器,如果一样则不作处理/如果容器不终止并且没有指定的重启策略则不处理/否则调用Docker Client下载镜像,运行容器)</p>
<ul>
<li> 容器健康检查</li>
</ul>
<p>LivenessProbe(是否健康,不健康就删除容器,没探针的话默认都健康)和ReadinessProbe(判断是否启动完成,可以接受请求,如果失败则由Endpoint Controller把这个容器所在Pod的endpoint条目删除)</p>
<p>执行方式：执行命令(cat /tmp/health)/TCP检查端口/HTTP检查端口</p>
<ul>
<li>cAdvisor监控资源</li>
</ul>
<p>4194端口暴露一个简单UI。弃用，想用可以用daemonSet新建一个cadvisor。现在监控用metrics server和custom metrics。</p>
<h2 id="kube-proxy"><a href="#kube-proxy" class="headerlink" title="kube-proxy"></a>kube-proxy</h2><p>Service是对一组Pod的抽象，创建Service时会创建虚拟IP，客户端访问虚拟IP，Service把请求转发到后端Pod。Service的作用实际上就是kube-proxy完成的。</p>
<p>proxy是Service的代理+负载均衡器。核心功能就是把某个到Service的访问转发到后端多个Pod实例上。Service的Cluster IP和NodePort等就是proxy通过iptables的NAT转换实现的。</p>
<p>proxy目前的默认模式是iptables模式，核心功能变成：watch apiserver接口追踪service和endpoint变化，更新iptables信息，客户的请求流量通过iptables的NAT网络地址转换(IP端口名称的映射关系)直接路由到目标Pod。</p>
<p>iptables模式完全在内核态，不用专户单到用户态的proxy，所以性能更强。</p>
<p>缺陷：service，pod大量增加，规则数大，性能下降，所以引入了IPVS，即IP虚拟服务器，提供高性能负载均衡，可以无限规模扩张，数据结构用哈希表。</p>
<h3 id="IPVS"><a href="#IPVS" class="headerlink" title="IPVS"></a>IPVS</h3><h2 id="集群安全"><a href="#集群安全" class="headerlink" title="集群安全"></a>集群安全</h2><p>包括认证授权，准入控制，secret机制。</p>
<p>逻辑是认证鉴权-准入控制-得到响应。</p>
<h2 id="API-server认证管理"><a href="#API-server认证管理" class="headerlink" title="API server认证管理"></a>API server认证管理</h2><p>如何认证识别客户端身份？访问权限怎么授予？即认证+授权问题</p>
<p>提供三种级别认证方式：</p>
<ol>
<li><p>HTTPS CA(可信第三方)根证书认证,和HTTPS的SSL认证差不多</p>
</li>
<li><p>HTTP token认证.Token存放信息，在API调用时,http头里加入token就好</p>
</li>
<li><p>HTTP base认证,用户名+冒号+密码用BASE64算法编码后放在头认证域，发给服务端。</p>
</li>
</ol>
<h2 id="API-Server授权管理"><a href="#API-Server授权管理" class="headerlink" title="API Server授权管理"></a>API Server授权管理</h2><p>给不同用户不同的访问权限:</p>
<ul>
<li><p>AlwaysDeny</p>
</li>
<li><p>AlwaysAllow(默认)</p>
</li>
<li><p>ABAC基于属性的访问控制</p>
</li>
</ul>
<p>指定授权策略文件，文件中每一行以map形式提供访问策略对象，可以设置apiVersion,kind:Policy,spec属性。</p>
<p>ABAC中，收到请求，识别出携带的策略对象属性，然后匹配策略文件，至少一条匹配成功就通过授权。</p>
<p>Serviceaccount会自动生成ABAC用户名，创建新的namespace时会产生serviceaccount，携带ABAC用户名，把这个写入授权策略就好。</p>
<ul>
<li>RBAC基于角色的访问控制</li>
</ul>
<p>引入Role、ClusterRole、RoleBinding、ClusterRoleBinding四个资源对象，以yaml形式编写构建。</p>
<p>Role绑定namespace，在namespace中用role定义角色权限</p>
<p>ClusterRole绑定集群内角色,可以访问集群范围内的资源、全部命名空间的资源等</p>
<p>RoleBinding、ClusterRoleBinding绑定有权利的角色和目标对象，使目标(User，Group，Service Acount)得到权力。</p>
<p>逻辑是：(User，Group，Service Acount)-&gt;通过RoleBinding-&gt;再到Role-&gt;再到对Pod的操作get watch list等</p>
<ul>
<li>Webhook调用外部REST服务对用户授权</li>
</ul>
<p>实现HTTP接口，k8s会调用这个接口去外部REST服务中对用户授权。此时API Server变成客户端，远端授权服务网站变成授权服务端。</p>
<ul>
<li>Node专用于kubelet请求访问控制</li>
</ul>
<h2 id="准入控制"><a href="#准入控制" class="headerlink" title="准入控制"></a>准入控制</h2><p>准入控制链检查，通过检查才能得到相应。</p>
<h2 id="Service-Account"><a href="#Service-Account" class="headerlink" title="Service Account"></a>Service Account</h2><p>一种账号，给Pod里的进程用，属于当前namespace。这些进程要去访问API Server时，就用serviceaccount来做身份认证。Service Account包含多个secret对象，是用于不同访问目标的身份鉴权协助。</p>
<h2 id="Secret-私密凭据"><a href="#Secret-私密凭据" class="headerlink" title="Secret 私密凭据"></a>Secret 私密凭据</h2><p>保管私密数据，密码、token、keys等。放在secret对象里更安全，便于使用和分发。</p>
<p>怎么用？创建pod时指定serviceaccount从而自动使用secret/挂载secret到pod(volume)/指定pod的imagepullsecret额外引用这个secret</p>
<h2 id="K8S-网络原理"><a href="#K8S-网络原理" class="headerlink" title="K8S 网络原理"></a>K8S 网络原理</h2><p>每个Pod有一个独立的ip地址，所有pod都在联通的网路空间里，pod内容器共享一个网络堆栈(pause容器+业务容器，从而pod内容器可以用localhost访问对方端口)。</p>
<p>K8S网络和Dokcer动态端口映射方式的区别？</p>
<p>Docker的更复杂，端口管理复杂，访问者看到的IP和实际IP不同，应用配置很复杂。</p>
<p>为了支持这个简单K8S模型，要求所有容器/节点都可以不用NAT时和别的容器/节点通信，容器的地址和别人看到的地址是同一个。</p>
<h2 id="Docker网络基础"><a href="#Docker网络基础" class="headerlink" title="Docker网络基础"></a>Docker网络基础</h2><h3 id="网络命名空间"><a href="#网络命名空间" class="headerlink" title="网络命名空间"></a>网络命名空间</h3><p>通过网络命名空间把独立的协议栈隔离到不同namespace中，相互独立、</p>
<p>各自namespace可以有自己的独立路由表，iptables。</p>
<p>对于独立的各个网络协议栈，只能通过veth设备对(veth pair)来做通信，连接两个网络协议栈。veth pair就是为了在不同网络namespace中通信创建的，成对出现。</p>
<p>网络连起来了，那么怎么把主机间通信连起来？用网桥，一个二层虚拟网络设备，使得网络接口间报文能互相转发。通过mac地址识别转发。</p>
<p>可以通信了，那怎么对特定数据包进行处理？引入Netfilter和iptables。</p>
<h3 id="Docker网络模式"><a href="#Docker网络模式" class="headerlink" title="Docker网络模式"></a>Docker网络模式</h3><p>4类：</p>
<ul>
<li><p>host(–net=host)</p>
</li>
<li><p>container(–net=container:NAME_or_ID)</p>
</li>
<li><p>none(–net=none)</p>
</li>
<li><p>bridge(–net=bridge)</p>
</li>
</ul>
<p>k8s下只使用这个。</p>
<p>dockerdaemon第一次启动，创建虚拟网桥docker0，给他分配一个子网，对于docker创建的每个容器，都会创建一个虚拟的veth设备对，一段在网桥，一端用网络namespace映射到容器内的eth0设备，给eth0分配一个IP地址。</p>
<h2 id="K8S网络实现"><a href="#K8S网络实现" class="headerlink" title="K8S网络实现"></a>K8S网络实现</h2><p>这个比docker复杂多了</p>
<p>需要解决容器间/Pod间/pod和service间/集群外和集群内之间的通信。</p>
<ul>
<li>容器间</li>
</ul>
<p>同一个Pod下的容器共有一套网络命名空间，打开端口不会有冲突，使用本地IPC进行通信。使用localhost就可以访问</p>
<ul>
<li>Pod之间</li>
</ul>
<p>同一个Node内的不同Pod间的容器，可以直接用对方Pod的IP地址通信，而不需要使用其他发现机制如DNS。从Docker bridge模式可以看到，每个Pod都是通过veth pair链接到同一个docker0网桥，所以他们都关联在同一个docker0网桥上，地址段相同，可以直接通信。</p>
<p>不同Node上的Pod，那只能通过宿主机的物理网卡进行了，必须通过主机的IP地址进行寻址和通信。所以要对Pod的IP分配进行规划，不能有冲突，将Pod的IP和Node的IP关联起来。</p>
<p>不同Node间就变成了，Pod1-&gt;Pod1eth0网卡-&gt;Node1的docker0网桥-&gt;Node1的物理网卡-&gt;Node2的物理网卡-&gt;Node2的docker0网桥-&gt;Pod2的eth0网卡-&gt;Pod2的具体容器。</p>
<p>而endpoint都会存在etcd中。</p>
<h2 id="实例-K8S-Pod创建过程中发生了什么"><a href="#实例-K8S-Pod创建过程中发生了什么" class="headerlink" title="实例: K8S Pod创建过程中发生了什么"></a>实例: K8S Pod创建过程中发生了什么</h2><ul>
<li>kubectl上验证+生成请求给apiserver</li>
</ul>
<p>输入kubectl命令后，先执行客户端验证操作。</p>
<p>主要是确保不合法的请求失败（如创建不支持的资源或镜像名称格式错误），此时不会和API server交互。</p>
<p>发送HTTP请求之前还要进行客户端认证。用户凭证放在kubeconfig文件中，把这些认证信息放在HTTP请求头中(认证信息可以是CA证书,token,用户名和密码)</p>
<p>验证通过后，使用generator(用来序列化)封装给apiserver的HTTP请求。</p>
<ul>
<li>APIserver收到请求，认证+授权+准入控制</li>
</ul>
<p>请求到达apiserver，先验证请求者是合法的，即认证。针对三种认证方式，各自进行认证。</p>
<p>认证完毕后，apiserver给用户进行授权。(授权方法ABAC/RBAC/webhook/node等)</p>
<p>认证授权之后，进行准入控制。</p>
<p>走一系列的准入控制链判断额外检查是否通过，如果都通过，那么可以准入；如果一个环出错，那么立即终止。</p>
<p>准入控制器都是以插件形式存储在admission目录下的，最后被编译到apiserver二进制文件中去。</p>
<p>着重介绍 SecurityContextDeny、ResourceQuota 及 LimitRanger这三个准入控制器。</p>
<p>SecurityContextDeny 该插件将禁止创建设置了 Security Context 的 Pod。</p>
<p>ResourceQuota 不仅能限制某个 Namespace 中创建资源的数量，而且能限制某个 Namespace 中被 Pod 所请求的资源总量。该准入控制器和资源对象 ResourceQuota 一起实现了资源配额管理。</p>
<p>LimitRanger 作用类似于上面的 ResourceQuota 控制器，针对 Namespace 资源的每个个体（Pod 与 Container 等）的资源配额。该插件和资源对象 LimitRange 一起实现资源配额管理。</p>
<p>至此，k8s已经对所有的调用请求进行了全面审查并通过。</p>
<ul>
<li>apiserver把信息存入etcd</li>
</ul>
<p>kube-apiserver 将对 HTTP 请求进行反序列化，然后利用结果构建运行时对象，然后资源将会通过 storage provider 保存到 etcd 中。</p>
<p>资源创建过程中出现的任何错误都会被捕获，最后 storage provider 会执行 get 调用来确认该资源是否被成功创建。</p>
<p>最后构造 HTTP 响应并返回给客户端。</p>
<p>到目前为止，我们创建的 Deployment 资源已经保存到了 etcd 中，但 apiserver 仍然看不到它。</p>
<ul>
<li>初始化</li>
</ul>
<p>在一个资源对象被持久化到数据存储之后，apiserver 还无法完全看到或调度它，在此之前还要执行一系列 Initializers。</p>
<p>Initializers 是一种与资源类型相关联的控制器，它会在资源对外可用之前执行某些逻辑。</p>
<p>如果某个资源类型没有 Initializers，就会跳过此初始化步骤立即使资源对外可见。</p>
<ul>
<li>controller控制</li>
</ul>
<p>Deployment 实际上只是一系列 Replicaset 的集合，而 Replicaset 是一系列 Pod 的集合。那么 Kubernetes 是如何从一个 HTTP 请求按照层级结构依次创建这些资源的呢？</p>
<p>其实这些工作都是由 Kubernetes 内置的 Controller(控制器) 来完成的。</p>
<p>将 Deployment 记录存储到 etcd 并初始化后，就可以通过 kube-apiserver 使其可见，然后 Deployment Controller 就会检测到它。</p>
<p>在意识到没有与其关联的 ReplicaSet 或 Pod 记录后，Deployment Controller 就会开始执行弹性伸缩流程，创建 ReplicaSet 资源。</p>
<p>该 Deployment 的 status 就会被更新，然后重新进入与之前相同的循环，等待 Deployment 与期望的状态相匹配。</p>
<p>由于 Deployment Controller 只关心 ReplicaSet，因此需要通过 ReplicaSet Controller 来继续协调。</p>
<p>Deployment Controller 创建了第一个 ReplicaSet，但仍然还是没有 Pod，ReplicaSet Controller 的工作是监视 ReplicaSets 及其相关资源（Pod）的生命周期。</p>
<p>当创建 ReplicaSet 时，RS Controller 检查新 ReplicaSet 的状态，并检查当前状态与期望状态之间存在的偏差，然后通过调整 Pod 的副本数来达到期望的状态。</p>
<ul>
<li>Scheduler控制</li>
</ul>
<p>当所有的 Controller 正常运行后，etcd 中就会保存一个 Deployment、一个 ReplicaSet 和 三个 Pod 资源记录，并且可以通过 kube-apiserver 查看。</p>
<p>然而，这些 Pod 资源现在还处于 Pending 状态，因为它们还没有被调度到集群中合适的 Node 上运行。这个问题最终要靠调度器（Scheduler）来解决。</p>
<p>Scheduler 的作用是将待调度的 Pod 按照特定的算法和调度策略(预选策略+优选策略)绑定到集群中某个合适的 Node 上，并将绑定信息写入 etcd 中。</p>
<p>一旦找到了合适的节点，Scheduler 就会通过 POST 请求发送给 apiserver。</p>
<p>当 kube-apiserver 接收到此 Binding 对象时，会更新 Pod 资源中的Node信息。</p>
<p>一旦 Scheduler 将 Pod 调度到某个节点上，该节点的 Kubelet 就会接管该 Pod 并开始部署。</p>
<ul>
<li>目标节点的kubelet</li>
</ul>
<p>接管任务，获取Pod清单，部署Pod，下载镜像并启动容器。</p>
<p>第一次启动 Pod 时，Kubelet 会通过RPC协议调用 RunPodSandbox创建sandbox。sandbox 用于描述一组容器，例如在 Kubernetes 中它表示的是 Pod。</p>
<p>首先创建的是 pause 容器。pause 容器作为基础容器，为 Pod 中的业务容器提供了大量的 Pod 级别资源。pause 容器提供了一种方法来管理所有这些命名空间并允许业务容器共享它们。</p>
<p>在同一个网络命名空间中的好处是：同一个 Pod 中的容器可以使用 localhost 来相互通信。</p>
<p>pause 容器的第二个功能与 PID 命名空间的工作方式相关，在 PID 命名空间中，进程之间形成一个树状结构，一旦某个子进程由于父进程的错误而变成了“孤儿进程”，其便会被 init 进程进行收养并最终回收资源。</p>
<p>一旦创建好了 pause 容器，下面就会开始检查磁盘状态然后开始启动业务容器。</p>
<p>现在我们的 Pod 已经有了基本的骨架：一个共享所有命名空间以允许业务容器在同一个 Pod 里进行通信的 pause 容器。但现在还有一个问题，那就是容器的网络是如何建立的？</p>
<p>当 Kubelet 为 Pod 创建网络时，它会将创建网络的任务交给 CNI 插件。cni 插件可以给 pause 容器配置相关的网络，然后 Pod 中其他的容器都使用 pause 容器的网络。</p>
<p>跨主机之间的容器如何通信呢？</p>
<p>通常情况下使用 overlay 网络来进行跨主机容器通信，这是一种动态同步多个主机间路由的方法。其中最常用的 overlay 网络插件是 flannel。</p>
<p>所有网络都配置完成后，接下来就开始真正启动业务容器了！</p>
<p>首先启动 PodSpec 中定义的 init 容器，然后再启动业务容器。</p>
<p>至此，Pod就部署在了Node上，并启动了内部的所有容器。</p>
<h2 id="Pod-状态-status"><a href="#Pod-状态-status" class="headerlink" title="Pod 状态 status"></a>Pod 状态 status</h2><p>Pending（悬决）|Pod 已被 Kubernetes 系统接受，但有一个或者多个容器尚未创建亦未运行。此阶段包括等待 Pod 被调度的时间和通过网络下载镜像的时间<br>Running（运行中）|Pod 已经绑定到了某个节点，Pod 中所有的容器都已被创建。至少有一个容器仍在运行，或者正处于启动或重启状态。<br>Succeeded（成功）|Pod 中的所有容器都已<strong>成功终止</strong>，并且<strong>不会再重启</strong>。<br>Failed（失败）|Pod 中的所有容器都已终止，并且至少有一个容器是因为失败终止。也就是说，容器以非 0 状态退出或者被系统终止。<br>Unknown（未知）|因为某些原因无法取得 Pod 的状态。这种情况通常是因为与 Pod 所在主机通信失败。</p>
<h1 id="Kubernetes-内容"><a href="#Kubernetes-内容" class="headerlink" title="Kubernetes 内容"></a>Kubernetes 内容</h1><ul>
<li>控制平面Master组件：</li>
</ul>
<p>apiserver+</p>
<p>controller-manager(kube:节点/副本/端点/服务帐户和令牌控制器和cloud两种)+</p>
<p>scheduler(监视新创建的未指定运行节点的 Pod，并选择节点让 Pod 在上面运行，即Pod的运行调度，亲和性等)+</p>
<p>etcd(保存 Kubernetes 所有集群数据的后台数据库)</p>
<ul>
<li>Node组件：</li>
</ul>
<p>kubelet(每个节点上运行的代理。它保证K8S创建的容器都运行在 Pod 中。接收 PodSpecs，确保这些 PodSpecs 中描述的容器处于运行状态且健康。)</p>
<p>kube-proxy(集群中每个节点上运行的网络代理,实现 Kubernetes Service 概念的一部分。维护节点上的网络规则。这些网络规则允许从集群内部或外部的网络会话与 Pod 进行网络通信。)</p>
<p>容器运行时（Container Runtime。负责运行容器的软件。）</p>
<ul>
<li>插件</li>
</ul>
<p>插件使用 Kubernetes 资源（DaemonSet、 Deployment等）实现集群功能。 因为这些插件提供集群级别的功能，插件中命名空间域的资源属于 kube-system 命名空间。</p>
<p>DNS</p>
<p>几乎所有 Kubernetes 集群都应该 有集群 DNS， 因为很多示例都需要 DNS 服务。</p>
<p>集群 DNS 是一个 DNS 服务器，和环境中的其他 DNS 服务器一起工作，它为 Kubernetes 服务提供 DNS 记录。</p>
<p>Kubernetes 启动的容器自动将此 DNS 服务器包含在其 DNS 搜索列表中。</p>
<p>DashBoard</p>
<p>通用的、基于 Web 的用户界面。 它使用户可以管理集群中运行的应用程序以及集群本身并进行故障排除。</p>
<p>容器资源监控</p>
<p>metrics相关</p>
<p>集群层面日志</p>
<p>日至存储相关</p>
<h2 id="K8S对象"><a href="#K8S对象" class="headerlink" title="K8S对象"></a>K8S对象</h2><p>Kubernetes 对象 是持久化的实体，通过.yaml创建。 Kubernetes 使用这些实体去表示整个集群的状态。特别地，它们描述了如下信息：</p>
<ul>
<li><p>哪些容器化应用在运行（以及在哪些节点上），通过matchlabels等字段</p>
</li>
<li><p>可以被应用使用的资源，通过request和limit等字段</p>
</li>
<li><p>关于应用运行时表现的策略，比如重启策略、升级策略，以及容错策略，如滚动升级等</p>
</li>
</ul>
<h3 id="yaml必须字段"><a href="#yaml必须字段" class="headerlink" title="yaml必须字段"></a>yaml必须字段</h3><p>需要配置如下的字段：</p>
<p>apiVersion - 创建该对象所使用的 Kubernetes API 的版本</p>
<p>kind - 想要创建的对象的类别，deployment/service等</p>
<p>metadata - 帮助<strong>唯一性标识对象的一些数据</strong>，包括一个 name 字符串、UID 和可选的 namespace，如name:test</p>
<p>你也需要提供对象的 <strong>spec</strong> 字段。可以包含label等特定内容，包含replicas指定副本数目，包含template指定模板（包括容器的镜像/端口等，容器metadata如labels等）</p>
<h3 id="对象管理"><a href="#对象管理" class="headerlink" title="对象管理"></a>对象管理</h3><p>一般都是用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f test.yaml&#x2F;&#x2F;创建</span><br><span class="line">kubectl apply -f test.yaml&#x2F;&#x2F;更新</span><br><span class="line">kubectl delete -f test.yaml&#x2F;&#x2F;删除</span><br><span class="line">kubectl diff -f test.yaml&#x2F;&#x2F;查看更改</span><br></pre></td></tr></table></figure>
<p>使用matadata中的内容唯一标识数据，而其他内容需要使用它的时候，会使用这个k-v对的值来选择。</p>
<p>一个 Service 指向的一组 pods 是由标签选择算符定义的。同样，一个 ReplicationController 应该管理的 pods 的数量也是由标签选择算符定义的。</p>
<p>使用选择：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">selector:</span><br><span class="line">    component: redis</span><br></pre></td></tr></table></figure>
<p>此外，metadata中还可以加上注解annotation，来添加一些额外信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: annotations-demo</span><br><span class="line">  annotations:</span><br><span class="line">    imageregistry: &quot;https:&#x2F;&#x2F;hub.docker.com&#x2F;&quot;</span><br></pre></td></tr></table></figure>
<h2 id="节点Node"><a href="#节点Node" class="headerlink" title="节点Node"></a>节点Node</h2><p>向 API 服务器添加节点的方式主要有两种：</p>
<ol>
<li>节点上的 kubelet 向控制面执行自注册；</li>
<li>你，或者别的什么人，手动添加一个 Node 对象。</li>
</ol>
<h3 id="节点状态"><a href="#节点状态" class="headerlink" title="节点状态"></a>节点状态</h3><ul>
<li>地址</li>
</ul>
<p>HostName：由节点的内核设置。可以通过 kubelet 的 –hostname-override 参数覆盖。<br>ExternalIP：通常是节点的可外部路由（从集群外可访问）的 IP 地址。<br>InternalIP：通常是节点的仅可在集群内部路由的 IP 地址。</p>
<ul>
<li>状况</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&quot;conditions&quot;: [</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;type&quot;: &quot;Ready&quot;,</span><br><span class="line">    &quot;status&quot;: &quot;True&quot;,</span><br><span class="line">    &quot;reason&quot;: &quot;KubeletReady&quot;,</span><br><span class="line">    &quot;message&quot;: &quot;kubelet is posting ready status&quot;,</span><br><span class="line">    &quot;lastHeartbeatTime&quot;: &quot;2019-06-05T18:38:35Z&quot;,</span><br><span class="line">    &quot;lastTransitionTime&quot;: &quot;2019-06-05T11:41:27Z&quot;</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h3 id="控制面到节点通信"><a href="#控制面到节点通信" class="headerlink" title="控制面到节点通信"></a>控制面到节点通信</h3><p>Kubernetes 采用的是中心辐射型（Hub-and-Spoke）API 模式。 </p>
<p>所有从集群（或所运行的 Pods）发出的 API 调用都终止于 apiserver（其它控制面组件都没有被设计为可暴露远程服务）。 </p>
<p>apiserver 被配置为在一个安全的 HTTPS 端口（443）上监听远程连接请求， 并启用一种或多种形式的客户端身份认证机制。 </p>
<h3 id="控制面到节点"><a href="#控制面到节点" class="headerlink" title="控制面到节点"></a>控制面到节点</h3><p>有两种主要的通信路径。 第一种是从 apiserver 到集群中每个节点上运行的 kubelet 进程。 第二种是从 apiserver 通过它的代理功能连接到任何节点、Pod 或者服务。</p>
<ul>
<li>API 服务器到 kubelet</li>
</ul>
<p>从 apiserver 到 kubelet 的连接用于：</p>
<ol>
<li>获取 Pod 日志</li>
<li>挂接（通过 kubectl）到运行中的 Pod</li>
<li>提供 kubelet 的端口转发功能。</li>
</ol>
<p>这些连接终止于 kubelet 的 HTTPS 末端。 默认情况下，apiserver 不检查 kubelet 的服务证书。这使得此类连接容易受到中间人攻击， 在非受信网络或公开网络上运行也是 不安全的。</p>
<p>为了对这个连接进行认证，使用 –kubelet-certificate-authority 标志给 apiserver 提供一个根证书包，用于 kubelet 的服务证书。</p>
<p>如果无法实现这点，又要求避免在非受信网络或公共网络上进行连接，可在 apiserver 和 kubelet 之间使用 SSH 隧道。</p>
<p>最后，应该启用 Kubelet 用户认证和/或鉴权 来保护 kubelet API。</p>
<ul>
<li>apiserver 到节点、Pod 和服务</li>
</ul>
<p>从 apiserver 到节点、Pod 或服务的连接默认为纯 HTTP 方式，因此既没有认证，也没有加密。 </p>
<p>这些连接可通过给 API URL 中的节点、Pod 或服务名称添加前缀 https: 来运行在安全的 HTTPS 连接上。 </p>
<p>不过这些连接既不会验证 HTTPS 末端提供的证书，也不会提供客户端证书。 </p>
<p>因此，虽然连接是加密的，仍无法提供任何完整性保证。 </p>
<p>这些连接 目前还不能安全地 在非受信网络或公共网络上运行。</p>
<h3 id="Pods"><a href="#Pods" class="headerlink" title="Pods"></a>Pods</h3><p>Pod 是可以在 Kubernetes 中创建和管理的、最小的可部署的计算单元。</p>
<p>Pod 的共享上下文包括一组 Linux namespace、控制组（cgroup）和一些其他的用来隔离 Docker 容器的技术。 在 Pod 的上下文中，每个独立的应用可能会进一步实施隔离。</p>
<p>就 Docker 概念的术语而言，Pod 类似于共享名字空间和文件系统卷的一组 Docker 容器。</p>
<h4 id="pause容器"><a href="#pause容器" class="headerlink" title="pause容器"></a>pause容器</h4><p>Pod = Pause容器 + 其他业务容器。</p>
<p>每个Pod里运行着一个特殊的被称之为Pause的容器，其他容器则为业务容器，这些<strong>业务容器共享Pause容器的网络栈和Volume挂载卷</strong></p>
<p>pause容器，全称infrastructure container（又叫infra）基础容器</p>
<p>pause容器的PID是1。kubernetes中的<strong>pause容器主要为每个业务容器提供以下功能，为其他业务容器提供各类namespace资源</strong>：</p>
<p>PID命名空间：Pod中的不同应用程序可以看到其他应用程序的进程ID。</p>
<p>网络命名空间：Pod中的多个容器能够访问同一个IP和端口范围。</p>
<p>IPC命名空间：Pod中的多个容器能够使用SystemV IPC或POSIX消息队列进行通信。</p>
<p>UTS命名空间：Pod中的多个容器共享一个主机名；Volumes（共享存储卷）：</p>
<p>Pod中的各个容器可以访问在Pod级别定义的Volumes。</p>
<h4 id="静态Pod"><a href="#静态Pod" class="headerlink" title="静态Pod"></a>静态Pod</h4><p>仅存在特定Node上的Pod，无法通过api server控制，无法与RC/deployment/daemonset关联，kubectl无法对其进行健康检查，由kubectl创建，总在kubectl所在的Node上运行。</p>
<p>主要是把kubectl的启动参数–config=yaml存放位置，重启kubectl，就可以创建静态pod。或者通过–manifest-url=目标yaml网址来创建，kubectl定期扫描两种方式的位置，有内容就创建静态pod。</p>
<p>只能通过把对应位置的内容rm掉才可以删除，否则直接kubectl删除的时候会变成pending状态，等待中，不会被删除。</p>
<h4 id="共享卷"><a href="#共享卷" class="headerlink" title="共享卷"></a>共享卷</h4><p>pod中的容器共享本地存储卷，container1和container2都可以使用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">volumeMounts:</span><br><span class="line">- name: logs</span><br><span class="line">  mountPath: &#x2F;usr&#x2F;local&#x2F;log</span><br></pre></td></tr></table></figure>
<h4 id="生命周期和重启策略"><a href="#生命周期和重启策略" class="headerlink" title="生命周期和重启策略"></a>生命周期和重启策略</h4><p>pending|镜像仍未创建或在下载中<br>running|至少有一个容器运行/正在启动/正在重启<br>succeeded|所有容器执行成功后退出，不再重启<br>failed|至少有一个容器退出为失败状态<br>unknown|无法获取pod状态，网络问题等</p>
<p>重启策略restartpolicy：</p>
<p>Always：自动重启<br>onfailure：容器终止且退出码不为0，由kubectl自动重启<br>never：不重启</p>
<p>重启策略在不同的控制方式下设置不一样：</p>
<p>RC/daemonset：always，必须保证持续运行<br>job：onfailure/never，因为是全部执行完毕后就结束，所以不重启</p>
<h4 id="健康检查和服务可用性检查"><a href="#健康检查和服务可用性检查" class="headerlink" title="健康检查和服务可用性检查"></a>健康检查和服务可用性检查</h4><p>主要是用两个探针来实现。</p>
<p>livenessProbe：判断容器是否为running状态，是否存活。默认为success，只有设置了才会去探查，根据重启策略重启。</p>
<p>readnessProbe：判断容器服务是否可用，为ready状态？只有ready才可以对外提供服务，否则的话从service后端的endpoint列表里格里拉出去，避免用户进入服务不可用的pod实例。</p>
<p>probe实现方法：</p>
<p>execAction：执行命令，返回0则正常。执行cat /tmp/health等。</p>
<p>TCPSocketAction：通过容器的IP:PORT来判断加你差，设置一个port</p>
<p>HTTPGetAction：通过get某个地址的某个多端口返回的状态码判断是否健康（200~400都是健康）。</p>
<p>默认参数：</p>
<p>initialDelaySeconds：什么时候开始首次检查？</p>
<p>timeoutSeconds：等待多久后判定为无法提供服务？</p>
<h4 id="Pod调度-运行节点选择控制"><a href="#Pod调度-运行节点选择控制" class="headerlink" title="Pod调度(运行节点选择控制)"></a>Pod调度(运行节点选择控制)</h4><p>RC(选一个标签) —&gt; RS(选多个标签) —&gt; deployment(更自动的部署)</p>
<p>deployment实际上是通过RS来实现副本自动控制的，所以用deployment。</p>
<p>调度时可能需要实现以下内容：</p>
<ol>
<li>想要放在特定的节点上</li>
</ol>
<p>通过制定NodeSelector来实现。</p>
<ol start="2">
<li>想要放在特定节点，但是目标不符合条件，资源不足；如果要选择多种合适的目标节点？</li>
</ol>
<p>使用NodeAffinity节点亲和性设置。</p>
<ol start="3">
<li>不同节点之间，一些容器就要放一起，一些不能一起，怎么办？</li>
</ol>
<p>使用PodAffinity实现</p>
<ol start="4">
<li>有状态集群怎么调度？虽然节点看起来都一样，但是他挂载的数据是有状态的，需要顺序执行。</li>
</ol>
<p>使用statefulSet来特殊控制副本，Pod绑定具体的PV和PVC做持久化存储。</p>
<ol start="5">
<li>需要调度仅创建一个Pod副本，如系统的监控log，只需要一个？</li>
</ol>
<p>用daemonset实现。</p>
<ol start="6">
<li>批处理作业，创建多个Pod来协作，都完成后整个作业结束。也就是一批只做一次的任务的调度怎么做？</li>
</ol>
<p>使用Job来做，并延伸出了CronJob。</p>
<h5 id="deployment"><a href="#deployment" class="headerlink" title="deployment"></a>deployment</h5><p>自动部署+维持副本数量+监控副本数量<br>kind:Deployment<br>spec.replicas指定数量<br>spec.template指定pod模板，如.metadata,.spec.container等</p>
<h5 id="NodeSelector定向调度"><a href="#NodeSelector定向调度" class="headerlink" title="NodeSelector定向调度"></a>NodeSelector定向调度</h5><p>先对Node打上标签<br> kubectl label nodes <node-name> <label-key>=<label-value></p>
<p>然后在Pod定义中执行nodeselector<br>.spec.template.spec.nodeSelector: zone=north</p>
<p>会对标签对应的内容挑选一个可用Node进行调度。</p>
<h5 id="NodeAffinity-节点亲和性调度"><a href="#NodeAffinity-节点亲和性调度" class="headerlink" title="NodeAffinity:节点亲和性调度"></a>NodeAffinity:节点亲和性调度</h5><p>亲和性调度这种调度方式更具表达力。</p>
<p>使用软限制、优先采用等方式，代替硬限制。</p>
<p>节点亲和性<strong>可以依据节点上其他Pod的标签来限制</strong>，而不是非要用当前Pod来做限制，所以可以<strong>描述Pod之间的亲和或互斥关系</strong>。</p>
<p>NodeAffinity是用来替换NodeSelector的，有两种表达方式：</p>
<ol>
<li>required during scheduling ingnored during excecution</li>
</ol>
<p>必须满足规则才可以调度到节点上，相当于硬限制。</p>
<ol start="2">
<li>preferred during scheduling ingnored during excecution</li>
</ol>
<p>优先调度到满足当前规则的节点，软限制。</p>
<p>两种方式中的ingnored during excecution表示的是：</p>
<p>如果Pod所在的Node在Pod运行期间(excecution)标签发生了变更，不再符合亲和性需求，则可以忽略label变化，继续运行Pod在该节点上。</p>
<p>设置在.spec.affinity.nodeAffinity.requiredduringschedulingingnoredduringexcecution.nodeselectorterms中做一系列的matchexpressions字段匹配</p>
<p>而不是在template中配置，和template是同级的。</p>
<p>匹配规则：</p>
<p>nodeSelector+nodeAffinity，则两个都要满足</p>
<p>nodeAffinity指定多个nodeSelectorTerms，满足一个Terms就好</p>
<p>nodeSelectorTerms有多个matchExpressions，一个节点必须满足所有expression</p>
<h5 id="PodAffinity"><a href="#PodAffinity" class="headerlink" title="PodAffinity"></a>PodAffinity</h5><p>根据节点正在运行的Pod的标签而不是Node标签来做调度，要求对Node和Pod都进行匹配。</p>
<p><strong>可以描述为：如果在具有标签X(区域标签，通过topologyKey指定)的Node上运行一个或多个符合条件Y的Pod，那么Pod应该运行在这个Node上。</strong></p>
<p>设置参数和Node一样，也是2个：required during scheduling ingnored during excecution和preferred during scheduling ingnored during excecution</p>
<p>亲和性案例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 制定一个security&#x3D;SI的亲和标签，同时topologyKey&#x3D;kubernetes.io&#x2F;hostname，即Node要有这个topologyKey标签</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">	name:affinity</span><br><span class="line">spec:</span><br><span class="line">	affinity:</span><br><span class="line">		podAffinity:</span><br><span class="line">			requiredduringschedulingingnoredduringexcecution:</span><br><span class="line">			- labelSelector:</span><br><span class="line">				matchExpressions:</span><br><span class="line">				- key: security</span><br><span class="line">					operator: In</span><br><span class="line">					values:</span><br><span class="line">					- S1</span><br><span class="line">			topologyKey: kubernetes.io&#x2F;hostname</span><br></pre></td></tr></table></figure>
<p>互斥性案例(基本一样，不过是把podAffinity修改一下，改成podAntiAffinity)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 不能放在节点区域标签为hostname的节点上</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">	name:affinity</span><br><span class="line">spec:</span><br><span class="line">	affinity:</span><br><span class="line">		podAntiAffinity:</span><br><span class="line">			requiredduringschedulingingnoredduringexcecution:</span><br><span class="line">			- labelSelector:</span><br><span class="line">				matchExpressions:</span><br><span class="line">				- key: security</span><br><span class="line">					operator: In</span><br><span class="line">					values:</span><br><span class="line">					- S1</span><br><span class="line">			topologyKey: kubernetes.io&#x2F;hostname</span><br></pre></td></tr></table></figure>
<h5 id="污点-容忍"><a href="#污点-容忍" class="headerlink" title="污点+容忍"></a>污点+容忍</h5><p>Affinity是为了实现Pod调度到某些更好的节点上，Taint相反，他让Node拒绝Pod运行。</p>
<p>Taint和Toleration一起使用，让Pod避开不合适的Node。</p>
<p>怎么配合使用？</p>
<p>给Node加一个Taint属性，如果Pod上声明的Toleration可以容忍这个Taint，那么才可以在这个Node上运行。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; noSchedule表示的是效果，不进行调度，还有noExecute不执行</span><br><span class="line">kubectl taint nodes node1 key&#x3D;value:NoSchedule</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; Pod上，指的是能容忍key&#x3D;value:noSchedule的Node。</span><br><span class="line">tolerations:</span><br><span class="line">- key: &quot;key&quot;</span><br><span class="line">	operator: &quot;Equal&quot;</span><br><span class="line">	value: &quot;Equal&quot;</span><br><span class="line">	effect: &quot;NoSchedule&quot;</span><br></pre></td></tr></table></figure>
<h5 id="DaemonSet：在每个Node上都调度一个Pod"><a href="#DaemonSet：在每个Node上都调度一个Pod" class="headerlink" title="DaemonSet：在每个Node上都调度一个Pod"></a>DaemonSet：在每个Node上都调度一个Pod</h5><p>实例：日志采集程序fluentd，logstach；性能监控程序prometheus node exporter等。</p>
<p>也可以对DaemonSet进行滚动升级，在yaml中添加参数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">apiVersion</span><br><span class="line">kind: DaemonSet</span><br><span class="line">metadata</span><br><span class="line">spec:</span><br><span class="line">	updateStrategy:</span><br><span class="line">		type: RollingUpdate</span><br></pre></td></tr></table></figure>
<h5 id="Job批处理"><a href="#Job批处理" class="headerlink" title="Job批处理"></a>Job批处理</h5><p>几种模式：</p>
<ul>
<li>Job 模块 扩展 模式：</li>
</ul>
<p>一个Job对象对应一个待处理的工作，Job和工作一一对应。适合工作数少，工作要处理的内容多的场景。</p>
<ul>
<li>Queue with Pod Per Work Item</li>
</ul>
<p>采用任务队列存放工作，一个Job去完成这些工作，Job怎么完成呢？通过<strong>启动N个Pod去实现N个工作</strong>。工作-&gt;任务队列-&gt;Job单个-&gt;分出多个Pod</p>
<ul>
<li>Queue with variable Pod Count</li>
</ul>
<p>采用任务队列存放工作，一个Job去完成这些工作，Job怎么完成呢？通过<strong>启动M个Pod去实现N个工作</strong>，Pod数量不一定就和工作数量一样。工作-&gt;任务队列-&gt;Job单个-&gt;分出多个Pod</p>
<p>Job可以分为三类：</p>
<ul>
<li>没并行的Job</li>
</ul>
<p>一个Job启动一个Pod</p>
<ul>
<li>并行的Job，使用完成数计数</li>
</ul>
<p>Job启动多个Pod。</p>
<p>设定.spec.completion&gt;0，当正常结束的Pod数量达到参数时，Job结束。</p>
<p>设定.spec.parallelism控制并行度，即同时启动多少个Pod来处理工作。</p>
<ul>
<li>并行Job，使用任务队列</li>
</ul>
<p>额外设置一个任务队列，存放工作</p>
<h6 id="CronJob-定时任务"><a href="#CronJob-定时任务" class="headerlink" title="CronJob 定时任务"></a>CronJob 定时任务</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">apiVersion:</span><br><span class="line">kind: CronJob</span><br><span class="line">metadata:</span><br><span class="line">spec:</span><br><span class="line">	schedule: &quot;*&#x2F;1 * * * *&quot; &#x2F;&#x2F;表示每隔1分钟触发任务， a&#x2F;b的含义是第一次触发在a，隔b再触发。</span><br><span class="line">	jobTemplate:</span><br><span class="line">		spec:</span><br></pre></td></tr></table></figure>
<p>至此，所有的Pod调度器都解释清楚了。</p>
<h4 id="初始化容器-init-container"><a href="#初始化容器-init-container" class="headerlink" title="初始化容器 init container"></a>初始化容器 init container</h4><p>初始化容器这个容器的存在是为了什么？</p>
<p>是为了在启动应用容器之前启动多个初始化容器，把应用的预置条件配置好。<strong>初始化容器不一样的地方在于他只运行一次</strong>。</p>
<p>初始化容器和应用容器的不同：</p>
<ol>
<li>执行顺序，初始化早于应用容器，所有初始化容器的执行也有顺序</li>
<li>都有资源限制配置，但是初始化容器会选所有初始化容器中的配额最大值</li>
<li>初始化容器不能设置readinessProbe探针，因为成功运行后才能运行普通容器</li>
</ol>
<p>Pod重启后，初始化容器会重启，Pod重启在这几个场景：</p>
<ol>
<li>初始化容器的image更新，初始化容器会重启，从而Pod重启。而普通容器的image更新不会重启Pod，只会重启应用容器。</li>
<li>Pod的infrastructure容器(也就是pause容器)更新，Pod会重启</li>
<li>Pod中所有应用容器终止，并且重启策略=always，Pod重启</li>
</ol>
<h4 id="重要-Pod升级和回滚-版本控制"><a href="#重要-Pod升级和回滚-版本控制" class="headerlink" title="重要!!!Pod升级和回滚(版本控制)"></a>重要!!!Pod升级和回滚(版本控制)</h4><p>更新服务时需要停止所有服务相关Pod，如果集群过大，这个过程会很复杂，时间长+可能出错。会导致长期的服务不可用，所以才引出了滚动升级功能。</p>
<p>如果是Deployment创建的Pod，可以通过修改dep.yaml中的内容，然后apply，那么就会进行自动更新，如果错误，可以回滚到旧版本。</p>
<p>可以通过</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl rollout status deployment&#x2F;depname</span><br></pre></td></tr></table></figure>
<p>查看对应内容的deployment的更新过程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe deployment&#x2F;depname</span><br></pre></td></tr></table></figure>
<p>查看详细事件信息</p>
<p>整个deployment的更新流程？</p>
<p>创建一个RS-&gt;根据需求创建副本-&gt;收到更新命令-&gt;创建新的RS，数量=1-&gt;就的RS缩到2-&gt;new RS=2,old RS=1-&gt;new RS=3,old RS=0-&gt;完成</p>
<p>上面说的是直接修改deployment来应用，更新策略其实可以在yaml中的spec.strategy设置</p>
<ul>
<li>Recreate</li>
</ul>
<p>spec.strategy.type = Recreate，表示更新时，先杀掉所有Pod，然后创建新的</p>
<ul>
<li>RollingUpdate</li>
</ul>
<p>spec.strategy.type = RollingUpdate，滚动更新。</p>
<p>spec.strategy.RollingUpdate.maxUnavailable: 指定更新时不可用状态Pod的数量上限</p>
<p>spec.strategy.RollingUpdate.maxSurge:指定Pod总数可超过期望副本数的最大值</p>
<p><strong>deployment的回滚</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 查看deployment历史</span><br><span class="line">kubectl rollout history deployment&#x2F;depname</span><br><span class="line">&#x2F;&#x2F; 得到历史列表</span><br><span class="line">REVISION   CHANGE-CAUSE</span><br><span class="line">1			操作代码1</span><br><span class="line">2			操作代码2</span><br><span class="line">3			操作代码3</span><br><span class="line">&#x2F;&#x2F; 回滚</span><br><span class="line">kubectl rollout undo deployment&#x2F;depname --to-revision&#x3D;2</span><br></pre></td></tr></table></figure>
<p>DaemonSet的更新策略：</p>
<ul>
<li>OnDelete</li>
</ul>
<p>默认升级策略。创建好新的配置后，只有用户手动删除旧版本Pod，才触发新建操作。</p>
<ul>
<li>RollingUpdate</li>
</ul>
<p>旧版本自动被杀掉，然后创建新的。</p>
<p>但是两个不同：1.不支持查看DS的更新记录2.回滚不能直接通过kubectl rollback指令执行(因为看不了更新记录)，只能重新提交旧版本apply</p>
<p>StatefulSet的更新策略：</p>
<p>也逐渐支持OnDelete、RollingUpdate、partition策略，能保留更新历史，可直接回滚历史版本。</p>
<h4 id="Pod扩缩容-副本控制"><a href="#Pod扩缩容-副本控制" class="headerlink" title="Pod扩缩容(副本控制)"></a>Pod扩缩容(副本控制)</h4><p>手动修改deployment的spec.relicas指标</p>
<p>或者使用自动扩容机制(注意HPA的探测周期可调)</p>
<p>早期的自动扩缩容数据来源于Heapster，heapster可以理解为一个数据收集器，他收集Node上的cadvisor数据。</p>
<p>HPA工作原理：</p>
<p>Metrics Server持续采集所有Pod副本的指标数据-&gt;HPA持续获取MS的API上提供的数据信息-&gt;HPA根据用户定义的扩缩容规则计算目标副本数-&gt;数目不同时进行扩缩容。</p>
<ul>
<li>指标类型</li>
</ul>
<p>指标由Master的kube-controller-manager服务持续监测，包含Pod资源利用率+Pod自定义指标+Object自定义指标或外部指标</p>
<ul>
<li>扩缩容算法</li>
</ul>
<p>目标副本数 = 当前副本数 × （当前指标值 / 期望指标值），往上取整。</p>
<p>当目标与1十分接近，可以设置一个容忍度0.1，在结果的-0.1~+0.1之间都不进行扩缩容。</p>
<p>HPA排除了部分Pod的指标，不计入运算：</p>
<p>正在删除的/指标无法获得的/刚启动没到特定时间的/还没ready的</p>
<p>此外还加入了平滑，系统会记录一段时间里最好的副本选择，从而避免短时抖动。</p>
<ul>
<li>yaml指定<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">apiVersion:autoscaling&#x2F;v1</span><br><span class="line">kind:HorizontalPodAutoscaler</span><br><span class="line">matadata:</span><br><span class="line">spec:</span><br><span class="line">	scaleTargetRef:</span><br><span class="line">		apiVersion:</span><br><span class="line">		kind:deployment</span><br><span class="line">		name</span><br><span class="line">	minReplicas:</span><br><span class="line">	maxReplicas:</span><br><span class="line">	targetCPUUtilizationPercentage:</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">apiVersion:autoscaling&#x2F;v2beta2</span><br><span class="line">kind:HorizontalPodAutoscaler</span><br><span class="line">matadata:</span><br><span class="line">spec:</span><br><span class="line">	scaleTargetRef:</span><br><span class="line">		apiVersion:</span><br><span class="line">		kind:deployment</span><br><span class="line">		name</span><br><span class="line">	minReplicas:</span><br><span class="line">	maxReplicas:</span><br><span class="line">	metrics:</span><br><span class="line">	- type: Resource</span><br><span class="line">		resource:</span><br><span class="line">			name: cpu</span><br><span class="line">			target:</span><br><span class="line">				type: Utilization</span><br><span class="line">				averageUtilization: 50</span><br><span class="line">	- type: Pods</span><br><span class="line">		pods:</span><br><span class="line">			metric:</span><br><span class="line">				name:packets-per-second</span><br><span class="line">			targetAverageValue: 1k</span><br></pre></td></tr></table></figure></li>
<li>自定义HPA</li>
</ul>
<p>预先部署自定义的Metrics server，可以用prometheus、Azure的Adapter自定义实现。</p>
<p>架构图实际上就是答辩ppt里的多色图：Prometheus-&gt;custom metrics server-&gt;metrics aggregator-&gt;API server-&gt;HPA-&gt;Deployment-&gt;Pod调整</p>
<h3 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h3><p>为一组有相同功能的容器应用提供统一的入口地址，把请求分发到后端的应用上。</p>
<p>主要是通过selector把相应的deployment等内容选中组合在一个入口。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;必须存在的字段</span><br><span class="line">apiVersion:</span><br><span class="line">kind:Service</span><br><span class="line">metadata:</span><br><span class="line">	name:</span><br><span class="line">	namespace:</span><br><span class="line">spec:</span><br><span class="line">	selector:[]</span><br><span class="line">	type:</span><br><span class="line">	cluster IP:</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>一开始是直接通过containerPort设置提供服务的容器端口，但是存在问题。</p>
<p>在deployment的spec.template.spec.container.ports.- containerPort直接设定</p>
<p>这样可以通过kubectl get pod -l app=webapp -o yaml | grep podIP查看Pod的IP地址和端口号。</p>
<p>问题：1.Pod所在的IP地址是不可靠的，如果Pod所在的Node发生故障，Pod的IP地址会发生变化。2.如果容器本身是分布式的，有多个实例，那么服务访问就有问题，多个端口，还需要前端设置一个负载均衡器做请求分发。</p>
<p>这个负载均衡器实际上就是Service。</p>
<p>Service的IP的和端口确定后，内部访问这个Service就直接通过cluster IP:port来进行。对这个端口的访问就直接转发到后端的两个容器上。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">apiVersion:</span><br><span class="line">kind:Service</span><br><span class="line">metadata:</span><br><span class="line">spec:</span><br><span class="line">	ports:</span><br><span class="line">	- port: 8081&#x2F;&#x2F;访问service时的外部端口号</span><br><span class="line">	  targetPort:8080&#x2F;&#x2F;绑定的容器的暴露的服务端口号</span><br><span class="line">	selector:</span><br><span class="line">	  app: webapp&#x2F;&#x2F;指定后端的容器</span><br></pre></td></tr></table></figure>
<p>所以service的yaml主要做的就是绑定selector对应的容器的对应端口号，然后把这个端口号绑定在自己的外部端口号上。</p>
<p>有了Service这个负载均衡器，然后怎么进行负载分发呢？</p>
<ol>
<li><p>轮询模式(默认)： 把请求转发到各个绑定的Pod</p>
</li>
<li><p>基于客户端IP的会话保持模式：第一次时把某客户端发起的请求转发到后端某个Pod上，之后从相同客户端发起的都转发到这个Pod上。所以取决于第一次的绑定。可以通过sessionAffinity来绑定亲和哪个Pod的clusterIP</p>
</li>
</ol>
<ul>
<li> Service多端口</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">spec:</span><br><span class="line">	ports:</span><br><span class="line">	- name:</span><br><span class="line">	  port:</span><br><span class="line">	  protocol:</span><br><span class="line">	- name:</span><br><span class="line">	  port:</span><br><span class="line">	  protocol:</span><br></pre></td></tr></table></figure>
<h4 id="外部访问Pod或Service"><a href="#外部访问Pod或Service" class="headerlink" title="外部访问Pod或Service"></a>外部访问Pod或Service</h4><p>在Pod的yaml中指定spec.template.containers.ports.hostPort</p>
<p>不常用，多副本时会冲突。</p>
<h4 id="Service端口映射到物理机"><a href="#Service端口映射到物理机" class="headerlink" title="Service端口映射到物理机"></a>Service端口映射到物理机</h4><p>设置Service的spec.ports.nodePort，默认在30000~32767之间选一个。</p>
<p>对应的防火墙上也要设置到权限，使得外部能访问。才能用物理机IP:nodePort进行访问。</p>
<h3 id="DNS服务"><a href="#DNS服务" class="headerlink" title="DNS服务"></a>DNS服务</h3><p>集群内是通过ClusterIP进行访问的，这个对应的映射关系由集群内的DNS服务提供。目前采用的是CoreDNS。</p>
<h3 id="Ingress-重要-服务发现和负载均衡"><a href="#Ingress-重要-服务发现和负载均衡" class="headerlink" title="Ingress(重要,服务发现和负载均衡)"></a>Ingress(重要,服务发现和负载均衡)</h3><p>Service暴露端口有个问题，如果Service很多，那么要开放很多端口，怎么管理？</p>
<p>引入Ingress，定义一个Ingress策略+Ingress Controller(相当于边缘路由器)就好了。</p>
<ol>
<li>部署ingress Controller</li>
</ol>
<p>实现逻辑：监听API Server，获取全部Ingress策略的定义-&gt;基于定义，生成nginx配置文件-&gt;加载配置文件，建立关联关系</p>
<ol start="2">
<li>定义ingress策略</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 这里定义一个从website.com&#x2F;demo的域名到webapp的service的8080&#x2F;demo端口的映射</span><br><span class="line">apiVersion:</span><br><span class="line">kind:Ingress</span><br><span class="line">matadata:</span><br><span class="line">spec:</span><br><span class="line">	rules:</span><br><span class="line">	- host: website.com</span><br><span class="line">	http:</span><br><span class="line">		paths:</span><br><span class="line">		- path: &#x2F;demo</span><br><span class="line">		  backend:</span><br><span class="line">		    serviceName: webapp</span><br><span class="line">			servicePort: 8080</span><br></pre></td></tr></table></figure>

<h1 id="Serverless框架-————-相关概念"><a href="#Serverless框架-————-相关概念" class="headerlink" title="Serverless框架 ———— 相关概念"></a>Serverless框架 ———— 相关概念</h1><p>Serverless是的核心思想是<strong>用户无须关注支撑应用服务运行的底层主机</strong>。</p>
<p>用户无须关心软件应用运行涉及的底层服务器的状态、资源（比如CPU、内存、磁盘及网络）及数量。软件应用正常运行所需要的计算资源由底层的云计算平台动态提供。</p>
<p>在Serverless架构下，当用户完成应用开发后，软件应用将被部署到指定的运行环境，这个运行环境不再是具体的一台或多台服务器，而是支持Serverless的云计算平台。</p>
<p>有客户端请求到达或特定事件发生时，云计算平台负责将应用部署到某台Serverless云计算平台的主机中。</p>
<p>Serverless云计算平台保证该主机提供应用正常运行所需的计算资源。</p>
<p>在访问量升高时，云计算平台动态地增加应用的部署实例。当应用空闲一段时间后，云计算平台自动将应用从主机中卸载，并回收资源。</p>
<p>用户之所以不用再关注服务器是因为底层的云计算平台完成了大量的自动化工作。</p>
<h2 id="FaaS与BaaS"><a href="#FaaS与BaaS" class="headerlink" title="FaaS与BaaS"></a>FaaS与BaaS</h2><p>目前业界的各类Serverless实现按功能而言，主要为应用服务提供了两个方面的支持：函数即服务（Function as a Service，FaaS）以及后台即服务（Backend as a Service，BaaS）。</p>
<ul>
<li>FaaS</li>
</ul>
<p>FaaS提供了一个计算平台，在这个平台上，应用以一个或多个函数的形式开发、运行和管理等。</p>
<p>FaaS可以根据实际的访问量进行应用的自动化动态加载和资源的自动化动态分配。大多数FaaS平台可以根据预定义的事件触发指定的函数应用逻辑。</p>
<p>FaaS是目前Serverless架构实现的一个重要手段。FaaS平台的特点在很大程度上影响了目前Serverless应用的架构和实现方式，FaaS平台是一个完整的Serverless实现的重要组成部分，仅仅通过FaaS平台并不能完全实现Serverless架构的落地。</p>
<p>FaaS为应用的开发、运行和管理提供良好的Serverless基础。但是对应用整体系统而言，并没有完全实现Serverless化。因此，在实现应用架构Serverless化时，也应该实现应用所依赖的服务的Serverless化。</p>
<ul>
<li>BaaS</li>
</ul>
<p>为了实现应用后台服务的Serverless化，BaaS（后台即服务）也应该被纳入一个完整的Serverless实现的范畴内。</p>
<p>BaaS涵盖的范围很广泛，包含任何应用所依赖的服务。AWS的DynamoDB数据库就是DBaaS的一个例子。用户按需申请使用数据库服务，而无须关注数据库的运维和缩扩容。数据库的运维完全由服务提供方AWS负责。</p>
<p>要实现完整的Serverless架构，用户必须结合FaaS和BaaS的功能，使得应用整体的系统架构实现Serverless化，最大化地实现Serverless架构所承诺带来的价值。</p>
<p>因此，一个完整的Serverless实现，必须同时提供FaaS和BaaS两个方面的功能。</p>
<h2 id="Serverless架构下的应用与传统架构下的应用的异同"><a href="#Serverless架构下的应用与传统架构下的应用的异同" class="headerlink" title="Serverless架构下的应用与传统架构下的应用的异同"></a>Serverless架构下的应用与传统架构下的应用的异同</h2><ul>
<li><p>传统架构</p>
<div align="center"> <img src="https://github.com/Liccol/Liccol.github.io/blob/master/img/kubernetes-1.webp" width=""> </div><br>
</li>
<li><p>Serverless应用架构</p>
<div align="center"> <img src="https://upload-images.jianshu.io/upload_images/3342415-54878079b8c5750b.jpg?imageMogr2/auto-orient/strip|imageView2/2/w/1200/format/webp" width=""> </div><br>

</li>
</ul>
<p>Serverless架构下的应用架构图。这个应用实现的功能和前文的应用一样，即为用户提供订单的增删查改服务。应用被部署在Serverless平台之上。应用的功能点变成若干个函数定义，部署于FaaS中。</p>
<ul>
<li>两种架构的比较</li>
</ul>
<p>传统架构的应用部署在主机之上，而Serverless架构的应用部署于Serverless平台之上，由Serverless平台提供运行所需的计算资源传统架构的应用里，所有的逻辑都集中在同一个部署交付件中。</p>
<p>Serverless应用的逻辑层部署运行在Serverless平台的FaaS服务之上。因此，应用的逻辑被打散成多个独立的细颗粒度的函数逻辑。</p>
<p>因为业务逻辑运行在FaaS服务之上，所以相关的业务逻辑拥有事件驱动、资源自动弹性扩展、高可用等特性。</p>
<p>用户也无须运维业务逻辑所消耗的计算资源，Serverless架构的应用所依赖的数据库从具体的特定数据库实例，变成了数据库服务。用户无须关注数据库所消耗的计算资源的运维。</p>
<p>在Serverless架构下，由于应用的逻辑分散成了若干个函数，推荐通过API网关对这些函数逻辑进行统一的管控（如流量控制、安全管控、版本管理等）。</p>
<p>在完备的Serverless平台上，API网关也会作为一种用户可以快速消费的服务而存在。在Serverless架构下，具体的主机资源不再是用户关注的对象，不存于应用架构图中。取而代之的是Serverless平台及其子服务，如FaaS和各类BaaS服务。</p>
<h2 id="Serveless技术特点"><a href="#Serveless技术特点" class="headerlink" title="Serveless技术特点"></a>Serveless技术特点</h2><ul>
<li>按需加载</li>
</ul>
<p>在Serverless架构下，应用的加载（load）和卸载（unload）由Serverless云计算平台控制。这意味着应用不总是一直在线的。只有当有请求到达或者有事件发生时才会被部署和启动。</p>
<ul>
<li>事件驱动</li>
</ul>
<p>Serverless架构的应用并不总是一直在线，而是按需加载执行。</p>
<p>通过将不同事件来源（Event Source）的事件（Event）与特定的函数进行关联，实现对不同事件采取不同的反应动作，这样可以非常容易地实现事件驱动（Event Driven）架构。</p>
<ul>
<li>状态非本地持久化</li>
</ul>
<p>应用不再与特定的服务器关联。因此应用的状态不能，也不会保存在其运行的服务器之上，</p>
<ul>
<li>非会话保持</li>
</ul>
<p>应用不再与特定的服务器关联。每次处理请求的应用实例可能是相同服务器上的应用实例，也可能是新生成的服务器上的应用实例。因此，Serverless架构更适合无状态的应用。</p>
<ul>
<li>自动弹性伸缩</li>
</ul>
<p>Serverless应用原生可以支持高可用，可以应对突发的高访问量。应用实例数量根据实际的访问量由云计算平台进行弹性的自动扩展或收缩，云</p>
<ul>
<li>应用函数化</li>
</ul>
<p>Serverless架构下的应用会被函数化，但不能说Serverless就是Function as a Service（FaaS）。</p>
<ul>
<li>依赖服务化</li>
</ul>
<p>在Server-less架构下的应用的依赖应该服务化和无服务器化，也就是实现BaaS。</p>
<p>所有应用依赖的服务都是一个个Backend Service，应用通过BaaS方便获取，而无须关心底层细节。</p>
<p>和FaaS一样，BaaS是Serverless架构实现的另一个重要组件。</p>
<h2 id="缺陷"><a href="#缺陷" class="headerlink" title="缺陷"></a>缺陷</h2><ul>
<li>控制力</li>
</ul>
<p>对于一些希望掌控底层计算资源的应用场景，并不是最合适的选择。</p>
<ul>
<li>可移植性</li>
</ul>
<p>Serverless应用的实现在很大程度上依赖于Serverless平台及该平台上的FaaS和BaaS服务。不同IT厂商的Serverless平台和解决方案的具体实现并不相同。</p>
<ul>
<li>安全性</li>
</ul>
<p>Serverless架构下，用户不能直接控制应用实际所运行的主机。在运行时可能共用底层的主机资源。对于一些安全性要求较高的应用，这将带来潜在的安全风险</p>
<ul>
<li>性能</li>
</ul>
<p>应用的首次加载及重新加载的过程将产生一定的延时。对于一些对延时敏感的应用，需要通过预先加载或延长空闲超时时间等手段进行处理。</p>
<ul>
<li>执行时长</li>
</ul>
<p>大部分Serverless平台对FaaS函数的执行时长存在限制。因此Serverless应用<strong>更适合一些执行时长较短的作业</strong>。</p>
<ul>
<li>技术成熟度</li>
</ul>
<p>目前Serverless相关平台、工具和框架还处在一个不断变化和演进的阶段，开发和调试的用户体验还需要进一步提升。Serverless相关的文档和资料相对比较少，深入了解Serverless架构的架构师、开发人员和运维人员也相对较少</p>
<h2 id="相关技术"><a href="#相关技术" class="headerlink" title="相关技术"></a>相关技术</h2><p>按所管控的计算资源的范围来划分，云计算模式可以分为基础架构即服务（Infrastructure as a Service）、平台即服务（Platform as a Service，PaaS）以及软件即服务（Software as a Service，SaaS）。</p>
<h3 id="IaaS、PaaS与SaaS"><a href="#IaaS、PaaS与SaaS" class="headerlink" title="IaaS、PaaS与SaaS"></a>IaaS、PaaS与SaaS</h3><ul>
<li>IaaS(购买云存储服务器)</li>
</ul>
<p>应用架构底层的网络、存储和计算资源（主机、物理机或虚拟机），由云平台供应商提供和运维。</p>
<p>用户在云平台上付费申请所需的网络、存储和计算资源，云平台供应商在一定时间内提供。</p>
<ul>
<li>PaaS(为服务器配置好OS等，可以直接在上面开发软件)</li>
</ul>
<p>提供了应用的运行环境（如应用运行时）、应用依赖的服务（如数据库、中间件、负载均衡、构建服务、发布服务）以及底层所需的计算资源，用户可以把精力集中在应用的开发和创新上。</p>
<ul>
<li>SaaS(购买云上的服务，如搭好的网页、软件等)</li>
</ul>
<p>用户完全不用管理任何应用和基础设施，从而变成云服务的消费者，直接消费已经准备好的应用。</p>
<h3 id="Serverless与容器"><a href="#Serverless与容器" class="headerlink" title="Serverless与容器"></a>Serverless与容器</h3><p>容器架构中最小的运行单元是容器，而Serverless中则是函数。</p>
<p>容器应用一般是预先部署，然后持续在线。这看起来和Serverless不大一样，因为FaaS是按需加载和执行的。</p>
<p>而在Serverless架构中，应用是按需加载和执行的。这意味着理论上Serverless的资源使用效率更高。</p>
<p>但其实是可以的，虽然目前容器内一般运行的是一个完整的应用，但是将容器内运行的对象变成函数显然无困难。</p>
<p>Kubernetes上默认没有事件触发的支持，无法做到按需部署容器应用。</p>
<p>但是通过Kubernetes叠加上一些FaaS框架运行包含函数逻辑的容器，用户很容易使Kubernetes具备FaaS服务的能力。</p>
<p>所以也就是说，可以通过Kubernetes+事件触发容器来实现Serverless的功能。</p>
<h3 id="Serverless技术基础————-FaaS"><a href="#Serverless技术基础————-FaaS" class="headerlink" title="Serverless技术基础———— FaaS"></a>Serverless技术基础———— FaaS</h3><p>每一个函数完成一个相对简单的业务逻辑，一个完整的应用由若干个函数组成。因为FaaS和Serverless的关系密切，因此FaaS的特点同时也是Serverless平台的特点：</p>
<ul>
<li>抽象了底层计算资源</li>
<li>按使用量付费</li>
<li>自动弹性扩展</li>
<li>事件驱动</li>
</ul>
<p>宏观来看，一个FaaS平台的架构中包含如下主要组件：</p>
<ul>
<li>函数定义（Function Definition）：一个函数实现一个业务逻辑</li>
<li>函数实例（Function Instance）：在运行状态的应用函数的实例</li>
<li>控制器（Controller）：负责应用函数的加载、执行等流程的管理</li>
<li>事件（Event）：事件驱动架构中的事件</li>
<li>事件源（Event Source）：事件驱动架构中的事件来源。可以是一个数据库中插入了新的记录，也可以是一个目录里删除了一个文件，或者是消息队列收到了新的消息</li>
<li>触发规则（Trigger Rule）：定义事件与函数的关系及触发的规则</li>
<li>平台服务（Platform Service）：支撑应用运行的各类底层服务，如计算资源、数据存储等</li>
</ul>
<p>函数的生命周期：在FaaS上一个函数从创建到执行的生命周期</p>
<ul>
<li>用户根据所选定的FaaS平台的规范进行函数应用的开发。</li>
<li>编写好的函数将上传至FaaS平台。平台将负责编译和构建这些函数，并将构建的输出保存。</li>
<li>用户设置函数被触发的规则，将事件源与特定版本的函数进行关联。</li>
<li>当事件到达且满足触发规则时，平台将会部署、编译构建后的函数并执行。平台将监控函数执行的状态，根据请求量的大小，平台负责对函数实例进行扩容和缩容</li>
</ul>
<p>函数工作流</p>
<p>当涉及多个函数执行时，就需要有逻辑处理执行的顺序、错误重试、异常捕获以及状态传递等细节。</p>
<p>一些FaaS实现开始提供针对FaaS函数的流程编排服务或工具，以简化FaaS应用的流程编排，如AWS Step Functions和Fission Workflows。</p>
<h3 id="BaaS"><a href="#BaaS" class="headerlink" title="BaaS"></a>BaaS</h3><p>BaaS的价值</p>
<p>后端即服务（Backend as a Service，BaaS）</p>
<p>通过BaaS平台，用户的应用程序可以对接后端的各种服务，省去了用户学习各种技术和中间件的成本，降低了应用开发的复杂度。BaaS的服务往往由服务供应商提供，用户无须关心底层细节，无须维护相关资源</p>
<h1 id="Serverless-产品-————-kubeless"><a href="#Serverless-产品-————-kubeless" class="headerlink" title="Serverless 产品 ———— kubeless"></a>Serverless 产品 ———— kubeless</h1><p>主要讲一下k8s的serverless产品——kubeless。</p>
<p>kubeless 是 kubernetes native 的无服务计算框架，它可以让用户在 kubernetes 之上使用 FaaS 构建高级应用程序。</p>
<p>Kubless 有三个核心概念：</p>
<ul>
<li><strong>Functions</strong>：需要被执行的用户代码，同时包含运行时依赖、构建指令等信息；</li>
<li><strong>Triggers</strong>：和函数关联的事件源(通过设置trigger快速触发后台函数运行)。如果把事件源比作生产者，函数比作执行者，那么触发器就是联系两者的桥梁；</li>
<li><strong>Runtime</strong>：代表函数运行时所依赖的环境。</li>
</ul>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>介绍是怎么做到产品提供的基本功能的：</p>
<ul>
<li>敏捷构建：基于用户提交的源码迅速构建可执行的函数，简化部署流程；</li>
<li>灵活触发：基于各类事件触发函数的执行，方便快捷地集成新的事件源；</li>
<li>自动伸缩：根据业务需求，自动完成扩容缩容，无须人工干预。</li>
</ul>
<h3 id="敏捷构建"><a href="#敏捷构建" class="headerlink" title="敏捷构建"></a>敏捷构建</h3><div align="center"> <img src="https://cdn.nlark.com/lark/0/2018/png/86722/1543736647858-7fe371aa-2f30-4e4b-bdb7-d90007aae53a.png" width=""> </div><br>

<p>函数生命周期的定义如图。</p>
<p>用户只需提供源码和函数说明，构建部署等工作通常由 serverless 平台完成。 因此，基于用户提交的源码迅速构建可执行函数是 serverless 产品必须具备的基础能力。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubeless function deploy hello --runtime python2.7 \</span><br><span class="line">                                --from-file test.py \</span><br><span class="line">                                --handler test.hello</span><br></pre></td></tr></table></figure>
<p>配置时的参数为：</p>
<p>hello：将要部署的函数名称；</p>
<p>–runtime python2.7： 指定使用 python 2.7 作为运行环境。</p>
<p>–from-file test.py：指定函数源码文件（支持 zip 格式）。</p>
<p>–handler test.hello：指定使用 test.py 中的 hello 方法处理请求。(参考对象.方法的写法)</p>
<h4 id="函数资源与K8s-Operator"><a href="#函数资源与K8s-Operator" class="headerlink" title="函数资源与K8s Operator"></a>函数资源与K8s Operator</h4><p>Kubeless 函数是一个自定义 K8s 对象，本质上是 k8s operator。k8s operator 原理如下图所示：</p>
<div align="center"> <img src="https://cdn.nlark.com/lark/0/2018/png/86722/1543562354219-9e3e57ca-5d59-48f0-b228-487eda4fdf35.png" width=""> </div><br>

<p>以 kubeless 函数为例，描述 K8s operator 的一般工作流程：</p>
<ol>
<li><p>使用 k8s 的 CustomResourceDefinition(CRD) 定义资源，这里创建了一个名为functions.kubeless.io的 CRD 来代表 kubeless 函数；</p>
</li>
<li><p>创建一个 controller 监听自定义资源的 ADD、UPDATE、DELETE 事件并绑定 hander。这里创建了一个名为function-controller的 CRD controller，该 controller 会监听针对 function 的 ADD、UPDATE、DELETE 事件，并绑定三种 handler（参阅 AddEventHandler）；</p>
</li>
<li><p>用户执行创建、更新、删除自定义资源的命令；</p>
</li>
<li><p>Controller 根据监听到的事件调用相应的 handler。</p>
</li>
</ol>
<h4 id="函数构成"><a href="#函数构成" class="headerlink" title="函数构成"></a>函数构成</h4><p>Kubeless 的 function-controller监听到针对 function 的 ADD 事件后，会触发相应 handler 创建函数。一个函数由若干 K8s 对象组成，包括 ConfigMap、Service、Deployment、Pod 等，其结构如下图所示：</p>
<div align="center"> <img src="https://cdn.nlark.com/lark/0/2018/png/86722/1543592884194-d679c8cf-c8cf-4ce0-8124-7a574e7d7ae7.png" width=""> </div><br>

<p>这个构造的过程应该是去构建相应的各个yaml文件。<br>ocnfigmap:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  handler: test.hello</span><br><span class="line">  # 函数依赖的第三方 python 库</span><br><span class="line">  requirements.txt: |</span><br><span class="line">    kubernetes&#x3D;&#x3D;2.0.0</span><br><span class="line">  # 函数源码</span><br><span class="line">  test.py: |</span><br><span class="line">    def hello(event, context):</span><br><span class="line">      print event</span><br><span class="line">      return event[&#39;data&#39;]</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    created-by: kubeless</span><br><span class="line">    function: hello</span><br><span class="line">  # 该 ConfigMap 名称</span><br><span class="line">  name: hello</span><br><span class="line">  namespace: default</span><br></pre></td></tr></table></figure>
<p>Service指定函数访问方式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    created-by: kubeless</span><br><span class="line">    function: hello</span><br><span class="line">  # 该 Service 名称</span><br><span class="line">  name: hello</span><br><span class="line">  namespace: default</span><br><span class="line">  ...</span><br><span class="line">spec:</span><br><span class="line">  clusterIP: 10.109.2.217</span><br><span class="line">  ports:</span><br><span class="line">  - name: http-function-port</span><br><span class="line">    port: 8080</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 8080</span><br><span class="line">  # 选择对应函数</span><br><span class="line">  selector:</span><br><span class="line">    created-by: kubeless</span><br><span class="line">    function: hello</span><br><span class="line">  # Service 类型</span><br><span class="line">  type: ClusterIP</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>Deployment 用于编排执行函数逻辑的 Pods，通过它可以描述函数期望的个数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    created-by: kubeless</span><br><span class="line">    function: hello</span><br><span class="line">  name: hello</span><br><span class="line">  namespace: default</span><br><span class="line">  ...</span><br><span class="line">spec:</span><br><span class="line">  # 指定函数期望的个数</span><br><span class="line">  replicas: 1</span><br></pre></td></tr></table></figure>
<p>Pod 是真正执行函数逻辑的容器。</p>
<p>Pod 中的 volumes 段指定了该函数的 ConfigMap。</p>
<p>这会将 ConfigMap 中的源码和依赖添加到 volumeMounts.mountPath 指定的目录里面。从容器视角来看，文件路径为/src/test.py和 /src/requirements。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">  volumeMounts:</span><br><span class="line">  - mountPath: &#x2F;kubeless</span><br><span class="line">    name: hello</span><br><span class="line">  - mountPath: &#x2F;src</span><br><span class="line">    name: hello-deps</span><br><span class="line">volumes:</span><br><span class="line">- emptyDir: &#123;&#125;</span><br><span class="line">  name: hello</span><br><span class="line">- configMap:</span><br><span class="line">    defaultMode: 420</span><br><span class="line">    name: hello</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>Init Container</p>
<p>Pod 中的 Init Container 主要作用如下：</p>
<ul>
<li>将源码和依赖文件拷贝到指定目录；</li>
<li>安装第三方依赖。</li>
</ul>
<p>Func Container</p>
<p>Pod 中的 Func Container 会加载 Init Container 准备好的源码和依赖并执行函数。</p>
<p>不同 runtime 加载代码的方式大同小异。主要流程都是解析api获得的json内容，分配给制定好的字段，然后启动。</p>
<h4 id="灵活触发-trigger的多种触发方式"><a href="#灵活触发-trigger的多种触发方式" class="headerlink" title="灵活触发(trigger的多种触发方式)"></a>灵活触发(trigger的多种触发方式)</h4><p>函数的触发方式分成了如下图所示的几种类别。</p>
<div align="center"> <img src="https://cdn.nlark.com/lark/0/2018/png/86722/1543734315398-14f58052-43b3-45ab-a9b6-5742e6914576.png" width=""> </div><br>
<div align="center"> <img src="https://cdn.nlark.com/lark/0/2018/png/86722/1543390616914-71b0b63f-7c2f-43e8-a7b5-b1aee9d9fb06.png" width=""> </div><br>

<p>触发方式|类别<br>kubeless CLI|Synchronous Req/Rep<br>Http Trigger|Synchronous Req/Rep<br>Cronjob Trigger|Job (Master/Worker)<br>Kafka Trigger|Async Message Queue<br>Nats Trigger|Async Message Queue<br>Kinesis Trigger|Message Stream</p>
<h5 id="HTTP-trigger"><a href="#HTTP-trigger" class="headerlink" title="HTTP trigger"></a>HTTP trigger</h5><p>Kubeless 利用 K8s ingress 机制实现了 http trigger。</p>
<p>Kubeless 创建了一个名为httptriggers.kubeless.io的 CRD 来代表 http trigger 对象。</p>
<p>同时，kubeless 包含一个名为http-trigger-controller的 CRD controller，它会持续监听针对 http trigger 和 function 的 ADD、UPDATE、DELETE 事件，并执行对应的操作。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  # 该 Ingress 的名字，即创建 http trigger 时指定的 name</span><br><span class="line">  name: http-hello</span><br><span class="line">  ...</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: example.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - backend:</span><br><span class="line">          # 指向 kubeless 为函数 hello 创建的 ClusterIP 类型的 Service</span><br><span class="line">          serviceName: hello</span><br><span class="line">          servicePort: 8080</span><br><span class="line">        path: &#x2F;echo</span><br></pre></td></tr></table></figure>
<p>Ingress 只是用于描述路由规则，要让规则生效、实现请求转发，集群中需要有一个正在运行的 ingress controller。可供选择的 ingress controller 有 Contour、F5 BIG-IP Controller for Kubernetes、Kong Ingress Controllerfor Kubernetes、NGINX Ingress Controller for Kubernetes、Traefik 等。</p>
<p>这种路由规则描述和路由功能实现相分离的思想很好地提现了 K8s 始终坚持的需求和供给分离的设计理念。</p>
<p>上文中的命令在创建 trigger 时指定了 nginx 作为 gateway，因此需要部署一个 nginx-ingress-controller。该 controller 的基本工作原理如下：</p>
<ul>
<li>以 pod 的形式运行在独立的命名空间中；</li>
<li>以 hostPort 的形式暴露出来供外界访问；</li>
<li>内部运行着一个 nginx 实例；</li>
<li>监听和 ingress、service 等资源相关的事件。如果发现这些事件最终会影响到路由规则，ingress controller 会采用向 Lua hander 发送新的 endpoints 列表或者直接修改 nginx.conf 并 reload nginx 等手段达到更新路由规则的目的。</li>
</ul>
<p>完成上述工作后，我们便可以通过发送 HTTP 请求触发函数 hello 的执行：</p>
<ul>
<li>HTTP 请求首先会由 nginx-ingress-controller 中的 nginx 处理；</li>
<li>Nginx 根据 nginx.conf 中的路由规则将请求转发给函数对应的 service；</li>
<li>最后，请求会转发至挂载在 service 后的某个函数进行处理。</li>
</ul>
<h5 id="Cronjob-trigger"><a href="#Cronjob-trigger" class="headerlink" title="Cronjob trigger"></a>Cronjob trigger</h5><p>如果希望<strong>定期</strong>触发函数执行，需要为函数创建 cronjob 触发器。</p>
<p>K8s 支持通过 CronJob 定期运行任务，kubeless 利用这个特性实现了 cronjob trigger。Kubeless 创建了一个名为cronjobtriggers.kubeless.io的 CRD 来代表 cronjob trigger 对象。</p>
<p>同时，kubeless 包含一个名为cronjob-trigger-controller的 CRD controller，它会持续监听针对 cronjob trigger 和 function 的 ADD、UPDATE、DELETE 事件，并执行对应的操作。</p>
<p>使用这个命令可以创建一个每分钟出发hello函数的触发器。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeless trigger cronjob create scheduled-invoke-hello --function&#x3D;hello --schedule&#x3D;&quot;*&#x2F;1 * * * *&quot;</span><br></pre></td></tr></table></figure>
<h5 id="自定义"><a href="#自定义" class="headerlink" title="自定义"></a>自定义</h5><p>如果发现 kubeless 默认提供的触发器无法满足业务需求，可以自定义新的触发器。新触发器的构建流程如下：</p>
<ul>
<li>为新的事件源创建一个 CRD 来描述事件源触发器；</li>
<li>在自定义资源对象的 spec 里描述该事件源的属性，例如 KafkaTriggerSpec、HTTPTriggerSpec；</li>
<li>为该 CRD 创建一个 CRD controller。<ul>
<li><p>该 controller 需要持续监听针对事件源触发器和 function 的 CRUD 操作并作出正确的处理。例如，controller 监听到 function 的删除事件，需要把和该 function 关联的触发器一并删掉；</p>
</li>
<li><p>当事件发生时，触发关联函数的执行。</p>
<p>我们可以看到，自定义 trigger 的流程遵循了 K8s Operator 设计模式。</p>
</li>
</ul>
</li>
</ul>
<h3 id="自动伸缩"><a href="#自动伸缩" class="headerlink" title="自动伸缩"></a>自动伸缩</h3><p>K8s 通过 Horizontal Pod Autoscaler 实现 pod 的自动水平伸缩。Kubeless 的 function 通过 K8s deployment 部署运行，因此天然可以利用 HPA 实现自动伸缩。</p>
<ul>
<li>内置度量指标 cpu</li>
</ul>
<p>CPU 使用率等，对于这类指标 HPA 可以通过 metrics API 从 Metrics Server 中获取数据。Metrics Server 是 Heapster 的继承者，它可以从 Kubelet、cAdvisor 中获取度量数据。</p>
<ul>
<li>自定义度量指标 qps</li>
</ul>
<p>QPS 属于自定义度量指标，想要获取这类指标的度量数据需要完成下列步骤。</p>
<p>部署用于存储度量数据的系统，这里选择Prometheus。</p>
<p>Prometheus 是一套开源监控&amp;告警&amp;时序数据解决方案。采集度量数据，并写入部署好的 Prometheus 中。</p>
<p>Kubeless 提供的函数框架会在函数每次被调用时，将下列度量数据 function_duration_seconds、function_calls_total、function_failures_total 写入 Prometheus。</p>
<p>部署实现了 custom metrics API 的 custom API server。这里，因为度量数据被存入了 Prometheus，因此选择部署 k8s-prometheus-adapter，它可以从 Prometheus 中获取度量数据。</p>
<p>完成上述步骤后，HPA 就可以通过 custom metrics API 从 Prometheus Adapter 中获取 qps 度量数据。详细配置步骤可参考文章 kubeless-autoscaling。</p>
<ul>
<li>其他度量指标自定义</li>
</ul>
<p>有时基于 cpu 和 qps 这两种度量指标对函数进行自动伸缩还远远不够。如果希望基于其它度量指标，需要了解 K8s 定义的度量指标类型及其获取方式。</p>
<p>目前，K8s 1.13 版本支持的度量指标类型如下：</p>
<p>类型|简介|获取方式<br>Object|代表 k8s 对象的度量指标，例如上文提到的 Service 对象的 function_calls 指标。|custom.metrics.k8s.io<br>度量数据采集后，需要通过已有适配器或自己实现适配器获取数据。目前已有的适配器包括 k8s-prometheus-adapter、azure-k8s-metrics-adapter、k8s-stackdriver 等。<br>Pod|代表伸缩目标中每个 pod 的自定义度量指标，例如 pod 每秒处理的事务数。在与目标值比较前需要除以 pod 个数。|同上<br>Resource|代表伸缩目标中每个 pod 的 K8s 内置资源指标（如 CPU、Memory）。在与目标值比较前需要除以 pod 个数。|metrics.k8s.io<br>从 Metrics Server 或 Heapster 中获取度量数据。<br>External|External 是一个全局度量指标，它与任何 K8s 对象无关。它允许伸缩目标基于来自 cluster 外部的信息进行伸缩（如外部负载均衡器的 QPS，云消息服务中的队列长度）。|external.metrics.k8s.io<br>度量数据采集后，需要云平台厂商提供适配器或自己实现。目前已有的适配器包括 azure-k8s-metrics-adapter、k8s-stackdriver 等。</p>
<p>准备好相应的度量数据和获取数据的组件，HPA 就能基于它们对函数进行自动伸缩。</p>
<h4 id="度量数据使用"><a href="#度量数据使用" class="headerlink" title="度量数据使用"></a>度量数据使用</h4><ul>
<li>基于CPU使用率</li>
</ul>
<p>为该函数创建一个基于 cpu 使用率的 HPA，它将运行该函数的 pod 数量控制在 1 到 3 之间，并通过增加或减少 pod 个数使得所有 pod 的平均 cpu 使用率维持在 70%。</p>
<p>通过–参数的形式把目标传递进去</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeless autoscale create hello --metric&#x3D;cpu --min&#x3D;1 --max&#x3D;3 --value&#x3D;70</span><br></pre></td></tr></table></figure>
<ul>
<li>基于 qps</li>
</ul>
<p>以下命令将为函数 hello 创建一个基于 qps 的 HPA，它将运行该函数的 pod 数量控制在 1 到 5 之间，并通过增加或减少 pod 个数确保所有挂在服务 hello 后的 pod 每秒能处理的请求次数之和达到 2000。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeless autoscale create hello --metric&#x3D;qps --min&#x3D;1 --max&#x3D;5 --value&#x3D;2k</span><br></pre></td></tr></table></figure>
<ul>
<li>基于多项指标</li>
</ul>
<p>这种需要通过yaml创建一个指定的HPA控制器。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">kind: HorizontalPodAutoscaler</span><br><span class="line">apiVersion: autoscaling&#x2F;v2alpha1</span><br><span class="line">metadata:</span><br><span class="line">  name: hello-cpu-and-memory</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    created-by: kubeless</span><br><span class="line">    function: hello</span><br><span class="line">spec:</span><br><span class="line">  scaleTargetRef:</span><br><span class="line">    kind: Deployment</span><br><span class="line">    name: hello</span><br><span class="line">  minReplicas: 1</span><br><span class="line">  maxReplicas: 10</span><br><span class="line">  metrics:</span><br><span class="line">  - type: Resource</span><br><span class="line">    resource:</span><br><span class="line">      name: cpu</span><br><span class="line">      targetAverageUtilization: 50</span><br><span class="line">  - type: Resource</span><br><span class="line">    resource:</span><br><span class="line">      name: memory</span><br><span class="line">      targetAverageValue: 200Mi</span><br></pre></td></tr></table></figure>
<h3 id="自动伸缩策略"><a href="#自动伸缩策略" class="headerlink" title="自动伸缩策略"></a>自动伸缩策略</h3><p>一个理想的自动伸缩策略应当处理好下列场景：</p>
<ul>
<li>当负载激增时，函数能迅速扩展以应对突发流量；</li>
<li>当负载下降时，函数能立即收缩以节省资源消耗；</li>
<li>具备抗噪声干扰能力，能够精确计算出目标容量；</li>
<li>能够避免自动伸缩过于频繁造成系统抖动。</li>
</ul>
<p>Kubeless 依赖的 HPA 充分考虑了上述情形，不断改进和完善其使用的自动伸缩策略。下面以 K8s 1.13 版本为例描述该策略。</p>
<p>HPA 每隔一段时间会根据获取的度量数据同步一次和该 HPA 关联的 pod 个数。</p>
<p>时间间隔通过 kube-controller-manager 的参数–horizontal-pod-autoscaler-sync-period指定，默认为 15s。</p>
<p>在每一次同步过程中，HPA 需要经历如下图所示的计算流程。</p>
<div align="center"> <img src="https://cdn.nlark.com/lark/0/2018/png/86722/1543237287466-eacc4930-922f-4e21-9eb3-60c29da4397f.png" width=""> </div><br>

<h4 id="计算目标副本数"><a href="#计算目标副本数" class="headerlink" title="计算目标副本数"></a>计算目标副本数</h4><p>计算 HPA 列表中每项指标需要的 pod 数量中的最大值作为目标。在计算每项指标的 replicaCountProposal 过程中会考虑下列因素：</p>
<p>允许目标度量值和实际度量值存在一定程度的误差，如果在误差范围内直接使用 currentReplicas 作为 replicaCountProposal。</p>
<p>这样做是为了避免伸缩过于频繁造成系统抖动，该误差值可以通过–horizontal-pod-autoscaler-tolerance指定。</p>
<h5 id="pod刚启动时的特殊处理"><a href="#pod刚启动时的特殊处理" class="headerlink" title="pod刚启动时的特殊处理"></a>pod刚启动时的特殊处理</h5><p>当一个 pod 刚启动时，该 pod 反映的度量值往往不是很准确，HPA 会将这种 pod 视为 unready。在计算度量值时，HPA 会跳过处于 unready 状态的 pod。这样做是为了消除噪声干扰。</p>
<p>可以通过–horizontal-pod-autoscaler-cpu-initialization-period和–horizontal-pod-autoscaler-initial-readiness-delay调整 pod 被认为处于 unready 状态的时间。</p>
<h4 id="平滑目标副本数"><a href="#平滑目标副本数" class="headerlink" title="平滑目标副本数"></a>平滑目标副本数</h4><p>将最近一段时间计算出的 metricDesiredReplicas 记录下来，取其中的最大值作为 stabilizedRecommendation。</p>
<p>这样做是为了让缩容过程变得平滑，消除度量数据异常波动造成的影响。(比如目标副本数一直在小幅波动，那倒不如直接取个近期的最大，浪费就浪费了)。</p>
<p>该时间段可以通过参数–horizontal-pod-autoscaler-downscale-stabilization-window指定，默认为 5 分钟。</p>
<h4 id="规范目标副本数"><a href="#规范目标副本数" class="headerlink" title="规范目标副本数"></a>规范目标副本数</h4><p>限制 desiredReplicas 最大为 currentReplicas * scaleUpLimitFactor(等于2)，这样做是为了防止因 采集到了“虚假的”度量数据造成扩容过快。</p>
<p>限制 desiredReplicas 大于等于 hpaMinReplicas，小于等于 hpaMaxReplicas。</p>
<h4 id="执行扩容缩容操作"><a href="#执行扩容缩容操作" class="headerlink" title="执行扩容缩容操作"></a>执行扩容缩容操作</h4><p>如果通过上述步骤计算出的 desiredReplicas 不等于 currentReplicas，则“执行”扩容缩容操作。</p>
<p>这里所说的执行只是将 desiredReplicas 赋值给 RC 或 Deployment 中的 replicas，pod 的创建销毁会由 kube-scheduler 和 worker node 上的 kubelet 异步完成的。</p>
<h2 id="存在问题"><a href="#存在问题" class="headerlink" title="存在问题"></a>存在问题</h2><p>Kubeless 基于 K8s 提供了较为完整的 serverless 解决方案，但和一些商业 serverless 产品还存在一定差距：</p>
<ul>
<li>Kubeless 并未在镜像拉取、代码下载、容器启动等方面做过多优化，导致函数冷启动时间过长；</li>
<li>Kubeless 并未过多考虑多租户的问题，如果希望多个用户的函数运行在同一个集群里，还需要进行二次开发；</li>
<li>Kubeless 不支持函数间的协调管理，无法像 AWS Step Functions 那样自定义工作流。</li>
</ul>
<h1 id="常用的Serverless触发流程"><a href="#常用的Serverless触发流程" class="headerlink" title="常用的Serverless触发流程"></a>常用的Serverless触发流程</h1><div align="center"> <img src="https://upload-images.jianshu.io/upload_images/3342415-11aa91afa043ae7a.jpg?imageMogr2/auto-orient/strip|imageView2/2/w/1200/format/webp" width=""> </div><br>



      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color1">Kubernetes</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2020/09/11/2020-09-11-Kubernetes/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-2020-08-24-JAVA反射详解" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/08/24/2020-08-24-JAVA%E5%8F%8D%E5%B0%84%E8%AF%A6%E8%A7%A3/">JAVA 反射详解</a>
    </h1>
  

        
        <a href="/2020/08/24/2020-08-24-JAVA%E5%8F%8D%E5%B0%84%E8%AF%A6%E8%A7%A3/" class="archive-article-date">
  	<time datetime="2020-08-23T16:00:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2020-08-24</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="JAVA-反射"><a href="#JAVA-反射" class="headerlink" title="JAVA 反射"></a>JAVA 反射</h1><p>JAVA反射机制是在运行状态中，对于任意一个类，都能够通过反射知道这个类的所有属性和方法；对于任意一个对象，都能够调用它的任意方法和属性。</p>
<p>这种动态获取信息以及动态调用对象方法的功能称为java语言的反射机制。</p>
<h2 id="用途"><a href="#用途" class="headerlink" title="用途"></a>用途</h2><p>在日常的第三方应用开发过程中，经常会遇到某个类的某个成员变量、方法或是属性是<strong>私有的</strong>或是<strong>只对系统应用开放</strong>，这时候就可以利用Java的反射机制通过反射来获取所需的私有成员或是方法。</p>
<p>当然，也不是所有的都适合反射，之前就遇到一个案例，通过反射得到的结果与预期不符。经过层层调用后在最终返回结果的地方对应用的权限进行了校验，对于没有权限的应用返回值是没有意义的缺省值，否则返回实际值，起到保护用户的隐私目的。</p>
<h2 id="基本反射技术"><a href="#基本反射技术" class="headerlink" title="基本反射技术"></a>基本反射技术</h2><ol>
<li>根据内容得到类</li>
</ol>
<p>通过getClass()获得类名，通过getSuperClass()获取父类。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">String name &#x3D; &quot;Huanglinqing&quot;;</span><br><span class="line">Class c1 &#x3D; name.getClass();</span><br><span class="line">&#x2F;&#x2F; 输出java.lang.String</span><br><span class="line">System.out.println(c1.getName());</span><br></pre></td></tr></table></figure>
<p>通过Class.forName(目标)获得目标类名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">   String name &#x3D; &quot;java.lang.String&quot;;</span><br><span class="line">   Class c1 &#x3D; null;</span><br><span class="line">   try &#123;</span><br><span class="line">          c1 &#x3D; Class.forName(name);</span><br><span class="line">          System.out.println(c1.getName());</span><br><span class="line">      &#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>获取Type属性</li>
</ol>
<p>获得的内容都是Class类。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Class c1 &#x3D; Boolean.TYPE;</span><br><span class="line">Class c2 &#x3D; Byte.TYPE;</span><br><span class="line">Class c3 &#x3D; Float.TYPE;</span><br><span class="line">Class c4 &#x3D; Double.TYPE;</span><br></pre></td></tr></table></figure>
<h2 id="获取类的成员"><a href="#获取类的成员" class="headerlink" title="获取类的成员"></a>获取类的成员</h2><p>当类中<strong>方法定义为私有</strong>的时候我们能调用？不能！</p>
<p>当<strong>变量是私有</strong>的时候我们能获取吗？不能！</p>
<p>但是反射可以，比如源码中有你需要用到的方法，但是那个方法是私有的，这个时候你就可以通过反射去执行这个私有方法，并且获取私有变量。</p>
<p>举例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">public class Test &#123;</span><br><span class="line">	&#x2F;&#x2F; 私有变量</span><br><span class="line">    private int age;</span><br><span class="line">    private String name;</span><br><span class="line">    private int testint;</span><br><span class="line"> </span><br><span class="line">    public Test(int age) &#123;</span><br><span class="line">        this.age &#x3D; age;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    public Test(int age, String name) &#123;</span><br><span class="line">        this.age &#x3D; age;</span><br><span class="line">        this.name &#x3D; name;</span><br><span class="line">    &#125;</span><br><span class="line">	&#x2F;&#x2F; 私有方法</span><br><span class="line">    private Test(String name) &#123;</span><br><span class="line">        this.name &#x3D; name;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    public Test() &#123;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>下面可以通过反射来获得私有内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 新建一个类</span><br><span class="line">Test test &#x3D; new Test();</span><br><span class="line">&#x2F;&#x2F; 获得类内容</span><br><span class="line">Class c4 &#x3D; test.getClass();</span><br><span class="line">&#x2F;&#x2F; 新建构造方法，获得类的构造方法，可以有多个，所以是一个Constructor数组形式</span><br><span class="line">Constructor[] constructors ;</span><br><span class="line">constructors &#x3D; c4.getDeclaredConstructors();</span><br><span class="line"></span><br><span class="line">  	for (int i &#x3D; 0; i &lt; constructors.length; i++) &#123;</span><br><span class="line">		&#x2F;&#x2F;getModifiers获得构造方法的类型</span><br><span class="line">        System.out.print(Modifier.toString(constructors[i].getModifiers()) + &quot;参数：&quot;);</span><br><span class="line">		&#x2F;&#x2F;getParameterTypes获得方法的入参类型</span><br><span class="line">        Class[] parametertypes &#x3D; constructors[i].getParameterTypes();</span><br><span class="line">        for (int j &#x3D; 0; j &lt; parametertypes.length; j++) &#123;</span><br><span class="line">             	System.out.print(parametertypes[j].getName() + &quot; &quot;);</span><br><span class="line">      	&#125;</span><br><span class="line">      System.out.println(&quot;&quot;);</span><br><span class="line">  	&#125;</span><br></pre></td></tr></table></figure>
<p>上面使用的getDeclaredConstructors()是获得全部的构造方法</p>
<p>也可以直接获得特定构造方法，使用getDeclaredConstructor()，结尾没有s</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;要获取的是有两个参数int和String的构造方法，先设计好p，把p传入getDeclaredConstructor就好了</span><br><span class="line">  Class[] p &#x3D; &#123;int.class,String.class&#125;;</span><br><span class="line">  try &#123;</span><br><span class="line">       constructors &#x3D; c4.getDeclaredConstructor(p);</span><br><span class="line">       System.out.print(Modifier.toString(constructors.getModifiers()) + &quot;参数:&quot;);</span><br><span class="line">       Class[] parametertypes &#x3D; constructors.getParameterTypes();</span><br><span class="line">       for (int j &#x3D; 0; j &lt; parametertypes.length; j++) &#123;</span><br><span class="line">            System.out.print(parametertypes[j].getName() + &quot; &quot;);</span><br><span class="line">          &#125;</span><br><span class="line">       &#125; catch (NoSuchMethodException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>
<p>得到了构造方法之后，怎么调用构造一个新实例？（即我反射回来了我得用起来阿）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">\\ 类内容</span><br><span class="line">   public Test(int age, String name) &#123;</span><br><span class="line">        this.age &#x3D; age;</span><br><span class="line">        this.name &#x3D; name;</span><br><span class="line">        System.out.println(&quot;hello&quot; + name + &quot;i am&quot; + age);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    private Test(String name) &#123;</span><br><span class="line">        this.name &#x3D; name;</span><br><span class="line">        System.out.println(&quot;My Name is&quot; +</span><br><span class="line">                name);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Test test &#x3D; new Test();</span><br><span class="line">Class c4 &#x3D; test.getClass();</span><br><span class="line"></span><br><span class="line">Class[] p &#x3D; &#123;int.class,String.class&#125;;</span><br><span class="line">&#x2F;&#x2F; 得到公共构造方法</span><br><span class="line">constructors &#x3D; c4.getDeclaredConstructor(p);</span><br><span class="line">&#x2F;&#x2F; 通过构造方法来新建实例</span><br><span class="line">constructors.newInstance(24,&quot;HuangLinqing&quot;);</span><br><span class="line">&#x2F;&#x2F; 得到并通过私有构造方法来新建实例</span><br><span class="line">Class[] p &#x3D; &#123;String.class&#125;;</span><br><span class="line">constructors &#x3D; c4.getDeclaredConstructor(p);</span><br><span class="line">&#x2F;&#x2F; 注意要先setAccessible，不然打印不出来</span><br><span class="line">constructors.setAccessible(true);</span><br><span class="line">constructors.newInstance(&quot;HuangLinqing&quot;);</span><br></pre></td></tr></table></figure>
<p>调用类的私有方法的方法：</p>
<p>假设有这么个刚发welcome，入参是String类型</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">  private void welcome(String tips)&#123;</span><br><span class="line">        System.out.println(tips);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>可以这样调用他的私有方法：(使用invoke()执行，需要两个参数，类实例和方法参数，如果不能像new这样得到类实例的话，可以用上面的反射获得类信息，然后newInstance新建一个)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">     Class[] p4 &#x3D; &#123;String.class&#125;;</span><br><span class="line">     Method method &#x3D; c4.getDeclaredMethod(&quot;welcome&quot;,p4);</span><br><span class="line">     method.setAccessible(true);</span><br><span class="line">     Object arg1s[] &#x3D; &#123;&quot;test string&quot;&#125;;</span><br><span class="line">     method.invoke(test,arg1s);</span><br></pre></td></tr></table></figure>
<p>获取私有字段并修改：</p>
<p>前提是没有办法得到类实例，不然的话直接test.set就好了。通过Filed类来做，getDeclaredField获得内部的私有字段，然后进行修改。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Field field &#x3D; c4.getDeclaredField(&quot;name&quot;);</span><br><span class="line">field.setAccessible(true);</span><br><span class="line">field.set(o,&quot;代码男人&quot;);</span><br></pre></td></tr></table></figure>
<p>总结：</p>
<p>可以看到，基本上都是对一个类实例，反射得到内容，如果是public的，那么可以直接调用，如newInstance，invoke等，但如果是private的，就需要在调用前进行setAccessible(true)，然后才能使用。</p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color5">JAVA</a>
        		</li>
      		 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">反射</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2020/08/24/2020-08-24-JAVA%E5%8F%8D%E5%B0%84%E8%AF%A6%E8%A7%A3/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-2020-08-24-Docker总结" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/08/24/2020-08-24-Docker%E6%80%BB%E7%BB%93/">Docker总结</a>
    </h1>
  

        
        <a href="/2020/08/24/2020-08-24-Docker%E6%80%BB%E7%BB%93/" class="archive-article-date">
  	<time datetime="2020-08-23T16:00:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2020-08-24</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="容器-与-Docker"><a href="#容器-与-Docker" class="headerlink" title="容器 与 Docker"></a>容器 与 Docker</h1><p>容器 = cgroup + namespace + rootfs + 容器引擎(docker 中就是 docker engine)</p>
<h2 id="Docker和虚拟机的区别"><a href="#Docker和虚拟机的区别" class="headerlink" title="Docker和虚拟机的区别"></a>Docker和虚拟机的区别</h2><div align="center"> <img src="https://upload-images.jianshu.io/upload_images/12979420-a562cd670f2b8b02?imageMogr2/auto-orient/strip|imageView2/2/w/529/format/webp
" width=""> </div><br>

<ul>
<li>(docker抽象层更少,效率更高,更高资源利用率)虚拟机的Guest OS层，还有Hypervisor层在Docker上已经被Docker Engine层所取代.</li>
</ul>
<p>Guest OS 是虚拟机安装的操作系统，是一个完整的系统内核;Hypervisor可以理解为硬件虚拟化平台，它在Host OS后以内核驱动的形式存在。</p>
<p>Docker容器上的程序，直接使用的都是实际物理机的硬件资源。因此在cpu、内存、利用率上，Docker将会在效率上具有更大的优势。</p>
<ul>
<li><p>(资源隔离方式不同,带来不同的性能开销)虚拟机实现资源的隔离的方式是利用独立的Guest OS+Hypervisor虚拟化实现的；Docker简单很多，利用的是目前当前Linux内核本身支持的容器方式。</p>
</li>
<li><p>(启动速度不同)Docker秒级启动。Docker直接利用系统内核，避免了虚拟机启动时所需要的系统引导时间和操作系统运行的资源消耗。</p>
</li>
<li><p>(兼容性)Docker能够高效地部署和扩容，Docker容器几乎可以在任意平台上运行，包括虚拟机、物理机、公有云、私有云、个人电脑、服务器等。</p>
</li>
</ul>
<h2 id="namespace-资源隔离"><a href="#namespace-资源隔离" class="headerlink" title="namespace(资源隔离)"></a>namespace(资源隔离)</h2><p>Linux Namespace 是kernel 的一个功能，它可以<strong>隔离</strong>一系列系统的资源，比如PID(Process ID)，User ID, Network等等。</p>
<p>linux内核实现namespace的主要目的，就是为了实现轻量级虚拟化技术服务。</p>
<p>在同一个namespace下的进程感知彼此的变化，而对外界的进程一无所知。</p>
<p>这样就可以让容器中的进程产生错觉，仿佛自己置身一个独立的系统环境中，以达到隔离的目的。</p>
<p>linux内核提拱了6种namespace隔离的系统调用：</p>
<p>namespace|系统调用参数|隔离内容<br>UTS|CLONE_NEWUTS|主机名或域名<br>IPC|CLONE_NEWIPC|信号量、消息队列和共享内存<br>PID|CLONE_NEWPID|进程编号<br>Network|CLONE_NEWNET|网络设备、网络战、端口等<br>Mount|CLONE_NEWNS|挂载点（文件系统）<br>User|CLONE_NEWUSER|用户组和用户组</p>
<p>Namesapce 的API主要使用三个系统调用：</p>
<ul>
<li>clone() - 创建新进程。根据调用参数来判断哪种namespace被创建，而且它们的子进程也会被包含到namespace中。</li>
</ul>
<p>使用这些API时需要指定一下6个参数中的一个或多个，通过 | 操作实现。</p>
<p>这6个参数分别是CLONE_NEWUTS、CLONE_NEWIPC、CLONE_NEWPID、CLONE_NEWNET、CLONE_NEWNS、CLONE_NEWUSER。</p>
<ul>
<li>setns() - 将进程加入到namespace中</li>
</ul>
<p>在进程都结束的情况下，也可以通过挂载的形式把namespace保留下来，保留namespace的目的是为以后有进程加入作准备。</p>
<p>在docker中，使用docker exec命令在意境运行的容器中执行新的命令，就需要用到该方法。</p>
<p>通过setns()系统调用，进程从原先的namespace加入到某个已经存在的namespace。</p>
<p>为了使新的pid namespace生效，会在函数执行后使用clone()创建子进程继续执行新命令，让原先的进程结束运行。</p>
<ul>
<li>unshare() - 将进程移出某个namespace</li>
</ul>
<p>调用unshare()的主要作用就是，不启动新进程就可以起到隔离的作用，相当于跳出原先的namespace进行操作</p>
<p>这样，就可以在原进程进行了一些需要隔离的操作。</p>
<p>linux中自带unshare命令，就是通过unshare()系统调用实现的，<strong>docker目前并没有使用这个系统调用</strong>。</p>
<h3 id="UTS-namespace"><a href="#UTS-namespace" class="headerlink" title="UTS namespace"></a>UTS namespace</h3><p>UNIX Time-sharing System，提供了主机名与域名的隔离，这样每个容器就可以拥有独立的主机名和域名了。为什么要隔离主机名？因为主机名可以代替IP来访问。如果不隔离，同名访问会出冲突。</p>
<p>在网络上可以被视为一个独立的节点，而非宿主机上的一个进程。</p>
<p>docker中，每个镜像基本都以自身所提供的服务名称来命名镜像的hostname，且不会对宿主机产生任何影响。</p>
<h3 id="IPC-namespace"><a href="#IPC-namespace" class="headerlink" title="IPC namespace"></a>IPC namespace</h3><p>Inter-Process Communication。进程间通信IPC资源包括常见的信号量、消息队列和共享内存。</p>
<p>申请IPC资源就申请了一个全局唯一的32位ID，所以IPC namespace中实际上包含了系统IPC标识符以及实现POSIX消息队列的文件系统。</p>
<p>在同一个IPC namespace下的进程彼此可见，不同IPC namespace下的进程则互相不可见。</p>
<p>目前使用IPC namespace机制的系统不多，其中比较有名的有PostgreSQL。Docker当前也使用IPC namespace实现了容器与宿主机、容器与容器之间的IPC隔离。</p>
<h3 id="PID-namespace"><a href="#PID-namespace" class="headerlink" title="PID namespace"></a>PID namespace</h3><p>PID namespace隔离非常实用，它对进程PID重新标号，即两个不同namespace下的进程可以有相同的PID。每个PID namespace都有自己的计数程序。</p>
<p>内核为所有的PID namespace维护了一个树状结构，最顶层的是系统初始时创建的，被称为root namespace，它创建的新PID namespace被称为child namespace(树的子节点)，构建节点父子关系。</p>
<p>通过这种方式，不同的PID namespace会形成一个层级体系。所属的父节点可以看到子节点中的进程，并可以通过信号等方式对子节点中的进程产生影响。反过来，子节点却不能看到父节点PID namespace中的任何内容。</p>
<p>由此产生如下结论：</p>
<ul>
<li><p>每个PID namespace中的第一个进程“PID 1”，都会像全通Linux中的init进程一样拥有特权，其特殊作用。</p>
</li>
<li><p>一个namespace中的进程，不可能通过kill或ptrace PID影响父节点或者兄弟节点中的进程，因为其他几点的PID在这个namespace没有任何意义。</p>
</li>
<li><p>如果你在新的PID namespace中重新挂载/proc文件系统，会发现其下只显示同属一个PID namespace中的其他进程。</p>
</li>
<li><p>在root namespace中看到所有的进程，并且递归包含所有子节点中的进程。</p>
</li>
</ul>
<p>到这里，可能已经联想到了一种在Docker外部监控运行程序的方法了，就是监控Docker daemon所在的PID namespace下的所有进程及子进程，再进行筛选即可找到想监控的程序。</p>
<h3 id="network-namespace"><a href="#network-namespace" class="headerlink" title="network namespace"></a>network namespace</h3><p>主要提供了关于网络资源的隔离，包括网络设备、IPv4和IPv6协议栈、IP路由表、防火墙、/proc/net目录、/sys/class/net目录、socket等。</p>
<p>Network namespace 可以让每个容器拥有自己独立的网络设备（虚拟的），而且容器内的应用可以绑定到自己的端口，每个 namesapce 内的端口都不会互相冲突。</p>
<p>在宿主机上搭建网桥后，就能很方便的实现容器之间的通信，而且每个容器内的应用都可以使用相同的端口。</p>
<p>一个物理的网络设备最多存在于一个network namespace中，可以通过创建veth pair(虚拟网络设备对：有两端，类似管道，如果数据从一端传入另一端也能接受，反之亦然)在不同的network namespace间创建通道，以达到通信目的。</p>
<h3 id="user-namespace"><a href="#user-namespace" class="headerlink" title="user namespace"></a>user namespace</h3><p>主要隔离了安全相关的标识符(identifier)和属性(attribute)，包括用户ID、用户组ID、root目录、key(指密钥)以及特殊权限。</p>
<p>通俗地讲，一个普通用户的进程通过clone()创建的新进程在新user namespace中可以拥有不同的用户和用户组。</p>
<p>这意味着一个进程在容器外属于一个没有特权的普通用户，但是它创建的容器进程却属于拥有所有权限的超级用户，这个技术为容器提供了极大的自由。</p>
<p>隔离用户和用户组。它的厉害之处在于，可以让宿主机上的一个普通用户在 namespace 里成为 0 号用户，也就是 root 用户。这样普通用户可以在容器内“随心所欲”，但是影响也仅限在容器内。</p>
<h3 id="mount-namespace"><a href="#mount-namespace" class="headerlink" title="mount namespace"></a>mount namespace</h3><p>隔离文件挂载点，每个进程能看到的文件系统都记录在/proc/$$/mounts里。在一个 namespace 里挂载、卸载的动作不会影响到其他 namespace。</p>
<h2 id="举个namespace的例子"><a href="#举个namespace的例子" class="headerlink" title="举个namespace的例子"></a>举个namespace的例子</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 交互式运行一个容器,分配一个伪输入终端</span><br><span class="line">docker run -it busybox &#x2F;bin&#x2F;sh</span><br></pre></td></tr></table></figure>
<p>在容器内部使用ps可以查看进程id(可以看到有一个pid=1的/bin/sh)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x2F; # ps</span><br><span class="line">PID   USER     TIME  COMMAND</span><br><span class="line">    1 root      0:00 &#x2F;bin&#x2F;sh</span><br><span class="line">    5 root      0:00 ps</span><br></pre></td></tr></table></figure>
<p>在宿主机中呢(这个对应的进程id是3702)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># ps -ef |grep busy</span><br><span class="line">root      3702  3680  0 15:53 pts&#x2F;0    00:00:00 docker run -it busybox &#x2F;bin&#x2F;sh</span><br></pre></td></tr></table></figure>
<p>这就意味着，前面执行的/bin/sh，已经被Docker隔离在了一个跟宿主机完全不同的世界当中。</p>
<p>这在源码中实际上是这么一段：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 调用clone，加入namespace，当前这个使用的是PID namespace</span><br><span class="line">int pid &#x3D; clone(main_function, stack_size, CLONE_NEWPID | SIGCHLD, NULL);</span><br></pre></td></tr></table></figure>
<p>但有个问题，然后如果你自己只用PID namespace使用上述的clone()创建一个进程。</p>
<p>查看ps或top等命令时，却还是能看到所有进程，说明并没有完全隔离。</p>
<p>这是因为像ps、top这些命令会去读/proc文件系统，而此时你创建的隔离了pid的进程和宿主机使用的是同一个/proc文件系统，所以这些命令显示的东西都是一样的。</p>
<p>所以，我们还需要使其它的namespace隔离(即很多时候只是单纯的一个namespace的隔离不大够)，如文件系统进行隔离。</p>
<h2 id="docker与namespace"><a href="#docker与namespace" class="headerlink" title="docker与namespace?"></a>docker与namespace?</h2><p>理解docker容器本质上是一个运行在宿主机上的一个进程，那么进程就可以使用之前的namespace手段。</p>
<p>创建容器时，通过namespace提供需要的系统资源给容器进程，隔离出自己单独的空间.</p>
<h2 id="cgroup-资源限额"><a href="#cgroup-资源限额" class="headerlink" title="cgroup(资源限额)"></a>cgroup(资源限额)</h2><p>namespace并不能提供物理资源上的隔离，比如 CPU 或者内存，如果在同一台机器上运行了多个对彼此以及宿主机器一无所知的容器，这些容器却共同占用了宿主机器的物理资源。</p>
<p>如果其中的某一个容器正在执行 CPU 密集型的任务，那么就会影响其他容器中任务的性能与执行效率，导致多个容器相互影响并且抢占资源。</p>
<p>Linux Cgroups(Control Groups) 提供了对一组进程及将来的子进程的资源的限制 ，控制和统计的能力，这些资源包括CPU，内存，存储，网络等。</p>
<p>通过Cgroups，可以方便的限制某个进程的资源占用，并且可以实时的监控进程的监控和统计信息。</p>
<h3 id="两种cgroup驱动"><a href="#两种cgroup驱动" class="headerlink" title="两种cgroup驱动"></a>两种cgroup驱动</h3><ul>
<li>systemd</li>
</ul>
<p>system daemon 的cgroup驱动</p>
<ul>
<li>cgroupfs</li>
</ul>
<p>要用 CPU share 为多少，直接把 pid 写入对应的一个 cgroup 文件，然后把对应需要限制的资源也写入相应的 memory cgroup 文件和 CPU 的 cgroup 文件。</p>
<h3 id="三个组件"><a href="#三个组件" class="headerlink" title="三个组件"></a>三个组件</h3><ul>
<li>cgroup</li>
</ul>
<p>对进程分组管理的一种机制。一个cgroup包含一组进程，并可以在这个cgroup上增加Linux subsystem的各种参数的配置，将一组进程和一组subsystem的系统参数关联起来。亦即，管理“组进程”并关联参数</p>
<ul>
<li>subsystem</li>
</ul>
<p>subsystem 是一组资源控制的模块，一般包含有：</p>
<p><strong>blkio</strong> 设置对块设备（比如硬盘）的<strong>输入输出</strong>的访问控制（block/io），限制磁盘IOPS和bps速率</p>
<p><strong>cpu</strong> 设置cgroup中的进程的<strong>CPU</strong>被调度的策略</p>
<p>cpuacct 可以统计cgroup中的进程的CPU占用(cpu account)</p>
<p>cpuset 在多核机器上设置cgroup中的进程可以使用的CPU和内存（此处内存仅使用于NUMA架构）</p>
<p><strong>devices</strong> 控制cgroup中进程对<strong>设备</strong>的访问</p>
<p><strong>freezer</strong> 用于<strong>挂起</strong>(suspends)和<strong>恢复</strong>(resumes) cgroup中的进程</p>
<p><strong>memory</strong> 用于控制cgroup中进程的内存占用</p>
<p>net_cls 用于将cgroup中进程产生的网络包分类(classify)，以便Linux的tc(traffic controller) (net_classify) 可以根据分类(classid)区分出来自某个cgroup的包并做限流或监控。</p>
<p>net_prio 设置cgroup中进程产生的网络流量的优先级</p>
<p>ns 这个subsystem比较特殊，它的作用是cgroup中进程在新的namespace fork新进程(NEWNS)时，创建出一个新的cgroup，这个cgroup包含新的namespace中进程。</p>
<ul>
<li>hierarchy</li>
</ul>
<p>hierarchy 的功能是把<strong>一组cgroup</strong>串成一个树状的结构，一个这样的树便是一个hierarchy，通过这种树状的结构，Cgroups可以做到继承。</p>
<p>比如我的系统对一组定时的任务进程通过cgroup1限制了CPU的使用率，然后其中有一个定时dump日志的进程还需要限制磁盘IO。</p>
<p>为了避免限制了影响到其他进程，就可以创建cgroup2继承于cgroup1并限制磁盘的IO，这样cgroup2便继承了cgroup1中的CPU的限制，并且又增加了磁盘IO的限制而不影响到cgroup1中的其他进程。</p>
<h2 id="cgroup操作实例"><a href="#cgroup操作实例" class="headerlink" title="cgroup操作实例"></a>cgroup操作实例</h2><ul>
<li><p>创建并挂载一个hierarchy:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir cgroup-test</span><br><span class="line">sudo mount -t cgroup -o none,name&#x3D;cgroup-test cgroup-test .&#x2F;cgroup-test</span><br><span class="line">ls .&#x2F;cgroup-test</span><br></pre></td></tr></table></figure></li>
<li><p>在创建好的hierarchy上cgroup根节点扩展出两个子cgroup，子cgroup会扩展父cgroupd的属性。</p>
</li>
<li><p>在cgroup中添加和移动进程</p>
</li>
</ul>
<p>一个进程在一个cgroup的hirearchy进程中，只能在一个cgroup节点上存在，只要把该进程ID写入该cgroup节点的tasks文件，就可以把进程移动到这个cgroup节点。</p>
<ul>
<li>通过subsystem限制cgroup中的进程资源<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount | grep memory</span><br></pre></td></tr></table></figure>
查看哪个目录挂在了memory subsystem的hierarchy上,并修改limit_in_bytes</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo sh -c &quot;echo &quot;100m&quot; &gt; memory.limit_in_bytes&quot; sudo sh -c &quot;echo &quot;100m&quot; &gt; memory.limit_in_bytes&quot;</span><br></pre></td></tr></table></figure>
<h2 id="cgroup-namespace-在docker中实际上是有libcontainer来集成的"><a href="#cgroup-namespace-在docker中实际上是有libcontainer来集成的" class="headerlink" title="cgroup+namespace+ 在docker中实际上是有libcontainer来集成的"></a>cgroup+namespace+ 在docker中实际上是有libcontainer来集成的</h2><h2 id="rootfs"><a href="#rootfs" class="headerlink" title="rootfs"></a>rootfs</h2><p>rootfs 代表一个 Docker 容器在启动时(而非运行后)其内部进程可见的文件系统视角，或者叫 Docker 容器的根目录。</p>
<p>先来看一下，Linux 操作系统内核启动时，内核会先挂载一个只读的 rootfs，当系统检测其完整性之后，决定是否将其切换到读写模式。</p>
<p>Docker 沿用这种思想，不同的是，挂载rootfs 完毕之后，没有像 Linux 那样将容器的文件系统切换到读写模式，而是利用联合挂载技术(UnionFS)，在这个只读的 rootfs 上挂载一个读写的文件系统，挂载后该读写文件系统空空如也。</p>
<p>Docker 文件系统简单理解为：只读的 rootfs + 可读写的文件系统。</p>
<div align="center"> <img src="https://upload-images.jianshu.io/upload_images/13880937-537571f61796d2e9.png?imageMogr2/auto-orient/strip|imageView2/2/w/546/format/webp" width=""> </div><br>

<h3 id="UnionFS"><a href="#UnionFS" class="headerlink" title="UnionFS"></a>UnionFS</h3><p>简单来说就是支持将不同目录挂载到同一个虚拟文件系统下的文件系统。</p>
<p>这种文件系统可以一层一层地叠加修改文件。无论底下有多少层都是只读的，只有最上层的文件系统是可写的。</p>
<p>当需要修改一个文件时，创建该文件的一个副本，将文件从只读层复制到可写层进行修改，结果也保存在可写层。在Docker中，底下的只读层就是image，可写层就是Container。(类比镜像和容器)</p>
<h2 id="隔离之后如何进行通信？————docker网络相关"><a href="#隔离之后如何进行通信？————docker网络相关" class="headerlink" title="隔离之后如何进行通信？————docker网络相关"></a>隔离之后如何进行通信？————docker网络相关</h2><p>所以 Docker 虽然可以通过命名空间创建一个隔离的网络环境，但是 Docker 中的服务仍然需要与外界相连才能发挥作用。</p>
<p>每一个使用 docker run 启动的容器其实都具有单独的网络命名空间，Docker 为我们提供了四种不同的网络模式，Host、Container、None 和 Bridge 模式。(安装Docker时，它会自动创建三个网络，bridge（创建容器默认连接到此网络）、 none 、host)</p>
<p>run容器时使用-network参数(host/none/bridge/container:NAME_or_ID)指定连接到哪个网络</p>
<h3 id="bridge模式-默认接入该网络"><a href="#bridge模式-默认接入该网络" class="headerlink" title="bridge模式(默认接入该网络)"></a>bridge模式(默认接入该网络)</h3><p>Docker 会为所有的容器设置 IP 地址。当 Docker 服务器在主机上启动之后会创建新的虚拟网桥 docker0，随后在该主机上启动的全部服务在默认情况下都与docker0相连。</p>
<p>在默认情况下，每一个容器在创建时都会创建一对虚拟网卡，两个虚拟网卡组成了数据的通道，其中一个会放在创建的容器中，会加入到名为 docker0 网桥中。</p>
<p>docker0 会为每一个容器分配一个新的 IP 地址并将 docker0 的 IP 地址设置为默认的网关。网桥 docker0 通过 iptables 中的配置与宿主机器上的网卡相连，所有符合条件的请求都会通过 iptables 转发到 docker0 并由网桥分发给对应的机器。</p>
<p>Docker 通过 Linux 的命名空间实现了网络的隔离，又通过 iptables 进行数据包转发，让 Docker 容器能够优雅地为宿主机器或者其他容器提供服务。</p>
<h4 id="bridge模式拓扑"><a href="#bridge模式拓扑" class="headerlink" title="bridge模式拓扑"></a>bridge模式拓扑</h4><p>虚拟网桥的工作方式和物理交换机类似，这样主机上的所有容器就通过交换机连在了一个二层网络中。</p>
<p>接下来就要为容器分配IP了，Docker会选择一个和宿主机不同的IP地址和子网分配给docker0，连接到docker0的容器就从这个子网中选择一个未占用的IP使用。</p>
<p>如一般Docker会使用172.17.0.0/16这个网段，并将172.17.0.1/16分配给docker0网桥（在主机上使用ifconfig命令是可以看到docker0的，可以认为它是网桥的管理接口，在宿主机上作为一块虚拟网卡使用）。</p>
<p>单机环境下的网络拓扑如下，主机地址为10.10.0.186/24。</p>
<div align="center"> <img src="https://img-blog.csdnimg.cn/20190702230627173.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21lbHRzbm93,size_16,color_FFFFFF,t_70" width=""> </div><br>

<h4 id="Bridge配置详解"><a href="#Bridge配置详解" class="headerlink" title="Bridge配置详解"></a>Bridge配置详解</h4><p>（1）在主机上创建一对虚拟网卡veth pair设备。veth设备总是成对出现的，它们组成了一个数据的通道，数据从一个设备进入，就会从另一个设备出来。因此，veth设备常用来连接两个网络设备。</p>
<p>（2）Docker将veth pair设备的一端放在新创建的容器中，并命名为eth0。另一端放在主机中，以veth65f9这样类似的名字命名，并将这个网络设备加入到docker0网桥中，可以通过brctl show命令查看。</p>
<p>（3）从docker0子网中分配一个IP给容器使用，并设置docker0的IP地址为容器的默认网关。</p>
<h4 id="Bridge下怎么进行容器通信"><a href="#Bridge下怎么进行容器通信" class="headerlink" title="Bridge下怎么进行容器通信"></a>Bridge下怎么进行容器通信</h4><p>在bridge模式下，连在同一网桥上的容器可以相互通信（若出于安全考虑，也可以禁止它们之间通信，方法是在DOCKER_OPTS变量中设置–icc=false，这样只有使用–link才能使两个容器通信）。</p>
<p>Docker默认配置–icc=true，也就是说，宿主机上的所有容器可以不受任何限制地相互通信，这可能导致拒绝服务攻击。</p>
<p>进一步地，Docker可以通过–ip_forward和–iptables两个选项控制容器间、容器和外部世界的通信。</p>
<p>容器也可以与外部通信，我们看一下主机上的Iptable规则，可以看到这么一条</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-A POSTROUTING -s 172.17.0.0&#x2F;16 ! -o docker0 -j MASQUERADE</span><br></pre></td></tr></table></figure>
<p>这条规则会将也就是从Docker容器产生的包，并且不是从docker0网卡发出的，进行源地址转换，转换成主机网卡的地址。</p>
<p>举一个例子:</p>
<p>假设主机有一块网卡为eth0，IP地址为10.10.101.105/24，网关为10.10.101.254。</p>
<p>从主机上一个IP为172.17.0.1/16的容器中ping百度（180.76.3.151）。</p>
<p>IP包首先从容器发往自己的默认网关docker0，包到达docker0后，也就到达了主机上。然后会查询主机的路由表，发现包应该从主机的eth0发往主机的网关10.10.105.254/24。</p>
<p>接着包会转发给eth0，并从eth0发出去（主机的ip_forward转发应该已经打开）。</p>
<p>这时候，上面的Iptable规则就会起作用，对包做SNAT转换，将源地址换为eth0的地址。这样，在外界看来，这个包就是从10.10.101.105上发出来的，Docker容器对外是不可见的。</p>
<p>那么，外面的机器是如何访问Docker容器的服务呢？我们首先用创建一个含有web应用的容器，将容器的80端口映射到主机的80端口。</p>
<p>然后查看Iptable规则的变化，发现多了这样一条规则：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-A DOCKER ! -i docker0 -p tcp -m tcp --dport 80 -j DNAT --to-destination 172.17.0.2:80</span><br></pre></td></tr></table></figure>
<p>此条规则就是对主机eth0收到的目的端口为80的tcp流量进行DNAT转换，将流量发往172.17.0.2:80，也就是我们上面创建的Docker容器。所以，外界只需访问10.10.101.105:80就可以访问到容器中的服务。</p>
<p>除此之外，我们还可以自定义Docker使用的IP地址、DNS等信息，甚至使用自己定义的网桥，但是其工作方式还是一样的。</p>
<h3 id="Host模式"><a href="#Host模式" class="headerlink" title="Host模式"></a>Host模式</h3><p>与宿主机在同一个网络中，但没有独立IP地址。</p>
<p>如果启动容器的时候使用host模式，那么这个容器将不会获得一个独立的Network Namespace，而是和宿主机共用一个Network Namespace。</p>
<p>容器将不会虚拟出自己的网卡，配置自己的IP等，而是使用宿主机的IP和端口。</p>
<h3 id="container模式-类比host"><a href="#container模式-类比host" class="headerlink" title="container模式(类比host)"></a>container模式(类比host)</h3><p>这个模式指定新创建的容器和已经存在的一个容器共享一个Network Namespace，而不是和宿主机共享。</p>
<p>新创建的容器不会创建自己的网卡，配置自己的IP，而是和一个指定的容器共享IP、端口范围等。同样，两个容器除了网络方面，其他的如文件系统、进程列表等还是隔离的。两个容器的进程可以通过lo网卡设备通信。</p>
<h3 id="none模式"><a href="#none模式" class="headerlink" title="none模式"></a>none模式</h3><p>该模式将容器放置在它自己的网络栈中，但是并不进行任何配置。</p>
<p>实际上，该模式关闭了容器的网络功能，在以下情况下是有用的：容器并不需要网络（例如只需要写磁盘卷的批处理任务）。</p>
<h3 id="自定义网络"><a href="#自定义网络" class="headerlink" title="自定义网络"></a>自定义网络</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network create --driver bridge new_bridge</span><br></pre></td></tr></table></figure>
<h2 id="Docker怎么建立image，创建容器？"><a href="#Docker怎么建立image，创建容器？" class="headerlink" title="Docker怎么建立image，创建容器？"></a>Docker怎么建立image，创建容器？</h2><ol>
<li>image建立</li>
</ol>
<div align="center"> <img src="https://img-blog.csdnimg.cn/20190927222252368.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl8zODQ5OTIxNQ==,size_16,color_FFFFFF,t_70" width=""> </div><br>


<ul>
<li><p>docker镜像由一层层layer组合起来</p>
</li>
<li><p>每一层layer对应的是Dockerfile中的一条指令</p>
</li>
<li><p>这些layer中，只有一层layer(container layer)为R/W，layer即</p>
</li>
<li><p>其他layer是read-only layer,均为image layer(R/O)</p>
</li>
<li><p>通常最后一层为CMD层或者ENTRYPOINT层，这一层是R/W的</p>
</li>
</ul>
<p>所有的容器其实都是共用一个image.镜像是只读的,每一层都是只读的.</p>
<p>在内核的上面,最底层是一个基础镜像层(Debian),如果想要在ubuntu基础镜像上装一个emacs编辑器,则只能在基础镜像之上,再去构建一个新的镜像层.</p>
<p>以此类推,如果想要在emacs镜像层上添加一个apache,则只能再在其上面再构建一个新的镜像层.每一层实际上都是挂载在宿主机相应的目录下.</p>
<h3 id="那么怎么做读写？"><a href="#那么怎么做读写？" class="headerlink" title="那么怎么做读写？"></a>那么怎么做读写？</h3><p>其实在镜像的最上层,还有一个读写层,在容器启动的时候为当前容器单独挂载.所有对容器的操作都发生在读写层.一旦容器销毁,这个读写层也会随之销毁.</p>
<p>所以 容器 = 镜像 + 读写层</p>
<p>对这个读写层的操作主要有写时复制和用时配置。</p>
<ul>
<li>写时复制</li>
</ul>
<p>所有的文件与数据都是从image读取.当要对文件进行写操作的时候,才从image把要写的文件复制到容器内的文件系统进行修改.</p>
<p>所以无论有多少个容器共享同一个image,所做的写操作其实都是对从image中复制到自己的文件系统中的复本中进行,不会修改image的源文件.</p>
<ul>
<li>用时配置</li>
</ul>
<p>启动一个新的容器的时候,并不会为这个容器预分配一些磁盘空间,而是当有新文件写入的时候,才会按需分配新空间.</p>
<ol start="2">
<li>创建容器</li>
</ol>
<ul>
<li><p>先创建容器,然后配置Namespace,创建父进程.</p>
</li>
<li><p>挂载文件系统然后替换init进程为用户进程</p>
</li>
<li><p>完成容器创建</p>
</li>
</ul>
<h2 id="容器引擎"><a href="#容器引擎" class="headerlink" title="容器引擎"></a>容器引擎</h2><div align="center"> <img src="https://segmentfault.com/img/bVbgQoC?w=639&h=285
" width=""> </div><br>

<h3 id="Docker-Daemon"><a href="#Docker-Daemon" class="headerlink" title="Docker Daemon"></a>Docker Daemon</h3><p>作为Docker容器管理的守护进程.守护进程模块不停的在重构，其基本功能和定位没有变化。和一般的CS架构系统一样，守护进程负责和Docker client交互，并管理Docker镜像、容器。</p>
<h3 id="Containerd"><a href="#Containerd" class="headerlink" title="Containerd"></a>Containerd</h3><div align="center"> <img src="https://upload-images.jianshu.io/upload_images/8911567-132e0c0087881517.png?imageMogr2/auto-orient/strip|imageView2/2/w/862/format/webp" width=""> </div><br>

<p>containerd主要职责是镜像管理（镜像、元信息等）、容器执行（调用最终运行时组件执行）。独立负责容器运行时和生命周期（如创建、启动、停止、中止、信号处理、删除等）。</p>
<p>containerd向上为Docker Daemon提供了gRPC接口，使得Docker Daemon屏蔽下面的结构变化，确保原有接口向下兼容。</p>
<p>向下通过containerd-shim结合runC，使得引擎可以<strong>独立升级</strong>，避免之前Docker Daemon升级会导致所有容器不可用的问题。</p>
<h3 id="docker-shim"><a href="#docker-shim" class="headerlink" title="docker-shim"></a>docker-shim</h3><p>docker-shim是一个真实运行的容器的真实垫片载体，每启动一个容器都会起一个新的docker-shim的一个进程，</p>
<p>他直接通过指定的三个参数：</p>
<p>容器id，boundle目录（containerd的对应某个容器生成的目录，一般位于：/var/run/docker/libcontainerd/containerID），运行时二进制（默认为runc）</p>
<p>来调用runc的api创建一个容器。</p>
<h3 id="RunC"><a href="#RunC" class="headerlink" title="RunC"></a>RunC</h3><p>runC基于libcontainer库，是用来运行容器的。</p>
<p>Docker默认提供了docker-runc实现，事实上，通过containerd的封装，可以在Docker Daemon启动的时候指定runc的实现。</p>
<h3 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h3><p>首先，需要创建容器标准包，这部分实际上由containerd的bundle模块实现，将Docker镜像转换成容器标准包。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker export $(docker create busybox) | tar -C rootfs -xvf -</span><br></pre></td></tr></table></figure>
<p>上述命令将busybox镜像解压缩到指定的rootfs目录中。如果本地不存在busybox镜像，containerd还会通过distribution模块去远程仓库拉取。</p>
<p>此时，准备所需的文件，接下来我们需要创建配置文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-runc spec</span><br></pre></td></tr></table></figure>
<p>此时会生成一个名为config.json的配置文件，该文件和Docker容器的配置文件类似，主要包含容器挂载信息、平台信息、进程信息等容器启动依赖的所有数据。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">runc run busybox</span><br><span class="line">或者</span><br><span class="line">docker-runc run busybox</span><br></pre></td></tr></table></figure>
<p>执行之后，我们可以看见容器已经启动：</p>
<p>此时，事实上已经可以不依赖Docker本身，如果系统上安装了runc包，即可运行容器。</p>
<p>从这里可以看到标准化的重要性。</p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color2">Docker</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2020/08/24/2020-08-24-Docker%E6%80%BB%E7%BB%93/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-2020-08-24-常用解题方法" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/08/24/2020-08-24-%E5%B8%B8%E7%94%A8%E8%A7%A3%E9%A2%98%E6%96%B9%E6%B3%95/">常用解题方法</a>
    </h1>
  

        
        <a href="/2020/08/24/2020-08-24-%E5%B8%B8%E7%94%A8%E8%A7%A3%E9%A2%98%E6%96%B9%E6%B3%95/" class="archive-article-date">
  	<time datetime="2020-08-23T16:00:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2020-08-24</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>优化做题步骤：<br>1.先找测试用例，枚举出特殊用例<br>    特殊用例优先顺序：<br>    1.1 为空（输入内容为0时/Tree问题root==null/空字符串）<br>    1.2 边界问题（组合问题单项内容就大于目标值时/数字有序，从一开始给的target值就小于最小值或者大于最大值/树问题的流程中遇到新赋值的节点是null,尤其注意在流程中出现的null，先判断null再判断其他(即&amp;&amp;关系中先写null再写别的)）<br>2.举几个简单的例子，确定整体思路<br>3.考虑边界，什么时候结束？base case是什么？</p>
<hr>
<p>算法复杂度:O(f(n))，表示算法复杂度的上界 &lt;= a * f(n)，有权值a的倍数关系–&gt;这个倍数对于算法复杂度来说只是倍数关系，在n无穷大时，不影响其趋势-&gt;所以就衍生出对于log n的复杂度，log的底一般不写，因为也只是差了个倍数log a b = log c b / log c a<br>for循环复杂度=循环次数*循环体内代码复杂度<br>if-else复杂度取决于if条件判断和else部分的复杂度最大的那一个</p>
<hr>
<p>一般的取余还可以用 num &amp; 0x1来做，×2可以用&lt;&lt;1来做，/2可以用&gt;&gt;1来做。<br>常用的取余mod模板：（有些题目他的范围会很大，所以需要mod取余的结果，一般返回int，过程中使用long，提前给一个MOD作为除数）：<br>这里只是在结果中单一的取余，在过程中如果ans也有的话，也要在过程中取余！！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 假设要对10^+7取余</span></span><br><span class="line"><span class="comment">// 使用pow函数，得到的结果是double类型，所以要强制转换为int，四舍五入</span></span><br><span class="line"><span class="keyword">int</span> MOD = (<span class="keyword">int</span>) Math.pow(<span class="number">10</span>, <span class="number">9</span>)+<span class="number">7</span>; </span><br><span class="line"><span class="comment">// 在计算过程中，要使用long来扩大数的范围，避免出错</span></span><br><span class="line"><span class="keyword">long</span> ans = <span class="number">0</span>;</span><br><span class="line"><span class="comment">// 直接取余的话结果还是long，又要强制转回来</span></span><br><span class="line"><span class="keyword">return</span> (<span class="keyword">int</span>) (ans % MOD);</span><br></pre></td></tr></table></figure>
<p>先找特例，然后想方法.<br>一般先考虑:为空，越界,链表（头尾节点/无节点/单节点），二维数组（单行/单列）等。<br>需要拼接的一般用StringBuilder。<br>需要判断前后的时候，若保留前面一个，可以从i=1~length；判断i和i-1(十分需要注意范围),但需要特殊处理i=0的情况<br>需要从后往前处理的问题，可以考虑把内容调转方向，如sb.reverse<br>需要从后往前数，可以直接int i=s.length()，然后从后往前给就好了。<br>遇到乘积问题，记得先初始化答案为1，否则的话像数组的初始化时默认为0，这样所有结果都是0.<br>传参时如果对参数进行改变，最好额外添加一个参数进行传递，避免在函数内改变了入参值。<br>涉及到队列queue问题，一定要把q.size单独赋值给一个int变量，否则如果直接把q.size放在for的判定循环里，随着q的入队出队，很可能会带来错误!!!<br>for(int i = num1.length() - 1, j = num2.length() - 1; i &gt;= 0 || j &gt;= 0; i–, j–){} //注意这里的i和j同步声明时，int只需要写一个，否则报错<br>for循环中，如果是一组一组的，可以尝试双for循环，并且每次int i+=circleLen，而不是单纯的i++，并且末尾挂出来的那些内容可以通过if判断当前索引是否小于length即可划开界限。<br>一个值在循环中修改后，在这个循环体后面最好别出现这个值。<br>对于循环加上的值，判断是否为0，否则会一直循环出问题。<br>    start = i - (len - 1) / 2;<br>    end = i + len / 2;<br>    回文中的起始点位置<br>树的遍历重建中，确定根之后，左子树的数总数|右子树的书总数不论在哪种序遍历中都是一样的，这是很重要的递归范围标准，注意数组边界的开闭。</p>
<hr>
<h1 id="链表"><a href="#链表" class="headerlink" title="链表"></a>链表</h1><p>!!!头结点删除:pHead = pHead.next;跳到后面去<br>–或者可以额外添加一个头结点<br>        ListNode head = new ListNode(Integer.MIN_VALUE);<br>        head.next = pHead;<br>        ListNode pre = head;<br>        ListNode cur = head.next;<br>ListNode answer = new ListNode(-1); //新建链表，val = -1，next = null;<br>判断链表是否为空: if(list1 != null)，不能用list.next来判断，因为这么判断的话，当前还在的节点就不好说了，还不如在上面直接list = list.next，后面没了自然就会是null的类型。<br>注意链表的赋值等实际上就是赋值当前节点，他赋予的是当前节点值和下一个节点指针，而一般题目中会在后续对next进行调整，所以head.next = list1这种，实际上就等同于把一个节点包含进来而已，因为后续肯定还要更改next的。</p>
<hr>
<h1 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h1><p>Arrays.sort(arr);直接对int数组进行排序，从小到大<br>row = array.length;<br>col = array[0].length;<br>Arrays.copyOfRange(pre, i + 1, pre.length) // 数组切割，左闭右开<br>数组大小直接用a.length就可以获得</p>
<hr>
<p>#字符串/数字转换<br>Integer.parseInt(str) //字符串转数字<br>Integer.toString(num) //数字转字符串<br>String.valueOf(num)   //数字转字符串<br>Str = num + “”        //数字转字符串<br>str.equals(“12”);     //字符串匹配判断</p>
<hr>
<h1 id="字符串-字符数组常用函数"><a href="#字符串-字符数组常用函数" class="headerlink" title="字符串/字符数组常用函数"></a>字符串/字符数组常用函数</h1><p>StringBuffer sb = new StringBuffer; sb.replace(i, i+1, “01”);// 这个很重要，replace函数会把某种当前字符更改为01,此时*<strong>后面的所有字符往后推**<em>，所以往后遍历时，你的字符串长度是要+1的，</em></strong>否则的话，大于原长位置的字符都不会被排查到。***<br>— 上面这种可以直接使用String strNew = sb.toString().replace(“a”, “dsfa”); 这是String特有的方法，直接替换完毕。<br>String[] strs = {“a”,”b”} //定义数组时都要用中括号<br>for(char c : S.toCharArray()){} //频繁使用于字符串问题中，把字符串改到字符数组进行处理<br>Character.isLetter() //用来判断是否是字母<br>Character.toLowerCase(ch); //大写转小写<br>Character.toUpperCase(ch); //小写转大写<br>String s; s.charAt(i) //查找第i个字符,获取字符串中的第i个字符时使用<br>String s.substring(start, end); //获取子串。[start, end)<br>String s.substring(start); //获取子串<br>String s.length()这个一般是开区间，因为以0为起始，所以判断时一般是i &lt; s.length();</p>
<p>String的用法：<br>//java中String是只读的，没有办法进行变换，因此需要使用StringBuilder。<br>String.split(“+ | -“) //注意: .$|*等转义字符，必须得加\;若有多个分隔符,用|作为连字符。<br>String.length() //获取字符串的长度<br>String.charAt(i) //获取第i个字符的内容<br>String.subString(start)   //获取[start,）的字符串<br>String.subString(start,end) //获取[start,end）中的字符串<br>char[] c = iniString.toCharArray() //将字符串转为char数组来进行改变字符内容<br>String.equal() //判断两个字符串是否相等<br>String.indexof(ch); // 查找索引</p>
<p>//字符的拼接，采用效率高的StringBuilder，其用法：<br>除了String中支持的方法外，StringBuilder支持字符的增、删、改。<br>StringBuilder sb = new StringBuilder();<br>stringBuilder.append(“we”);  // 添加we在词尾<br>sb.append(1); //这里会直接添加一个1的字符串，而不会报错！牛逼<br>stringBuilder.insert(0,”we”);// 在0的位置加入后面的内容<br>stringBuilder.reverse();    // 翻转，在一些从后往前的操作中有奇效<br>stringBuilder.delete(0,1);  // 删除[0,1)的数据<br>stringBuilder.deleteCharAt(0);<br>stringBuilder.setCharAt(0,’p’); //在某一个独特位置设置字符<br>char c = stringBuilder.charAt(i);//查询某个位置上的字符</p>
<hr>
<h1 id="HashMap常用的几个函数"><a href="#HashMap常用的几个函数" class="headerlink" title="HashMap常用的几个函数:"></a>HashMap常用的几个函数:</h1><p>适用范围:频率累计/<br>HashMap&lt;Integer, Integer&gt; map = new HashMap&lt;Integer, Integer&gt;();<br>map.put(key, value); //注意元素时String时用””，Character时用’’<br>map.get(key) //返回value，失败则为null<br>map.getOrDefault(key, defaultValue); //返回value，失败则为defaultValue<br>map.remove(key); //删除key, 返回key对应的value, 否则返回null<br>map.remove(key, value); //删除k-v对，失败返回false<br>map.containsKey(key); //查找key, 常用作判断<br>map.containsValue(value); //查找value<br>map.keySet(); //获取key列表</p>
<h2 id="典型应用"><a href="#典型应用" class="headerlink" title="典型应用"></a>典型应用</h2><ol>
<li>元素遍历<br>// 使用Iterator迭代器，专门用来对集合中的对象进行处理。.Iterator()函数返回集合的迭代器对象，对于这个Iterator可以使用相应的函数。<strong>用来做遍历是十分方便的，配合.hasNext()和.next()函数</strong><br> Iterator iterator = hashMap.keySet().iterator();<br> while (iterator.hasNext()){<pre><code> String key = (String)iterator.next();
 System.out.println(key+&quot;=&quot;+hashMap.get(key));
</code></pre>
 }</li>
<li>keySet遍历并操作<br>for(int num : map.keySet()){操作内容}</li>
<li>累计出现次数<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">HashMap&lt;Integer, Integer&gt; map = <span class="keyword">new</span> HashMap&lt;Integer, Integer&gt;();</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> num : nums) map.put(num, map.getOrDefault(num, <span class="number">0</span>) + <span class="number">1</span>);</span><br></pre></td></tr></table></figure>
</li>
</ol>
<hr>
<h1 id="HashSet常用的几个函数"><a href="#HashSet常用的几个函数" class="headerlink" title="HashSet常用的几个函数:"></a>HashSet常用的几个函数:</h1><p>判断重复的问题一般可以使用HashSet<br>HashSet<Character> set = new HashSet&lt;&gt;();<br>set.length<br>set.add(value);<br>set.remove(value);</p>
<hr>
<h1 id="List数据结构（-线性表-，这里使用的是动态数组类ArrayList）"><a href="#List数据结构（-线性表-，这里使用的是动态数组类ArrayList）" class="headerlink" title="List数据结构（!!!线性表!!!，这里使用的是动态数组类ArrayList）"></a>List数据结构（!!!线性表!!!，这里使用的是动态数组类ArrayList）</h1><p>不论是什么List，是List还是套List，都可以直接用ArrayList类来直接创建<br>List<String> list = new ArrayList();<br>list.add(index, element);// 在index位置插入内容，其后内容索引+1<br>–特例用法list.add(0, element)在索引第一个位置加入内容，即可以在头部插入新内容，常用于List的倒序翻转<br>list.add(element);<br>list.get(i); //获取第i个内容，索引从0开始。<br>list.isEmpty(); //判断是否为空<br>list.size();    //元素个数<br>list.remove(index)</p>
<hr>
<h1 id="栈数据结构"><a href="#栈数据结构" class="headerlink" title="栈数据结构"></a>栈数据结构</h1><p>Stack<Integer> st = new Stack<Ingeter>();<br>st.push(ch);<br>char ch = st.pop(); //直接取出顶部元素内容赋值给ch<br>st.isEmpty(); // 返回boolean值,这是Vector的方法，return elementCount == 0;所以当内容为null时会抛出异常，不建议这么使用。<br>st.empty(); // 同样的判断空否。这里调用vector中的size()函数，再判断是否为空。 return size() == 0;所以会避开null异常的抛出，用这个。<br>st.peek();     // 获取栈顶元素</p>
<hr>
<h1 id="位运算"><a href="#位运算" class="headerlink" title="位运算"></a>位运算</h1><p>测试第 k 位: s &amp; (1 &lt;&lt; k)<br>设置第 k 位: s |= (1 &lt;&lt; k)<br>第 k 位置零: s &amp;= ~(1 &lt;&lt; k)<br>切换第 k 位值: s ^= ~(1 &lt;&lt; k)<br>乘以 2n: s &lt;&lt; n<br>除以 2n: s &gt;&gt; n<br>交集: s &amp; t<br>并集: s | t<br>减法: s &amp; ~t<br>交换 x = x ^ y ^ (y = x)<br>取出最小非 0 位（Extract lowest set bit）: s &amp; (-s)<br>取出最小 0 位（Extract lowest unset bit）: ~s &amp; (s + 1)<br>交换值: x ^= y; y ^= x; x ^= y;<br>n = n &amp; (n-1)  =&gt;  消除n最右侧的1(如10110, 得到10100)<br>a = n &amp; -n  =&gt;  得到n最低位的1(如10100，得到00100)</p>
<hr>
<h1 id="队列-LinkedList和ArrayList的区别"><a href="#队列-LinkedList和ArrayList的区别" class="headerlink" title="队列(LinkedList和ArrayList的区别)"></a>队列(LinkedList和ArrayList的区别)</h1><p>import java.util.Queue;<br>import java.util.LinkedList;<br>// 队列queue接口在java中使用LinkedList实现的，所以新建时要这么用<br>Queue<TreeNode> queue = new LinkedList<TreeNode>();<br>queue.offer(node);    //添加内容<br>node = queue.poll(); //访问队头并抛出<br>node = queue.peek(); //访问队头,不抛出<br>涉及到队列queue问题，一定要把q.size单独赋值给一个int变量，否则如果直接把q.size放在for的判定循环里，随着q的入队出队，很可能会带来错误!!!<br>int len = queue.size();for(int i = 0; i &lt; len; i++){}  //这个是正确的<br>for(int i = 0; i &lt; queue.size(); i++){} //这里边如果有入队出队操作,结果必然错误</p>
<hr>
<h1 id="二分查找"><a href="#二分查找" class="headerlink" title="二分查找"></a>二分查找</h1><p>// 限定于有序数组中。将需要找的位置局限在 [left, right] 之间，判断区间中位数是否是内容。最终当 left &gt; right 表明不存在，当 left == right 时，表明只剩下一种可能，判断这个值是否满足条件，若满足，则求出结果，不满足表明不存在。<br>public int findLeftBorder(int[] arr, int num, int left, int right) {<br>    if (left &gt; right) {<br>        return -1;<br>    } else if (left == right) {<br>        return arr[left] == num ? left : -1;<br>    }<br>    int mid = (left + right) / 2;<br>    if (arr[mid] &gt; num) {<br>        return findLeftBorder(arr, num, left, mid - 1);<br>    } else if (arr[mid] == num) {<br>        return findLeftBorder(arr, num, left, mid);<br>    } else {<br>         return findLeftBorder(arr, num, mid + 1, right);<br>    }<br>}</p>
<hr>
<h1 id="动态规划"><a href="#动态规划" class="headerlink" title="动态规划"></a>动态规划</h1><p>什么样的题目适合使用动态规划？<br>    一般是以下三种，因为DP一般就求一个结果值。<br>    最大值/最小值<br>    是否可行<br>    方案总数<br>动态规划的一般步骤：<br>    确定dp[i]或dp[i][j]代表的含义(基础一步, dp含义弄错了不利于得到它的递推式)<br>    根据dp表示的含义, 得到它的递推式(关键, 也是最难的一步)，检查不同方式得到的递推式右边值，对整体结果会不会有影响(检查后效性)<br>    弄清楚题目要求的结果怎么由dp得到(动手之前需要思考的问题, 结果不一定是dp[0]或dp[n1][n2])<br>    dp的basecase有哪些, 必须确定好basecase, 才能使用递推式逐步得到结果的dp值<br>无后效性：如果给定某一阶段的状态，则在这一阶段以后过程的发展不受这阶段以前各段状态的影响。</p>
<p>比如dp[i] = dp[i - 1] + dp[i - 2]，意思就是确定了dp[i - 1]和dp[i - 2]后，就可以确定dp[i]，而dp[i-1] 和 dp[i-2]本身是由什么过程确定的，不会影响dp[i]的结果。</p>
<p>如斐波那契数列:<br>class Solution {<br>    public int climbStairs(int n) {<br>        if(n &lt; 3){<br>            return n;<br>        }<br>        int[] dp = new int[n+1];<br>        dp[1] = 1;<br>        dp[2] = 2;<br>        for(int i=3; i&lt;=n; i++){<br>            dp[i] = dp[i-1] + dp[i-2];<br>        }<br>        return dp[n];<br>    }<br>}</p>
<hr>
<p>java题的输入获取:<br>示例:<br>1231<br>adfsfasd<br>fsd<br>算法:<br>import java.util.Scanner;<br>public class Main {<br>    public static void main(String[] args) {<br>        Scanner sc=new Scanner(System.in);<br>        while (sc.hasNext()){<br>            String str=sc.next();<br>            // 函数体内容<br>            //输出<br>            System.out.println(str);<br>        }<br>    }<br>}<br>示例:<br>1<br>3<br>算法:<br>import java.util.Scanner;<br>public class Main {<br>    public static void main(String[] args) {<br>        Scanner sc=new Scanner(System.in);<br>        while (sc.hasNextInt()){<br>            int n = sc.nextInt();<br>            // 函数体内容<br>            //输出<br>            System.out.println(n);<br>        }<br>    }<br>}<br>示例:输出行列和数字矩阵<br>2 3<br>1 3 2<br>3 1 3<br>2 2<br>2 2<br>1 3<br>public class Class_4 {<br>    public static void main(String[] args) {<br>        Scanner scan = new Scanner(System.in);<br>        while(scan.hasNext()){<br>            int m = scan.nextInt();<br>            int n = scan.nextInt() ;<br>            int [][] array = new int[m][n] ;<br>            for (int i=0 ; i&lt;m ; i++){<br>                for(int j=0 ;j&lt;n ;j++)<br>                {<br>                    array[i][j]=scan.nextInt();<br>                }<br>            }<br>        }<br>    }<br>}<br>示例:输入行数和多行带分隔的字符串<br>3<br>1,2<br>3,4,2<br>3,2,1<br>1<br>1,2,3<br>算法:<br>import java.util.Scanner;<br>public class Main {<br>    public static void main(String[] args) {<br>        Scanner sc=new Scanner(System.in);<br>        while (sc.hasNext()){<br>            int n = sc.nextInt();<br>            List<String> lines = new ArrayList&lt;&gt;();<br>            // 输入问题，我这里指定了n为数组的个数<br>            for (int i = 0; i &lt; n; i++) {<br>                //获取下面几行内容,存为String,再分割,保存为int数组<br>                String a = scan.next();<br>                if (a.isEmpty() || a.length() == 0) {<br>                    break;<br>                } else {<br>                    lines.add(a);<br>                }<br>            }<br>            // 函数体内容<br>            String tmp;<br>            for (int i = 0; i &lt; lines.size(); i++) {<br>                tmp = lines.get(i);<br>                // 获取数组<br>                String[] nums = tmp.split(“,”);<br>            }<br>            //输出<br>            System.out.println();<br>        }<br>    }<br>}</p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">秋招</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2020/08/24/2020-08-24-%E5%B8%B8%E7%94%A8%E8%A7%A3%E9%A2%98%E6%96%B9%E6%B3%95/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-2020-08-24-MySQL内容" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/08/24/2020-08-24-MySQL%E5%86%85%E5%AE%B9/">SQL语句基础</a>
    </h1>
  

        
        <a href="/2020/08/24/2020-08-24-MySQL%E5%86%85%E5%AE%B9/" class="archive-article-date">
  	<time datetime="2020-08-23T16:00:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2020-08-24</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="SQL语句基础"><a href="#SQL语句基础" class="headerlink" title="SQL语句基础"></a>SQL语句基础</h1><h1 id="一、基础"><a href="#一、基础" class="headerlink" title="一、基础"></a>一、基础</h1><p>模式(基本表的集合)定义了数据如何存储、存储什么样的数据以及数据如何分解等信息，数据库和表都有模式。</p>
<p>主键能够唯一的标识表中的每一个行。这样的一列或者多列成为表的主键，通过它可以强制表的实体完整性。当创建或者更改表时可以通过定义PRIMARY KEY约束来创建主键，一个表只能有一个主键约束。主键的值不允许修改，也不允许复用（不能将已经删除的主键值赋给新数据行的主键）。</p>
<p>SQL（Structured Query Language)，标准 SQL 由 ANSI 标准委员会管理，从而称为 ANSI SQL。各个 DBMS 都有自己的实现，如 PL/SQL、Transact-SQL 等。</p>
<p>SQL 语句不区分大小写，但是数据库表名、列名和值是否区分大小写依赖于具体的 DBMS(数据库管理系统) 以及配置。</p>
<p>数据库创建与使用：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> DATABASE test;</span><br><span class="line">USE test;</span><br></pre></td></tr></table></figure>
<p><strong>主键</strong>：关系型数据库中的一条记录中有若干个属性，若其中某一个属性组(注意是组，可以多列)能唯一标识一条记录，该属性组就可以成为一个主键。</p>
<p>eg:</p>
<p>学生表(学号，姓名，性别，班级)</p>
<p>其中每个学生的<strong>学号是唯一</strong>的，学号就是一个主键</p>
<p>课程表(课程编号,课程名,学分)</p>
<p>其中<strong>课程编号是唯一</strong>的,课程编号就是一个主键</p>
<p>成绩表(学号,课程号,成绩) </p>
<p>成绩表中单一一个属性无法唯一标识一条记录，<strong>学号和课程号的组合才可以唯一标识一条记录</strong>，所以学号和课程号的属性组是一个主键</p>
<p>1.主键是能确定一条记录的唯一标识，比如，一条记录包括身份正号，姓名，年龄。</p>
<p>身份证号是唯一能确定你这个人的，其他都可能有重复，所以，身份证号是主键。 </p>
<p>2.外键用于与另一张表的关联。是能确定另一张表记录的字段，用于保持数据的一致性。</p>
<p>比如，A表中的一个字段，是B表的主键，那他就可以是A表的外键。</p>
<p>如果没有主键，则按照下列规则来建聚簇索引</p>
<p>没有主键时，会用一个唯一且不为空的索引列做为主键，成为此表的聚簇索引</p>
<p>如果没有这样的索引，InnoDB会隐式定义一个主键来作为聚簇索引。</p>
<h1 id="二、创建表"><a href="#二、创建表" class="headerlink" title="二、创建表"></a>二、创建表</h1><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> mytable (</span><br><span class="line">  # <span class="type">int</span> 类型，不为空，自增</span><br><span class="line">  id <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  # <span class="type">int</span> 类型，不可为空，默认值为 <span class="number">1</span>，不为空</span><br><span class="line">  col1 <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">1</span>,</span><br><span class="line">  # 变长字符串类型，最长为 <span class="number">45</span> 个字符，可以为空</span><br><span class="line">  col2 <span class="type">VARCHAR</span>(<span class="number">45</span>) <span class="keyword">NULL</span>,</span><br><span class="line">  # 日期类型，可为空</span><br><span class="line">  col3 <span class="type">DATE</span> <span class="keyword">NULL</span>,</span><br><span class="line">  # 设置主键为 id</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`));</span><br></pre></td></tr></table></figure>
<h1 id="三、修改表"><a href="#三、修改表" class="headerlink" title="三、修改表"></a>三、修改表</h1><p>添加列 ALTER语句</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> mytable</span><br><span class="line"><span class="keyword">ADD</span> col <span class="type">CHAR</span>(<span class="number">20</span>);</span><br></pre></td></tr></table></figure>
<p>删除列和表 删除列、表等大集体一般用的是DROP</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> mytable</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">COLUMN</span> col;</span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> mytable;</span><br></pre></td></tr></table></figure>
<h1 id="四、插入"><a href="#四、插入" class="headerlink" title="四、插入"></a>四、插入</h1><p>普通插入多个数据 INSERT INTO，mytable(col1, col2)标记插入哪个表哪列</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> mytable(col1, col2)</span><br><span class="line"><span class="keyword">VALUES</span></span><br><span class="line">(val1, val2),</span><br><span class="line">(val3, val4);</span><br></pre></td></tr></table></figure>
<p>插入检索出来的数据 注意数据维度相同</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> mytable1(col1, col2)</span><br><span class="line"><span class="keyword">SELECT</span> col1, col2</span><br><span class="line"><span class="keyword">FROM</span> mytable2;</span><br></pre></td></tr></table></figure>
<p>将一个表的内容插入到一个新表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> newtable <span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> mytable;</span><br></pre></td></tr></table></figure>
<h1 id="五、更新"><a href="#五、更新" class="headerlink" title="五、更新"></a>五、更新</h1><p>更新内容 UPDATE .. SET A=B</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">UPDATE mytable</span><br><span class="line"><span class="keyword">SET</span> col <span class="operator">=</span> val</span><br><span class="line"><span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<h1 id="六、删除"><a href="#六、删除" class="headerlink" title="六、删除"></a>六、删除</h1><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> mytable</span><br><span class="line"><span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<p><strong>TRUNCATE TABLE</strong>   可以清空表，也就是删除所有行。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">TRUNCATE</span> <span class="keyword">TABLE</span> mytable;</span><br></pre></td></tr></table></figure>
<p><strong>使用更新和删除操作时一定要用 WHERE 子句，不然会把整张表的数据都破坏。可以先用 SELECT 语句进行测试，防止错误删除。</strong></p>
<h1 id="七、查询"><a href="#七、查询" class="headerlink" title="七、查询"></a>七、查询</h1><h2 id="DISTINCT"><a href="#DISTINCT" class="headerlink" title="DISTINCT"></a>DISTINCT</h2><p><strong>去重</strong>查询。相同值只会出现一次。它作用于所有列，也就是说所有列的值都相同才算相同。</p>
<p>使用时可以把它当做一个修饰符，所以一定是放在目标列前面的，但这个DISTINCT不是函数，所以不加括号。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> col1, col2</span><br><span class="line"><span class="keyword">FROM</span> mytable;</span><br></pre></td></tr></table></figure>
<h2 id="LIMIT"><a href="#LIMIT" class="headerlink" title="LIMIT"></a>LIMIT</h2><p>限制返回的行数。可以有两个参数，第一个参数为起始行，从 0 开始；第二个参数为返回的总行数。</p>
<p>返回第 3 ~ 5 行：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> mytable</span><br><span class="line">LIMIT <span class="number">2</span>, <span class="number">3</span>;</span><br></pre></td></tr></table></figure>
<h1 id="八、排序"><a href="#八、排序" class="headerlink" title="八、排序"></a>八、排序</h1><ul>
<li>  <strong>ASC</strong>  ：升序（默认）</li>
<li>  <strong>DESC</strong>  ：降序</li>
</ul>
<p>可以按多个列进行排序，并且为每个列指定不同的排序方式：ORDER一般放在语句最后。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> mytable</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> col1 <span class="keyword">DESC</span>, col2 <span class="keyword">ASC</span>;</span><br></pre></td></tr></table></figure>
<h1 id="九、过滤"><a href="#九、过滤" class="headerlink" title="九、过滤"></a>九、过滤</h1><p>不进行过滤的数据非常大，导致通过网络传输了多余的数据，从而浪费了网络带宽。因此尽量使用 SQL 语句来过滤不必要的数据，而不是传输所有的数据到客户端中然后由客户端进行过滤。使用WHERE进行过滤。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> mytable</span><br><span class="line"><span class="keyword">WHERE</span> col <span class="keyword">IS</span> <span class="keyword">NULL</span>;</span><br></pre></td></tr></table></figure>
<p>下表显示了 WHERE 子句可用的操作符</p>
<table>
<thead>
<tr>
<th align="center">操作符</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">=</td>
<td align="center">等于</td>
</tr>
<tr>
<td align="center">&lt;</td>
<td align="center">小于</td>
</tr>
<tr>
<td align="center">&gt;</td>
<td align="center">大于</td>
</tr>
<tr>
<td align="center">&lt;&gt; !=</td>
<td align="center">不等于</td>
</tr>
<tr>
<td align="center">&lt;= !&gt;</td>
<td align="center">小于等于</td>
</tr>
<tr>
<td align="center">&gt;= !&lt;</td>
<td align="center">大于等于</td>
</tr>
<tr>
<td align="center">BETWEEN</td>
<td align="center">在两个值之间</td>
</tr>
<tr>
<td align="center">IS NULL</td>
<td align="center">为 NULL 值</td>
</tr>
</tbody></table>
<p>应该注意到，NULL 与 0、空字符串都不同。</p>
<p><strong>AND 和 OR</strong>   用于连接多个过滤条件。优先处理 AND，当一个过滤表达式涉及到多个 AND 和 OR 时，可以使用 () 来决定优先级，使得优先级关系更清晰。</p>
<p><strong>IN</strong>   操作符用于匹配一组值，其后也可以接一个 SELECT 子句，从而匹配子查询得到的一组值。</p>
<p><strong>NOT</strong>   操作符用于否定一个条件。</p>
<h1 id="十、通配符"><a href="#十、通配符" class="headerlink" title="十、通配符"></a>十、通配符</h1><p>通配符也是用在过滤语句中，但它<strong>只能用于文本字段</strong>。</p>
<ul>
<li><p>  <strong>%</strong>   匹配 &gt;=0 个任意字符；</p>
</li>
<li><p>  <strong>_</strong>   匹配 ==1 个任意字符；</p>
</li>
<li><p>  <strong>[ ]</strong>   可以匹配集合内的字符，例如 [ab] 将匹配字符 a 或者 b。用脱字符 ^ 可以对其进行否定，也就是不匹配集合内的字符。</p>
</li>
</ul>
<p>使用 Like 来进行通配符匹配。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> mytable</span><br><span class="line"><span class="keyword">WHERE</span> col <span class="keyword">LIKE</span> <span class="string">&#x27;[^AB]%&#x27;</span>; <span class="comment">-- 不以 A 和 B 开头的任意文本</span></span><br></pre></td></tr></table></figure>
<p>不要滥用通配符，通配符位于开头处匹配会非常慢。</p>
<h1 id="十一、计算字段"><a href="#十一、计算字段" class="headerlink" title="十一、计算字段"></a>十一、计算字段</h1><p>在数据库服务器上完成数据的转换和格式化的工作往往比客户端上快得多，并且转换和格式化后的数据量更少的话可以减少网络通信量。</p>
<p>计算字段通常需要使用   <strong>AS</strong>   来取别名，否则输出的时候字段名为计算表达式。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> col1 <span class="operator">*</span> col2 <span class="keyword">AS</span> alias</span><br><span class="line"><span class="keyword">FROM</span> mytable;</span><br></pre></td></tr></table></figure>
<p><strong>CONCAT()</strong>   用于连接两个字段。许多数据库会使用空格把一个值填充为列宽，因此连接的结果会出现一些不必要的空格，使用 <strong>TRIM()</strong> 可以去除首尾空格。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> CONCAT(<span class="built_in">TRIM</span>(col1), <span class="string">&#x27;(&#x27;</span>, <span class="built_in">TRIM</span>(col2), <span class="string">&#x27;)&#x27;</span>) <span class="keyword">AS</span> concat_col</span><br><span class="line"><span class="keyword">FROM</span> mytable;</span><br></pre></td></tr></table></figure>
<h1 id="十二、函数"><a href="#十二、函数" class="headerlink" title="十二、函数"></a>十二、函数</h1><p>各个 DBMS 的函数都是不相同的，因此不可移植，以下主要是 MySQL 的函数。</p>
<h2 id="汇总"><a href="#汇总" class="headerlink" title="汇总"></a>汇总</h2><table>
<thead>
<tr>
<th align="center">函 数</th>
<th align="center">说 明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">AVG()</td>
<td align="center">返回某列的平均值</td>
</tr>
<tr>
<td align="center">COUNT()</td>
<td align="center">返回某列的行数</td>
</tr>
<tr>
<td align="center">MAX()</td>
<td align="center">返回某列的最大值</td>
</tr>
<tr>
<td align="center">MIN()</td>
<td align="center">返回某列的最小值</td>
</tr>
<tr>
<td align="center">SUM()</td>
<td align="center">返回某列值之和</td>
</tr>
</tbody></table>
<p>AVG() 会忽略 NULL 行。</p>
<p>使用 DISTINCT 可以汇总不同的值。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">AVG</span>(<span class="keyword">DISTINCT</span> col1) <span class="keyword">AS</span> avg_col</span><br><span class="line"><span class="keyword">FROM</span> mytable;</span><br></pre></td></tr></table></figure>
<h1 id="十三、分组"><a href="#十三、分组" class="headerlink" title="十三、分组"></a>十三、分组</h1><p>把具有相同的数据值的行放在同一组中。</p>
<p>可以对同一分组数据使用汇总函数进行处理，例如求分组数据的平均值等。</p>
<p>指定的分组字段除了能按该字段进行分组，也会自动按该字段进行排序。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> col, <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> num</span><br><span class="line"><span class="keyword">FROM</span> mytable</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> col;</span><br></pre></td></tr></table></figure>
<p>GROUP BY 自动按分组字段进行排序，ORDER BY 也可以按汇总字段来进行排序。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> col, <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> num</span><br><span class="line"><span class="keyword">FROM</span> mytable</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> col</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> num;</span><br></pre></td></tr></table></figure>
<p>WHERE 过滤行，HAVING 过滤分组，行过滤应当先于分组过滤。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> col, <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> num</span><br><span class="line"><span class="keyword">FROM</span> mytable</span><br><span class="line"><span class="keyword">WHERE</span> col <span class="operator">&gt;</span> <span class="number">2</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> col</span><br><span class="line"><span class="keyword">HAVING</span> num <span class="operator">&gt;=</span> <span class="number">2</span>;</span><br></pre></td></tr></table></figure>
<p>分组规定：</p>
<ul>
<li>GROUP BY 子句出现在 WHERE 子句之后，ORDER BY 子句之前；</li>
<li>除了汇总字段外，SELECT 语句中的每一字段都必须在 GROUP BY 子句中给出；</li>
<li>NULL 的行会单独分为一组；</li>
<li>大多数 SQL 实现不支持 GROUP BY 列具有可变长度的数据类型。</li>
</ul>
<h1 id="十五、连接-关键"><a href="#十五、连接-关键" class="headerlink" title="十五、连接(!!!关键!!!)"></a>十五、连接(!!!关键!!!)</h1><p>连接用于连接多个表，使用 JOIN … ON 。</p>
<p>连接可以替换子查询，并且比子查询的效率一般会更快。可以用 AS 给列名、计算字段和表名取别名，给表名取别名是为了简化 SQL 语句以及连接相同表。</p>
<h2 id="内连接，用于查找两表中匹配的数据"><a href="#内连接，用于查找两表中匹配的数据" class="headerlink" title="内连接，用于查找两表中匹配的数据"></a>内连接，用于查找两表中匹配的数据</h2><p>内连接又称等值连接，使用 INNER JOIN 关键字，返回两表ON中匹配的列中查询的数值，如下面就返回key相同的A和B的value组成的结果。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> A.value, B.value</span><br><span class="line"><span class="keyword">FROM</span> tablea <span class="keyword">AS</span> A <span class="keyword">INNER</span> <span class="keyword">JOIN</span> tableb <span class="keyword">AS</span> B</span><br><span class="line"><span class="keyword">ON</span> A.key <span class="operator">=</span> B.key;</span><br></pre></td></tr></table></figure>
<h2 id="自连接"><a href="#自连接" class="headerlink" title="自连接"></a>自连接</h2><p>自连接可以看成内连接的一种，不过是自己和自己连接。</p>
<p>一张员工表，包含员工姓名和员工所属部门，要找出与 Jim 处在同一部门的所有员工姓名。</p>
<p>自连接中就是把内连接中A=B表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> e1.name</span><br><span class="line"><span class="keyword">FROM</span> employee <span class="keyword">AS</span> e1 <span class="keyword">INNER</span> <span class="keyword">JOIN</span> employee <span class="keyword">AS</span> e2</span><br><span class="line"><span class="keyword">ON</span> e1.department <span class="operator">=</span> e2.department</span><br><span class="line">      <span class="keyword">AND</span> e2.name <span class="operator">=</span> &quot;Jim&quot;;</span><br></pre></td></tr></table></figure>
<h2 id="自然连接"><a href="#自然连接" class="headerlink" title="自然连接"></a>自然连接</h2><p>自然连接是把同名列通过等值测试连接起来的，同名列可以有多个。</p>
<p>内连接和自然连接的区别：内连接提供连接的列，而自然连接自动连接所有同名列。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> A.value, B.value</span><br><span class="line"><span class="keyword">FROM</span> tablea <span class="keyword">AS</span> A <span class="keyword">NATURAL</span> <span class="keyword">JOIN</span> tableb <span class="keyword">AS</span> B;</span><br></pre></td></tr></table></figure>
<h2 id="外连接-重要"><a href="#外连接-重要" class="headerlink" title="外连接(!!!重要!!!)"></a>外连接(!!!重要!!!)</h2><p>外连接保留没有关联的那些行。分为左外连接，右外连接以及全外连接，左外连接就是保留LEFT OUTER JOIN字段左侧表没有关联的行，右外连接同理。</p>
<p>检索所有顾客的订单信息，包括还没有订单信息的顾客。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> Customers.cust_id, Orders.order_num</span><br><span class="line"><span class="keyword">FROM</span> Customers <span class="keyword">LEFT</span> <span class="keyword">OUTER</span> <span class="keyword">JOIN</span> Orders</span><br><span class="line"><span class="keyword">ON</span> Customers.cust_id <span class="operator">=</span> Orders.cust_id;</span><br></pre></td></tr></table></figure>
<p>customers 表：</p>
<table>
<thead>
<tr>
<th align="center">cust_id</th>
<th align="center">cust_name</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td align="center">a</td>
</tr>
<tr>
<td align="center">2</td>
<td align="center">b</td>
</tr>
<tr>
<td align="center">3</td>
<td align="center">c</td>
</tr>
</tbody></table>
<p>orders 表：</p>
<table>
<thead>
<tr>
<th align="center">order_id</th>
<th align="center">cust_id</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td align="center">1</td>
</tr>
<tr>
<td align="center">2</td>
<td align="center">1</td>
</tr>
<tr>
<td align="center">3</td>
<td align="center">3</td>
</tr>
<tr>
<td align="center">4</td>
<td align="center">3</td>
</tr>
</tbody></table>
<p>结果：(把id相同的)</p>
<table>
<thead>
<tr>
<th align="center">cust_id</th>
<th align="center">cust_name</th>
<th align="center">order_id</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td align="center">a</td>
<td align="center">1</td>
</tr>
<tr>
<td align="center">1</td>
<td align="center">a</td>
<td align="center">2</td>
</tr>
<tr>
<td align="center">3</td>
<td align="center">c</td>
<td align="center">3</td>
</tr>
<tr>
<td align="center">3</td>
<td align="center">c</td>
<td align="center">4</td>
</tr>
<tr>
<td align="center">2</td>
<td align="center">b</td>
<td align="center">Null</td>
</tr>
</tbody></table>
<h1 id="十六、组合查询"><a href="#十六、组合查询" class="headerlink" title="十六、组合查询"></a>十六、组合查询</h1><p>使用   <strong>UNION</strong>   来组合两个查询，如果第一个查询返回 M 行，第二个查询返回 N 行，那么组合查询的结果一般为 M+N 行。<strong>默认会去除相同行</strong>，如果需要保留相同行，使用 UNION ALL。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> col</span><br><span class="line"><span class="keyword">FROM</span> mytable</span><br><span class="line"><span class="keyword">WHERE</span> col <span class="operator">=</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">UNION</span></span><br><span class="line"><span class="keyword">SELECT</span> col</span><br><span class="line"><span class="keyword">FROM</span> mytable</span><br><span class="line"><span class="keyword">WHERE</span> col <span class="operator">=</span><span class="number">2</span>;</span><br></pre></td></tr></table></figure>
<h1 id="十七、视图"><a href="#十七、视图" class="headerlink" title="十七、视图"></a>十七、视图</h1><p>视图是虚拟的表，本身不包含数据，也就不能对其进行索引操作。</p>
<p>对视图的操作和对普通表的操作一样。</p>
<p>视图具有如下好处：</p>
<ul>
<li>简化复杂的 SQL 操作，比如复杂的连接；</li>
<li>只使用实际表的一部分数据；</li>
<li>通过只给用户访问视图的权限，保证数据的安全性；</li>
<li>更改数据格式和表示。</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> myview <span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> Concat(col1, col2) <span class="keyword">AS</span> concat_col, col3<span class="operator">*</span>col4 <span class="keyword">AS</span> compute_col</span><br><span class="line"><span class="keyword">FROM</span> mytable</span><br><span class="line"><span class="keyword">WHERE</span> col5 <span class="operator">=</span> val;</span><br></pre></td></tr></table></figure>
<h1 id="十八、存储过程"><a href="#十八、存储过程" class="headerlink" title="十八、存储过程"></a>十八、存储过程</h1><p>存储过程可以看成是对一系列 SQL 操作的批处理。</p>
<p>使用存储过程的好处：</p>
<ul>
<li>代码封装，保证了一定的安全性；</li>
<li>代码复用；</li>
<li>由于是预先编译，因此具有很高的性能。</li>
</ul>
<p>命令行中创建存储过程需要自定义分隔符，因为命令行是以 ; 为结束符，而存储过程中也包含了分号，因此会错误把这部分分号当成是结束符，造成语法错误。</p>
<p>包含 in、out 和 inout 三种参数。</p>
<p>给变量赋值都需要用 select into 语句。</p>
<p>每次只能给一个变量赋值，不支持集合的操作。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">delimiter <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> myprocedure( <span class="keyword">out</span> ret <span class="type">int</span> )</span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">declare</span> y <span class="type">int</span>;</span><br><span class="line">        <span class="keyword">select</span> <span class="built_in">sum</span>(col1)</span><br><span class="line">        <span class="keyword">from</span> mytable</span><br><span class="line">        <span class="keyword">into</span> y;</span><br><span class="line">        <span class="keyword">select</span> y<span class="operator">*</span>y <span class="keyword">into</span> ret;</span><br><span class="line">    <span class="keyword">end</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"></span><br><span class="line">delimiter ;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">call</span> myprocedure(<span class="variable">@ret</span>);</span><br><span class="line"><span class="keyword">select</span> <span class="variable">@ret</span>;</span><br></pre></td></tr></table></figure>
<h1 id="十九、游标"><a href="#十九、游标" class="headerlink" title="十九、游标"></a>十九、游标</h1><p>在存储过程中使用游标可以对一个结果集进行移动遍历。</p>
<p>游标主要用于交互式应用，其中用户需要对数据集中的任意行进行浏览和修改。</p>
<p>使用游标的四个步骤：</p>
<ol>
<li>声明游标，这个过程没有实际检索出数据；</li>
<li>打开游标；</li>
<li>取出数据；</li>
<li>关闭游标；</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">delimiter <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> myprocedure(<span class="keyword">out</span> ret <span class="type">int</span>)</span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">declare</span> done <span class="type">boolean</span> <span class="keyword">default</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">declare</span> mycursor <span class="keyword">cursor</span> <span class="keyword">for</span></span><br><span class="line">        <span class="keyword">select</span> col1 <span class="keyword">from</span> mytable;</span><br><span class="line">        # 定义了一个 continue handler，当 <span class="keyword">sqlstate</span> <span class="string">&#x27;02000&#x27;</span> 这个条件出现时，会执行 <span class="keyword">set</span> done <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">        <span class="keyword">declare</span> continue handler <span class="keyword">for</span> <span class="keyword">sqlstate</span> <span class="string">&#x27;02000&#x27;</span> <span class="keyword">set</span> done <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">open</span> mycursor;</span><br><span class="line"></span><br><span class="line">        repeat</span><br><span class="line">            <span class="keyword">fetch</span> mycursor <span class="keyword">into</span> ret;</span><br><span class="line">            <span class="keyword">select</span> ret;</span><br><span class="line">        until done <span class="keyword">end</span> repeat;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">close</span> mycursor;</span><br><span class="line">    <span class="keyword">end</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"> delimiter ;</span><br></pre></td></tr></table></figure>
<h1 id="二十、触发器"><a href="#二十、触发器" class="headerlink" title="二十、触发器"></a>二十、触发器</h1><p>触发器会在某个表执行以下语句时而自动执行：DELETE、INSERT、UPDATE。</p>
<p>触发器必须指定在语句执行之前还是之后自动执行，之前执行使用 BEFORE 关键字，之后执行使用 AFTER 关键字。BEFORE 用于数据验证和净化，AFTER 用于审计跟踪，将修改记录到另外一张表中。</p>
<p>INSERT 触发器包含一个名为 NEW 的虚拟表。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> mytrigger AFTER <span class="keyword">INSERT</span> <span class="keyword">ON</span> mytable</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="type">ROW</span> <span class="keyword">SELECT</span> NEW.col <span class="keyword">into</span> <span class="variable">@result</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="variable">@result</span>; <span class="comment">-- 获取结果</span></span><br></pre></td></tr></table></figure>
<p>DELETE 触发器包含一个名为 OLD 的虚拟表，并且是只读的。</p>
<p>UPDATE 触发器包含一个名为 NEW 和一个名为 OLD 的虚拟表，其中 NEW 是可以被修改的，而 OLD 是只读的。</p>
<p>MySQL 不允许在触发器中使用 CALL 语句，也就是不能调用存储过程。</p>
<h1 id="二十一、事务管理"><a href="#二十一、事务管理" class="headerlink" title="二十一、事务管理"></a>二十一、事务管理</h1><p>基本术语：</p>
<ul>
<li>事务（transaction）指一组 SQL 语句；</li>
<li>回退（rollback）指撤销指定 SQL 语句的过程；</li>
<li>提交（commit）指将未存储的 SQL 语句结果写入数据库表；</li>
<li>保留点（savepoint）指事务处理中设置的临时占位符（placeholder），你可以对它发布回退（与回退整个事务处理不同）。</li>
</ul>
<p>不能回退 SELECT 语句，回退 SELECT 语句也没意义；也不能回退 CREATE 和 DROP 语句。</p>
<p>MySQL 的事务提交默认是隐式提交，每执行一条语句就把这条语句当成一个事务然后进行提交。当出现 START TRANSACTION 语句时，会关闭隐式提交；当 COMMIT 或 ROLLBACK 语句执行后，事务会自动关闭，重新恢复隐式提交。</p>
<p>设置 autocommit 为 0 可以取消自动提交；autocommit 标记是针对每个连接而不是针对服务器的。</p>
<p>如果没有设置保留点，ROLLBACK 会回退到 START TRANSACTION 语句处；如果设置了保留点，并且在 ROLLBACK 中指定该保留点，则会回退到该保留点。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">START</span> TRANSACTION</span><br><span class="line"><span class="operator">/</span><span class="operator">/</span> ...</span><br><span class="line"><span class="keyword">SAVEPOINT</span> delete1</span><br><span class="line"><span class="operator">/</span><span class="operator">/</span> ...</span><br><span class="line"><span class="keyword">ROLLBACK</span> <span class="keyword">TO</span> delete1</span><br><span class="line"><span class="operator">/</span><span class="operator">/</span> ...</span><br><span class="line"><span class="keyword">COMMIT</span></span><br></pre></td></tr></table></figure>
<h1 id="MySQL-索引等重要内容"><a href="#MySQL-索引等重要内容" class="headerlink" title="MySQL(索引等重要内容)"></a>MySQL(索引等重要内容)</h1><h1 id="一、索引"><a href="#一、索引" class="headerlink" title="一、索引"></a>一、索引</h1><h2 id="B-Tree-原理"><a href="#B-Tree-原理" class="headerlink" title="B+ Tree 原理"></a>B+ Tree 原理</h2><p>MySQL的数据库索引的底层结构是B+树，这是为了方便查找和排序。</p>
<h3 id="1-数据结构"><a href="#1-数据结构" class="headerlink" title="1. 数据结构"></a>1. 数据结构</h3><p>B+ Tree 是基于 B Tree (平衡树。平衡树是一颗查找树，并且所有叶子节点位于同一层。)和叶子节点顺序访问指针进行实现，它具有 B Tree 的平衡性，并且通过顺序访问指针来提高区间查询的性能。 </p>
<p>B Tree是没有叶子上的链表指针的！这样B+树只需要遍历叶子结点就能遍历就能实现树的便利了。而B-Tree需要获取所有节点，相比之下B+Tree效率更高。</p>
<p>在 B+ Tree 中，一个节点中的 key 从左到右非递减排列，如果某个指针的左右相邻 key 分别是 key<sub>i</sub> 和 key<sub>i+1</sub>，且不为 null，则该指针指向节点的所有大于等于 key<sub>i</sub> 且小于等于 key<sub>i+1</sub>的 key 。</p>
<div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/33576849-9275-47bb-ada7-8ded5f5e7c73.png" width="350px"> </div><br>

<h3 id="2-操作"><a href="#2-操作" class="headerlink" title="2. 操作"></a>2. 操作</h3><p>进行查找操作时，首先在根节点进行二分查找，找到一个 key 所在的指针，然后递归地在指针所指向的节点进行查找。直到查找到叶子节点，然后在叶子节点上进行二分查找，找出 key 所对应的 data。</p>
<p>插入删除操作会破坏平衡树的平衡性，因此在插入删除操作之后，需要对树进行一个分裂、合并、旋转等操作来维护平衡性。</p>
<h3 id="3-与红黑树的比较"><a href="#3-与红黑树的比较" class="headerlink" title="3. 与红黑树的比较"></a>3. 与红黑树的比较</h3><p>红黑树等平衡树也可以用来实现索引，但是文件系统及数据库系统普遍采用 B+ Tree 作为索引结构，主要有以下两个原因：</p>
<p>（一）更少的查找次数</p>
<p>平衡树查找操作的时间复杂度和树高 h 相关，O(h)=O(log<sub>d</sub>N)，其中 d 为每个节点的出度。树的高度随着数据量增加而增加，IO代价高。</p>
<p>红黑树的出度为 2，而 B+ Tree 的出度一般都非常大，所以红黑树的树高 h 很明显比 B+ Tree 大非常多，查找的次数也就更多。</p>
<p>（二）利用磁盘预读特性</p>
<p>为了减少磁盘 I/O 操作，磁盘往往不是严格按需读取，而是每次都会<strong>预读</strong>。预读过程中，磁盘进行顺序读取，顺序读取不需要进行磁盘寻道，并且只需要很短的磁盘旋转时间，速度会非常快。</p>
<p>操作系统一般将内存和磁盘分割成固定大小的块，每一块称为一页，内存与磁盘以页为单位交换数据。数据库系统将索引的一个节点的大小设置为页的大小，使得一次 I/O 就能完全载入一个节点。并且可以利用预读特性，相邻的节点也能够被预先载入。</p>
<h2 id="MySQL-索引（B-树索引，其他引擎有别的索引方式）"><a href="#MySQL-索引（B-树索引，其他引擎有别的索引方式）" class="headerlink" title="MySQL 索引（B+树索引，其他引擎有别的索引方式）"></a>MySQL 索引（B+树索引，其他引擎有别的索引方式）</h2><p>索引是在<strong>存储引擎层</strong>实现的，不同存储引擎具有不同的索引类型和实现。</p>
<h3 id="1-数据结构角度——B-Tree-索引"><a href="#1-数据结构角度——B-Tree-索引" class="headerlink" title="1. 数据结构角度——B+Tree 索引"></a>1. 数据结构角度——B+Tree 索引</h3><p>是大多数 MySQL 存储引擎的默认索引类型。</p>
<p>因为不再需要进行全表扫描，只需要对树进行搜索即可，所以查找速度快很多。因为 B+ Tree 的有序性，所以除了用于查找，还可以用于排序和分组。</p>
<p>可以指定多个列作为索引列，多个索引列共同组成键。</p>
<p>适用于全键值、键值范围和键前缀查找，其中键前缀查找只适用于最左前缀查找。如果不是按照索引列的顺序进行查找，则无法使用索引。</p>
<p>InnoDB 的 B+Tree 索引分为主索引和辅助索引。主索引的叶子节点 data 域记录着完整的数据记录，这种索引方式被称为<strong>聚簇索引</strong>。因为无法把数据行存放在两个不同的地方，所以一个表只能有一个聚簇索引。</p>
<p>按照索引的键是否为主键来分为“主索引”和“辅助索引”，使用主键键值建立的索引称为“主索引”，其它的称为“辅助索引”。</p>
<p>聚簇索引的辅助索引的叶子节点的data存储的是主键的值，主索引的叶子节点的data存储的是数据本身，也就是说数据和索引存储在一起，并且索引查询到的地方就是数据（data）本身。</p>
<p>那么就引出了：索引的顺序和数据本身的顺序就是相同的；</p>
<p>而非聚簇索引的主索引和辅助索引的叶子节点的data都是存储的数据的物理地址，也就是说索引和数据并不是存储在一起的，数据的顺序和索引的顺序并没有任何关系，也就是索引顺序与数据物理排列顺序无关。</p>
<div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/45016e98-6879-4709-8569-262b2d6d60b9.png" width="350px"> </div><br>

<div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/7c349b91-050b-4d72-a7f8-ec86320307ea.png" width="350px"> </div><br>

<p>AVL树和红黑树基本都是存储在内存中才会使用的数据结构。在大规模数据数据存储的时候，显然不能将全部数据全部加载进内存，如果采用红黑树，就会造成频繁IO，效率低下。</p>
<h3 id="2-数据结构角度——哈希索引——非聚簇索引"><a href="#2-数据结构角度——哈希索引——非聚簇索引" class="headerlink" title="2. 数据结构角度——哈希索引——非聚簇索引"></a>2. 数据结构角度——哈希索引——非聚簇索引</h3><p>哈希索引能以 O(1) 时间进行查找，但是失去了有序性：</p>
<ul>
<li>无法用于排序与分组；</li>
<li>只支持精确查找，无法用于部分查找和范围查找。</li>
</ul>
<p>和哈希是类似的，对于每一行数据，存储引擎都会对所有的索引列计算一个哈希码（hashCode），将所有的哈希码存储在索引中，同时在索引表中保存指向每个数据行的指针，所以也是非聚簇的。</p>
<p>InnoDB 存储引擎有一个特殊的功能叫“自适应哈希索引”，当某个索引值被使用的非常频繁时，会在 B+Tree 索引之上再创建一个哈希索引，这样就让 B+Tree 索引具有哈希索引的一些优点，比如快速的哈希查找。</p>
<h3 id="3-数据结构角度——全文索引"><a href="#3-数据结构角度——全文索引" class="headerlink" title="3. 数据结构角度——全文索引"></a>3. 数据结构角度——全文索引</h3><p>MyISAM 存储引擎支持全文索引，用于查找文本中的关键词，而不是直接比较是否相等。</p>
<p>查找条件使用 MATCH AGAINST，而不是普通的 WHERE。</p>
<p>全文索引使用倒排索引实现，它记录着关键词到其所在文档的映射。</p>
<p>InnoDB 存储引擎在 MySQL 5.6.4 版本中也开始支持全文索引。</p>
<h3 id="数据结构角度——空间索引"><a href="#数据结构角度——空间索引" class="headerlink" title="数据结构角度——空间索引"></a>数据结构角度——空间索引</h3><p>可以用于地理数据存储。空间数据索引会从所有维度来索引数据，可以有效地使用任意维度来进行组合查询。</p>
<h3 id="1-数据物理存储与键值逻辑顺序——非聚簇索引"><a href="#1-数据物理存储与键值逻辑顺序——非聚簇索引" class="headerlink" title="1. 数据物理存储与键值逻辑顺序——非聚簇索引"></a>1. 数据物理存储与键值逻辑顺序——非聚簇索引</h3><p>在SELECT搜索时，需要先在索引树中快速检索到目标内容，但是要想取到他对应行的数据，必须找到该行数据在硬盘中的存储位置，在单行检索上很快。</p>
<p>每次通过索引检索到所需行号后，还需要通过叶子上存放的磁盘地址去磁盘内取数据（回行），这很消耗时间。为了优化这部分回行取数据时间，InnoDB 引擎采用了聚簇索引。</p>
<p>使用非聚合索引的场景：</p>
<ol>
<li><p>某列包含大数目的不同值（因为在叶子节点不需要去保存数据，只需要保存地址）</p>
</li>
<li><p>频繁更新的列，因为非聚集索引添加记录时，不会引起数据顺序的重组</p>
</li>
</ol>
<p>实例：</p>
<div align="center"> <img src="https://mmbiz.qpic.cn/mmbiz_png/SYoYmIOcI5ralVp2b3MQdpn2G9n2AuaaXNtyvxah28fegd0yIEVNp3tpHYLflH09PYBZjcJ7Ar15QSfzHOiaBOw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" width=""> </div><br>

<p>根据你的索引字段生成一颗新的B+树。因此， 我们每加一个索引，就会增加表的体积， 占用磁盘存储空间。</p>
<p>然而，注意看叶子节点，非聚簇索引的叶子节点并不是真实数据，它的叶子节点依然是索引节点，存放的是该索引字段的值以及对应的主键索引(聚簇索引)。</p>
<div align="center"> <img src="https://mmbiz.qpic.cn/mmbiz_png/SYoYmIOcI5ralVp2b3MQdpn2G9n2AuaaNdMton1rewN2MXeHuJwjbfdBtHfsLSfxWFqsu8uzYcgA0DyAUkxVeQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" width=""> </div><br>

<p>通过上图红线可以看出，先从非聚簇索引树开始查找，然后找到聚簇索引后。根据聚簇索引，在聚簇索引的B+树上，找到完整的数据！</p>
<p>多加一个索引，就会多生成一颗非聚簇索引树。因此，很多文章才说，索引不能乱加。因为，有几个索引，就有几颗非聚簇索引树！</p>
<p>你在做插入操作的时候，需要同时维护这几颗树的变化！因此，如果索引太多，插入性能就会下降!</p>
<h3 id="2-数据物理存储与键值逻辑顺序——聚簇索引"><a href="#2-数据物理存储与键值逻辑顺序——聚簇索引" class="headerlink" title="2. 数据物理存储与键值逻辑顺序——聚簇索引"></a>2. 数据物理存储与键值逻辑顺序——聚簇索引</h3><p>定义：<strong>数据行的物理顺序与列值（主键的那一列）的逻辑顺序相同</strong>。</p>
<p>Mysql中的数据是按照主键的顺序存放的。而聚簇索引就是按照每张表的主键来构造一颗B+树，树的叶子节点存放表的行数据，所以顺序相同。</p>
<p>并且由于表里的数据只能按照一颗B+树排序，因此一张表只能有一个聚簇索引。</p>
<p>InnoDB的聚簇索引其实就是在同一个结构中保存了B+Tree索引和数据行(所以能直接查找到数据，不用根据地址再次查找，避免回表查询)。</p>
<p>1、选择B+树作为存储结构</p>
<p>2、聚合索引必须有主键，没有主键就会选择Unique key作为主键，没有Unique则会在系统内部生成rowid作为主键，因此主键不宜过长，使得辅助索引过大，主键如果不是单调的就会造成B+Tree频繁的分裂调整</p>
<p>3、在InnoDb上会选择自增字段作为主键，是为了维持B+树的分裂特性，顺序添加到当前索引的后续位置，当达到最大就会分裂产生新的页，也不需要移动原有的顺序</p>
<p>4、聚合索引分主索引和辅助索引，主索引叶子结点存储键值对应的数据本身，辅助索引叶子结点存储主键键值</p>
<p>5、由于辅助索引存储的是主键键值，因此<strong>按照辅助索引搜索</strong>的时候需要检索两遍，第一遍找到对应的主键，第二遍在主索引到达叶子结点中找到数据</p>
<p>使用聚合索引的场景：</p>
<ol>
<li><p>某列包含小数目的不同值</p>
</li>
<li><p>排序和范围索引（主键递增）</p>
</li>
</ol>
<p>实例：</p>
<div align="center"> <img src="https://mmbiz.qpic.cn/mmbiz_png/SYoYmIOcI5ralVp2b3MQdpn2G9n2Auaaqko1fHU9jKV67diclTn66icSLozzYDibrPwPHRFgnGPcl8jsjLNdFKNeQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1
" width=""> </div><br>

<p>分为上下两个部分，上半部分是由主键形成的B+树，下半部分就是磁盘上真实的数据！那么，当我们， 执行下面的语句：select * from table where pId=’11’</p>
<div align="center"> <img src="https://mmbiz.qpic.cn/mmbiz_png/SYoYmIOcI5ralVp2b3MQdpn2G9n2AuaaSlj1hg6C3HZgdX5m567iatj6tonzRgyOToP1ibYpKpMW5odtoPrHU5bg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" width=""> </div><br>

<p>从根开始，经过3次查找，就可以找到真实数据。如果不使用索引，那就要在磁盘上，进行逐行扫描，直到找到数据位置。显然，使用索引速度会快。但是在写入数据的时候，需要维护这颗B+树的结构，因此写入性能会下降！</p>
<h3 id="1-应用层面-逻辑角度-——普通索引-单列索引"><a href="#1-应用层面-逻辑角度-——普通索引-单列索引" class="headerlink" title="1. 应用层面(逻辑角度)——普通索引(单列索引)"></a>1. 应用层面(逻辑角度)——普通索引(单列索引)</h3><p>即一个索引只包含单个列，一个表可以有多个单列索引</p>
<h3 id="2-应用层面-逻辑角度-——唯一索引——属于非聚簇"><a href="#2-应用层面-逻辑角度-——唯一索引——属于非聚簇" class="headerlink" title="2. 应用层面(逻辑角度)——唯一索引——属于非聚簇"></a>2. 应用层面(逻辑角度)——唯一索引——属于非聚簇</h3><p>索引列的值必须唯一，但允许有空值</p>
<h3 id="3-应用层面-逻辑角度-——复合索引-多列索引-——属于非聚簇"><a href="#3-应用层面-逻辑角度-——复合索引-多列索引-——属于非聚簇" class="headerlink" title="3. 应用层面(逻辑角度)——复合索引(多列索引)——属于非聚簇"></a>3. 应用层面(逻辑角度)——复合索引(多列索引)——属于非聚簇</h3><p>即一个索引包含多个列</p>
<h3 id="4-应用层面-逻辑角度-——主键索引"><a href="#4-应用层面-逻辑角度-——主键索引" class="headerlink" title="4. 应用层面(逻辑角度)——主键索引"></a>4. 应用层面(逻辑角度)——主键索引</h3><p>主键索引是一种特殊的唯一索引，不允许有空值</p>
<h3 id="相关问题"><a href="#相关问题" class="headerlink" title="相关问题"></a>相关问题</h3><ol>
<li><p>现在我有一个列，里头的数据都是唯一的，需要建一个索引，选唯一索引还是普通索引？————是唯一索引！因为字段具有唯一特性，数据唯一，没别的选择了。</p>
</li>
<li><p>为什么唯一索引的<strong>插入</strong>速度比不上普通索引？</p>
</li>
</ol>
<p>————在进行非聚簇索引的插入时，先判断插入的索引页是否在内存中。如果在，则直接插入；如果不在，放入Change Buffer 中，然后再以一定频率和情况进行Change Buffer和原数据页合并(merge)操作。</p>
<pre><code>这能将多个插入合并到一个操作中，就大大提高了非聚簇索引的插入性能。
</code></pre>
<p>————而唯一速度的插入比普通索引慢的原因就是:</p>
<pre><code>唯一索引无法利用Change Buffer；普通索引可以利用Change Buffer
</code></pre>
<ol start="3">
<li>那么为什么唯一索引不用change buffer？</li>
</ol>
<p>————因为唯一索引为了保证唯一性，需要将数据页加载进内存才能判断是否违反唯一性约束。但既然数据页都加载到内存了，还不如直接更新内存中的数据页，没有必要再使用Change Buffer走更长的路径。</p>
<ol start="4">
<li>唯一索引的<strong>查找搜索</strong>速度比普通索引快的原因是？</li>
</ol>
<p>————普通索引在找到满足条件的第一条记录后，还需要判断下一条记录，直到第一个不满足条件的记录出现。唯一索引在找到满足条件的第一条记录后，直接返回，不用判断下一条记录了。</p>
<h2 id="什么时候要建立索引？"><a href="#什么时候要建立索引？" class="headerlink" title="什么时候要建立索引？"></a>什么时候要建立索引？</h2><p>去my.cnf里配置三个配置：</p>
<p>打开慢查询日志</p>
<p>slow_query_log=1</p>
<p>慢查询日志存储路径</p>
<p>slow_query_log_file=/var/log/mysql/log-slow-queries.log</p>
<p>SQL执行时间大于3秒，则记录日志</p>
<p>long_query_time=3</p>
<p>此时发现监控到慢SQL了，则先考虑是否能优化SQL语言，比如使用limnit等。</p>
<p>实在没法优化了，尝试建立索引。</p>
<p>(1)索引并非越多越好，<strong>大量的索引不仅占用磁盘空间，而且还会影响insert,delete,update等语句的性能</strong></p>
<p>(2)避免对经常更新的表做更多的索引，并且索引中的列尽可能少；对经常用于查询的字段创建索引，避免添加不必要的索引</p>
<p>(3)数据量少的表尽量不要使用索引，由于数据较少，查询花费的时间可能比遍历索引的时间还要短，索引可能不会产生优化效果</p>
<p>(4)在条件表达式中经常用到不同值较多的列上创建索引，在不同值很少的列上不要建立索引。比如性别字段只有“男”“女”俩个值，就无需建立索引。</p>
<p>(5)在频繁进行排序或者分组的列上建立索引，如果排序的列有多个，可以在这些列上建立联合索引。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 构建指令</span><br><span class="line"><span class="keyword">CREATE</span> INDEX index_name <span class="keyword">ON</span> <span class="keyword">table</span>(<span class="keyword">column</span>(length));</span><br><span class="line"># 建表时直接创建</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `<span class="keyword">table</span>` (</span><br><span class="line">    `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT ,</span><br><span class="line">    INDEX index_name (title(length))</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>
<h2 id="有多个索引的时候是怎么走的？（优先级）"><a href="#有多个索引的时候是怎么走的？（优先级）" class="headerlink" title="有多个索引的时候是怎么走的？（优先级）"></a>有多个索引的时候是怎么走的？（优先级）</h2><p>Mysql在优化器中有一个优化器称为Range 优化器，负责进行范围查询的优化！</p>
<p>那么该优化器计算执行成本有两种方式index dive与index statistics。前者统计速度慢但是能得到精准的值，后者统计速度快但是数据未必精准。</p>
<p>有一列名为Cardinality，该值表示索引列中不重复值的个数。索引列的唯一值的个数，如果是复合索引就是唯一组合的个数。</p>
<p>这个数值将会作为mysql优化器对语句执行计划进行判定时依据。如果唯一性太小，那么优化器会认为，这个索引对语句没有太大帮助，而不使用索引。</p>
<p>Cardinality值越大，意味着使用索引能排除越多的数据，执行也更为高效。</p>
<h2 id="索引优化-用了索引，用的过程中怎么更优？"><a href="#索引优化-用了索引，用的过程中怎么更优？" class="headerlink" title="索引优化(用了索引，用的过程中怎么更优？)"></a>索引优化(用了索引，用的过程中怎么更优？)</h2><p>这里说的是，索引INDEX使用的过程，如何建立更高效的索引，怎么去设置索引，而不是索引的实现方式!!!</p>
<h3 id="1-独立的列"><a href="#1-独立的列" class="headerlink" title="1. 独立的列"></a>1. 独立的列</h3><p>使用索引是有前提条件的。在进行查询时，索引列不能是表达式的一部分，也不能是函数的参数，否则无法使用索引。</p>
<p>例如下面的查询不能使用 actor_id 列的索引：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> actor_id <span class="keyword">FROM</span> sakila.actor <span class="keyword">WHERE</span> actor_id <span class="operator">+</span> <span class="number">1</span> <span class="operator">=</span> <span class="number">5</span>;</span><br></pre></td></tr></table></figure>
<h3 id="2-多列索引"><a href="#2-多列索引" class="headerlink" title="2. 多列索引"></a>2. 多列索引</h3><p>在需要使用多个列作为条件进行查询时，使用多列索引比使用多个单列索引性能更好。例如下面的语句中，最好把 actor_id 和 film_id 设置为多列索引。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> film_id, actor_ id <span class="keyword">FROM</span> sakila.film_actor</span><br><span class="line"><span class="keyword">WHERE</span> actor_id <span class="operator">=</span> <span class="number">1</span> <span class="keyword">AND</span> film_id <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<h3 id="3-选择更好的索引列的顺序"><a href="#3-选择更好的索引列的顺序" class="headerlink" title="3. 选择更好的索引列的顺序"></a>3. 选择更好的索引列的顺序</h3><p>让选择性最强的索引列放在前面。索引的选择性是指：不重复的索引值~/记录总数。选择性越高，记录值越多，区分度越高，查询效率也越高。</p>
<h3 id="4-前缀索引"><a href="#4-前缀索引" class="headerlink" title="4. 前缀索引"></a>4. 前缀索引</h3><p>对于 BLOB、TEXT 和 VARCHAR 类型的列，必须使用前缀索引，只索引开始的部分字符。前缀长度的选取需要根据索引选择性来确定。</p>
<h3 id="5-覆盖索引"><a href="#5-覆盖索引" class="headerlink" title="5. 覆盖索引"></a>5. 覆盖索引</h3><p>索引包含所有需要查询的字段的值。</p>
<p>具有以下优点：</p>
<ul>
<li>索引通常远小于数据行的大小，只读取索引能大大减少数据访问量。</li>
<li>一些存储引擎（例如 MyISAM）在内存中只缓存索引，而数据依赖于操作系统来缓存。因此，只访问索引可以不使用系统调用（通常比较费时）。</li>
<li>对于 InnoDB 引擎，若辅助索引能够覆盖查询，则无需访问主索引。</li>
</ul>
<h2 id="索引的优点（用了索引，有啥好处？）"><a href="#索引的优点（用了索引，有啥好处？）" class="headerlink" title="索引的优点（用了索引，有啥好处？）"></a>索引的优点（用了索引，有啥好处？）</h2><ul>
<li><p>大大减少了服务器需要扫描的数据行数。</p>
</li>
<li><p>帮助服务器避免进行排序和分组，以及避免创建临时表（B+Tree 索引是有序的，可以用于 ORDER BY 和 GROUP BY 操作。临时表主要是在排序和分组过程中创建，不需要排序和分组，也就不需要创建临时表）。</p>
</li>
<li><p>将随机 I/O 变为顺序 I/O（B+Tree 索引是有序的，会将<strong>相邻的数据都存储在一起</strong>）。</p>
</li>
</ul>
<h2 id="索引的使用条件"><a href="#索引的使用条件" class="headerlink" title="索引的使用条件"></a>索引的使用条件</h2><ul>
<li><p>对于非常小的表，大部分情况下简单的全表扫描比建立索引更高效；</p>
</li>
<li><p>对于中到大型的表，索引就非常有效；</p>
</li>
<li><p>但是对于特大型的表，建立和维护索引的代价将会随之增长。需要能直接区分出需要查询的一组数据，而不是一条一条匹配，例如可以使用<strong>分区技术</strong>。</p>
</li>
</ul>
<h1 id="二、查询性能优化"><a href="#二、查询性能优化" class="headerlink" title="二、查询性能优化"></a>二、查询性能优化</h1><h2 id="使用-Explain-进行分析"><a href="#使用-Explain-进行分析" class="headerlink" title="使用 Explain 进行分析"></a>使用 Explain 进行分析</h2><p>Explain 用来分析 SELECT 查询语句，开发人员可以通过分析 Explain 结果来优化查询语句。</p>
<p>比较重要的字段有：</p>
<ul>
<li>select_type : 查询类型，有简单查询、联合查询、子查询等</li>
<li>key : 使用的索引</li>
<li>rows : 扫描的行数</li>
</ul>
<h2 id="优化数据访问"><a href="#优化数据访问" class="headerlink" title="优化数据访问"></a>优化数据访问</h2><h3 id="1-减少请求的数据量"><a href="#1-减少请求的数据量" class="headerlink" title="1. 减少请求的数据量"></a>1. 减少请求的数据量</h3><ul>
<li>只返回必要的列：最好不要使用 SELECT * 语句。</li>
<li>只返回必要的行：使用 LIMIT 语句来限制返回的数据。</li>
<li>缓存重复查询的数据：使用缓存可以避免在数据库中进行查询，特别在要查询的数据经常被重复查询时，缓存带来的查询性能提升将会是非常明显的。</li>
</ul>
<h3 id="2-减少服务器端扫描的行数"><a href="#2-减少服务器端扫描的行数" class="headerlink" title="2. 减少服务器端扫描的行数"></a>2. 减少服务器端扫描的行数</h3><p>最有效的方式是使用索引来覆盖查询。</p>
<h2 id="重构查询方式"><a href="#重构查询方式" class="headerlink" title="重构查询方式"></a>重构查询方式</h2><h3 id="1-切分大查询"><a href="#1-切分大查询" class="headerlink" title="1. 切分大查询"></a>1. 切分大查询</h3><p>一个大查询如果一次性执行的话，可能一次锁住很多数据、占满整个事务日志、耗尽系统资源、阻塞很多小的但重要的查询。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> messages <span class="keyword">WHERE</span> <span class="keyword">create</span> <span class="operator">&lt;</span> DATE_SUB(NOW(), <span class="type">INTERVAL</span> <span class="number">3</span> <span class="keyword">MONTH</span>);</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rows_affected <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">do &#123;</span><br><span class="line">    rows_affected <span class="operator">=</span> do_query(</span><br><span class="line">    &quot;DELETE FROM messages WHERE create  &lt; DATE_SUB(NOW(), INTERVAL 3 MONTH) LIMIT 10000&quot;)</span><br><span class="line">&#125; while rows_affected &gt; 0</span><br></pre></td></tr></table></figure>
<h3 id="2-分解大连接查询"><a href="#2-分解大连接查询" class="headerlink" title="2. 分解大连接查询"></a>2. 分解大连接查询</h3><p>将一个大连接查询分解成对每一个表进行一次单表查询，然后在应用程序中进行关联，这样做的好处有：</p>
<ul>
<li>让缓存更高效。对于连接查询，如果其中一个表发生变化，那么整个查询缓存就无法使用。而分解后的多个查询，即使其中一个表发生变化，对其它表的查询缓存依然可以使用。</li>
<li>分解成多个单表查询，这些单表查询的缓存结果更可能被其它查询使用到，从而减少冗余记录的查询。</li>
<li>减少锁竞争；</li>
<li>在应用层进行连接，可以更容易对数据库进行拆分，从而更容易做到高性能和可伸缩。</li>
<li>查询本身效率也可能会有所提升。例如下面的例子中，使用 IN() 代替连接查询，可以让 MySQL 按照 ID 顺序进行查询，这可能比随机的连接要更高效。</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> tag</span><br><span class="line"><span class="keyword">JOIN</span> tag_post <span class="keyword">ON</span> tag_post.tag_id<span class="operator">=</span>tag.id</span><br><span class="line"><span class="keyword">JOIN</span> post <span class="keyword">ON</span> tag_post.post_id<span class="operator">=</span>post.id</span><br><span class="line"><span class="keyword">WHERE</span> tag.tag<span class="operator">=</span><span class="string">&#x27;mysql&#x27;</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> tag <span class="keyword">WHERE</span> tag<span class="operator">=</span><span class="string">&#x27;mysql&#x27;</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> tag_post <span class="keyword">WHERE</span> tag_id<span class="operator">=</span><span class="number">1234</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> post <span class="keyword">WHERE</span> post.id <span class="keyword">IN</span> (<span class="number">123</span>,<span class="number">456</span>,<span class="number">567</span>,<span class="number">9098</span>,<span class="number">8904</span>);</span><br></pre></td></tr></table></figure>
<h1 id="三、切分"><a href="#三、切分" class="headerlink" title="三、切分"></a>三、切分</h1><h2 id="水平切分"><a href="#水平切分" class="headerlink" title="水平切分"></a>水平切分</h2><p>水平切分又称为 Sharding，它是将同一个表中的记录拆分到多个结构相同的表中。</p>
<p>当一个表的数据不断增多时，Sharding 是必然的选择，它可以将数据分布到集群的不同节点上，从而缓存单个数据库的压力。</p>
<div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/63c2909f-0c5f-496f-9fe5-ee9176b31aba.jpg" width=""> </div><br>

<h2 id="垂直切分"><a href="#垂直切分" class="headerlink" title="垂直切分"></a>垂直切分</h2><p>垂直切分是将一张表按列切分成多个表，通常是按照列的关系密集程度进行切分，也可以利用垂直切分将经常被使用的列和不经常被使用的列切分到不同的表中。</p>
<p>在数据库的层面使用垂直切分将按数据库中表的密集程度部署到不同的库中，例如将原来的电商数据库垂直切分成商品数据库、用户数据库等。</p>
<div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/e130e5b8-b19a-4f1e-b860-223040525cf6.jpg" width=""> </div><br>

<h2 id="Sharding-策略"><a href="#Sharding-策略" class="headerlink" title="Sharding 策略"></a>Sharding 策略</h2><ul>
<li>哈希取模：hash(key) % N；</li>
<li>范围：可以是 ID 范围也可以是时间范围；</li>
<li>映射表：使用单独的一个数据库来存储映射关系。</li>
</ul>
<h2 id="Sharding-存在的问题"><a href="#Sharding-存在的问题" class="headerlink" title="Sharding 存在的问题"></a>Sharding 存在的问题</h2><h3 id="1-事务问题"><a href="#1-事务问题" class="headerlink" title="1. 事务问题"></a>1. 事务问题</h3><p>使用分布式事务来解决，比如 XA 接口。</p>
<h3 id="2-连接"><a href="#2-连接" class="headerlink" title="2. 连接"></a>2. 连接</h3><p>可以将原来的连接分解成多个单表查询，然后在用户程序中进行连接。</p>
<h3 id="3-ID-唯一性"><a href="#3-ID-唯一性" class="headerlink" title="3. ID 唯一性"></a>3. ID 唯一性</h3><ul>
<li>使用全局唯一 ID（GUID）</li>
<li>为每个分片指定一个 ID 范围</li>
<li>分布式 ID 生成器 (如 Twitter 的 Snowflake 算法)</li>
</ul>
<h1 id="四、复制"><a href="#四、复制" class="headerlink" title="四、复制"></a>四、复制</h1><h2 id="主从复制"><a href="#主从复制" class="headerlink" title="主从复制"></a>主从复制</h2><p>主要涉及三个线程：binlog 线程、I/O 线程和 SQL 线程。</p>
<ul>
<li>  <strong>binlog 线程</strong>  ：负责将主服务器上的数据更改写入二进制日志（Binary log）中。</li>
<li>  <strong>I/O 线程</strong>  ：负责从主服务器上读取二进制日志，并写入从服务器的中继日志（Relay log）。</li>
<li>  <strong>SQL 线程</strong>  ：负责读取中继日志，解析出主服务器已经执行的数据更改并在从服务器中重放（Replay）。</li>
</ul>
<div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/master-slave.png" width=""> </div><br>

<h2 id="读写分离"><a href="#读写分离" class="headerlink" title="读写分离"></a>读写分离</h2><p>主服务器处理写操作以及实时性要求比较高的读操作，而从服务器处理读操作。</p>
<p>读写分离能提高性能的原因在于：</p>
<ul>
<li>主从服务器负责各自的读和写，极大程度缓解了锁的争用；</li>
<li>从服务器可以使用 MyISAM，提升查询性能以及节约系统开销；</li>
<li>增加冗余，提高可用性。</li>
</ul>
<p>读写分离常用代理方式来实现，代理服务器接收应用层传来的读写请求，然后决定转发到哪个服务器。</p>
<h1 id="数据库系统原理"><a href="#数据库系统原理" class="headerlink" title="数据库系统原理"></a>数据库系统原理</h1><h1 id="一、事务"><a href="#一、事务" class="headerlink" title="一、事务"></a>一、事务</h1><h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><p><strong>事务</strong>指的是<strong>满足 ACID 特性的一组操作</strong>，可以通过 Commit 提交一个事务，也可以使用 Rollback 进行回滚。</p>
<div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/image-20191207222237925.png"/> </div><br>

<h2 id="ACID"><a href="#ACID" class="headerlink" title="ACID"></a>ACID</h2><h3 id="1-原子性（Atomicity）"><a href="#1-原子性（Atomicity）" class="headerlink" title="1. 原子性（Atomicity）"></a>1. 原子性（Atomicity）</h3><p>事务被视为不可分割的最小单元，事务的所有操作要么<strong>全部提交成功</strong>，要么<strong>全部失败回滚</strong>。(一组操作,成组完成)</p>
<p>回滚可以用回滚日志（Undo Log）来实现，日志记录着事务所执行的修改操作，在回滚时反向执行这些修改操作。</p>
<h3 id="2-一致性（Consistency）"><a href="#2-一致性（Consistency）" class="headerlink" title="2. 一致性（Consistency）"></a>2. 一致性（Consistency）</h3><p>数据库在事务执行前后都保持一致性状态。在一致性状态下，所有事务对同一个数据的读取结果都是相同的。</p>
<h3 id="3-隔离性（Isolation）"><a href="#3-隔离性（Isolation）" class="headerlink" title="3. 隔离性（Isolation）"></a>3. 隔离性（Isolation）</h3><p>一个事务所做的修改在最终提交以前，对其它事务是<strong>不可见</strong>的。</p>
<h3 id="4-持久性（Durability）"><a href="#4-持久性（Durability）" class="headerlink" title="4. 持久性（Durability）"></a>4. 持久性（Durability）</h3><p>一旦事务提交，则其所做的修改将会永远保存到数据库中。即使系统发生崩溃，事务执行的结果也不能丢失。</p>
<p>系统发生奔溃可以用重做日志（Redo Log）进行恢复，从而实现持久性。</p>
<p>与回滚日志记录数据的逻辑修改不同，重做日志记录的是数据页的物理修改。</p>
<hr>
<p>事务的 ACID 特性概念简单，但不是很好理解，主要是因为这几个特性不是一种平级关系：</p>
<ul>
<li>只有满足一致性，事务的执行结果才是正确的(执行过程中各事务对数据的读取结果都相同,才不会出错)。</li>
<li>在无并发的情况下，事务串行执行，隔离性一定能够满足。此时只要能满足原子性，就一定能满足一致性。</li>
<li>在并发的情况下，多个事务并行执行，事务不仅要满足原子性，还需要满足**隔离性(应对并发问题)**，才能满足一致性。</li>
<li>事务满足持久化是为了能应对系统崩溃的情况。</li>
</ul>
<div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/image-20191207210437023.png"/> </div><br>

<h2 id="AUTOCOMMIT-MySQL采用"><a href="#AUTOCOMMIT-MySQL采用" class="headerlink" title="AUTOCOMMIT(MySQL采用)"></a>AUTOCOMMIT(MySQL采用)</h2><p>MySQL 默认采用自动提交模式。</p>
<p>也就是说，如果不显式使用<code>START TRANSACTION</code>语句来开始一个事务，那么<strong>每个查询操作都会被当做一个事务</strong>并<strong>自动提交</strong>。</p>
<h1 id="二、并发一致性问题"><a href="#二、并发一致性问题" class="headerlink" title="二、并发一致性问题"></a>二、并发一致性问题</h1><p>在并发环境下，事务的隔离性很难保证，因此会出现很多并发一致性问题，以下都是并发带来的问题：</p>
<h2 id="丢失修改-覆盖"><a href="#丢失修改-覆盖" class="headerlink" title="丢失修改(覆盖)"></a>丢失修改(覆盖)</h2><p>T<sub>1</sub> 和 T<sub>2</sub> 两个事务都对一个数据进行修改，T<sub>1</sub> 先修改，T<sub>2</sub> 随后修改，T<sub>2</sub> 的修改覆盖了 T<sub>1</sub> 的修改。</p>
<div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/image-20191207221744244.png"/> </div><br>

<h2 id="读脏数据-脏读"><a href="#读脏数据-脏读" class="headerlink" title="读脏数据(脏读)"></a>读脏数据(脏读)</h2><p>T<sub>1</sub> 修改一个数据，T<sub>2</sub> 随后读取这个数据。如果 T<sub>1</sub> 撤销了这次修改(如本次原子操作失败时)，那么 T<sub>2</sub> 读取的数据是脏数据。</p>
<p>或者可以这么说，事务1对记录做修改，在事务1完成并提交之前，数据处于待定状态(可能提交，可能回滚)，此时事务2把这个数据读取了，做了进一步处理，从而产生了未提交的数据依赖关系。</p>
<div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/image-20191207221920368.png"/> </div><br>

<h2 id="不可重复读"><a href="#不可重复读" class="headerlink" title="不可重复读"></a>不可重复读</h2><p>T<sub>2</sub> 读取一个数据，T<sub>1</sub> 对该数据做了修改。如果 T<sub>2</sub> 再次读取这个数据，此时读取的结果和第一次读取的结果不同。</p>
<div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/image-20191207222102010.png"/> </div><br>

<h2 id="幻影读"><a href="#幻影读" class="headerlink" title="幻影读"></a>幻影读</h2><p>T<sub>1</sub> 读取某个范围的数据，T<sub>2</sub> 在这个范围内插入新的数据，T<sub>1</sub> 再次读取这个范围的数据，此时读取的结果和和第一次读取的结果不同。</p>
<div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/image-20191207222134306.png"/> </div><br>

<hr>
<p>产生并发不一致性问题的<strong>主要原因</strong>是破坏了事务的隔离性，解决方法是通过并发控制来保证隔离性。</p>
<p>并发控制可以通过封锁来实现，但是封锁操作需要<strong>用户自己控制</strong>，相当复杂。数据库管理系统提供了<strong>事务的隔离级别</strong>(怎么实现看下文)，让用户以一种更轻松的方式处理并发一致性问题。</p>
<h1 id="三、封锁"><a href="#三、封锁" class="headerlink" title="三、封锁"></a>三、封锁</h1><h2 id="封锁粒度"><a href="#封锁粒度" class="headerlink" title="封锁粒度"></a>封锁粒度</h2><p>MySQL 中提供了两种封锁粒度：行级锁以及表级锁。</p>
<p>应该尽量<strong>只锁定需要修改的那部分数据</strong>，而不是所有的资源。锁定的数据量越少，发生锁争用的可能就越小，系统的并发程度就越高。(封锁程度小了，能提供的隔离粒度就更小，控制更精细)</p>
<p>但是加锁需要消耗资源，<strong>锁的各种操作（包括获取锁、释放锁、以及检查锁状态）都会增加系统开销</strong>。因此封锁<strong>粒度越小</strong>，系统<strong>开销就越大</strong>。(因为对每个封锁程度都需要进行锁的相关操作)</p>
<p>在选择封锁粒度时，需要在锁开销和并发程度之间做一个权衡。</p>
<h2 id="封锁类型"><a href="#封锁类型" class="headerlink" title="封锁类型"></a>封锁类型</h2><h3 id="1-读写锁-针对表，行"><a href="#1-读写锁-针对表，行" class="headerlink" title="1. 读写锁(针对表，行)"></a>1. 读写锁(针对表，行)</h3><ul>
<li>互斥锁（Exclusive），简写为 X 锁，又称写锁。</li>
<li>共享锁（Shared），简写为 S 锁，又称读锁。</li>
</ul>
<p>有以下两个规定：</p>
<ul>
<li>一个事务对数据对象 A 加了 X 锁，就可以对 A 进行读取和更新。加锁期间其它事务不能对 A 加任何锁。</li>
<li>一个事务对数据对象 A 加了 S 锁，可以对 A 进行读取操作，但是不能进行更新操作。加锁期间其它事务能对 A 加 S 锁，但是不能加 X 锁。</li>
</ul>
<p>锁的兼容关系如下：</p>
<div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/image-20191207213523777.png"/> </div><br>

<h3 id="2-意向锁-针对表"><a href="#2-意向锁-针对表" class="headerlink" title="2. 意向锁(针对表)"></a>2. 意向锁(针对表)</h3><p>使用意向锁（Intention Locks）可以更容易地支持多粒度封锁。</p>
<p>在存在行级锁和表级锁的情况下，事务 T 想要<strong>对表 A 加 X 锁</strong>，就需要先检测是否有其它事务对表 A 或者表 A 中的任意一行加了锁，那么就<strong>需要对表 A 的每一行都检测一次，这是非常耗时的。</strong></p>
<p>意向锁在原来的 X/S 锁之上引入了 IX/IS，<strong>IX/IS 都是表锁</strong>，用来表示一个事务想要在表中的某个数据行上加 X 锁或 S 锁。有以下两个规定：</p>
<ul>
<li>一个事务在获得某个数据行对象的 S 锁之前，必须先获得表的 IS 锁或者更强的锁；</li>
<li>一个事务在获得某个数据行对象的 X 锁之前，必须先获得表的 IX 锁。</li>
</ul>
<p>通过引入意向锁，事务 T 想要对表 A 加 X 锁，只需要先检测是否有其它事务对表 A 加了 X/IX/S/IS 锁，如果加了就表示有其它事务正在使用这个表或者表中某一行的锁，因此事务 T 加 X 锁失败。</p>
<p>各种锁的兼容关系如下：<strong>必须先获得表锁，才可以获得下面的读写锁</strong></p>
<div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/image-20191207214442687.png"/> </div><br>

<p>解释如下：</p>
<ul>
<li>任意 IS/IX 锁之间都是兼容的，因为它们只<strong>表示想要对表加锁，而不是真正加锁</strong>；</li>
<li>这里兼容关系针对的是表级锁，而表级的 IX 锁和行级的 X 锁兼容，两个事务可以对两个数据行加 X 锁。（<strong>事务 T<sub>1</sub> 想要对数据行 R<sub>1</sub> 加 X 锁，事务 T<sub>2</sub> 想要对同一个表的数据行 R<sub>2</sub> 加 X 锁，两个事务都需要对该表加 IX 锁，但是 IX 锁是兼容的，并且 IX 锁与行级的 X 锁也是兼容的，因此两个事务都能加锁成功，对同一个表中的两个数据行做修改。</strong>）</li>
</ul>
<h2 id="封锁协议"><a href="#封锁协议" class="headerlink" title="封锁协议"></a>封锁协议</h2><h3 id="1-三级封锁协议"><a href="#1-三级封锁协议" class="headerlink" title="1. 三级封锁协议"></a>1. 三级封锁协议</h3><p><strong>一级封锁协议</strong>  </p>
<p>事务 T 要修改数据 A 时必须加 X 锁，直到 T 结束才释放锁。</p>
<p>可以解决丢失修改问题，因为不能同时有两个事务对同一个数据进行修改，那么事务的修改就不会被覆盖。</p>
<div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/image-20191207220440451.png"/> </div><br>

<p><strong>二级封锁协议</strong>  </p>
<p>在<strong>一级</strong>的基础上，要求读取数据 A 时必须加 S 锁，<strong>读取完马上释放</strong> S 锁。</p>
<p>可以解决读脏数据问题，因为如果一个事务在对数据 A 进行修改，根据 1 级封锁协议，会加 X 锁，那么就不能再加 S 锁了，也就是不会读入数据。</p>
<div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/image-20191207220831843.png"/> </div><br>

<p><strong>三级封锁协议</strong>  </p>
<p>在<strong>一级</strong>的基础上，因为二级会出现不可重复读问题，要求读取数据 A 时必须加 S 锁，直到<strong>事务结束</strong>了才能释放 S 锁。</p>
<p>可以解决不可重复读的问题，因为读 A 时，其它事务不能对 A 加 X 锁，从而避免了在读的期间数据发生改变。</p>
<div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/image-20191207221313819.png"/> </div><br>

<h3 id="2-两段锁协议"><a href="#2-两段锁协议" class="headerlink" title="2. 两段锁协议"></a>2. 两段锁协议</h3><p>加锁和解锁分为两个阶段进行。</p>
<p>可串行化调度是指，通过并发控制，<strong>使得并发执行的事务结果与某个串行执行的事务结果相同</strong>。串行执行的事务互不干扰，不会出现并发一致性问题。</p>
<p>事务遵循两段锁协议是保证可串行化调度的充分条件。例如以下操作满足两段锁协议，它是可串行化调度。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lock-x(A)...lock-s(B)...lock-s(C)...unlock(A)...unlock(C)...unlock(B)</span><br></pre></td></tr></table></figure>
<p>但不是必要条件，例如以下操作不满足两段锁协议，但它还是可串行化调度。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lock-x(A)...unlock(A)...lock-s(B)...unlock(B)...lock-s(C)...unlock(C)</span><br></pre></td></tr></table></figure>
<h2 id="MySQL-隐式与显示锁定"><a href="#MySQL-隐式与显示锁定" class="headerlink" title="MySQL 隐式与显示锁定"></a>MySQL 隐式与显示锁定</h2><p>InnoDB 存储引擎采用两段锁协议，会根据隔离级别在需要的时候自动加锁，并且所有的锁都是在同一时刻被释放，这被称为<strong>隐式</strong>锁定。</p>
<p>InnoDB 也可以使用特定的语句进行显示锁定：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> ... LOCK <span class="keyword">In</span> SHARE MODE;</span><br><span class="line"><span class="keyword">SELECT</span> ... <span class="keyword">FOR</span> UPDATE;</span><br></pre></td></tr></table></figure>
<h1 id="四、隔离级别"><a href="#四、隔离级别" class="headerlink" title="四、隔离级别"></a>四、隔离级别</h1><h2 id="未提交读（READ-UNCOMMITTED）"><a href="#未提交读（READ-UNCOMMITTED）" class="headerlink" title="未提交读（READ UNCOMMITTED）"></a>未提交读（READ UNCOMMITTED）</h2><p>事务中的修改，即使没有提交，对其它事务也是可见的。</p>
<h2 id="提交读（READ-COMMITTED）"><a href="#提交读（READ-COMMITTED）" class="headerlink" title="提交读（READ COMMITTED）"></a>提交读（READ COMMITTED）</h2><p>一个事务只能读取已经提交的事务所做的修改。换句话说，一个事务所做的修改在提交之前对其它事务是不可见的。</p>
<h2 id="可重复读（REPEATABLE-READ）"><a href="#可重复读（REPEATABLE-READ）" class="headerlink" title="可重复读（REPEATABLE READ）"></a>可重复读（REPEATABLE READ）</h2><p>保证在同一个事务中多次读取同一数据的结果是一样的。</p>
<h2 id="可串行化（SERIALIZABLE）"><a href="#可串行化（SERIALIZABLE）" class="headerlink" title="可串行化（SERIALIZABLE）"></a>可串行化（SERIALIZABLE）</h2><p>强制事务串行执行，这样多个事务互不干扰，不会出现并发一致性问题。</p>
<p>该隔离级别需要加锁实现，因为要使用加锁机制保证同一时间只有一个事务执行，也就是保证事务串行执行。</p>
<hr>
<div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/image-20191207223400787.png"/> </div><br>

<h1 id="五、多版本并发控制"><a href="#五、多版本并发控制" class="headerlink" title="五、多版本并发控制"></a>五、多版本并发控制</h1><p>多版本并发控制（MVCC）是InnoDB 存储引擎实现隔离级别的一种具体方式，用于实现<strong>提交读和可重复读</strong>这两种隔离级别。</p>
<p>而未提交读隔离级别总是读取最新的数据行，要求很低，无需使用 MVCC。</p>
<p>可串行化隔离级别需要对所有读取的行都加锁，单纯使用 MVCC 无法实现。</p>
<h2 id="基本思想-怎么实现中间两个隔离界别"><a href="#基本思想-怎么实现中间两个隔离界别" class="headerlink" title="基本思想(怎么实现中间两个隔离界别)"></a>基本思想(怎么实现中间两个隔离界别)</h2><p>主要是通过版本号来做。</p>
<p>在封锁一节中提到，加锁能解决多个事务同时执行时出现的并发一致性问题。在实际场景中读操作往往多于写操作，因此又引入了读写锁来避免不必要的加锁操作，例如读和读没有互斥关系。</p>
<p>读写锁中读和写操作仍然是互斥的，而 MVCC 利用了多版本的思想，写操作更新最新的版本快照，而读操作去读旧版本快照，没有互斥关系，这一点和 CopyOnWrite 类似。</p>
<p>在 MVCC 中事务的修改操作（DELETE、INSERT、UPDATE…<strong>增删改</strong>）会为数据行新增一个版本快照。</p>
<p>脏读和不可重复读最根本的原因是事务读取到其它事务未提交的修改。在事务进行读取操作时，为了解决脏读和不可重复读问题，MVCC 规定只能读取已经提交的快照。当然一个事务可以读取自身未提交的快照，这不算是脏读。</p>
<h2 id="版本号"><a href="#版本号" class="headerlink" title="版本号"></a>版本号</h2><ul>
<li>系统版本号 SYS_ID：是一个递增的数字，每开始一个新的事务，系统版本号就会自动递增。</li>
<li>事务版本号 TRX_ID ：事务开始时的系统版本号。</li>
</ul>
<h2 id="Undo-日志"><a href="#Undo-日志" class="headerlink" title="Undo 日志"></a>Undo 日志</h2><p>MVCC 的<strong>多版本</strong>指的是多个版本的快照，<strong>快照存储在 Undo 日志中</strong>，该日志通过回滚指针 ROLL_PTR 把一个数据行的所有快照连接起来。</p>
<p>例如在 MySQL 创建一个表 t，包含主键 id 和一个字段 x。我们先插入一个数据行，然后对该数据行执行两次更新操作。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t(id, x) <span class="keyword">VALUES</span>(<span class="number">1</span>, &quot;a&quot;);</span><br><span class="line">UPDATE t <span class="keyword">SET</span> x<span class="operator">=</span>&quot;b&quot; <span class="keyword">WHERE</span> id<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line">UPDATE t <span class="keyword">SET</span> x<span class="operator">=</span>&quot;c&quot; <span class="keyword">WHERE</span> id<span class="operator">=</span><span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<p>因为没有使用 <code>START TRANSACTION</code> 将上面的操作当成一个事务来执行，根据 MySQL 的 AUTOCOMMIT 机制，每个操作都会被当成一个事务来执行，所以上面的操作总共涉及到三个事务。快照中除了记录事务版本号 TRX_ID 和操作之外，还记录了一个 bit 的 DEL 字段，用于标记是否被删除。</p>
<div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/image-20191208164808217.png"/> </div><br>

<p>INSERT、UPDATE、DELETE 操作会创建一个日志，并将事务版本号 TRX_ID  写入。DELETE 可以看成是一个特殊的 UPDATE，还会额外将 DEL 字段设置为 1。</p>
<h2 id="ReadView"><a href="#ReadView" class="headerlink" title="ReadView"></a>ReadView</h2><p>(通过TRX_ID范围来判断我当前这个操作是在事务前/后还是根据隔离识别来)</p>
<p>MVCC 维护了一个 <strong>ReadView</strong> 结构，主要包含了<strong>当前系统未提交的事务列表 TRX_IDs {TRX_ID_1, TRX_ID_2, …}**，还有该列表的最小值 **TRX_ID_MIN</strong> 和 <strong>TRX_ID_MAX</strong>。</p>
<div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/image-20191208171445674.png"/> </div><br>

<p>在进行 SELECT 操作时(因为要选择数据)，根据数据行快照的 TRX_ID 与 TRX_ID_MIN 和 TRX_ID_MAX 之间的关系，从而判断数据行快照是否可以使用：</p>
<ul>
<li><p>TRX_ID &lt; TRX_ID_MIN，表示该数据行快照时在当前所有未提交事务之前进行更改的，因此可以使用。</p>
</li>
<li><p>TRX_ID &gt; TRX_ID_MAX，表示该数据行快照是在事务启动之后被更改的，因此不可使用。</p>
</li>
<li><p>TRX_ID_MIN &lt;= TRX_ID &lt;= TRX_ID_MAX，需要根据隔离级别再进行判断：</p>
<ul>
<li>提交读：如果 TRX_ID  在 TRX_IDs  列表中，表示该数据行快照对应的事务还未提交，则该快照不可使用。否则表示已经提交，可以使用。</li>
<li>可重复读：都不可以使用。因为如果可以使用的话，那么其它事务也可以读到这个数据行快照并进行修改，那么当前事务再去读这个数据行得到的值就会发生改变，也就是出现了不可重复读问题。</li>
</ul>
</li>
</ul>
<p>在数据行快照不可使用的情况下，需要沿着 Undo Log 的回滚指针 ROLL_PTR  找到下一个快照，再进行上面的判断。</p>
<h2 id="快照读与当前读"><a href="#快照读与当前读" class="headerlink" title="快照读与当前读"></a>快照读与当前读</h2><h3 id="1-快照读"><a href="#1-快照读" class="headerlink" title="1. 快照读"></a>1. 快照读</h3><p>MVCC 的 <strong>SELECT</strong> 操作是<strong>快照</strong>中的数据，不需要进行加锁操作。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">table</span> ...;</span><br></pre></td></tr></table></figure>
<h3 id="2-当前读"><a href="#2-当前读" class="headerlink" title="2. 当前读"></a>2. 当前读</h3><p>MVCC 其它会对数据库进行修改的操作（INSERT、UPDATE、DELETE）需要进行<strong>加锁</strong>操作，从而读取最新的数据。可以看到 MVCC 并不是完全不用加锁，而<strong>只是避免了 SELECT 的加锁操作</strong>。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span>;</span><br><span class="line">UPDATE;</span><br><span class="line"><span class="keyword">DELETE</span>;</span><br></pre></td></tr></table></figure>
<p>在进行 SELECT 操作时，可以强制指定进行加锁操作。以下第一个语句需要加 S 锁，第二个需要加 X 锁。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> ? lock <span class="keyword">in</span> share mode;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> ? <span class="keyword">for</span> update;</span><br></pre></td></tr></table></figure>
<h1 id="六、Next-Key-Locks"><a href="#六、Next-Key-Locks" class="headerlink" title="六、Next-Key Locks"></a>六、Next-Key Locks</h1><p>Next-Key Locks 是 MySQL 的 InnoDB 存储引擎的一种锁实现。</p>
<p>MVCC 不能解决<strong>幻影读问题，Next-Key Locks 就是为了解决这个问题而存在的</strong>。在可重复读（REPEATABLE READ）隔离级别下，使用 MVCC + Next-Key Locks 可以解决幻读问题。</p>
<h2 id="Record-Locks-锁索引"><a href="#Record-Locks-锁索引" class="headerlink" title="Record Locks(锁索引)"></a>Record Locks(锁索引)</h2><p>锁定一个记录上的索引，而不是记录本身。</p>
<p>如果表没有设置索引，InnoDB 会自动在主键上创建隐藏的聚簇索引，因此 Record Locks 依然可以使用。</p>
<h2 id="Gap-Locks-锁间隙"><a href="#Gap-Locks-锁间隙" class="headerlink" title="Gap Locks(锁间隙)"></a>Gap Locks(锁间隙)</h2><p>锁定索引之间的间隙，但是不包含索引本身。例如当一个事务执行以下语句，其它事务就不能在 t.c 中插入 15。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> c <span class="keyword">FROM</span> t <span class="keyword">WHERE</span> c <span class="keyword">BETWEEN</span> <span class="number">10</span> <span class="keyword">and</span> <span class="number">20</span> <span class="keyword">FOR</span> UPDATE;</span><br></pre></td></tr></table></figure>
<h2 id="Next-Key-Locks"><a href="#Next-Key-Locks" class="headerlink" title="Next-Key Locks"></a>Next-Key Locks</h2><p>它是 Record Locks 和 Gap Locks 的结合，不仅<strong>锁定一个记录上的索引</strong>，也<strong>锁定索引之间的间隙</strong>。</p>
<p>它锁定一个前开后闭区间，例如一个索引包含以下值：10, 11, 13, and 20，那么就需要锁定以下区间：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="operator">-</span>∞, <span class="number">10</span>]</span><br><span class="line">(<span class="number">10</span>, <span class="number">11</span>]</span><br><span class="line">(<span class="number">11</span>, <span class="number">13</span>]</span><br><span class="line">(<span class="number">13</span>, <span class="number">20</span>]</span><br><span class="line">(<span class="number">20</span>, <span class="operator">+</span>∞)</span><br></pre></td></tr></table></figure>
<p>其中索引都要锁住如(10, 11]，但是间隙如13~20也要锁着。</p>
<h1 id="七、关系数据库设计理论"><a href="#七、关系数据库设计理论" class="headerlink" title="七、关系数据库设计理论"></a>七、关系数据库设计理论</h1><h2 id="函数依赖"><a href="#函数依赖" class="headerlink" title="函数依赖"></a>函数依赖</h2><p>记 A-&gt;B 表示 A 函数决定 B，也可以说 B 函数依赖于 A。</p>
<p>如果 {A1，A2，… ，An} 是关系的一个或多个属性的集合，该集合函数决定了关系的其它<strong>所有属性并且是最小的</strong>，那么该集合就称为<strong>键码</strong>。</p>
<p>对于 A-&gt;B，如果能找到 A 的真子集 A’，使得 A’-&gt; B，那么 A-&gt;B 就是部分函数依赖，否则就是完全函数依赖。</p>
<p>对于 A-&gt;B，B-&gt;C，则 A-&gt;C 是一个传递函数依赖。</p>
<h2 id="异常"><a href="#异常" class="headerlink" title="异常"></a>异常</h2><p>以下的学生课程关系的函数依赖为 {Sno, Cname} -&gt; {Sname, Sdept, Mname, Grade}，键码为 {Sno, Cname}。也就是说，确定学生和课程之后，就能确定其它信息。</p>
<table>
<thead>
<tr>
<th align="center">Sno</th>
<th align="center">Sname</th>
<th align="center">Sdept</th>
<th align="center">Mname</th>
<th align="center">Cname</th>
<th align="center">Grade</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td align="center">学生-1</td>
<td align="center">学院-1</td>
<td align="center">院长-1</td>
<td align="center">课程-1</td>
<td align="center">90</td>
</tr>
<tr>
<td align="center">2</td>
<td align="center">学生-2</td>
<td align="center">学院-2</td>
<td align="center">院长-2</td>
<td align="center">课程-2</td>
<td align="center">80</td>
</tr>
<tr>
<td align="center">2</td>
<td align="center">学生-2</td>
<td align="center">学院-2</td>
<td align="center">院长-2</td>
<td align="center">课程-1</td>
<td align="center">100</td>
</tr>
<tr>
<td align="center">3</td>
<td align="center">学生-3</td>
<td align="center">学院-2</td>
<td align="center">院长-2</td>
<td align="center">课程-2</td>
<td align="center">95</td>
</tr>
</tbody></table>
<p>不符合范式的关系，会产生很多异常，主要有以下四种异常：</p>
<ul>
<li>冗余数据：例如 <code>学生-2</code> 出现了两次。</li>
<li>修改异常：修改了一个记录中的信息，但是另一个记录中相同的信息却没有被修改。</li>
<li>删除异常：删除一个信息，那么也会丢失其它信息。例如删除了 <code>课程-1</code> 需要删除第一行和第三行，那么 <code>学生-1</code> 的信息就会丢失。</li>
<li>插入异常：例如想要插入一个学生的信息，如果这个学生还没选课，那么就无法插入。</li>
</ul>
<h2 id="范式"><a href="#范式" class="headerlink" title="范式"></a>范式</h2><p>范式理论是为了解决以上提到四种异常。</p>
<p>高级别范式的依赖于低级别的范式，1NF 是最低级别的范式。</p>
<h3 id="1-第一范式-1NF"><a href="#1-第一范式-1NF" class="headerlink" title="1. 第一范式 (1NF)"></a>1. 第一范式 (1NF)</h3><p>属性不可分。</p>
<h3 id="2-第二范式-2NF"><a href="#2-第二范式-2NF" class="headerlink" title="2. 第二范式 (2NF)"></a>2. 第二范式 (2NF)</h3><p>每个非主属性完全函数依赖于键码。</p>
<p>可以通过分解来满足。</p>
<p><font size=4>  <strong>分解前</strong>  </font><br></p>
<table>
<thead>
<tr>
<th align="center">Sno</th>
<th align="center">Sname</th>
<th align="center">Sdept</th>
<th align="center">Mname</th>
<th align="center">Cname</th>
<th align="center">Grade</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td align="center">学生-1</td>
<td align="center">学院-1</td>
<td align="center">院长-1</td>
<td align="center">课程-1</td>
<td align="center">90</td>
</tr>
<tr>
<td align="center">2</td>
<td align="center">学生-2</td>
<td align="center">学院-2</td>
<td align="center">院长-2</td>
<td align="center">课程-2</td>
<td align="center">80</td>
</tr>
<tr>
<td align="center">2</td>
<td align="center">学生-2</td>
<td align="center">学院-2</td>
<td align="center">院长-2</td>
<td align="center">课程-1</td>
<td align="center">100</td>
</tr>
<tr>
<td align="center">3</td>
<td align="center">学生-3</td>
<td align="center">学院-2</td>
<td align="center">院长-2</td>
<td align="center">课程-2</td>
<td align="center">95</td>
</tr>
</tbody></table>
<p>以上学生课程关系中，{Sno, Cname} 为键码，有如下函数依赖：</p>
<ul>
<li>Sno -&gt; Sname, Sdept</li>
<li>Sdept -&gt; Mname</li>
<li>Sno, Cname-&gt; Grade</li>
</ul>
<p>Grade 完全函数依赖于键码，它没有任何冗余数据，每个学生的每门课都有特定的成绩。</p>
<p>Sname, Sdept 和 Mname 都部分依赖于键码，当一个学生选修了多门课时，这些数据就会出现多次，造成大量冗余数据。</p>
<p><font size=4>  <strong>分解后</strong>  </font><br></p>
<p>关系-1</p>
<table>
<thead>
<tr>
<th align="center">Sno</th>
<th align="center">Sname</th>
<th align="center">Sdept</th>
<th align="center">Mname</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td align="center">学生-1</td>
<td align="center">学院-1</td>
<td align="center">院长-1</td>
</tr>
<tr>
<td align="center">2</td>
<td align="center">学生-2</td>
<td align="center">学院-2</td>
<td align="center">院长-2</td>
</tr>
<tr>
<td align="center">3</td>
<td align="center">学生-3</td>
<td align="center">学院-2</td>
<td align="center">院长-2</td>
</tr>
</tbody></table>
<p>有以下函数依赖：</p>
<ul>
<li>Sno -&gt; Sname, Sdept</li>
<li>Sdept -&gt; Mname</li>
</ul>
<p>关系-2</p>
<table>
<thead>
<tr>
<th align="center">Sno</th>
<th align="center">Cname</th>
<th align="center">Grade</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td align="center">课程-1</td>
<td align="center">90</td>
</tr>
<tr>
<td align="center">2</td>
<td align="center">课程-2</td>
<td align="center">80</td>
</tr>
<tr>
<td align="center">2</td>
<td align="center">课程-1</td>
<td align="center">100</td>
</tr>
<tr>
<td align="center">3</td>
<td align="center">课程-2</td>
<td align="center">95</td>
</tr>
</tbody></table>
<p>有以下函数依赖：</p>
<ul>
<li>Sno, Cname -&gt;  Grade</li>
</ul>
<h3 id="3-第三范式-3NF"><a href="#3-第三范式-3NF" class="headerlink" title="3. 第三范式 (3NF)"></a>3. 第三范式 (3NF)</h3><p>非主属性不传递函数依赖于键码。</p>
<p>上面的 关系-1 中存在以下传递函数依赖：</p>
<ul>
<li>Sno -&gt; Sdept -&gt; Mname</li>
</ul>
<p>可以进行以下分解：</p>
<p>关系-11</p>
<table>
<thead>
<tr>
<th align="center">Sno</th>
<th align="center">Sname</th>
<th align="center">Sdept</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td align="center">学生-1</td>
<td align="center">学院-1</td>
</tr>
<tr>
<td align="center">2</td>
<td align="center">学生-2</td>
<td align="center">学院-2</td>
</tr>
<tr>
<td align="center">3</td>
<td align="center">学生-3</td>
<td align="center">学院-2</td>
</tr>
</tbody></table>
<p>关系-12</p>
<table>
<thead>
<tr>
<th align="center">Sdept</th>
<th align="center">Mname</th>
</tr>
</thead>
<tbody><tr>
<td align="center">学院-1</td>
<td align="center">院长-1</td>
</tr>
<tr>
<td align="center">学院-2</td>
<td align="center">院长-2</td>
</tr>
</tbody></table>
<h1 id="八、ER-图（还需要看下）"><a href="#八、ER-图（还需要看下）" class="headerlink" title="八、ER 图（还需要看下）"></a>八、ER 图（还需要看下）</h1><p>Entity-Relationship，有三个组成部分：实体、属性、联系。</p>
<p>用来进行关系型数据库系统的概念设计。</p>
<h2 id="实体的三种联系"><a href="#实体的三种联系" class="headerlink" title="实体的三种联系"></a>实体的三种联系</h2><p>包含一对一，一对多，多对多三种。</p>
<ul>
<li>如果 A 到 B 是一对多关系，那么画个带箭头的线段指向 B；</li>
<li>如果是一对一，画两个带箭头的线段；</li>
<li>如果是多对多，画两个不带箭头的线段。</li>
</ul>
<p>下图的 Course 和 Student 是一对多的关系。</p>
<div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/1d28ad05-39e5-49a2-a6a1-a6f496adba6a.png" width="380px"/> </div><br>

<h2 id="表示出现多次的关系"><a href="#表示出现多次的关系" class="headerlink" title="表示出现多次的关系"></a>表示出现多次的关系</h2><p>一个实体在联系出现几次，就要用几条线连接。</p>
<p>下图表示一个课程的先修关系，先修关系出现两个 Course 实体，第一个是先修课程，后一个是后修课程，因此需要用两条线来表示这种关系。</p>
<div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/ac929ea3-daca-40ec-9e95-4b2fa6678243.png" width="250px"/> </div><br>

<h2 id="联系的多向性"><a href="#联系的多向性" class="headerlink" title="联系的多向性"></a>联系的多向性</h2><p>虽然老师可以开设多门课，并且可以教授多名学生，但是对于特定的学生和课程，只有一个老师教授，这就构成了一个三元联系。</p>
<div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/5bb1b38a-527e-4802-a385-267dadbd30ba.png" width="350px"/> </div><br>

<h2 id="表示子类"><a href="#表示子类" class="headerlink" title="表示子类"></a>表示子类</h2><p>用一个三角形和两条线来连接类和子类，与子类有关的属性和联系都连到子类上，而与父类和子类都有关的连到父类上。</p>
<div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/14389ea4-8d96-4e96-9f76-564ca3324c1e.png" width="450px"/> </div><br>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color4">SQL</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2020/08/24/2020-08-24-MySQL%E5%86%85%E5%AE%B9/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-2020-03-11-kubernetes-pods详解" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/03/11/2020-03-11-kubernetes-pods%E8%AF%A6%E8%A7%A3/">kubernetes-Pods详解</a>
    </h1>
  

        
        <a href="/2020/03/11/2020-03-11-kubernetes-pods%E8%AF%A6%E8%A7%A3/" class="archive-article-date">
  	<time datetime="2020-03-10T16:00:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2020-03-11</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="kubernetes-Pods详解"><a href="#kubernetes-Pods详解" class="headerlink" title="kubernetes-Pods详解"></a>kubernetes-Pods详解</h1><p>Pod的应用、配置、调度、升级及扩缩容相关。</p>
<h2 id="Pod的创建"><a href="#Pod的创建" class="headerlink" title="Pod的创建"></a>Pod的创建</h2><p>Pod由一个或者多个container构成，主要体现在spec.container下可以提供多个container镜像的构建方法。<br>创建一个server: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: auth-server &#x2F;&#x2F; Pod名称</span><br><span class="line">spec:</span><br><span class="line">  containers: &#x2F;&#x2F; Pod中运行的容器内容，可以有多个</span><br><span class="line">    - name: auth-server &#x2F;&#x2F; 容器名称</span><br><span class="line">      image: authserver:v1 &#x2F;&#x2F; 镜像来源</span><br><span class="line">      ports:</span><br><span class="line">      - containerPort: 8000 &#x2F;&#x2F; 容器监听的端口，是容器自己的端口</span><br><span class="line">        hostPort: 8000 &#x2F;&#x2F; 映射到主机上开启的端口</span><br></pre></td></tr></table></figure>
<p>Pod中可以有多个容器应用，相互之间仅需要通过localhost就可以访问了(也就是所谓的Pod中的容器被绑定在一起)，可以在容器中直接访问localhost访问Pod中的其他容器(前提是容器中另一个容器的端口监听开启)。<br>创建Pod时，采用的是:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f auth-server.yaml</span><br><span class="line">也可以使用</span><br><span class="line">kubectl apply -f auth-server.yaml</span><br></pre></td></tr></table></figure>
<p>可以通过describe来查看Pod的详细信息(包括端口是否开启正常等信息)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe pod auth-server</span><br></pre></td></tr></table></figure>
<h2 id="静态Pod"><a href="#静态Pod" class="headerlink" title="静态Pod"></a>静态Pod</h2><p><strong>仅存在特定的Node上</strong>，这意味着<strong>仅能通过kubelet管理</strong>。</p>
<p>无法通过ApiServer管理，无法与RC、Deployment和DaemonSet关联，即是该Node上静态的、不可被其他方控制的Pod。一般通过配置文件方式和HTTP方式配置。</p>
<h3 id="配置文件方式"><a href="#配置文件方式" class="headerlink" title="配置文件方式"></a>配置文件方式</h3><p>主要是为kubelet添加–config启动参数。其流程实际上是这样的:</p>
<p>启动kubelet-&gt;查找是否有指定目录-&gt;有的话，定期监控扫描目录-&gt;若有yaml或json文件-&gt;创建静态Pod。</p>
<p>通过配置启动参数–config=&lt;配置文件目录&gt;即可。一旦静态Pod创建成功，将无法在Master上通过kubectl delete pods进行删除。</p>
<h3 id="HTTP方式"><a href="#HTTP方式" class="headerlink" title="HTTP方式"></a>HTTP方式</h3><p>设置kubelet启动参数–manifest-url=<url>来定期从url下载yaml或json文件，有则进行静态Pod创建。</p>
<h2 id="Pod共享Volume"><a href="#Pod共享Volume" class="headerlink" title="Pod共享Volume"></a>Pod共享Volume</h2><p>多个容器共享Pod的存储卷，通过子啊containers下配置即可:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">containers:</span><br><span class="line">  - name: </span><br><span class="line">    volumeMounts:</span><br><span class="line">	- name: app-logs</span><br><span class="line">	  mountPath: &#x2F;usr&#x2F;loacl &#x2F;&#x2F; 卷挂载位置</span><br><span class="line">  - name:</span><br><span class="line">    volumeMounts:</span><br><span class="line">	- name: app-logs</span><br><span class="line">	  mountPath: &#x2F;usr&#x2F;loacl</span><br><span class="line">  volumes: &#x2F;&#x2F;添加这个方便控制存储卷</span><br><span class="line">  - name: app-logs</span><br><span class="line">    emptyDir: &#123;&#125; &#x2F;&#x2F;类型为emptyDir</span><br></pre></td></tr></table></figure>
<h2 id="Pods配置管理"><a href="#Pods配置管理" class="headerlink" title="Pods配置管理"></a>Pods配置管理</h2><h3 id="ConfigMap"><a href="#ConfigMap" class="headerlink" title="ConfigMap"></a>ConfigMap</h3><h2 id="Pods的重启策略及健康检查"><a href="#Pods的重启策略及健康检查" class="headerlink" title="Pods的重启策略及健康检查"></a>Pods的重启策略及健康检查</h2><p>重启策略和健康检查主要是对Pod生命周期进行管理，健康检查发现Pod存在问题，再采用重启策略。对Pod而言，一共有多种状态:</p>
<p>Prending | 镜像没有创建完毕，包括正在下载镜像等过程<br>Running  | 至少有一个容器已经处于运行状态、正在启动状态或正在重启状态<br>Succeeded| 所有容器成功执行后退出，并且没有因为故障需要重启<br>Failed   | 所有容器均已退出，但至少有一个容器退出时为失败状态<br>Unknown  | 无法获取Pod状态，可能是网络不畅</p>
<h3 id="重启策略"><a href="#重启策略" class="headerlink" title="重启策略"></a>重启策略</h3><p>Pod会存在故障等问题，所以需要配置相应的重启策略RestartPolicy，一般有三种:<br>Always: 容器失效时，立刻重启容器。<br>OnFailure: 容器终止且退出码不为0，即失败退出时，重启容器。<br>Never: 从不重启。<br>三类重启策略实际上是需要和控制方式挂钩的，不同方式的重启策略不同:<br>RC和DaemonSet: 必须Always，因为需要保证容器持久运行<br>Job: OnFailure或者Never，确保执行完成后不再重启<br>kubelet: 失效时自动重启Pod，此时是静态Pod，无论设置为什么策略，都不会进行健康检查。</p>
<h3 id="健康检查"><a href="#健康检查" class="headerlink" title="健康检查"></a>健康检查</h3><p>既然有重启策略，自然需要对Pod状态进行检查，这里涉及到两类健康检查探针:<br>LivenessProbe:判断容器是否存活(Running)，若不指明该探针，则默认该探针均返回Success。<br>ReadinessProbe:判断容器是否可用(Ready状态，是在get pods中显示的)，只有Ready后Pod才可以接收请求，常与Service的发现相关。</p>
<p>两类探针可以通过3种方式配置:<br>1.ExecAction</p>
<p>在容器中每次健康检查时执行命令来判断运行是否正常。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">containers:</span><br><span class="line">  - name: </span><br><span class="line">    livenessProbe:</span><br><span class="line">	  exec:</span><br><span class="line">	    command:</span><br><span class="line">		- cat</span><br><span class="line">		- &#x2F;tmp&#x2F;health</span><br><span class="line">		initialDelaySeconds: 60</span><br><span class="line">		timeoutSeconds: 2</span><br></pre></td></tr></table></figure>
<p>2.TCPSocketAction</p>
<p>定时通过容器的IP地址和端口号执行TCP检查</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">containers:</span><br><span class="line">  - name: </span><br><span class="line">    livenessProbe:</span><br><span class="line">	  tcpSocket:</span><br><span class="line">	    port: 8000</span><br><span class="line">		initialDelaySeconds: 60</span><br><span class="line">		timeoutSeconds: 2</span><br></pre></td></tr></table></figure>
<p>3.HTTPGetAction</p>
<p>定时通过容器的IP、端口号即路径调用HTTP Get方法，如果状态码大于200小雨400，则正常</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">containers:</span><br><span class="line">  - name: </span><br><span class="line">    livenessProbe:</span><br><span class="line">	  httpGet:</span><br><span class="line">	    path: &#x2F;_status&#x2F;healthz</span><br><span class="line">		port: 8000</span><br><span class="line">		initialDelaySeconds: 60</span><br><span class="line">		timeoutSeconds: 2</span><br></pre></td></tr></table></figure>
<p>需要注意的是: **每种方式都需要设置initialDelaySeconds(首次健康检查时间)和timeoutSeconds(健康检查请求等待响应的超时时间)**，否则无法进行健康检查。<br>此外，1.14版本之后还有Pod Readness Gates的健康检查方法，支持自定义的检查内容。</p>
<p><strong><em>配置完健康检查后，在几次检查后总会出错，一直循环报错导致pods卡在开关循环里，后续待处理</em></strong></p>
<h2 id="Pods的调度-重要"><a href="#Pods的调度-重要" class="headerlink" title="Pods的调度 | 重要"></a>Pods的调度 | 重要</h2><p>当然了，在kubernetes平台上直接创建Pod是很蠢的，因为当数量剧增，往往不容易管理，一般会通过RC、Deployment、DaemonSet、Job等控制器进行Pod副本的创建、调度和生命周期管理等自动控制。</p>
<h3 id="DaemonSet-在每个Node上调度一个Pod"><a href="#DaemonSet-在每个Node上调度一个Pod" class="headerlink" title="DaemonSet: 在每个Node上调度一个Pod"></a>DaemonSet: 在每个Node上调度一个Pod</h3><p>DaemonSet用于管理集群中每个Node上仅运行一份Pod的副本实例，那么从这个情况就能大致猜到，log和存储相关。<br>Daemonset主要用于三个场景:</p>
<ol>
<li>Gluster存储或者Ceph存储(不了解，后续在看)</li>
<li>日志采集程序，以fluentd为代表</li>
<li>性能监控程序，采集Node运行性能，如Prometheus<br>具体示例详见其他博文。</li>
</ol>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color1">Kubernetes</a>
        		</li>
      		 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color4">pod</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2020/03/11/2020-03-11-kubernetes-pods%E8%AF%A6%E8%A7%A3/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-2020-08-24-HashMap实现方式及相关内容" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/03/11/2020-08-24-HashMap%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F%E5%8F%8A%E7%9B%B8%E5%85%B3%E5%86%85%E5%AE%B9/">HashMap实现方式及相关内容</a>
    </h1>
  

        
        <a href="/2020/03/11/2020-08-24-HashMap%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F%E5%8F%8A%E7%9B%B8%E5%85%B3%E5%86%85%E5%AE%B9/" class="archive-article-date">
  	<time datetime="2020-03-10T16:00:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2020-03-11</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="HashMap实现方式及相关内容"><a href="#HashMap实现方式及相关内容" class="headerlink" title="HashMap实现方式及相关内容"></a>HashMap实现方式及相关内容</h1><h2 id="实现方式"><a href="#实现方式" class="headerlink" title="实现方式"></a>实现方式</h2><p>HashMap在jdk1.8中是通过<strong>链地址法</strong>实现的：</p>
<ol>
<li><p>先用一个数组作为桶存放数据结构</p>
</li>
<li><p>然后桶中存放的要么是<strong>链表</strong>（<strong>链表的节点个数小于等于8</strong>），要么是<strong>红黑树</strong>（链表节点数大了之后变成红黑树），要么为<strong>空</strong>。</p>
</li>
<li><p>如果计算的索引位置冲突了，就加入到链表中一直延伸，超过链表大小阈值就转换为红黑树。</p>
<h2 id="插入时，计算插入到哪里-先异或后与"><a href="#插入时，计算插入到哪里-先异或后与" class="headerlink" title="插入时，计算插入到哪里(先异或后与)"></a>插入时，计算插入到哪里(先异或后与)</h2><p>实际上是通过hashCode得到哈希码，然后计算得到哈希值，再计算在桶中的位置，冲突则解决冲突，用链地址法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 给一个key，求HashCode，对Code操作得到hash，再计算存放位置，这里是哈希值hash的计算方法</span><br><span class="line">return (key &#x3D;&#x3D; null)? 0 : h &#x3D; key.hashCode() ^ h &gt;&gt;&gt;16;</span><br><span class="line">position &#x3D; (n - 1) &amp; hash; &#x2F;&#x2F;n是桶的数组长度</span><br><span class="line">&#x2F;&#x2F; 为什么n-1？因为n是2的幂次方，所以一个位置是1，其他全0，n-1后，所有低位都变成1，这样就可以按位与了</span><br></pre></td></tr></table></figure>
<p>哈希表存的是key和对应的value值，需要建立key的索引位置，key的hashCode一共32位，右移16位异或可以将高低位信息整合在一起，这样就计算出哈希值了。<br>求哈希值（各种哈希值hash求法，称为哈希函数:模N取余（hash=K mod C），数字分析法(取key中取值较均匀的数字作为地址)，aK+C直接寻址法，平法取中法(key平方，取中间分布较均匀的几位)等等。<br>解决哈希冲突的比如线性探测法(一个个向后探测)，二次探测法(往左右跳着探测)，伪随机探测法(伪随机数，往边上定位置)），链地址法（后续加入链表）。<br>hash求出来后，实际上是做到了key-&gt;hash的映射，但是存储位置还没有定下来，所以需要继续计算存储位置position。<br>特别的是，<strong>key==null的内容放在第0个桶</strong>。</p>
</li>
</ol>
<h3 id="如果键值对多了，怎么定扩容？"><a href="#如果键值对多了，怎么定扩容？" class="headerlink" title="如果键值对多了，怎么定扩容？"></a>如果键值对多了，怎么定扩容？</h3><p>在不断放入元素的时候，怎么把Map扩容？然后把数字放进去？</p>
<p>扩容操作一般出现在<strong>容量*负载因子=该容量时需要进行扩容</strong>，HashMap每次扩容到<strong>2的幂次方</strong>，涉及到rehash和数据复制。</p>
<p>为什么容量必须为2的整数次方，并且扩容是2倍2倍地扩：使扩容前的单个节点无需与其他节点交互，只控制自己的节点和跳过去的新节点。</p>
<p>例如hash表有8个，要扩容为16个，那么之前放在7表的数据，可能对16取模会余15，也可能还是7；其他7种元素只能分配到7和15以外的0-15余数；这样的话，只需把部分数据往15表上移，保留一部分到原表中。</p>
<p>下面的方法是获得大于cap(可以理解成输入键值的大小)且最近的2的整数次幂的数。如输入10，则返回16。</p>
<p>其中<strong>cap-1</strong>的目的是另找到的目标值大于或等于原值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">int n &#x3D; cap - 1;</span><br><span class="line">n |&#x3D; n &gt;&gt;&gt; 1;</span><br><span class="line">n |&#x3D; n &gt;&gt;&gt; 2;</span><br><span class="line">n |&#x3D; n &gt;&gt;&gt; 4;</span><br><span class="line">n |&#x3D; n &gt;&gt;&gt; 8;</span><br><span class="line">n |&#x3D; n &gt;&gt;&gt; 16;</span><br><span class="line">return (n &lt; 0) ? 1 : (n &gt; MAXIMUM_CAPACITY)? MAXIMUM_CAPACITY: n+1;</span><br></pre></td></tr></table></figure>
<p>这里做了什么？</p>
<ol>
<li><p>把n-1，这是为了找到≥原值的扩容目标值</p>
</li>
<li><p>做1 2 4 8 16 的右移位，是为了把高位1的影响依次传递到后面，找到大于cap且最近的2的整数次幂（右移1，则绑定了每2位，右移2，则在此基础上绑定了每4位，类推），最后肯定是全1，然后+1就能出2的幂次方了，对应n位。</p>
</li>
</ol>
<h2 id="get方法"><a href="#get方法" class="headerlink" title="get方法"></a>get方法</h2><ul>
<li><p>首先对key求hash后取得所定位的桶。</p>
</li>
<li><p>如果桶为空则直接返回 null 。</p>
</li>
<li><p>否则判断桶的第一个位置(有可能是链表、红黑树)的 key 是否为查询的 key，是就直接返回 value。</p>
</li>
<li><p>如果第一个不匹配，则判断它的下一个是红黑树还是链表。</p>
</li>
<li><p>红黑树就按照树的查找方式返回值。</p>
</li>
<li><p>不然就按照链表的方式遍历匹配返回值。</p>
<h2 id="put方法"><a href="#put方法" class="headerlink" title="put方法"></a>put方法</h2></li>
</ul>
<p>主要通过putVal()函数实现，putVal过程中：</p>
<ul>
<li><p>判断当前桶是否为空，空的就需要初始化（resize 中会判断是否进行初始化）。</p>
</li>
<li><p>根据当前 key.hashcode 定位到具体的桶中并判断是否为空，为空表明没有 Hash 冲突，在当前位置创建一个新桶即可。</p>
</li>
<li><ol start="3">
<li>如果当前桶有值（ Hash 冲突），那么就要比较当前桶中的 key、key 的 hashcode 与写入的 key 是否相等，相等就赋值给 e,在第 8 步的时候会统一进行赋值及返回。</li>
</ol>
</li>
<li><p>3 中不等，则如果当前桶为红黑树，那就要按照红黑树的方式写入数据。</p>
</li>
<li><p>3.中不等，如果是个链表，就需要将当前的 key、value 封装成一个新节点写入到当前桶的后面（形成链表）。</p>
</li>
<li><p>接着判断当前链表的大小是否大于预设的阈值（默认为8），大于时就要转换为红黑树。</p>
</li>
<li><p>如果在遍历过程中找到 key 相同时直接退出遍历。</p>
</li>
<li><ol start="8">
<li>如果 e != null 就相当于存在相同的 key, 那就需要将值覆盖。</li>
</ol>
</li>
<li><p>最后判断是否需要进行扩容。</p>
</li>
</ul>
<h2 id="扩容过程"><a href="#扩容过程" class="headerlink" title="扩容过程"></a>扩容过程</h2><p>通过resize函数将数组扩容为原来容量的2倍后，需要<strong>重新将原有的元素映射到数组中</strong>。</p>
<ol>
<li><p>如果原来的位置只有一个节点，直接通过pos = (n - 1) &amp; hash计算其在数组中的位置。</p>
</li>
<li><p>如果是链表，进行链表的rehash时，根据hash &amp; oldCap的结果是0还是1，将链表拆分成两部分。</p>
</li>
</ol>
<p>举个栗子：如果原数组的容量为16，那n-1=15，然后有两个Entry通过pos = (n - 1) &amp; hash这个公式计算得到，他们在桶中的位置索引都是5。</p>
<p>扩容后，数组长度变成原来的两倍即32（n的大小变化了），n-1=31，用二进制表示就是1 1111，然后通过pos = (n - 1) &amp; hash这个公式，就能把上面两个节点分成两个部分。</p>
<ol start="3">
<li>如果是红黑树，就调用红黑树的split()方法，此处，会对红黑树也和链表一样分为高位和低位两个部分，如果树中元素的个数小于6个了，就将红黑树转换成链表。</li>
</ol>
<h2 id="移除过程"><a href="#移除过程" class="headerlink" title="移除过程"></a>移除过程</h2><p>移除元素时，先通过key找到对应的结点。</p>
<p>然后再分为链表、红黑树两种情况去处理。</p>
<p>红黑树转换成链表的操作。</p>
<p>在resize中和remove中是不同的，resize中是当红黑树中的节点少于6个时就将红黑树转为链表，</p>
<p>而remove函数中，是当红黑树的根节点的左孩子或右孩子为空时，才将红黑树转换成链表的。</p>
<h2 id="为什么HashMap线程不安全？在并发场景下使用时容易出现死循环？"><a href="#为什么HashMap线程不安全？在并发场景下使用时容易出现死循环？" class="headerlink" title="为什么HashMap线程不安全？在并发场景下使用时容易出现死循环？"></a>为什么HashMap线程不安全？在并发场景下使用时容易出现死循环？</h2><p>put导致数据覆盖：put时如果桶中的数据为空，则直接new一个元素，放入桶中。</p>
<p>在并发条件下，第一个线程判断桶中无元素，则new一个新节点，如果此时该线程被挂起。</p>
<p>然后另一个线程直接在此处放了一个新节点进去，然后线程1被唤醒后，不知道此位置已经有新元素了，会直接放数据进去，此时会将原来线程放的数据覆盖。</p>
<p>此外，在put的时候涉及到size++的操作，可能会导致HashMap的size出错。</p>
<p>说白了就是线程1put的时候，线程1被挂起，线程2不知道new过了，重复new覆盖线程1的数据。</p>
<p><strong>1. 扩容时(不断put需要扩容时)死循环或数据丢失(jdk1.7中插入元素用的是头插法,每次会把元素插入到新数组的头部,后面往后推)</strong></p>
<ul>
<li>假设有两个线程A和B都在进行put操作(假设当前需要扩容从2-&gt;4)。线程A在执行到transfer函数中被挂起，此时线程A还没完成扩容操作，链表还没有重连接完毕。</li>
</ul>
<p>假设当时容量2，内容为7-&gt;5，插入一个3变成7-&gt;5-&gt;3，需要扩容，执行到下面的第二步。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">e.next  &#x3D; newTable[i];</span><br><span class="line">newTable[i] &#x3D; e;	&#x2F;&#x2F;在这里被挂起</span><br><span class="line">e &#x3D; next.</span><br></pre></td></tr></table></figure>
<p>此时已经变成7-&gt;5和3-&gt;null，e=3，还没完成链表调整。</p>
<ul>
<li><p>线程A挂起后，此时线程B正常执行，并完成resize操作，把链表的重连接做好了，弄成了5 和 7-&gt;3, 有7.next = 3;</p>
</li>
<li><p>此时切换到线程A上，在线程A挂起时内存中存放的值和2的结构不一样。</p>
</li>
<li><p>A继续执行，可能出现链表a.next = b, b.next = a的环形链表出现，然后进行get操作时，就可能引起死循环。</p>
</li>
<li><p>也有可能A继续执行，因为链表结构不同，直接跳过了某个值的连接关系，导致数据丢失。</p>
</li>
</ul>
<p><strong>2. put时扩容带来数据覆盖，发生线程不安全(jdk1.8中)</strong></p>
<p>jdk1.8中，在发生hash碰撞，不再采用头插法方式，而是直接插入新数组上的链表尾部，因此不会出现环形链表的情况。</p>
<p>put时，如果没有hash碰撞则会直接插入元素。如果<strong>线程A和线程B同时进行put操作</strong>，刚好<strong>这两条不同的数据hash值一样，并且该位置数据为null</strong>，所以这线程A、B都会进入代码put内容。</p>
<p>假设一种情况，线程A进入后还未进行数据插入时挂起，而线程B正常执行，从而正常插入数据。</p>
<p>然后线程A获取时间片，此时线程A不进行hash判断了，问题出现：线程A会把线程B插入的数据给覆盖，发生线程不安全。</p>
<h3 id="HashTable怎么就线程安全了？"><a href="#HashTable怎么就线程安全了？" class="headerlink" title="HashTable怎么就线程安全了？"></a>HashTable怎么就线程安全了？</h3><p>HashTable通过加synchronized关键字修饰方法来做线程安全。synchronized可以保证方法或者代码块在运行时，同一时刻只有一个方法可以进入到临界区，同时它还可以保证共享变量的内存可见性，实际上就是加了个全局锁，所以其实效率也低下。</p>
<h2 id="LinkedHashMap继承HashMap"><a href="#LinkedHashMap继承HashMap" class="headerlink" title="LinkedHashMap继承HashMap"></a>LinkedHashMap继承HashMap</h2><p>其在HashMap的基础上，<strong>增加了一条双向链表</strong>，使得可以保持键值对的插入顺序，继承自原来HashMap的Node，增加了befor和after两个字段，用于维护双向链表。</p>
<p>除此之外，为了记录插入顺序，在LinkedHashMap中，增加了<strong>头结点和尾节点</strong>两个变量，每当有新键值对节点插入，新节点最终会接在 tail 引用指向的节点后面。而 tail 引用则会移动到新的节点上，这样一个双向链表就建立起来了。</p>
<p>相应的下面几个过程，重要的都是，在操作完之后，如果更新双向链表关系。</p>
<h3 id="建立过程"><a href="#建立过程" class="headerlink" title="建立过程"></a>建立过程</h3><p>重写了newNode方法，在这里建立链表的关系。（即生成新的节点，然后更新链表，新节点添加到链表尾部）</p>
<h3 id="删除过程"><a href="#删除过程" class="headerlink" title="删除过程"></a>删除过程</h3><p>使用的是HashMap的remove方法，但是重写了afterNodeRemoval方法，在这里更新链表。</p>
<h3 id="访问元素"><a href="#访问元素" class="headerlink" title="访问元素"></a>访问元素</h3><p>在访问元素的时候，有一个<strong>accessOrder</strong>属性，为<strong>true</strong>时，每访问一个元素，都会将这个访问的元素放到尾部，保证链表尾部是最常访问的数据，可用在缓存等场景中。</p>
<p>LinkedHashMap使用父类的HashMap来实现元素的访问，重写了afterNodeAccess方法，这样如果accessOrder为true时，就会调用afterNodeAccess方法，来按照访问来维护链表的顺序。</p>
<h3 id="基于LinkedHashMap的缓存实现"><a href="#基于LinkedHashMap的缓存实现" class="headerlink" title="基于LinkedHashMap的缓存实现"></a>基于LinkedHashMap的缓存实现</h3><p>基于LinkedHashMap，可以实现LRU缓存。在HashMap的putVal函数最后，会调用afterInsertion函数。而LinkedHashMap重写了这个函数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">void afterNodeInsertion(boolean evict) &#123; &#x2F;&#x2F; possibly remove eldest</span><br><span class="line">    LinkedHashMap.Entry&lt;K,V&gt; first;</span><br><span class="line">    &#x2F;&#x2F; 根据条件判断是否移除最近最少被访问的节点</span><br><span class="line">    if (evict &amp;&amp; (first &#x3D; head) !&#x3D; null &amp;&amp; removeEldestEntry(first)) &#123;</span><br><span class="line">        K key &#x3D; first.key;</span><br><span class="line">        removeNode(hash(key), key, null, false, true);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F; 移除最近最少被访问条件之一，通过覆盖此方法可实现不同策略的缓存</span><br><span class="line">	&#x2F;&#x2F; 这里了也是修改缓存机制时需要重写的地方</span><br><span class="line">	protected boolean removeEldestEntry(Map.Entry&lt;K,V&gt; eldest) &#123;</span><br><span class="line">		return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果想用LinkedHashMap来实现LRU缓存，就直接继承LinkedHashMap，然后重写removeEldestEntry函数，设置在某些条件下让其返回true（比如当前集合的元素数量大于某一阈值，就返回true，否则返回false）。这样，当条件满足时，就会删除头节点。</p>
<h1 id="volatile关键字"><a href="#volatile关键字" class="headerlink" title="volatile关键字"></a>volatile关键字</h1><h1 id="ConcurrentHashMap——线程安全的HashMap-jdk-1-7"><a href="#ConcurrentHashMap——线程安全的HashMap-jdk-1-7" class="headerlink" title="ConcurrentHashMap——线程安全的HashMap(jdk 1.7)"></a>ConcurrentHashMap——线程安全的HashMap(jdk 1.7)</h1><p>相比之下，ConcurrentHashMap 使用了分段锁技术来提高了并发度，ConcurrentHashMap引入Segment 的概念，目的是将map拆分成多个Segment(默认16个)。</p>
<p>操作ConcurrentHashMap细化到操作某一个Segment(槽)。在多线程环境下，不同线程操作不同的Segment，他们互不影响，这便可实现并发操作。</p>
<p>当我们对ConcurrentHashMap并发操作时，只要锁住一个 segment，其他剩余的Segment依然可以操作。这样只要保证每个 Segment 是线程安全的，我们就实现了全局的线程安全。而每个segment后面则是和hashmap一样，由数组+链表的结构组成。</p>
<div align="center"> <img src="https://upload-images.jianshu.io/upload_images/807144-4db95a9fa5fedc1c?imageMogr2/auto-orient/strip|imageView2/2/w/820/format/webp" width=""> </div><br>


<p>其主要采用<strong>CAS操作+synchronized锁</strong>的方式实现线程安全，其中synchronize锁的粒度为桶中头结点（包括链表Node结点，包装红黑树的TreeBin结点），底层依然由 “数组”桶+链表+红黑树 的方式实现。</p>
<h2 id="put方法-1"><a href="#put方法-1" class="headerlink" title="put方法"></a>put方法</h2><ul>
<li><p>通过key找到承载的Segment对象位置，然后调用tryLock()竞争Segment的锁，以确保能操作线程；如果获取锁失败，执行scanAndLockForPut方法等到调用成功。</p>
</li>
<li><p>循环次数retries 次数大于事先设置定好的MAX_SCAN_RETRIES，就执行lock() 方法，此方法会阻塞等待，一直到成功拿到Segment锁为止。</p>
</li>
<li><p>调用成功后走put流程</p>
</li>
<li><p>遍历该 HashEntry，如果不为空则判断传入的 key 和当前遍历的 key 是否相等，相等则覆盖旧的 value。</p>
</li>
<li><p>此前没有改key，即为空，则需要新建一个 HashEntry 并加入到 Segment 中，会先判断是否需要扩容。（这里就涉及到hashmap中的扩容导致线程不安全的问题了）</p>
</li>
<li><p>最后会解除获取当前 Segment 的锁。</p>
</li>
</ul>
<h3 id="那么在这样的设计下，是否还会有hashmap的put线程不安全问题呢？"><a href="#那么在这样的设计下，是否还会有hashmap的put线程不安全问题呢？" class="headerlink" title="那么在这样的设计下，是否还会有hashmap的put线程不安全问题呢？"></a>那么在这样的设计下，是否还会有hashmap的put线程不安全问题呢？</h3><p>ConcurrentHashMap的Segment槽是固定的16个，不变的</p>
<p>而ConcurrentHashMap的扩容实际上是Segment中的HashEntry数组扩容。当HashEntry达到某个临界点后，会扩容2为之前的2倍， 原理跟HashMap扩容类似。</p>
<p>进行扩容时，调用rehash方法，其实就是HashEntry扩展逻辑。</p>
<p>当线程执行到rehash方法时，表示当前线程已经获取到到当前Segment的锁对象，这就表示rehash方法的执行是线程安全，不会存在并发问题。</p>
<h2 id="remove"><a href="#remove" class="headerlink" title="remove"></a>remove</h2><p>ConcurrentHashMap的remove方法跟put方法操作一样，先获取segement对象后再操作，这里就不重复了。也是找到位置，然后删除。</p>
<h2 id="get"><a href="#get" class="headerlink" title="get"></a>get</h2><p>会发现<strong>get方法并没有获取锁的操作</strong>，这时就得讨论下执行get操作线程安全问题啦。</p>
<p>只需要将 Key 通过 Hash 之后定位到具体的 Segment ，再通过一次 Hash 定位到具体的元素上。</p>
<p>get方法之所以不需要加锁，原因比较简单，get为只读操作，不会改动map数据结构，所以在操作过程中，只需要保证涉及读取数据的属性为线程可见即可，也即使用volatile修饰。</p>
<p>所以ConcurrentHashMap 的 get 方法是非常高效的，因为整个过程都不需要加锁。</p>
<h2 id="ConcurrentHashMap-jdk1-8版本"><a href="#ConcurrentHashMap-jdk1-8版本" class="headerlink" title="ConcurrentHashMap(jdk1.8版本)"></a>ConcurrentHashMap(jdk1.8版本)</h2><p>jdk8版本的ConcurrentHashMap直接抛弃了Segment的设计，采用了较为轻捷的Node + CAS + Synchronized设计，保证线程安全。</p>
<p>具体的数据结构是这样的：</p>
<div align="center"> <img src="https://upload-images.jianshu.io/upload_images/807144-6264960638978dff?imageMogr2/auto-orient/strip|imageView2/2/w/757/format/webp" width=""> </div><br>

<p>构建一个默认大小为16的Node数组，类似hashmap的数组桶，数组上是链表node(1.7中是HashEntry,node中把val和next都用volatile修饰，保证了可见性)或者红黑树TreeNode。</p>
<p>桶中元素有自己的hash值来指定他是什么内容：</p>
<pre><code>hash== -1 (MOVED) ： 当前节点是ForwardingNode节点，处于扩展中。

hash== -2 (TREEBIN) ： 当前节点已经树化，为TreeBin对象，TreeBin节点代理红黑树操作

hash== -3 (RESERVED) ： 临时保留的哈希
</code></pre>
<h3 id="重要的内部类"><a href="#重要的内部类" class="headerlink" title="重要的内部类"></a>重要的内部类</h3><ol>
<li><p>Node节点类：<strong>这个类是后面三个类的基类。</strong>和HashMap中的节点类似，只是其<strong>val变量和next指针都用volatile来修饰</strong>。且不允许调用setValue方法修改Node的value值。</p>
</li>
<li><p>TreeNode：<strong>树节点</strong>类，指的是整个TreeBin中的节点的数据结构。</p>
</li>
</ol>
<p>链表过长时会转换成红黑树，但是与HashMap不相同的是，<strong>它不直接转换为红黑树</strong>，而是把Node包装成树节点<strong>TreeNode放在TreeBin对象</strong>中，然后由TreeBin这个数据结构完成对红黑树的包装。</p>
<p>而且TreeNode在ConcurrentHashMap继承自Node类，也就是说<strong>TreeNode带有next指针</strong>，这样做的目的是方便基于TreeBin的访问。</p>
<ol start="3">
<li>TreeBin： </li>
</ol>
<p>这个类放了一个名为root的TreeNode节点，也就是说在实际的ConcurrentHashMap“数组”中，存放的是TreeBin对象，而不是TreeNode对象，这是与HashMap的区别，另外这个类还带有了读写锁。</p>
<p>而HashMap的不足在于他的桶中存储的是TreeNode结点，这里的根本原因是并发过程中，有可能因为树的调整，形状发生错误变化，这样的话，桶中的第一个元素就变了，而使用TreeBin包装的话，就不会出现这种情况。 </p>
<p>这种类型的节点，我们通过hash值是否等于-2就可以判断桶中的节点是否是红黑树。</p>
<ol start="4">
<li>ForwardingNode：用于连接两个table的节点类。</li>
</ol>
<p>它包含一个nextTable指针，用于指向下一张表。而且这个节点的key value next指针全部为null。</p>
<p>在扩容操作中，我们需要对每个桶中的结点进行分离和转移。如果某个桶结点中所有节点都已经迁移完成了（已经被转移到新表 nextTable 中了），那么会在原 table 表的该位置挂上一个 ForwardingNode 结点，说明此桶<strong>已经完成迁移</strong>。这种类型的节点的hash值是-1。</p>
<h2 id="数组初始化"><a href="#数组初始化" class="headerlink" title="数组初始化"></a>数组初始化</h2><p>数组的初始化是在ConcurrentHashMap插入元素的时候发生的，如调用put时当前表为空时发生的。确定没有在扩容后，new一个新的表，更新sc。</p>
<p>初始化操作在initTable()中，没加锁，因为采取的策略是通过sizeCtl来判定是否已经有线程在扩容。</p>
<p><strong>sizeCtl(sc)</strong></p>
<p>一个控制标志符，取值不同有不同的含义：</p>
<ul>
<li>负数 代表正在进行初始化或扩容操作</li>
<li>-1 代表正在初始化</li>
<li>-N 表示有N-1个线程正在扩容</li>
<li>正数或0 代表hash表还没有被初始化，这个数值表示初始化(0)或下一次进行扩容的大小(正数)，这一点类似于扩容阈值的概念。它始终是容量的0.75倍。</li>
</ul>
<p>当sizeCtl&lt;0时，说明已经有线程在扩容，这个线程就会调用Thread.yield()让出一次CPU执行时间。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">if ((sc &#x3D; sizeCtl) &lt; 0)</span><br><span class="line">	Thread.yield(); &#x2F;&#x2F; lost initialization race; just spin</span><br><span class="line">else if (U.compareAndSwapInt(this, SIZECTL, sc, -1)) &#123;&#x2F;&#x2F;当前没有线程扩容，那就利用CAS方法把sizectl的值置为-1 表示本线程正在进行初始化</span><br><span class="line">		try &#123;</span><br><span class="line">			if ((tab &#x3D; table) &#x3D;&#x3D; null || tab.length &#x3D;&#x3D; 0) &#123;</span><br><span class="line">				&#x2F;&#x2F; sc&gt;0表明还没初始化，通过sc的值来初始化容量大小</span><br><span class="line">				int n &#x3D; (sc &gt; 0) ? sc : DEFAULT_CAPACITY;</span><br><span class="line">				@SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">				&#x2F;&#x2F; 根据sc开辟数组作为桶</span><br><span class="line">				Node&lt;K,V&gt;[] nt &#x3D; (Node&lt;K,V&gt;[])new Node&lt;?,?&gt;[n];</span><br><span class="line">				table &#x3D; tab &#x3D; nt;</span><br><span class="line">				&#x2F;&#x2F; 相当于0.75*n 用sizeCtl来表示阈值</span><br><span class="line">				sc &#x3D; n - (n &gt;&gt;&gt; 2);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; finally &#123;</span><br><span class="line">			sizeCtl &#x3D; sc;</span><br><span class="line">		&#125;</span><br><span class="line">		break;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h2 id="并发扩容-记录个数-判断是否扩容-扩容步骤"><a href="#并发扩容-记录个数-判断是否扩容-扩容步骤" class="headerlink" title="并发扩容(记录个数+判断是否扩容+扩容步骤)"></a>并发扩容(记录个数+判断是否扩容+扩容步骤)</h2><p>可以看到，优先级上，先判断是否初始化(初始化的时候其实也先判断了是否在扩容)，再判断是否在扩容(在扩容的话就需要去协助扩容)，最后才是put等操作。</p>
<p>使用addCount()记录元素个数，并检查是否需要进行扩容。</p>
<p>需要扩容时调用transfer()调整节点位置。</p>
<h3 id="addCount-计数-扩容调用"><a href="#addCount-计数-扩容调用" class="headerlink" title="addCount() 计数 + 扩容调用"></a>addCount() 计数 + 扩容调用</h3><p>ConcurrentHashMap使用一个long型名为baseCount变量和一个CounterCell[]的名为counterCells的变量一起记录size。（hashmap中是单独的size变量）</p>
<ul>
<li><p>首先通过CAS操作去直接更新baseCount。</p>
</li>
<li><p>如果失败，那说明有多个线程在竞争更新baseCount。则使用fullAddCount()，把x的值插入到counterCell类中，更新counterCells，等待后续更新baseCount。(为了避免更新冲突，生成随机数来生成hash，唯一标识)</p>
</li>
<li><p>然后检查是否需要扩容是否正在扩容。如果需要扩容，就调用扩容方法，如果正在扩容，就帮助其扩容，最后调用的都是transfer()。</p>
</li>
</ul>
<p>fullAddCount()：</p>
<ul>
<li><p>第一次执行的时候，counterCells这个数组应该是空的，所以先生成了一个大小为2的数组，赋值给了counterCells，然后创建一个初始值为要更新的量的CounterCell放在counterCells对应位置上。</p>
</li>
<li><p>如果通过(n - 1) &amp; h计算得到的线程对应的桶为空，那直接new一个初始值为x的CounterCell，放到桶中。</p>
</li>
<li><p>上一步失败的话，wasUncontended=false，那就通过代码，将wasUncontended更新为true，说明已经冲突了,开启下一次循环。</p>
</li>
</ul>
<h3 id="transfer进行位置调整"><a href="#transfer进行位置调整" class="headerlink" title="transfer进行位置调整"></a>transfer进行位置调整</h3><p>首先搞清楚，扩容是由线程承担的，每个线程承担不小于 16 个桶中的元素的扩容。</p>
<p>每当开始迁移一个桶中的元素的时候，线程会锁住当前槽中列表的头元素，扩容完成后会将这个桶中的节点设置为ForwardingNode。</p>
<p>假设这时候正好有 get请求过来会仍旧在旧的列表中访问，如果是插入、修改、删除、合并、compute 等操作时遇到 ForwardingNode，就表示正在扩容，那当前线程会加入扩容大军帮忙一起扩容，扩容结束后再做元素的更新操作。</p>
<ul>
<li><p>计算线程能承担多少个桶的扩容</p>
</li>
<li><p>对要扩容的桶，新建2倍大小的数组(因为每次扩容都是*2)，nextTable指向这个新数组。</p>
</li>
<li><p>新建一个ForwardingNode占位，这样别的线程查到这里的时候就知道正在扩容了。</p>
</li>
<li><p>循环处理每个槽(即槽)中的链表元素，并初始化i和bound值，i指当前槽位序号，bound指需要处理的当前槽位边界</p>
</li>
<li><p>当前处理槽结束了或者本来就空不用处理，那就有个ForwardingNode标明。</p>
</li>
<li><p>比如当前槽是需要扩容的，先定义两个变量节点ln和hn，按我的理解应该是lowNode和highNode，分别保存hash值的第X位为0和1的节点。</p>
</li>
</ul>
<p>(这个<strong>第X位</strong>实际上就是<strong>数组大小2^n的那个第n位</strong>，因为容量肯定对应二进制某位为1，其他全0，这样也更方便了他的扩容其实)</p>
<ul>
<li><p>使用fn&amp;n可以快速把链表中的元素区分成两类，A类和B类节点可以分散到新数组的原槽位和后边新加的槽位中。</p>
</li>
<li><p>根据第X位的hash不同把原槽位切成两条(hash第X位为0和为1)，然后复制到新数组中就好了，完成扩容。</p>
</li>
</ul>
<h2 id="put"><a href="#put" class="headerlink" title="put"></a>put</h2><ul>
<li><p>根据 key 计算出 hashcode 。</p>
</li>
<li><p>判断是否需要进行初始化，初始化完毕。</p>
</li>
<li><p>利用 CAS 得到当前 key 定位出的 Node 记为 f ，如果为空表示是首节点插入，<strong>可以直接写入</strong>数据，<strong>利用 CAS 尝试写入</strong>，失败则一直自旋保证成功。</p>
</li>
<li><p>如果不为空，且当前位置的 hashcode == MOVED == -1，表示正在扩容状态，则需要进行协助扩容。</p>
</li>
<li><p>如果上面都走过了，则利用 synchronized 锁住 f ， 插入数据。插入的时候，要么插入到链表中，要么插入到红黑树中。我们发现，这里的锁粒度是很小的，就锁住一个桶所以并发效率更高。</p>
</li>
<li><p>如果是插入到链表中，那去看看链表的长度有没有超过长度阈值8，如果超过了，就要将链表转换成红黑树。</p>
</li>
</ul>
<h2 id="cas写入-重点内容，实现了线程安全"><a href="#cas写入-重点内容，实现了线程安全" class="headerlink" title="cas写入(重点内容，实现了线程安全)"></a>cas写入(重点内容，实现了线程安全)</h2><p>CAS, 比较交换，一种无锁原子算法。CAS是一条原子指令，因为他是一种系统原语，所以在OS中他是被开中断和关中断包起来的。</p>
<p>看CAS之前，先看看synchronized这个锁操作。</p>
<p>在并发编程中，锁是消耗性能的操作，同一时间只能有一个线程进入同步块修改变量的值，比如下面的代码:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">synchronized void function(int b)&#123;</span><br><span class="line">  a &#x3D; a + b；</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果不加 synchronized 的话，这不是一个原子的操作，多线程上面时候会出问题。</p>
<p>多线程修改 a 的值就会导致结果不正确，出现线程安全问题。但锁又是要给耗费性能的操作。不论是拿锁，解锁，还是等待锁，阻塞，都是非常耗费性能的。那么能不能不加锁呢？</p>
<p>CAS过程是这样：它包含 3 个参数 CAS（V，E，N），V表示<strong>要更新的变量的值</strong>，E表示<strong>预期值</strong>，N表示<strong>新值</strong>，即在赋新值前判断是否变量是预期值。</p>
<p>仅当V==E时，才会将V的值设为N；如果V!=E，则说明已经有其他线程做两个更新，则当前线程则什么都不做。</p>
<p>最后，CAS 返回当前V的真实值。当多个线程同时使用CAS 操作一个变量时，只有一个会胜出，并成功更新，其余均会失败。</p>
<p>失败的线程不会挂起，仅是被告知失败，并且允许再次尝试，当然也允许实现的线程放弃操作。基于这样的原理，CAS 操作即使没有锁，也可以发现其他线程对当前线程的干扰。</p>
<h3 id="JAVA如何实现原子操作"><a href="#JAVA如何实现原子操作" class="headerlink" title="JAVA如何实现原子操作"></a>JAVA如何实现原子操作</h3><p>java.util.concurrent.atomic包中，所有类都是原子操作。例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String[] args) throws InterruptedException &#123;</span><br><span class="line">    AtomicInteger integer &#x3D; new AtomicInteger();</span><br><span class="line">    System.out.println(integer.get());</span><br><span class="line"></span><br><span class="line">    Thread[] threads &#x3D; new Thread[1000];</span><br><span class="line">	&#x2F;&#x2F; 启动1000个线程对AtomicInteger变量做自增。</span><br><span class="line">    for (int j &#x3D; 0; j &lt; 1000; j++) &#123;</span><br><span class="line">		&#x2F;&#x2F;启动线程.start()，同时就运行了run方法了</span><br><span class="line">      threads[j] &#x3D; new Thread(() -&gt;</span><br><span class="line">          integer.incrementAndGet()</span><br><span class="line">      );</span><br><span class="line">      threads[j].start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    for (int j &#x3D; 0; j &lt; 1000; j++) &#123;</span><br><span class="line">		&#x2F;&#x2F; join()方法会让main方法等待thread执行完毕后才继续。</span><br><span class="line">      threads[j].join();</span><br><span class="line">    &#125;</span><br><span class="line">	&#x2F;&#x2F; 得到1000</span><br><span class="line">    System.out.println(integer.get());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="CAS-缺点"><a href="#CAS-缺点" class="headerlink" title="CAS 缺点"></a>CAS 缺点</h3><p>著名的ABA问题，就是A-&gt;B-&gt;A, 已经修改完了，但是CAS无法察觉到。基本类型的话没关系，但如果是引用类型，这个对象里边有多个变量，就不好办了。</p>
<p>这时候往往会加入版本号来标注。</p>
<h3 id="使用CAS操作的三个核心方法"><a href="#使用CAS操作的三个核心方法" class="headerlink" title="使用CAS操作的三个核心方法"></a>使用CAS操作的三个核心方法</h3><p>三个静态的用于CAS操作的方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;获得在i位置上的Node节点</span><br><span class="line">static final &lt;K,V&gt; Node&lt;K,V&gt; tabAt(Node&lt;K,V&gt;[] tab, int i) &#123;</span><br><span class="line">	return (Node&lt;K,V&gt;)U.getObjectVolatile(tab, ((long)i &lt;&lt; ASHIFT) + ABASE);</span><br><span class="line">&#125;</span><br><span class="line">	&#x2F;&#x2F;利用CAS算法设置i位置上的Node节点。之所以能实现并发是因为他指定了原来这个节点的值是多少</span><br><span class="line">static final &lt;K,V&gt; boolean casTabAt(Node&lt;K,V&gt;[] tab, int i,</span><br><span class="line">									Node&lt;K,V&gt; c, Node&lt;K,V&gt; v) &#123;</span><br><span class="line">	return U.compareAndSwapObject(tab, ((long)i &lt;&lt; ASHIFT) + ABASE, c, v);</span><br><span class="line">&#125;</span><br><span class="line">	&#x2F;&#x2F;利用volatile方法设置节点位置的值</span><br><span class="line">static final &lt;K,V&gt; void setTabAt(Node&lt;K,V&gt;[] tab, int i, Node&lt;K,V&gt; v) &#123;</span><br><span class="line">	U.putObjectVolatile(tab, ((long)i &lt;&lt; ASHIFT) + ABASE, v);</span><br></pre></td></tr></table></figure>
<h2 id="get-1"><a href="#get-1" class="headerlink" title="get"></a>get</h2><p>同1.7，因为是只读操作，所以没上锁。寻址，返回值。</p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">HashMap</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2020/03/11/2020-08-24-HashMap%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F%E5%8F%8A%E7%9B%B8%E5%85%B3%E5%86%85%E5%AE%B9/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">Next &amp;raquo;</a>
    </nav>
  


          </div>
        </div>
      </div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2021 John Doe
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    <script>
	var yiliaConfig = {
		mathjax: false,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false,
		toc_hide_index: true,
		root: "/",
		innerArchive: true,
		showTags: false
	}
</script>

<script>!function(t){function n(e){if(r[e])return r[e].exports;var i=r[e]={exports:{},id:e,loaded:!1};return t[e].call(i.exports,i,i.exports,n),i.loaded=!0,i.exports}var r={};n.m=t,n.c=r,n.p="./",n(0)}([function(t,n,r){r(195),t.exports=r(191)},function(t,n,r){var e=r(3),i=r(52),o=r(27),u=r(28),c=r(53),f="prototype",a=function(t,n,r){var s,l,h,v,p=t&a.F,d=t&a.G,y=t&a.S,g=t&a.P,b=t&a.B,m=d?e:y?e[n]||(e[n]={}):(e[n]||{})[f],x=d?i:i[n]||(i[n]={}),w=x[f]||(x[f]={});d&&(r=n);for(s in r)l=!p&&m&&void 0!==m[s],h=(l?m:r)[s],v=b&&l?c(h,e):g&&"function"==typeof h?c(Function.call,h):h,m&&u(m,s,h,t&a.U),x[s]!=h&&o(x,s,v),g&&w[s]!=h&&(w[s]=h)};e.core=i,a.F=1,a.G=2,a.S=4,a.P=8,a.B=16,a.W=32,a.U=64,a.R=128,t.exports=a},function(t,n,r){var e=r(6);t.exports=function(t){if(!e(t))throw TypeError(t+" is not an object!");return t}},function(t,n){var r=t.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=r)},function(t,n){t.exports=function(t){try{return!!t()}catch(t){return!0}}},function(t,n){var r=t.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=r)},function(t,n){t.exports=function(t){return"object"==typeof t?null!==t:"function"==typeof t}},function(t,n,r){var e=r(126)("wks"),i=r(76),o=r(3).Symbol,u="function"==typeof o;(t.exports=function(t){return e[t]||(e[t]=u&&o[t]||(u?o:i)("Symbol."+t))}).store=e},function(t,n){var r={}.hasOwnProperty;t.exports=function(t,n){return r.call(t,n)}},function(t,n,r){var e=r(94),i=r(33);t.exports=function(t){return e(i(t))}},function(t,n,r){t.exports=!r(4)(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},function(t,n,r){var e=r(2),i=r(167),o=r(50),u=Object.defineProperty;n.f=r(10)?Object.defineProperty:function(t,n,r){if(e(t),n=o(n,!0),e(r),i)try{return u(t,n,r)}catch(t){}if("get"in r||"set"in r)throw TypeError("Accessors not supported!");return"value"in r&&(t[n]=r.value),t}},function(t,n,r){t.exports=!r(18)(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},function(t,n,r){var e=r(14),i=r(22);t.exports=r(12)?function(t,n,r){return e.f(t,n,i(1,r))}:function(t,n,r){return t[n]=r,t}},function(t,n,r){var e=r(20),i=r(58),o=r(42),u=Object.defineProperty;n.f=r(12)?Object.defineProperty:function(t,n,r){if(e(t),n=o(n,!0),e(r),i)try{return u(t,n,r)}catch(t){}if("get"in r||"set"in r)throw TypeError("Accessors not supported!");return"value"in r&&(t[n]=r.value),t}},function(t,n,r){var e=r(40)("wks"),i=r(23),o=r(5).Symbol,u="function"==typeof o;(t.exports=function(t){return e[t]||(e[t]=u&&o[t]||(u?o:i)("Symbol."+t))}).store=e},function(t,n,r){var e=r(67),i=Math.min;t.exports=function(t){return t>0?i(e(t),9007199254740991):0}},function(t,n,r){var e=r(46);t.exports=function(t){return Object(e(t))}},function(t,n){t.exports=function(t){try{return!!t()}catch(t){return!0}}},function(t,n,r){var e=r(63),i=r(34);t.exports=Object.keys||function(t){return e(t,i)}},function(t,n,r){var e=r(21);t.exports=function(t){if(!e(t))throw TypeError(t+" is not an object!");return t}},function(t,n){t.exports=function(t){return"object"==typeof t?null!==t:"function"==typeof t}},function(t,n){t.exports=function(t,n){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:n}}},function(t,n){var r=0,e=Math.random();t.exports=function(t){return"Symbol(".concat(void 0===t?"":t,")_",(++r+e).toString(36))}},function(t,n){var r={}.hasOwnProperty;t.exports=function(t,n){return r.call(t,n)}},function(t,n){var r=t.exports={version:"2.4.0"};"number"==typeof __e&&(__e=r)},function(t,n){t.exports=function(t){if("function"!=typeof t)throw TypeError(t+" is not a function!");return t}},function(t,n,r){var e=r(11),i=r(66);t.exports=r(10)?function(t,n,r){return e.f(t,n,i(1,r))}:function(t,n,r){return t[n]=r,t}},function(t,n,r){var e=r(3),i=r(27),o=r(24),u=r(76)("src"),c="toString",f=Function[c],a=(""+f).split(c);r(52).inspectSource=function(t){return f.call(t)},(t.exports=function(t,n,r,c){var f="function"==typeof r;f&&(o(r,"name")||i(r,"name",n)),t[n]!==r&&(f&&(o(r,u)||i(r,u,t[n]?""+t[n]:a.join(String(n)))),t===e?t[n]=r:c?t[n]?t[n]=r:i(t,n,r):(delete t[n],i(t,n,r)))})(Function.prototype,c,function(){return"function"==typeof this&&this[u]||f.call(this)})},function(t,n,r){var e=r(1),i=r(4),o=r(46),u=function(t,n,r,e){var i=String(o(t)),u="<"+n;return""!==r&&(u+=" "+r+'="'+String(e).replace(/"/g,"&quot;")+'"'),u+">"+i+"</"+n+">"};t.exports=function(t,n){var r={};r[t]=n(u),e(e.P+e.F*i(function(){var n=""[t]('"');return n!==n.toLowerCase()||n.split('"').length>3}),"String",r)}},function(t,n,r){var e=r(115),i=r(46);t.exports=function(t){return e(i(t))}},function(t,n,r){var e=r(116),i=r(66),o=r(30),u=r(50),c=r(24),f=r(167),a=Object.getOwnPropertyDescriptor;n.f=r(10)?a:function(t,n){if(t=o(t),n=u(n,!0),f)try{return a(t,n)}catch(t){}if(c(t,n))return i(!e.f.call(t,n),t[n])}},function(t,n,r){var e=r(24),i=r(17),o=r(145)("IE_PROTO"),u=Object.prototype;t.exports=Object.getPrototypeOf||function(t){return t=i(t),e(t,o)?t[o]:"function"==typeof t.constructor&&t instanceof t.constructor?t.constructor.prototype:t instanceof Object?u:null}},function(t,n){t.exports=function(t){if(void 0==t)throw TypeError("Can't call method on  "+t);return t}},function(t,n){t.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(t,n){t.exports={}},function(t,n){t.exports=!0},function(t,n){n.f={}.propertyIsEnumerable},function(t,n,r){var e=r(14).f,i=r(8),o=r(15)("toStringTag");t.exports=function(t,n,r){t&&!i(t=r?t:t.prototype,o)&&e(t,o,{configurable:!0,value:n})}},function(t,n,r){var e=r(40)("keys"),i=r(23);t.exports=function(t){return e[t]||(e[t]=i(t))}},function(t,n,r){var e=r(5),i="__core-js_shared__",o=e[i]||(e[i]={});t.exports=function(t){return o[t]||(o[t]={})}},function(t,n){var r=Math.ceil,e=Math.floor;t.exports=function(t){return isNaN(t=+t)?0:(t>0?e:r)(t)}},function(t,n,r){var e=r(21);t.exports=function(t,n){if(!e(t))return t;var r,i;if(n&&"function"==typeof(r=t.toString)&&!e(i=r.call(t)))return i;if("function"==typeof(r=t.valueOf)&&!e(i=r.call(t)))return i;if(!n&&"function"==typeof(r=t.toString)&&!e(i=r.call(t)))return i;throw TypeError("Can't convert object to primitive value")}},function(t,n,r){var e=r(5),i=r(25),o=r(36),u=r(44),c=r(14).f;t.exports=function(t){var n=i.Symbol||(i.Symbol=o?{}:e.Symbol||{});"_"==t.charAt(0)||t in n||c(n,t,{value:u.f(t)})}},function(t,n,r){n.f=r(15)},function(t,n){var r={}.toString;t.exports=function(t){return r.call(t).slice(8,-1)}},function(t,n){t.exports=function(t){if(void 0==t)throw TypeError("Can't call method on  "+t);return t}},function(t,n,r){var e=r(4);t.exports=function(t,n){return!!t&&e(function(){n?t.call(null,function(){},1):t.call(null)})}},function(t,n,r){var e=r(53),i=r(115),o=r(17),u=r(16),c=r(203);t.exports=function(t,n){var r=1==t,f=2==t,a=3==t,s=4==t,l=6==t,h=5==t||l,v=n||c;return function(n,c,p){for(var d,y,g=o(n),b=i(g),m=e(c,p,3),x=u(b.length),w=0,S=r?v(n,x):f?v(n,0):void 0;x>w;w++)if((h||w in b)&&(d=b[w],y=m(d,w,g),t))if(r)S[w]=y;else if(y)switch(t){case 3:return!0;case 5:return d;case 6:return w;case 2:S.push(d)}else if(s)return!1;return l?-1:a||s?s:S}}},function(t,n,r){var e=r(1),i=r(52),o=r(4);t.exports=function(t,n){var r=(i.Object||{})[t]||Object[t],u={};u[t]=n(r),e(e.S+e.F*o(function(){r(1)}),"Object",u)}},function(t,n,r){var e=r(6);t.exports=function(t,n){if(!e(t))return t;var r,i;if(n&&"function"==typeof(r=t.toString)&&!e(i=r.call(t)))return i;if("function"==typeof(r=t.valueOf)&&!e(i=r.call(t)))return i;if(!n&&"function"==typeof(r=t.toString)&&!e(i=r.call(t)))return i;throw TypeError("Can't convert object to primitive value")}},function(t,n,r){var e=r(5),i=r(25),o=r(91),u=r(13),c="prototype",f=function(t,n,r){var a,s,l,h=t&f.F,v=t&f.G,p=t&f.S,d=t&f.P,y=t&f.B,g=t&f.W,b=v?i:i[n]||(i[n]={}),m=b[c],x=v?e:p?e[n]:(e[n]||{})[c];v&&(r=n);for(a in r)(s=!h&&x&&void 0!==x[a])&&a in b||(l=s?x[a]:r[a],b[a]=v&&"function"!=typeof x[a]?r[a]:y&&s?o(l,e):g&&x[a]==l?function(t){var n=function(n,r,e){if(this instanceof t){switch(arguments.length){case 0:return new t;case 1:return new t(n);case 2:return new t(n,r)}return new t(n,r,e)}return t.apply(this,arguments)};return n[c]=t[c],n}(l):d&&"function"==typeof l?o(Function.call,l):l,d&&((b.virtual||(b.virtual={}))[a]=l,t&f.R&&m&&!m[a]&&u(m,a,l)))};f.F=1,f.G=2,f.S=4,f.P=8,f.B=16,f.W=32,f.U=64,f.R=128,t.exports=f},function(t,n){var r=t.exports={version:"2.4.0"};"number"==typeof __e&&(__e=r)},function(t,n,r){var e=r(26);t.exports=function(t,n,r){if(e(t),void 0===n)return t;switch(r){case 1:return function(r){return t.call(n,r)};case 2:return function(r,e){return t.call(n,r,e)};case 3:return function(r,e,i){return t.call(n,r,e,i)}}return function(){return t.apply(n,arguments)}}},function(t,n,r){var e=r(183),i=r(1),o=r(126)("metadata"),u=o.store||(o.store=new(r(186))),c=function(t,n,r){var i=u.get(t);if(!i){if(!r)return;u.set(t,i=new e)}var o=i.get(n);if(!o){if(!r)return;i.set(n,o=new e)}return o},f=function(t,n,r){var e=c(n,r,!1);return void 0!==e&&e.has(t)},a=function(t,n,r){var e=c(n,r,!1);return void 0===e?void 0:e.get(t)},s=function(t,n,r,e){c(r,e,!0).set(t,n)},l=function(t,n){var r=c(t,n,!1),e=[];return r&&r.forEach(function(t,n){e.push(n)}),e},h=function(t){return void 0===t||"symbol"==typeof t?t:String(t)},v=function(t){i(i.S,"Reflect",t)};t.exports={store:u,map:c,has:f,get:a,set:s,keys:l,key:h,exp:v}},function(t,n,r){"use strict";if(r(10)){var e=r(69),i=r(3),o=r(4),u=r(1),c=r(127),f=r(152),a=r(53),s=r(68),l=r(66),h=r(27),v=r(73),p=r(67),d=r(16),y=r(75),g=r(50),b=r(24),m=r(180),x=r(114),w=r(6),S=r(17),_=r(137),O=r(70),E=r(32),P=r(71).f,j=r(154),F=r(76),M=r(7),A=r(48),N=r(117),T=r(146),I=r(155),k=r(80),L=r(123),R=r(74),C=r(130),D=r(160),U=r(11),W=r(31),G=U.f,B=W.f,V=i.RangeError,z=i.TypeError,q=i.Uint8Array,K="ArrayBuffer",J="Shared"+K,Y="BYTES_PER_ELEMENT",H="prototype",$=Array[H],X=f.ArrayBuffer,Q=f.DataView,Z=A(0),tt=A(2),nt=A(3),rt=A(4),et=A(5),it=A(6),ot=N(!0),ut=N(!1),ct=I.values,ft=I.keys,at=I.entries,st=$.lastIndexOf,lt=$.reduce,ht=$.reduceRight,vt=$.join,pt=$.sort,dt=$.slice,yt=$.toString,gt=$.toLocaleString,bt=M("iterator"),mt=M("toStringTag"),xt=F("typed_constructor"),wt=F("def_constructor"),St=c.CONSTR,_t=c.TYPED,Ot=c.VIEW,Et="Wrong length!",Pt=A(1,function(t,n){return Tt(T(t,t[wt]),n)}),jt=o(function(){return 1===new q(new Uint16Array([1]).buffer)[0]}),Ft=!!q&&!!q[H].set&&o(function(){new q(1).set({})}),Mt=function(t,n){if(void 0===t)throw z(Et);var r=+t,e=d(t);if(n&&!m(r,e))throw V(Et);return e},At=function(t,n){var r=p(t);if(r<0||r%n)throw V("Wrong offset!");return r},Nt=function(t){if(w(t)&&_t in t)return t;throw z(t+" is not a typed array!")},Tt=function(t,n){if(!(w(t)&&xt in t))throw z("It is not a typed array constructor!");return new t(n)},It=function(t,n){return kt(T(t,t[wt]),n)},kt=function(t,n){for(var r=0,e=n.length,i=Tt(t,e);e>r;)i[r]=n[r++];return i},Lt=function(t,n,r){G(t,n,{get:function(){return this._d[r]}})},Rt=function(t){var n,r,e,i,o,u,c=S(t),f=arguments.length,s=f>1?arguments[1]:void 0,l=void 0!==s,h=j(c);if(void 0!=h&&!_(h)){for(u=h.call(c),e=[],n=0;!(o=u.next()).done;n++)e.push(o.value);c=e}for(l&&f>2&&(s=a(s,arguments[2],2)),n=0,r=d(c.length),i=Tt(this,r);r>n;n++)i[n]=l?s(c[n],n):c[n];return i},Ct=function(){for(var t=0,n=arguments.length,r=Tt(this,n);n>t;)r[t]=arguments[t++];return r},Dt=!!q&&o(function(){gt.call(new q(1))}),Ut=function(){return gt.apply(Dt?dt.call(Nt(this)):Nt(this),arguments)},Wt={copyWithin:function(t,n){return D.call(Nt(this),t,n,arguments.length>2?arguments[2]:void 0)},every:function(t){return rt(Nt(this),t,arguments.length>1?arguments[1]:void 0)},fill:function(t){return C.apply(Nt(this),arguments)},filter:function(t){return It(this,tt(Nt(this),t,arguments.length>1?arguments[1]:void 0))},find:function(t){return et(Nt(this),t,arguments.length>1?arguments[1]:void 0)},findIndex:function(t){return it(Nt(this),t,arguments.length>1?arguments[1]:void 0)},forEach:function(t){Z(Nt(this),t,arguments.length>1?arguments[1]:void 0)},indexOf:function(t){return ut(Nt(this),t,arguments.length>1?arguments[1]:void 0)},includes:function(t){return ot(Nt(this),t,arguments.length>1?arguments[1]:void 0)},join:function(t){return vt.apply(Nt(this),arguments)},lastIndexOf:function(t){return st.apply(Nt(this),arguments)},map:function(t){return Pt(Nt(this),t,arguments.length>1?arguments[1]:void 0)},reduce:function(t){return lt.apply(Nt(this),arguments)},reduceRight:function(t){return ht.apply(Nt(this),arguments)},reverse:function(){for(var t,n=this,r=Nt(n).length,e=Math.floor(r/2),i=0;i<e;)t=n[i],n[i++]=n[--r],n[r]=t;return n},some:function(t){return nt(Nt(this),t,arguments.length>1?arguments[1]:void 0)},sort:function(t){return pt.call(Nt(this),t)},subarray:function(t,n){var r=Nt(this),e=r.length,i=y(t,e);return new(T(r,r[wt]))(r.buffer,r.byteOffset+i*r.BYTES_PER_ELEMENT,d((void 0===n?e:y(n,e))-i))}},Gt=function(t,n){return It(this,dt.call(Nt(this),t,n))},Bt=function(t){Nt(this);var n=At(arguments[1],1),r=this.length,e=S(t),i=d(e.length),o=0;if(i+n>r)throw V(Et);for(;o<i;)this[n+o]=e[o++]},Vt={entries:function(){return at.call(Nt(this))},keys:function(){return ft.call(Nt(this))},values:function(){return ct.call(Nt(this))}},zt=function(t,n){return w(t)&&t[_t]&&"symbol"!=typeof n&&n in t&&String(+n)==String(n)},qt=function(t,n){return zt(t,n=g(n,!0))?l(2,t[n]):B(t,n)},Kt=function(t,n,r){return!(zt(t,n=g(n,!0))&&w(r)&&b(r,"value"))||b(r,"get")||b(r,"set")||r.configurable||b(r,"writable")&&!r.writable||b(r,"enumerable")&&!r.enumerable?G(t,n,r):(t[n]=r.value,t)};St||(W.f=qt,U.f=Kt),u(u.S+u.F*!St,"Object",{getOwnPropertyDescriptor:qt,defineProperty:Kt}),o(function(){yt.call({})})&&(yt=gt=function(){return vt.call(this)});var Jt=v({},Wt);v(Jt,Vt),h(Jt,bt,Vt.values),v(Jt,{slice:Gt,set:Bt,constructor:function(){},toString:yt,toLocaleString:Ut}),Lt(Jt,"buffer","b"),Lt(Jt,"byteOffset","o"),Lt(Jt,"byteLength","l"),Lt(Jt,"length","e"),G(Jt,mt,{get:function(){return this[_t]}}),t.exports=function(t,n,r,f){f=!!f;var a=t+(f?"Clamped":"")+"Array",l="Uint8Array"!=a,v="get"+t,p="set"+t,y=i[a],g=y||{},b=y&&E(y),m=!y||!c.ABV,S={},_=y&&y[H],j=function(t,r){var e=t._d;return e.v[v](r*n+e.o,jt)},F=function(t,r,e){var i=t._d;f&&(e=(e=Math.round(e))<0?0:e>255?255:255&e),i.v[p](r*n+i.o,e,jt)},M=function(t,n){G(t,n,{get:function(){return j(this,n)},set:function(t){return F(this,n,t)},enumerable:!0})};m?(y=r(function(t,r,e,i){s(t,y,a,"_d");var o,u,c,f,l=0,v=0;if(w(r)){if(!(r instanceof X||(f=x(r))==K||f==J))return _t in r?kt(y,r):Rt.call(y,r);o=r,v=At(e,n);var p=r.byteLength;if(void 0===i){if(p%n)throw V(Et);if((u=p-v)<0)throw V(Et)}else if((u=d(i)*n)+v>p)throw V(Et);c=u/n}else c=Mt(r,!0),u=c*n,o=new X(u);for(h(t,"_d",{b:o,o:v,l:u,e:c,v:new Q(o)});l<c;)M(t,l++)}),_=y[H]=O(Jt),h(_,"constructor",y)):L(function(t){new y(null),new y(t)},!0)||(y=r(function(t,r,e,i){s(t,y,a);var o;return w(r)?r instanceof X||(o=x(r))==K||o==J?void 0!==i?new g(r,At(e,n),i):void 0!==e?new g(r,At(e,n)):new g(r):_t in r?kt(y,r):Rt.call(y,r):new g(Mt(r,l))}),Z(b!==Function.prototype?P(g).concat(P(b)):P(g),function(t){t in y||h(y,t,g[t])}),y[H]=_,e||(_.constructor=y));var A=_[bt],N=!!A&&("values"==A.name||void 0==A.name),T=Vt.values;h(y,xt,!0),h(_,_t,a),h(_,Ot,!0),h(_,wt,y),(f?new y(1)[mt]==a:mt in _)||G(_,mt,{get:function(){return a}}),S[a]=y,u(u.G+u.W+u.F*(y!=g),S),u(u.S,a,{BYTES_PER_ELEMENT:n,from:Rt,of:Ct}),Y in _||h(_,Y,n),u(u.P,a,Wt),R(a),u(u.P+u.F*Ft,a,{set:Bt}),u(u.P+u.F*!N,a,Vt),u(u.P+u.F*(_.toString!=yt),a,{toString:yt}),u(u.P+u.F*o(function(){new y(1).slice()}),a,{slice:Gt}),u(u.P+u.F*(o(function(){return[1,2].toLocaleString()!=new y([1,2]).toLocaleString()})||!o(function(){_.toLocaleString.call([1,2])})),a,{toLocaleString:Ut}),k[a]=N?A:T,e||N||h(_,bt,T)}}else t.exports=function(){}},function(t,n){var r={}.toString;t.exports=function(t){return r.call(t).slice(8,-1)}},function(t,n,r){var e=r(21),i=r(5).document,o=e(i)&&e(i.createElement);t.exports=function(t){return o?i.createElement(t):{}}},function(t,n,r){t.exports=!r(12)&&!r(18)(function(){return 7!=Object.defineProperty(r(57)("div"),"a",{get:function(){return 7}}).a})},function(t,n,r){"use strict";var e=r(36),i=r(51),o=r(64),u=r(13),c=r(8),f=r(35),a=r(96),s=r(38),l=r(103),h=r(15)("iterator"),v=!([].keys&&"next"in[].keys()),p="keys",d="values",y=function(){return this};t.exports=function(t,n,r,g,b,m,x){a(r,n,g);var w,S,_,O=function(t){if(!v&&t in F)return F[t];switch(t){case p:case d:return function(){return new r(this,t)}}return function(){return new r(this,t)}},E=n+" Iterator",P=b==d,j=!1,F=t.prototype,M=F[h]||F["@@iterator"]||b&&F[b],A=M||O(b),N=b?P?O("entries"):A:void 0,T="Array"==n?F.entries||M:M;if(T&&(_=l(T.call(new t)))!==Object.prototype&&(s(_,E,!0),e||c(_,h)||u(_,h,y)),P&&M&&M.name!==d&&(j=!0,A=function(){return M.call(this)}),e&&!x||!v&&!j&&F[h]||u(F,h,A),f[n]=A,f[E]=y,b)if(w={values:P?A:O(d),keys:m?A:O(p),entries:N},x)for(S in w)S in F||o(F,S,w[S]);else i(i.P+i.F*(v||j),n,w);return w}},function(t,n,r){var e=r(20),i=r(100),o=r(34),u=r(39)("IE_PROTO"),c=function(){},f="prototype",a=function(){var t,n=r(57)("iframe"),e=o.length;for(n.style.display="none",r(93).appendChild(n),n.src="javascript:",t=n.contentWindow.document,t.open(),t.write("<script>document.F=Object<\/script>"),t.close(),a=t.F;e--;)delete a[f][o[e]];return a()};t.exports=Object.create||function(t,n){var r;return null!==t?(c[f]=e(t),r=new c,c[f]=null,r[u]=t):r=a(),void 0===n?r:i(r,n)}},function(t,n,r){var e=r(63),i=r(34).concat("length","prototype");n.f=Object.getOwnPropertyNames||function(t){return e(t,i)}},function(t,n){n.f=Object.getOwnPropertySymbols},function(t,n,r){var e=r(8),i=r(9),o=r(90)(!1),u=r(39)("IE_PROTO");t.exports=function(t,n){var r,c=i(t),f=0,a=[];for(r in c)r!=u&&e(c,r)&&a.push(r);for(;n.length>f;)e(c,r=n[f++])&&(~o(a,r)||a.push(r));return a}},function(t,n,r){t.exports=r(13)},function(t,n,r){var e=r(76)("meta"),i=r(6),o=r(24),u=r(11).f,c=0,f=Object.isExtensible||function(){return!0},a=!r(4)(function(){return f(Object.preventExtensions({}))}),s=function(t){u(t,e,{value:{i:"O"+ ++c,w:{}}})},l=function(t,n){if(!i(t))return"symbol"==typeof t?t:("string"==typeof t?"S":"P")+t;if(!o(t,e)){if(!f(t))return"F";if(!n)return"E";s(t)}return t[e].i},h=function(t,n){if(!o(t,e)){if(!f(t))return!0;if(!n)return!1;s(t)}return t[e].w},v=function(t){return a&&p.NEED&&f(t)&&!o(t,e)&&s(t),t},p=t.exports={KEY:e,NEED:!1,fastKey:l,getWeak:h,onFreeze:v}},function(t,n){t.exports=function(t,n){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:n}}},function(t,n){var r=Math.ceil,e=Math.floor;t.exports=function(t){return isNaN(t=+t)?0:(t>0?e:r)(t)}},function(t,n){t.exports=function(t,n,r,e){if(!(t instanceof n)||void 0!==e&&e in t)throw TypeError(r+": incorrect invocation!");return t}},function(t,n){t.exports=!1},function(t,n,r){var e=r(2),i=r(173),o=r(133),u=r(145)("IE_PROTO"),c=function(){},f="prototype",a=function(){var t,n=r(132)("iframe"),e=o.length;for(n.style.display="none",r(135).appendChild(n),n.src="javascript:",t=n.contentWindow.document,t.open(),t.write("<script>document.F=Object<\/script>"),t.close(),a=t.F;e--;)delete a[f][o[e]];return a()};t.exports=Object.create||function(t,n){var r;return null!==t?(c[f]=e(t),r=new c,c[f]=null,r[u]=t):r=a(),void 0===n?r:i(r,n)}},function(t,n,r){var e=r(175),i=r(133).concat("length","prototype");n.f=Object.getOwnPropertyNames||function(t){return e(t,i)}},function(t,n,r){var e=r(175),i=r(133);t.exports=Object.keys||function(t){return e(t,i)}},function(t,n,r){var e=r(28);t.exports=function(t,n,r){for(var i in n)e(t,i,n[i],r);return t}},function(t,n,r){"use strict";var e=r(3),i=r(11),o=r(10),u=r(7)("species");t.exports=function(t){var n=e[t];o&&n&&!n[u]&&i.f(n,u,{configurable:!0,get:function(){return this}})}},function(t,n,r){var e=r(67),i=Math.max,o=Math.min;t.exports=function(t,n){return t=e(t),t<0?i(t+n,0):o(t,n)}},function(t,n){var r=0,e=Math.random();t.exports=function(t){return"Symbol(".concat(void 0===t?"":t,")_",(++r+e).toString(36))}},function(t,n,r){var e=r(33);t.exports=function(t){return Object(e(t))}},function(t,n,r){var e=r(7)("unscopables"),i=Array.prototype;void 0==i[e]&&r(27)(i,e,{}),t.exports=function(t){i[e][t]=!0}},function(t,n,r){var e=r(53),i=r(169),o=r(137),u=r(2),c=r(16),f=r(154),a={},s={},n=t.exports=function(t,n,r,l,h){var v,p,d,y,g=h?function(){return t}:f(t),b=e(r,l,n?2:1),m=0;if("function"!=typeof g)throw TypeError(t+" is not iterable!");if(o(g)){for(v=c(t.length);v>m;m++)if((y=n?b(u(p=t[m])[0],p[1]):b(t[m]))===a||y===s)return y}else for(d=g.call(t);!(p=d.next()).done;)if((y=i(d,b,p.value,n))===a||y===s)return y};n.BREAK=a,n.RETURN=s},function(t,n){t.exports={}},function(t,n,r){var e=r(11).f,i=r(24),o=r(7)("toStringTag");t.exports=function(t,n,r){t&&!i(t=r?t:t.prototype,o)&&e(t,o,{configurable:!0,value:n})}},function(t,n,r){var e=r(1),i=r(46),o=r(4),u=r(150),c="["+u+"]",f="​",a=RegExp("^"+c+c+"*"),s=RegExp(c+c+"*$"),l=function(t,n,r){var i={},c=o(function(){return!!u[t]()||f[t]()!=f}),a=i[t]=c?n(h):u[t];r&&(i[r]=a),e(e.P+e.F*c,"String",i)},h=l.trim=function(t,n){return t=String(i(t)),1&n&&(t=t.replace(a,"")),2&n&&(t=t.replace(s,"")),t};t.exports=l},function(t,n,r){t.exports={default:r(86),__esModule:!0}},function(t,n,r){t.exports={default:r(87),__esModule:!0}},function(t,n,r){"use strict";function e(t){return t&&t.__esModule?t:{default:t}}n.__esModule=!0;var i=r(84),o=e(i),u=r(83),c=e(u),f="function"==typeof c.default&&"symbol"==typeof o.default?function(t){return typeof t}:function(t){return t&&"function"==typeof c.default&&t.constructor===c.default&&t!==c.default.prototype?"symbol":typeof t};n.default="function"==typeof c.default&&"symbol"===f(o.default)?function(t){return void 0===t?"undefined":f(t)}:function(t){return t&&"function"==typeof c.default&&t.constructor===c.default&&t!==c.default.prototype?"symbol":void 0===t?"undefined":f(t)}},function(t,n,r){r(110),r(108),r(111),r(112),t.exports=r(25).Symbol},function(t,n,r){r(109),r(113),t.exports=r(44).f("iterator")},function(t,n){t.exports=function(t){if("function"!=typeof t)throw TypeError(t+" is not a function!");return t}},function(t,n){t.exports=function(){}},function(t,n,r){var e=r(9),i=r(106),o=r(105);t.exports=function(t){return function(n,r,u){var c,f=e(n),a=i(f.length),s=o(u,a);if(t&&r!=r){for(;a>s;)if((c=f[s++])!=c)return!0}else for(;a>s;s++)if((t||s in f)&&f[s]===r)return t||s||0;return!t&&-1}}},function(t,n,r){var e=r(88);t.exports=function(t,n,r){if(e(t),void 0===n)return t;switch(r){case 1:return function(r){return t.call(n,r)};case 2:return function(r,e){return t.call(n,r,e)};case 3:return function(r,e,i){return t.call(n,r,e,i)}}return function(){return t.apply(n,arguments)}}},function(t,n,r){var e=r(19),i=r(62),o=r(37);t.exports=function(t){var n=e(t),r=i.f;if(r)for(var u,c=r(t),f=o.f,a=0;c.length>a;)f.call(t,u=c[a++])&&n.push(u);return n}},function(t,n,r){t.exports=r(5).document&&document.documentElement},function(t,n,r){var e=r(56);t.exports=Object("z").propertyIsEnumerable(0)?Object:function(t){return"String"==e(t)?t.split(""):Object(t)}},function(t,n,r){var e=r(56);t.exports=Array.isArray||function(t){return"Array"==e(t)}},function(t,n,r){"use strict";var e=r(60),i=r(22),o=r(38),u={};r(13)(u,r(15)("iterator"),function(){return this}),t.exports=function(t,n,r){t.prototype=e(u,{next:i(1,r)}),o(t,n+" Iterator")}},function(t,n){t.exports=function(t,n){return{value:n,done:!!t}}},function(t,n,r){var e=r(19),i=r(9);t.exports=function(t,n){for(var r,o=i(t),u=e(o),c=u.length,f=0;c>f;)if(o[r=u[f++]]===n)return r}},function(t,n,r){var e=r(23)("meta"),i=r(21),o=r(8),u=r(14).f,c=0,f=Object.isExtensible||function(){return!0},a=!r(18)(function(){return f(Object.preventExtensions({}))}),s=function(t){u(t,e,{value:{i:"O"+ ++c,w:{}}})},l=function(t,n){if(!i(t))return"symbol"==typeof t?t:("string"==typeof t?"S":"P")+t;if(!o(t,e)){if(!f(t))return"F";if(!n)return"E";s(t)}return t[e].i},h=function(t,n){if(!o(t,e)){if(!f(t))return!0;if(!n)return!1;s(t)}return t[e].w},v=function(t){return a&&p.NEED&&f(t)&&!o(t,e)&&s(t),t},p=t.exports={KEY:e,NEED:!1,fastKey:l,getWeak:h,onFreeze:v}},function(t,n,r){var e=r(14),i=r(20),o=r(19);t.exports=r(12)?Object.defineProperties:function(t,n){i(t);for(var r,u=o(n),c=u.length,f=0;c>f;)e.f(t,r=u[f++],n[r]);return t}},function(t,n,r){var e=r(37),i=r(22),o=r(9),u=r(42),c=r(8),f=r(58),a=Object.getOwnPropertyDescriptor;n.f=r(12)?a:function(t,n){if(t=o(t),n=u(n,!0),f)try{return a(t,n)}catch(t){}if(c(t,n))return i(!e.f.call(t,n),t[n])}},function(t,n,r){var e=r(9),i=r(61).f,o={}.toString,u="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[],c=function(t){try{return i(t)}catch(t){return u.slice()}};t.exports.f=function(t){return u&&"[object Window]"==o.call(t)?c(t):i(e(t))}},function(t,n,r){var e=r(8),i=r(77),o=r(39)("IE_PROTO"),u=Object.prototype;t.exports=Object.getPrototypeOf||function(t){return t=i(t),e(t,o)?t[o]:"function"==typeof t.constructor&&t instanceof t.constructor?t.constructor.prototype:t instanceof Object?u:null}},function(t,n,r){var e=r(41),i=r(33);t.exports=function(t){return function(n,r){var o,u,c=String(i(n)),f=e(r),a=c.length;return f<0||f>=a?t?"":void 0:(o=c.charCodeAt(f),o<55296||o>56319||f+1===a||(u=c.charCodeAt(f+1))<56320||u>57343?t?c.charAt(f):o:t?c.slice(f,f+2):u-56320+(o-55296<<10)+65536)}}},function(t,n,r){var e=r(41),i=Math.max,o=Math.min;t.exports=function(t,n){return t=e(t),t<0?i(t+n,0):o(t,n)}},function(t,n,r){var e=r(41),i=Math.min;t.exports=function(t){return t>0?i(e(t),9007199254740991):0}},function(t,n,r){"use strict";var e=r(89),i=r(97),o=r(35),u=r(9);t.exports=r(59)(Array,"Array",function(t,n){this._t=u(t),this._i=0,this._k=n},function(){var t=this._t,n=this._k,r=this._i++;return!t||r>=t.length?(this._t=void 0,i(1)):"keys"==n?i(0,r):"values"==n?i(0,t[r]):i(0,[r,t[r]])},"values"),o.Arguments=o.Array,e("keys"),e("values"),e("entries")},function(t,n){},function(t,n,r){"use strict";var e=r(104)(!0);r(59)(String,"String",function(t){this._t=String(t),this._i=0},function(){var t,n=this._t,r=this._i;return r>=n.length?{value:void 0,done:!0}:(t=e(n,r),this._i+=t.length,{value:t,done:!1})})},function(t,n,r){"use strict";var e=r(5),i=r(8),o=r(12),u=r(51),c=r(64),f=r(99).KEY,a=r(18),s=r(40),l=r(38),h=r(23),v=r(15),p=r(44),d=r(43),y=r(98),g=r(92),b=r(95),m=r(20),x=r(9),w=r(42),S=r(22),_=r(60),O=r(102),E=r(101),P=r(14),j=r(19),F=E.f,M=P.f,A=O.f,N=e.Symbol,T=e.JSON,I=T&&T.stringify,k="prototype",L=v("_hidden"),R=v("toPrimitive"),C={}.propertyIsEnumerable,D=s("symbol-registry"),U=s("symbols"),W=s("op-symbols"),G=Object[k],B="function"==typeof N,V=e.QObject,z=!V||!V[k]||!V[k].findChild,q=o&&a(function(){return 7!=_(M({},"a",{get:function(){return M(this,"a",{value:7}).a}})).a})?function(t,n,r){var e=F(G,n);e&&delete G[n],M(t,n,r),e&&t!==G&&M(G,n,e)}:M,K=function(t){var n=U[t]=_(N[k]);return n._k=t,n},J=B&&"symbol"==typeof N.iterator?function(t){return"symbol"==typeof t}:function(t){return t instanceof N},Y=function(t,n,r){return t===G&&Y(W,n,r),m(t),n=w(n,!0),m(r),i(U,n)?(r.enumerable?(i(t,L)&&t[L][n]&&(t[L][n]=!1),r=_(r,{enumerable:S(0,!1)})):(i(t,L)||M(t,L,S(1,{})),t[L][n]=!0),q(t,n,r)):M(t,n,r)},H=function(t,n){m(t);for(var r,e=g(n=x(n)),i=0,o=e.length;o>i;)Y(t,r=e[i++],n[r]);return t},$=function(t,n){return void 0===n?_(t):H(_(t),n)},X=function(t){var n=C.call(this,t=w(t,!0));return!(this===G&&i(U,t)&&!i(W,t))&&(!(n||!i(this,t)||!i(U,t)||i(this,L)&&this[L][t])||n)},Q=function(t,n){if(t=x(t),n=w(n,!0),t!==G||!i(U,n)||i(W,n)){var r=F(t,n);return!r||!i(U,n)||i(t,L)&&t[L][n]||(r.enumerable=!0),r}},Z=function(t){for(var n,r=A(x(t)),e=[],o=0;r.length>o;)i(U,n=r[o++])||n==L||n==f||e.push(n);return e},tt=function(t){for(var n,r=t===G,e=A(r?W:x(t)),o=[],u=0;e.length>u;)!i(U,n=e[u++])||r&&!i(G,n)||o.push(U[n]);return o};B||(N=function(){if(this instanceof N)throw TypeError("Symbol is not a constructor!");var t=h(arguments.length>0?arguments[0]:void 0),n=function(r){this===G&&n.call(W,r),i(this,L)&&i(this[L],t)&&(this[L][t]=!1),q(this,t,S(1,r))};return o&&z&&q(G,t,{configurable:!0,set:n}),K(t)},c(N[k],"toString",function(){return this._k}),E.f=Q,P.f=Y,r(61).f=O.f=Z,r(37).f=X,r(62).f=tt,o&&!r(36)&&c(G,"propertyIsEnumerable",X,!0),p.f=function(t){return K(v(t))}),u(u.G+u.W+u.F*!B,{Symbol:N});for(var nt="hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),rt=0;nt.length>rt;)v(nt[rt++]);for(var nt=j(v.store),rt=0;nt.length>rt;)d(nt[rt++]);u(u.S+u.F*!B,"Symbol",{for:function(t){return i(D,t+="")?D[t]:D[t]=N(t)},keyFor:function(t){if(J(t))return y(D,t);throw TypeError(t+" is not a symbol!")},useSetter:function(){z=!0},useSimple:function(){z=!1}}),u(u.S+u.F*!B,"Object",{create:$,defineProperty:Y,defineProperties:H,getOwnPropertyDescriptor:Q,getOwnPropertyNames:Z,getOwnPropertySymbols:tt}),T&&u(u.S+u.F*(!B||a(function(){var t=N();return"[null]"!=I([t])||"{}"!=I({a:t})||"{}"!=I(Object(t))})),"JSON",{stringify:function(t){if(void 0!==t&&!J(t)){for(var n,r,e=[t],i=1;arguments.length>i;)e.push(arguments[i++]);return n=e[1],"function"==typeof n&&(r=n),!r&&b(n)||(n=function(t,n){if(r&&(n=r.call(this,t,n)),!J(n))return n}),e[1]=n,I.apply(T,e)}}}),N[k][R]||r(13)(N[k],R,N[k].valueOf),l(N,"Symbol"),l(Math,"Math",!0),l(e.JSON,"JSON",!0)},function(t,n,r){r(43)("asyncIterator")},function(t,n,r){r(43)("observable")},function(t,n,r){r(107);for(var e=r(5),i=r(13),o=r(35),u=r(15)("toStringTag"),c=["NodeList","DOMTokenList","MediaList","StyleSheetList","CSSRuleList"],f=0;f<5;f++){var a=c[f],s=e[a],l=s&&s.prototype;l&&!l[u]&&i(l,u,a),o[a]=o.Array}},function(t,n,r){var e=r(45),i=r(7)("toStringTag"),o="Arguments"==e(function(){return arguments}()),u=function(t,n){try{return t[n]}catch(t){}};t.exports=function(t){var n,r,c;return void 0===t?"Undefined":null===t?"Null":"string"==typeof(r=u(n=Object(t),i))?r:o?e(n):"Object"==(c=e(n))&&"function"==typeof n.callee?"Arguments":c}},function(t,n,r){var e=r(45);t.exports=Object("z").propertyIsEnumerable(0)?Object:function(t){return"String"==e(t)?t.split(""):Object(t)}},function(t,n){n.f={}.propertyIsEnumerable},function(t,n,r){var e=r(30),i=r(16),o=r(75);t.exports=function(t){return function(n,r,u){var c,f=e(n),a=i(f.length),s=o(u,a);if(t&&r!=r){for(;a>s;)if((c=f[s++])!=c)return!0}else for(;a>s;s++)if((t||s in f)&&f[s]===r)return t||s||0;return!t&&-1}}},function(t,n,r){"use strict";var e=r(3),i=r(1),o=r(28),u=r(73),c=r(65),f=r(79),a=r(68),s=r(6),l=r(4),h=r(123),v=r(81),p=r(136);t.exports=function(t,n,r,d,y,g){var b=e[t],m=b,x=y?"set":"add",w=m&&m.prototype,S={},_=function(t){var n=w[t];o(w,t,"delete"==t?function(t){return!(g&&!s(t))&&n.call(this,0===t?0:t)}:"has"==t?function(t){return!(g&&!s(t))&&n.call(this,0===t?0:t)}:"get"==t?function(t){return g&&!s(t)?void 0:n.call(this,0===t?0:t)}:"add"==t?function(t){return n.call(this,0===t?0:t),this}:function(t,r){return n.call(this,0===t?0:t,r),this})};if("function"==typeof m&&(g||w.forEach&&!l(function(){(new m).entries().next()}))){var O=new m,E=O[x](g?{}:-0,1)!=O,P=l(function(){O.has(1)}),j=h(function(t){new m(t)}),F=!g&&l(function(){for(var t=new m,n=5;n--;)t[x](n,n);return!t.has(-0)});j||(m=n(function(n,r){a(n,m,t);var e=p(new b,n,m);return void 0!=r&&f(r,y,e[x],e),e}),m.prototype=w,w.constructor=m),(P||F)&&(_("delete"),_("has"),y&&_("get")),(F||E)&&_(x),g&&w.clear&&delete w.clear}else m=d.getConstructor(n,t,y,x),u(m.prototype,r),c.NEED=!0;return v(m,t),S[t]=m,i(i.G+i.W+i.F*(m!=b),S),g||d.setStrong(m,t,y),m}},function(t,n,r){"use strict";var e=r(27),i=r(28),o=r(4),u=r(46),c=r(7);t.exports=function(t,n,r){var f=c(t),a=r(u,f,""[t]),s=a[0],l=a[1];o(function(){var n={};return n[f]=function(){return 7},7!=""[t](n)})&&(i(String.prototype,t,s),e(RegExp.prototype,f,2==n?function(t,n){return l.call(t,this,n)}:function(t){return l.call(t,this)}))}
},function(t,n,r){"use strict";var e=r(2);t.exports=function(){var t=e(this),n="";return t.global&&(n+="g"),t.ignoreCase&&(n+="i"),t.multiline&&(n+="m"),t.unicode&&(n+="u"),t.sticky&&(n+="y"),n}},function(t,n){t.exports=function(t,n,r){var e=void 0===r;switch(n.length){case 0:return e?t():t.call(r);case 1:return e?t(n[0]):t.call(r,n[0]);case 2:return e?t(n[0],n[1]):t.call(r,n[0],n[1]);case 3:return e?t(n[0],n[1],n[2]):t.call(r,n[0],n[1],n[2]);case 4:return e?t(n[0],n[1],n[2],n[3]):t.call(r,n[0],n[1],n[2],n[3])}return t.apply(r,n)}},function(t,n,r){var e=r(6),i=r(45),o=r(7)("match");t.exports=function(t){var n;return e(t)&&(void 0!==(n=t[o])?!!n:"RegExp"==i(t))}},function(t,n,r){var e=r(7)("iterator"),i=!1;try{var o=[7][e]();o.return=function(){i=!0},Array.from(o,function(){throw 2})}catch(t){}t.exports=function(t,n){if(!n&&!i)return!1;var r=!1;try{var o=[7],u=o[e]();u.next=function(){return{done:r=!0}},o[e]=function(){return u},t(o)}catch(t){}return r}},function(t,n,r){t.exports=r(69)||!r(4)(function(){var t=Math.random();__defineSetter__.call(null,t,function(){}),delete r(3)[t]})},function(t,n){n.f=Object.getOwnPropertySymbols},function(t,n,r){var e=r(3),i="__core-js_shared__",o=e[i]||(e[i]={});t.exports=function(t){return o[t]||(o[t]={})}},function(t,n,r){for(var e,i=r(3),o=r(27),u=r(76),c=u("typed_array"),f=u("view"),a=!(!i.ArrayBuffer||!i.DataView),s=a,l=0,h="Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array".split(",");l<9;)(e=i[h[l++]])?(o(e.prototype,c,!0),o(e.prototype,f,!0)):s=!1;t.exports={ABV:a,CONSTR:s,TYPED:c,VIEW:f}},function(t,n){"use strict";var r={versions:function(){var t=window.navigator.userAgent;return{trident:t.indexOf("Trident")>-1,presto:t.indexOf("Presto")>-1,webKit:t.indexOf("AppleWebKit")>-1,gecko:t.indexOf("Gecko")>-1&&-1==t.indexOf("KHTML"),mobile:!!t.match(/AppleWebKit.*Mobile.*/),ios:!!t.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),android:t.indexOf("Android")>-1||t.indexOf("Linux")>-1,iPhone:t.indexOf("iPhone")>-1||t.indexOf("Mac")>-1,iPad:t.indexOf("iPad")>-1,webApp:-1==t.indexOf("Safari"),weixin:-1==t.indexOf("MicroMessenger")}}()};t.exports=r},function(t,n,r){"use strict";var e=r(85),i=function(t){return t&&t.__esModule?t:{default:t}}(e),o=function(){function t(t,n,e){return n||e?String.fromCharCode(n||e):r[t]||t}function n(t){return e[t]}var r={"&quot;":'"',"&lt;":"<","&gt;":">","&amp;":"&","&nbsp;":" "},e={};for(var u in r)e[r[u]]=u;return r["&apos;"]="'",e["'"]="&#39;",{encode:function(t){return t?(""+t).replace(/['<> "&]/g,n).replace(/\r?\n/g,"<br/>").replace(/\s/g,"&nbsp;"):""},decode:function(n){return n?(""+n).replace(/<br\s*\/?>/gi,"\n").replace(/&quot;|&lt;|&gt;|&amp;|&nbsp;|&apos;|&#(\d+);|&#(\d+)/g,t).replace(/\u00a0/g," "):""},encodeBase16:function(t){if(!t)return t;t+="";for(var n=[],r=0,e=t.length;e>r;r++)n.push(t.charCodeAt(r).toString(16).toUpperCase());return n.join("")},encodeBase16forJSON:function(t){if(!t)return t;t=t.replace(/[\u4E00-\u9FBF]/gi,function(t){return escape(t).replace("%u","\\u")});for(var n=[],r=0,e=t.length;e>r;r++)n.push(t.charCodeAt(r).toString(16).toUpperCase());return n.join("")},decodeBase16:function(t){if(!t)return t;t+="";for(var n=[],r=0,e=t.length;e>r;r+=2)n.push(String.fromCharCode("0x"+t.slice(r,r+2)));return n.join("")},encodeObject:function(t){if(t instanceof Array)for(var n=0,r=t.length;r>n;n++)t[n]=o.encodeObject(t[n]);else if("object"==(void 0===t?"undefined":(0,i.default)(t)))for(var e in t)t[e]=o.encodeObject(t[e]);else if("string"==typeof t)return o.encode(t);return t},loadScript:function(t){var n=document.createElement("script");document.getElementsByTagName("body")[0].appendChild(n),n.setAttribute("src",t)},addLoadEvent:function(t){var n=window.onload;"function"!=typeof window.onload?window.onload=t:window.onload=function(){n(),t()}}}}();t.exports=o},function(t,n,r){"use strict";var e=r(17),i=r(75),o=r(16);t.exports=function(t){for(var n=e(this),r=o(n.length),u=arguments.length,c=i(u>1?arguments[1]:void 0,r),f=u>2?arguments[2]:void 0,a=void 0===f?r:i(f,r);a>c;)n[c++]=t;return n}},function(t,n,r){"use strict";var e=r(11),i=r(66);t.exports=function(t,n,r){n in t?e.f(t,n,i(0,r)):t[n]=r}},function(t,n,r){var e=r(6),i=r(3).document,o=e(i)&&e(i.createElement);t.exports=function(t){return o?i.createElement(t):{}}},function(t,n){t.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(t,n,r){var e=r(7)("match");t.exports=function(t){var n=/./;try{"/./"[t](n)}catch(r){try{return n[e]=!1,!"/./"[t](n)}catch(t){}}return!0}},function(t,n,r){t.exports=r(3).document&&document.documentElement},function(t,n,r){var e=r(6),i=r(144).set;t.exports=function(t,n,r){var o,u=n.constructor;return u!==r&&"function"==typeof u&&(o=u.prototype)!==r.prototype&&e(o)&&i&&i(t,o),t}},function(t,n,r){var e=r(80),i=r(7)("iterator"),o=Array.prototype;t.exports=function(t){return void 0!==t&&(e.Array===t||o[i]===t)}},function(t,n,r){var e=r(45);t.exports=Array.isArray||function(t){return"Array"==e(t)}},function(t,n,r){"use strict";var e=r(70),i=r(66),o=r(81),u={};r(27)(u,r(7)("iterator"),function(){return this}),t.exports=function(t,n,r){t.prototype=e(u,{next:i(1,r)}),o(t,n+" Iterator")}},function(t,n,r){"use strict";var e=r(69),i=r(1),o=r(28),u=r(27),c=r(24),f=r(80),a=r(139),s=r(81),l=r(32),h=r(7)("iterator"),v=!([].keys&&"next"in[].keys()),p="keys",d="values",y=function(){return this};t.exports=function(t,n,r,g,b,m,x){a(r,n,g);var w,S,_,O=function(t){if(!v&&t in F)return F[t];switch(t){case p:case d:return function(){return new r(this,t)}}return function(){return new r(this,t)}},E=n+" Iterator",P=b==d,j=!1,F=t.prototype,M=F[h]||F["@@iterator"]||b&&F[b],A=M||O(b),N=b?P?O("entries"):A:void 0,T="Array"==n?F.entries||M:M;if(T&&(_=l(T.call(new t)))!==Object.prototype&&(s(_,E,!0),e||c(_,h)||u(_,h,y)),P&&M&&M.name!==d&&(j=!0,A=function(){return M.call(this)}),e&&!x||!v&&!j&&F[h]||u(F,h,A),f[n]=A,f[E]=y,b)if(w={values:P?A:O(d),keys:m?A:O(p),entries:N},x)for(S in w)S in F||o(F,S,w[S]);else i(i.P+i.F*(v||j),n,w);return w}},function(t,n){var r=Math.expm1;t.exports=!r||r(10)>22025.465794806718||r(10)<22025.465794806718||-2e-17!=r(-2e-17)?function(t){return 0==(t=+t)?t:t>-1e-6&&t<1e-6?t+t*t/2:Math.exp(t)-1}:r},function(t,n){t.exports=Math.sign||function(t){return 0==(t=+t)||t!=t?t:t<0?-1:1}},function(t,n,r){var e=r(3),i=r(151).set,o=e.MutationObserver||e.WebKitMutationObserver,u=e.process,c=e.Promise,f="process"==r(45)(u);t.exports=function(){var t,n,r,a=function(){var e,i;for(f&&(e=u.domain)&&e.exit();t;){i=t.fn,t=t.next;try{i()}catch(e){throw t?r():n=void 0,e}}n=void 0,e&&e.enter()};if(f)r=function(){u.nextTick(a)};else if(o){var s=!0,l=document.createTextNode("");new o(a).observe(l,{characterData:!0}),r=function(){l.data=s=!s}}else if(c&&c.resolve){var h=c.resolve();r=function(){h.then(a)}}else r=function(){i.call(e,a)};return function(e){var i={fn:e,next:void 0};n&&(n.next=i),t||(t=i,r()),n=i}}},function(t,n,r){var e=r(6),i=r(2),o=function(t,n){if(i(t),!e(n)&&null!==n)throw TypeError(n+": can't set as prototype!")};t.exports={set:Object.setPrototypeOf||("__proto__"in{}?function(t,n,e){try{e=r(53)(Function.call,r(31).f(Object.prototype,"__proto__").set,2),e(t,[]),n=!(t instanceof Array)}catch(t){n=!0}return function(t,r){return o(t,r),n?t.__proto__=r:e(t,r),t}}({},!1):void 0),check:o}},function(t,n,r){var e=r(126)("keys"),i=r(76);t.exports=function(t){return e[t]||(e[t]=i(t))}},function(t,n,r){var e=r(2),i=r(26),o=r(7)("species");t.exports=function(t,n){var r,u=e(t).constructor;return void 0===u||void 0==(r=e(u)[o])?n:i(r)}},function(t,n,r){var e=r(67),i=r(46);t.exports=function(t){return function(n,r){var o,u,c=String(i(n)),f=e(r),a=c.length;return f<0||f>=a?t?"":void 0:(o=c.charCodeAt(f),o<55296||o>56319||f+1===a||(u=c.charCodeAt(f+1))<56320||u>57343?t?c.charAt(f):o:t?c.slice(f,f+2):u-56320+(o-55296<<10)+65536)}}},function(t,n,r){var e=r(122),i=r(46);t.exports=function(t,n,r){if(e(n))throw TypeError("String#"+r+" doesn't accept regex!");return String(i(t))}},function(t,n,r){"use strict";var e=r(67),i=r(46);t.exports=function(t){var n=String(i(this)),r="",o=e(t);if(o<0||o==1/0)throw RangeError("Count can't be negative");for(;o>0;(o>>>=1)&&(n+=n))1&o&&(r+=n);return r}},function(t,n){t.exports="\t\n\v\f\r   ᠎             　\u2028\u2029\ufeff"},function(t,n,r){var e,i,o,u=r(53),c=r(121),f=r(135),a=r(132),s=r(3),l=s.process,h=s.setImmediate,v=s.clearImmediate,p=s.MessageChannel,d=0,y={},g="onreadystatechange",b=function(){var t=+this;if(y.hasOwnProperty(t)){var n=y[t];delete y[t],n()}},m=function(t){b.call(t.data)};h&&v||(h=function(t){for(var n=[],r=1;arguments.length>r;)n.push(arguments[r++]);return y[++d]=function(){c("function"==typeof t?t:Function(t),n)},e(d),d},v=function(t){delete y[t]},"process"==r(45)(l)?e=function(t){l.nextTick(u(b,t,1))}:p?(i=new p,o=i.port2,i.port1.onmessage=m,e=u(o.postMessage,o,1)):s.addEventListener&&"function"==typeof postMessage&&!s.importScripts?(e=function(t){s.postMessage(t+"","*")},s.addEventListener("message",m,!1)):e=g in a("script")?function(t){f.appendChild(a("script"))[g]=function(){f.removeChild(this),b.call(t)}}:function(t){setTimeout(u(b,t,1),0)}),t.exports={set:h,clear:v}},function(t,n,r){"use strict";var e=r(3),i=r(10),o=r(69),u=r(127),c=r(27),f=r(73),a=r(4),s=r(68),l=r(67),h=r(16),v=r(71).f,p=r(11).f,d=r(130),y=r(81),g="ArrayBuffer",b="DataView",m="prototype",x="Wrong length!",w="Wrong index!",S=e[g],_=e[b],O=e.Math,E=e.RangeError,P=e.Infinity,j=S,F=O.abs,M=O.pow,A=O.floor,N=O.log,T=O.LN2,I="buffer",k="byteLength",L="byteOffset",R=i?"_b":I,C=i?"_l":k,D=i?"_o":L,U=function(t,n,r){var e,i,o,u=Array(r),c=8*r-n-1,f=(1<<c)-1,a=f>>1,s=23===n?M(2,-24)-M(2,-77):0,l=0,h=t<0||0===t&&1/t<0?1:0;for(t=F(t),t!=t||t===P?(i=t!=t?1:0,e=f):(e=A(N(t)/T),t*(o=M(2,-e))<1&&(e--,o*=2),t+=e+a>=1?s/o:s*M(2,1-a),t*o>=2&&(e++,o/=2),e+a>=f?(i=0,e=f):e+a>=1?(i=(t*o-1)*M(2,n),e+=a):(i=t*M(2,a-1)*M(2,n),e=0));n>=8;u[l++]=255&i,i/=256,n-=8);for(e=e<<n|i,c+=n;c>0;u[l++]=255&e,e/=256,c-=8);return u[--l]|=128*h,u},W=function(t,n,r){var e,i=8*r-n-1,o=(1<<i)-1,u=o>>1,c=i-7,f=r-1,a=t[f--],s=127&a;for(a>>=7;c>0;s=256*s+t[f],f--,c-=8);for(e=s&(1<<-c)-1,s>>=-c,c+=n;c>0;e=256*e+t[f],f--,c-=8);if(0===s)s=1-u;else{if(s===o)return e?NaN:a?-P:P;e+=M(2,n),s-=u}return(a?-1:1)*e*M(2,s-n)},G=function(t){return t[3]<<24|t[2]<<16|t[1]<<8|t[0]},B=function(t){return[255&t]},V=function(t){return[255&t,t>>8&255]},z=function(t){return[255&t,t>>8&255,t>>16&255,t>>24&255]},q=function(t){return U(t,52,8)},K=function(t){return U(t,23,4)},J=function(t,n,r){p(t[m],n,{get:function(){return this[r]}})},Y=function(t,n,r,e){var i=+r,o=l(i);if(i!=o||o<0||o+n>t[C])throw E(w);var u=t[R]._b,c=o+t[D],f=u.slice(c,c+n);return e?f:f.reverse()},H=function(t,n,r,e,i,o){var u=+r,c=l(u);if(u!=c||c<0||c+n>t[C])throw E(w);for(var f=t[R]._b,a=c+t[D],s=e(+i),h=0;h<n;h++)f[a+h]=s[o?h:n-h-1]},$=function(t,n){s(t,S,g);var r=+n,e=h(r);if(r!=e)throw E(x);return e};if(u.ABV){if(!a(function(){new S})||!a(function(){new S(.5)})){S=function(t){return new j($(this,t))};for(var X,Q=S[m]=j[m],Z=v(j),tt=0;Z.length>tt;)(X=Z[tt++])in S||c(S,X,j[X]);o||(Q.constructor=S)}var nt=new _(new S(2)),rt=_[m].setInt8;nt.setInt8(0,2147483648),nt.setInt8(1,2147483649),!nt.getInt8(0)&&nt.getInt8(1)||f(_[m],{setInt8:function(t,n){rt.call(this,t,n<<24>>24)},setUint8:function(t,n){rt.call(this,t,n<<24>>24)}},!0)}else S=function(t){var n=$(this,t);this._b=d.call(Array(n),0),this[C]=n},_=function(t,n,r){s(this,_,b),s(t,S,b);var e=t[C],i=l(n);if(i<0||i>e)throw E("Wrong offset!");if(r=void 0===r?e-i:h(r),i+r>e)throw E(x);this[R]=t,this[D]=i,this[C]=r},i&&(J(S,k,"_l"),J(_,I,"_b"),J(_,k,"_l"),J(_,L,"_o")),f(_[m],{getInt8:function(t){return Y(this,1,t)[0]<<24>>24},getUint8:function(t){return Y(this,1,t)[0]},getInt16:function(t){var n=Y(this,2,t,arguments[1]);return(n[1]<<8|n[0])<<16>>16},getUint16:function(t){var n=Y(this,2,t,arguments[1]);return n[1]<<8|n[0]},getInt32:function(t){return G(Y(this,4,t,arguments[1]))},getUint32:function(t){return G(Y(this,4,t,arguments[1]))>>>0},getFloat32:function(t){return W(Y(this,4,t,arguments[1]),23,4)},getFloat64:function(t){return W(Y(this,8,t,arguments[1]),52,8)},setInt8:function(t,n){H(this,1,t,B,n)},setUint8:function(t,n){H(this,1,t,B,n)},setInt16:function(t,n){H(this,2,t,V,n,arguments[2])},setUint16:function(t,n){H(this,2,t,V,n,arguments[2])},setInt32:function(t,n){H(this,4,t,z,n,arguments[2])},setUint32:function(t,n){H(this,4,t,z,n,arguments[2])},setFloat32:function(t,n){H(this,4,t,K,n,arguments[2])},setFloat64:function(t,n){H(this,8,t,q,n,arguments[2])}});y(S,g),y(_,b),c(_[m],u.VIEW,!0),n[g]=S,n[b]=_},function(t,n,r){var e=r(3),i=r(52),o=r(69),u=r(182),c=r(11).f;t.exports=function(t){var n=i.Symbol||(i.Symbol=o?{}:e.Symbol||{});"_"==t.charAt(0)||t in n||c(n,t,{value:u.f(t)})}},function(t,n,r){var e=r(114),i=r(7)("iterator"),o=r(80);t.exports=r(52).getIteratorMethod=function(t){if(void 0!=t)return t[i]||t["@@iterator"]||o[e(t)]}},function(t,n,r){"use strict";var e=r(78),i=r(170),o=r(80),u=r(30);t.exports=r(140)(Array,"Array",function(t,n){this._t=u(t),this._i=0,this._k=n},function(){var t=this._t,n=this._k,r=this._i++;return!t||r>=t.length?(this._t=void 0,i(1)):"keys"==n?i(0,r):"values"==n?i(0,t[r]):i(0,[r,t[r]])},"values"),o.Arguments=o.Array,e("keys"),e("values"),e("entries")},function(t,n){function r(t,n){t.classList?t.classList.add(n):t.className+=" "+n}t.exports=r},function(t,n){function r(t,n){if(t.classList)t.classList.remove(n);else{var r=new RegExp("(^|\\b)"+n.split(" ").join("|")+"(\\b|$)","gi");t.className=t.className.replace(r," ")}}t.exports=r},function(t,n){function r(){throw new Error("setTimeout has not been defined")}function e(){throw new Error("clearTimeout has not been defined")}function i(t){if(s===setTimeout)return setTimeout(t,0);if((s===r||!s)&&setTimeout)return s=setTimeout,setTimeout(t,0);try{return s(t,0)}catch(n){try{return s.call(null,t,0)}catch(n){return s.call(this,t,0)}}}function o(t){if(l===clearTimeout)return clearTimeout(t);if((l===e||!l)&&clearTimeout)return l=clearTimeout,clearTimeout(t);try{return l(t)}catch(n){try{return l.call(null,t)}catch(n){return l.call(this,t)}}}function u(){d&&v&&(d=!1,v.length?p=v.concat(p):y=-1,p.length&&c())}function c(){if(!d){var t=i(u);d=!0;for(var n=p.length;n;){for(v=p,p=[];++y<n;)v&&v[y].run();y=-1,n=p.length}v=null,d=!1,o(t)}}function f(t,n){this.fun=t,this.array=n}function a(){}var s,l,h=t.exports={};!function(){try{s="function"==typeof setTimeout?setTimeout:r}catch(t){s=r}try{l="function"==typeof clearTimeout?clearTimeout:e}catch(t){l=e}}();var v,p=[],d=!1,y=-1;h.nextTick=function(t){var n=new Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)n[r-1]=arguments[r];p.push(new f(t,n)),1!==p.length||d||i(c)},f.prototype.run=function(){this.fun.apply(null,this.array)},h.title="browser",h.browser=!0,h.env={},h.argv=[],h.version="",h.versions={},h.on=a,h.addListener=a,h.once=a,h.off=a,h.removeListener=a,h.removeAllListeners=a,h.emit=a,h.prependListener=a,h.prependOnceListener=a,h.listeners=function(t){return[]},h.binding=function(t){throw new Error("process.binding is not supported")},h.cwd=function(){return"/"},h.chdir=function(t){throw new Error("process.chdir is not supported")},h.umask=function(){return 0}},function(t,n,r){var e=r(45);t.exports=function(t,n){if("number"!=typeof t&&"Number"!=e(t))throw TypeError(n);return+t}},function(t,n,r){"use strict";var e=r(17),i=r(75),o=r(16);t.exports=[].copyWithin||function(t,n){var r=e(this),u=o(r.length),c=i(t,u),f=i(n,u),a=arguments.length>2?arguments[2]:void 0,s=Math.min((void 0===a?u:i(a,u))-f,u-c),l=1;for(f<c&&c<f+s&&(l=-1,f+=s-1,c+=s-1);s-- >0;)f in r?r[c]=r[f]:delete r[c],c+=l,f+=l;return r}},function(t,n,r){var e=r(79);t.exports=function(t,n){var r=[];return e(t,!1,r.push,r,n),r}},function(t,n,r){var e=r(26),i=r(17),o=r(115),u=r(16);t.exports=function(t,n,r,c,f){e(n);var a=i(t),s=o(a),l=u(a.length),h=f?l-1:0,v=f?-1:1;if(r<2)for(;;){if(h in s){c=s[h],h+=v;break}if(h+=v,f?h<0:l<=h)throw TypeError("Reduce of empty array with no initial value")}for(;f?h>=0:l>h;h+=v)h in s&&(c=n(c,s[h],h,a));return c}},function(t,n,r){"use strict";var e=r(26),i=r(6),o=r(121),u=[].slice,c={},f=function(t,n,r){if(!(n in c)){for(var e=[],i=0;i<n;i++)e[i]="a["+i+"]";c[n]=Function("F,a","return new F("+e.join(",")+")")}return c[n](t,r)};t.exports=Function.bind||function(t){var n=e(this),r=u.call(arguments,1),c=function(){var e=r.concat(u.call(arguments));return this instanceof c?f(n,e.length,e):o(n,e,t)};return i(n.prototype)&&(c.prototype=n.prototype),c}},function(t,n,r){"use strict";var e=r(11).f,i=r(70),o=r(73),u=r(53),c=r(68),f=r(46),a=r(79),s=r(140),l=r(170),h=r(74),v=r(10),p=r(65).fastKey,d=v?"_s":"size",y=function(t,n){var r,e=p(n);if("F"!==e)return t._i[e];for(r=t._f;r;r=r.n)if(r.k==n)return r};t.exports={getConstructor:function(t,n,r,s){var l=t(function(t,e){c(t,l,n,"_i"),t._i=i(null),t._f=void 0,t._l=void 0,t[d]=0,void 0!=e&&a(e,r,t[s],t)});return o(l.prototype,{clear:function(){for(var t=this,n=t._i,r=t._f;r;r=r.n)r.r=!0,r.p&&(r.p=r.p.n=void 0),delete n[r.i];t._f=t._l=void 0,t[d]=0},delete:function(t){var n=this,r=y(n,t);if(r){var e=r.n,i=r.p;delete n._i[r.i],r.r=!0,i&&(i.n=e),e&&(e.p=i),n._f==r&&(n._f=e),n._l==r&&(n._l=i),n[d]--}return!!r},forEach:function(t){c(this,l,"forEach");for(var n,r=u(t,arguments.length>1?arguments[1]:void 0,3);n=n?n.n:this._f;)for(r(n.v,n.k,this);n&&n.r;)n=n.p},has:function(t){return!!y(this,t)}}),v&&e(l.prototype,"size",{get:function(){return f(this[d])}}),l},def:function(t,n,r){var e,i,o=y(t,n);return o?o.v=r:(t._l=o={i:i=p(n,!0),k:n,v:r,p:e=t._l,n:void 0,r:!1},t._f||(t._f=o),e&&(e.n=o),t[d]++,"F"!==i&&(t._i[i]=o)),t},getEntry:y,setStrong:function(t,n,r){s(t,n,function(t,n){this._t=t,this._k=n,this._l=void 0},function(){for(var t=this,n=t._k,r=t._l;r&&r.r;)r=r.p;return t._t&&(t._l=r=r?r.n:t._t._f)?"keys"==n?l(0,r.k):"values"==n?l(0,r.v):l(0,[r.k,r.v]):(t._t=void 0,l(1))},r?"entries":"values",!r,!0),h(n)}}},function(t,n,r){var e=r(114),i=r(161);t.exports=function(t){return function(){if(e(this)!=t)throw TypeError(t+"#toJSON isn't generic");return i(this)}}},function(t,n,r){"use strict";var e=r(73),i=r(65).getWeak,o=r(2),u=r(6),c=r(68),f=r(79),a=r(48),s=r(24),l=a(5),h=a(6),v=0,p=function(t){return t._l||(t._l=new d)},d=function(){this.a=[]},y=function(t,n){return l(t.a,function(t){return t[0]===n})};d.prototype={get:function(t){var n=y(this,t);if(n)return n[1]},has:function(t){return!!y(this,t)},set:function(t,n){var r=y(this,t);r?r[1]=n:this.a.push([t,n])},delete:function(t){var n=h(this.a,function(n){return n[0]===t});return~n&&this.a.splice(n,1),!!~n}},t.exports={getConstructor:function(t,n,r,o){var a=t(function(t,e){c(t,a,n,"_i"),t._i=v++,t._l=void 0,void 0!=e&&f(e,r,t[o],t)});return e(a.prototype,{delete:function(t){if(!u(t))return!1;var n=i(t);return!0===n?p(this).delete(t):n&&s(n,this._i)&&delete n[this._i]},has:function(t){if(!u(t))return!1;var n=i(t);return!0===n?p(this).has(t):n&&s(n,this._i)}}),a},def:function(t,n,r){var e=i(o(n),!0);return!0===e?p(t).set(n,r):e[t._i]=r,t},ufstore:p}},function(t,n,r){t.exports=!r(10)&&!r(4)(function(){return 7!=Object.defineProperty(r(132)("div"),"a",{get:function(){return 7}}).a})},function(t,n,r){var e=r(6),i=Math.floor;t.exports=function(t){return!e(t)&&isFinite(t)&&i(t)===t}},function(t,n,r){var e=r(2);t.exports=function(t,n,r,i){try{return i?n(e(r)[0],r[1]):n(r)}catch(n){var o=t.return;throw void 0!==o&&e(o.call(t)),n}}},function(t,n){t.exports=function(t,n){return{value:n,done:!!t}}},function(t,n){t.exports=Math.log1p||function(t){return(t=+t)>-1e-8&&t<1e-8?t-t*t/2:Math.log(1+t)}},function(t,n,r){"use strict";var e=r(72),i=r(125),o=r(116),u=r(17),c=r(115),f=Object.assign;t.exports=!f||r(4)(function(){var t={},n={},r=Symbol(),e="abcdefghijklmnopqrst";return t[r]=7,e.split("").forEach(function(t){n[t]=t}),7!=f({},t)[r]||Object.keys(f({},n)).join("")!=e})?function(t,n){for(var r=u(t),f=arguments.length,a=1,s=i.f,l=o.f;f>a;)for(var h,v=c(arguments[a++]),p=s?e(v).concat(s(v)):e(v),d=p.length,y=0;d>y;)l.call(v,h=p[y++])&&(r[h]=v[h]);return r}:f},function(t,n,r){var e=r(11),i=r(2),o=r(72);t.exports=r(10)?Object.defineProperties:function(t,n){i(t);for(var r,u=o(n),c=u.length,f=0;c>f;)e.f(t,r=u[f++],n[r]);return t}},function(t,n,r){var e=r(30),i=r(71).f,o={}.toString,u="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[],c=function(t){try{return i(t)}catch(t){return u.slice()}};t.exports.f=function(t){return u&&"[object Window]"==o.call(t)?c(t):i(e(t))}},function(t,n,r){var e=r(24),i=r(30),o=r(117)(!1),u=r(145)("IE_PROTO");t.exports=function(t,n){var r,c=i(t),f=0,a=[];for(r in c)r!=u&&e(c,r)&&a.push(r);for(;n.length>f;)e(c,r=n[f++])&&(~o(a,r)||a.push(r));return a}},function(t,n,r){var e=r(72),i=r(30),o=r(116).f;t.exports=function(t){return function(n){for(var r,u=i(n),c=e(u),f=c.length,a=0,s=[];f>a;)o.call(u,r=c[a++])&&s.push(t?[r,u[r]]:u[r]);return s}}},function(t,n,r){var e=r(71),i=r(125),o=r(2),u=r(3).Reflect;t.exports=u&&u.ownKeys||function(t){var n=e.f(o(t)),r=i.f;return r?n.concat(r(t)):n}},function(t,n,r){var e=r(3).parseFloat,i=r(82).trim;t.exports=1/e(r(150)+"-0")!=-1/0?function(t){var n=i(String(t),3),r=e(n);return 0===r&&"-"==n.charAt(0)?-0:r}:e},function(t,n,r){var e=r(3).parseInt,i=r(82).trim,o=r(150),u=/^[\-+]?0[xX]/;t.exports=8!==e(o+"08")||22!==e(o+"0x16")?function(t,n){var r=i(String(t),3);return e(r,n>>>0||(u.test(r)?16:10))}:e},function(t,n){t.exports=Object.is||function(t,n){return t===n?0!==t||1/t==1/n:t!=t&&n!=n}},function(t,n,r){var e=r(16),i=r(149),o=r(46);t.exports=function(t,n,r,u){var c=String(o(t)),f=c.length,a=void 0===r?" ":String(r),s=e(n);if(s<=f||""==a)return c;var l=s-f,h=i.call(a,Math.ceil(l/a.length));return h.length>l&&(h=h.slice(0,l)),u?h+c:c+h}},function(t,n,r){n.f=r(7)},function(t,n,r){"use strict";var e=r(164);t.exports=r(118)("Map",function(t){return function(){return t(this,arguments.length>0?arguments[0]:void 0)}},{get:function(t){var n=e.getEntry(this,t);return n&&n.v},set:function(t,n){return e.def(this,0===t?0:t,n)}},e,!0)},function(t,n,r){r(10)&&"g"!=/./g.flags&&r(11).f(RegExp.prototype,"flags",{configurable:!0,get:r(120)})},function(t,n,r){"use strict";var e=r(164);t.exports=r(118)("Set",function(t){return function(){return t(this,arguments.length>0?arguments[0]:void 0)}},{add:function(t){return e.def(this,t=0===t?0:t,t)}},e)},function(t,n,r){"use strict";var e,i=r(48)(0),o=r(28),u=r(65),c=r(172),f=r(166),a=r(6),s=u.getWeak,l=Object.isExtensible,h=f.ufstore,v={},p=function(t){return function(){return t(this,arguments.length>0?arguments[0]:void 0)}},d={get:function(t){if(a(t)){var n=s(t);return!0===n?h(this).get(t):n?n[this._i]:void 0}},set:function(t,n){return f.def(this,t,n)}},y=t.exports=r(118)("WeakMap",p,d,f,!0,!0);7!=(new y).set((Object.freeze||Object)(v),7).get(v)&&(e=f.getConstructor(p),c(e.prototype,d),u.NEED=!0,i(["delete","has","get","set"],function(t){var n=y.prototype,r=n[t];o(n,t,function(n,i){if(a(n)&&!l(n)){this._f||(this._f=new e);var o=this._f[t](n,i);return"set"==t?this:o}return r.call(this,n,i)})}))},,,,function(t,n){"use strict";function r(){var t=document.querySelector("#page-nav");if(t&&!document.querySelector("#page-nav .extend.prev")&&(t.innerHTML='<a class="extend prev disabled" rel="prev">&laquo; Prev</a>'+t.innerHTML),t&&!document.querySelector("#page-nav .extend.next")&&(t.innerHTML=t.innerHTML+'<a class="extend next disabled" rel="next">Next &raquo;</a>'),yiliaConfig&&yiliaConfig.open_in_new){document.querySelectorAll(".article-entry a:not(.article-more-a)").forEach(function(t){var n=t.getAttribute("target");n&&""!==n||t.setAttribute("target","_blank")})}if(yiliaConfig&&yiliaConfig.toc_hide_index){document.querySelectorAll(".toc-number").forEach(function(t){t.style.display="none"})}var n=document.querySelector("#js-aboutme");n&&0!==n.length&&(n.innerHTML=n.innerText)}t.exports={init:r}},function(t,n,r){"use strict";function e(t){return t&&t.__esModule?t:{default:t}}function i(t,n){var r=/\/|index.html/g;return t.replace(r,"")===n.replace(r,"")}function o(){for(var t=document.querySelectorAll(".js-header-menu li a"),n=window.location.pathname,r=0,e=t.length;r<e;r++){var o=t[r];i(n,o.getAttribute("href"))&&(0,h.default)(o,"active")}}function u(t){for(var n=t.offsetLeft,r=t.offsetParent;null!==r;)n+=r.offsetLeft,r=r.offsetParent;return n}function c(t){for(var n=t.offsetTop,r=t.offsetParent;null!==r;)n+=r.offsetTop,r=r.offsetParent;return n}function f(t,n,r,e,i){var o=u(t),f=c(t)-n;if(f-r<=i){var a=t.$newDom;a||(a=t.cloneNode(!0),(0,d.default)(t,a),t.$newDom=a,a.style.position="fixed",a.style.top=(r||f)+"px",a.style.left=o+"px",a.style.zIndex=e||2,a.style.width="100%",a.style.color="#fff"),a.style.visibility="visible",t.style.visibility="hidden"}else{t.style.visibility="visible";var s=t.$newDom;s&&(s.style.visibility="hidden")}}function a(){var t=document.querySelector(".js-overlay"),n=document.querySelector(".js-header-menu");f(t,document.body.scrollTop,-63,2,0),f(n,document.body.scrollTop,1,3,0)}function s(){document.querySelector("#container").addEventListener("scroll",function(t){a()}),window.addEventListener("scroll",function(t){a()}),a()}var l=r(156),h=e(l),v=r(157),p=(e(v),r(382)),d=e(p),y=r(128),g=e(y),b=r(190),m=e(b),x=r(129);(function(){g.default.versions.mobile&&window.screen.width<800&&(o(),s())})(),(0,x.addLoadEvent)(function(){m.default.init()}),t.exports={}},,,,function(t,n,r){(function(t){"use strict";function n(t,n,r){t[n]||Object[e](t,n,{writable:!0,configurable:!0,value:r})}if(r(381),r(391),r(198),t._babelPolyfill)throw new Error("only one instance of babel-polyfill is allowed");t._babelPolyfill=!0;var e="defineProperty";n(String.prototype,"padLeft","".padStart),n(String.prototype,"padRight","".padEnd),"pop,reverse,shift,keys,values,entries,indexOf,every,some,forEach,map,filter,find,findIndex,includes,join,slice,concat,push,splice,unshift,sort,lastIndexOf,reduce,reduceRight,copyWithin,fill".split(",").forEach(function(t){[][t]&&n(Array,t,Function.call.bind([][t]))})}).call(n,function(){return this}())},,,function(t,n,r){r(210),t.exports=r(52).RegExp.escape},,,,function(t,n,r){var e=r(6),i=r(138),o=r(7)("species");t.exports=function(t){var n;return i(t)&&(n=t.constructor,"function"!=typeof n||n!==Array&&!i(n.prototype)||(n=void 0),e(n)&&null===(n=n[o])&&(n=void 0)),void 0===n?Array:n}},function(t,n,r){var e=r(202);t.exports=function(t,n){return new(e(t))(n)}},function(t,n,r){"use strict";var e=r(2),i=r(50),o="number";t.exports=function(t){if("string"!==t&&t!==o&&"default"!==t)throw TypeError("Incorrect hint");return i(e(this),t!=o)}},function(t,n,r){var e=r(72),i=r(125),o=r(116);t.exports=function(t){var n=e(t),r=i.f;if(r)for(var u,c=r(t),f=o.f,a=0;c.length>a;)f.call(t,u=c[a++])&&n.push(u);return n}},function(t,n,r){var e=r(72),i=r(30);t.exports=function(t,n){for(var r,o=i(t),u=e(o),c=u.length,f=0;c>f;)if(o[r=u[f++]]===n)return r}},function(t,n,r){"use strict";var e=r(208),i=r(121),o=r(26);t.exports=function(){for(var t=o(this),n=arguments.length,r=Array(n),u=0,c=e._,f=!1;n>u;)(r[u]=arguments[u++])===c&&(f=!0);return function(){var e,o=this,u=arguments.length,a=0,s=0;if(!f&&!u)return i(t,r,o);if(e=r.slice(),f)for(;n>a;a++)e[a]===c&&(e[a]=arguments[s++]);for(;u>s;)e.push(arguments[s++]);return i(t,e,o)}}},function(t,n,r){t.exports=r(3)},function(t,n){t.exports=function(t,n){var r=n===Object(n)?function(t){return n[t]}:n;return function(n){return String(n).replace(t,r)}}},function(t,n,r){var e=r(1),i=r(209)(/[\\^$*+?.()|[\]{}]/g,"\\$&");e(e.S,"RegExp",{escape:function(t){return i(t)}})},function(t,n,r){var e=r(1);e(e.P,"Array",{copyWithin:r(160)}),r(78)("copyWithin")},function(t,n,r){"use strict";var e=r(1),i=r(48)(4);e(e.P+e.F*!r(47)([].every,!0),"Array",{every:function(t){return i(this,t,arguments[1])}})},function(t,n,r){var e=r(1);e(e.P,"Array",{fill:r(130)}),r(78)("fill")},function(t,n,r){"use strict";var e=r(1),i=r(48)(2);e(e.P+e.F*!r(47)([].filter,!0),"Array",{filter:function(t){return i(this,t,arguments[1])}})},function(t,n,r){"use strict";var e=r(1),i=r(48)(6),o="findIndex",u=!0;o in[]&&Array(1)[o](function(){u=!1}),e(e.P+e.F*u,"Array",{findIndex:function(t){return i(this,t,arguments.length>1?arguments[1]:void 0)}}),r(78)(o)},function(t,n,r){"use strict";var e=r(1),i=r(48)(5),o="find",u=!0;o in[]&&Array(1)[o](function(){u=!1}),e(e.P+e.F*u,"Array",{find:function(t){return i(this,t,arguments.length>1?arguments[1]:void 0)}}),r(78)(o)},function(t,n,r){"use strict";var e=r(1),i=r(48)(0),o=r(47)([].forEach,!0);e(e.P+e.F*!o,"Array",{forEach:function(t){return i(this,t,arguments[1])}})},function(t,n,r){"use strict";var e=r(53),i=r(1),o=r(17),u=r(169),c=r(137),f=r(16),a=r(131),s=r(154);i(i.S+i.F*!r(123)(function(t){Array.from(t)}),"Array",{from:function(t){var n,r,i,l,h=o(t),v="function"==typeof this?this:Array,p=arguments.length,d=p>1?arguments[1]:void 0,y=void 0!==d,g=0,b=s(h);if(y&&(d=e(d,p>2?arguments[2]:void 0,2)),void 0==b||v==Array&&c(b))for(n=f(h.length),r=new v(n);n>g;g++)a(r,g,y?d(h[g],g):h[g]);else for(l=b.call(h),r=new v;!(i=l.next()).done;g++)a(r,g,y?u(l,d,[i.value,g],!0):i.value);return r.length=g,r}})},function(t,n,r){"use strict";var e=r(1),i=r(117)(!1),o=[].indexOf,u=!!o&&1/[1].indexOf(1,-0)<0;e(e.P+e.F*(u||!r(47)(o)),"Array",{indexOf:function(t){return u?o.apply(this,arguments)||0:i(this,t,arguments[1])}})},function(t,n,r){var e=r(1);e(e.S,"Array",{isArray:r(138)})},function(t,n,r){"use strict";var e=r(1),i=r(30),o=[].join;e(e.P+e.F*(r(115)!=Object||!r(47)(o)),"Array",{join:function(t){return o.call(i(this),void 0===t?",":t)}})},function(t,n,r){"use strict";var e=r(1),i=r(30),o=r(67),u=r(16),c=[].lastIndexOf,f=!!c&&1/[1].lastIndexOf(1,-0)<0;e(e.P+e.F*(f||!r(47)(c)),"Array",{lastIndexOf:function(t){if(f)return c.apply(this,arguments)||0;var n=i(this),r=u(n.length),e=r-1;for(arguments.length>1&&(e=Math.min(e,o(arguments[1]))),e<0&&(e=r+e);e>=0;e--)if(e in n&&n[e]===t)return e||0;return-1}})},function(t,n,r){"use strict";var e=r(1),i=r(48)(1);e(e.P+e.F*!r(47)([].map,!0),"Array",{map:function(t){return i(this,t,arguments[1])}})},function(t,n,r){"use strict";var e=r(1),i=r(131);e(e.S+e.F*r(4)(function(){function t(){}return!(Array.of.call(t)instanceof t)}),"Array",{of:function(){for(var t=0,n=arguments.length,r=new("function"==typeof this?this:Array)(n);n>t;)i(r,t,arguments[t++]);return r.length=n,r}})},function(t,n,r){"use strict";var e=r(1),i=r(162);e(e.P+e.F*!r(47)([].reduceRight,!0),"Array",{reduceRight:function(t){return i(this,t,arguments.length,arguments[1],!0)}})},function(t,n,r){"use strict";var e=r(1),i=r(162);e(e.P+e.F*!r(47)([].reduce,!0),"Array",{reduce:function(t){return i(this,t,arguments.length,arguments[1],!1)}})},function(t,n,r){"use strict";var e=r(1),i=r(135),o=r(45),u=r(75),c=r(16),f=[].slice;e(e.P+e.F*r(4)(function(){i&&f.call(i)}),"Array",{slice:function(t,n){var r=c(this.length),e=o(this);if(n=void 0===n?r:n,"Array"==e)return f.call(this,t,n);for(var i=u(t,r),a=u(n,r),s=c(a-i),l=Array(s),h=0;h<s;h++)l[h]="String"==e?this.charAt(i+h):this[i+h];return l}})},function(t,n,r){"use strict";var e=r(1),i=r(48)(3);e(e.P+e.F*!r(47)([].some,!0),"Array",{some:function(t){return i(this,t,arguments[1])}})},function(t,n,r){"use strict";var e=r(1),i=r(26),o=r(17),u=r(4),c=[].sort,f=[1,2,3];e(e.P+e.F*(u(function(){f.sort(void 0)})||!u(function(){f.sort(null)})||!r(47)(c)),"Array",{sort:function(t){return void 0===t?c.call(o(this)):c.call(o(this),i(t))}})},function(t,n,r){r(74)("Array")},function(t,n,r){var e=r(1);e(e.S,"Date",{now:function(){return(new Date).getTime()}})},function(t,n,r){"use strict";var e=r(1),i=r(4),o=Date.prototype.getTime,u=function(t){return t>9?t:"0"+t};e(e.P+e.F*(i(function(){return"0385-07-25T07:06:39.999Z"!=new Date(-5e13-1).toISOString()})||!i(function(){new Date(NaN).toISOString()})),"Date",{toISOString:function(){
if(!isFinite(o.call(this)))throw RangeError("Invalid time value");var t=this,n=t.getUTCFullYear(),r=t.getUTCMilliseconds(),e=n<0?"-":n>9999?"+":"";return e+("00000"+Math.abs(n)).slice(e?-6:-4)+"-"+u(t.getUTCMonth()+1)+"-"+u(t.getUTCDate())+"T"+u(t.getUTCHours())+":"+u(t.getUTCMinutes())+":"+u(t.getUTCSeconds())+"."+(r>99?r:"0"+u(r))+"Z"}})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(50);e(e.P+e.F*r(4)(function(){return null!==new Date(NaN).toJSON()||1!==Date.prototype.toJSON.call({toISOString:function(){return 1}})}),"Date",{toJSON:function(t){var n=i(this),r=o(n);return"number"!=typeof r||isFinite(r)?n.toISOString():null}})},function(t,n,r){var e=r(7)("toPrimitive"),i=Date.prototype;e in i||r(27)(i,e,r(204))},function(t,n,r){var e=Date.prototype,i="Invalid Date",o="toString",u=e[o],c=e.getTime;new Date(NaN)+""!=i&&r(28)(e,o,function(){var t=c.call(this);return t===t?u.call(this):i})},function(t,n,r){var e=r(1);e(e.P,"Function",{bind:r(163)})},function(t,n,r){"use strict";var e=r(6),i=r(32),o=r(7)("hasInstance"),u=Function.prototype;o in u||r(11).f(u,o,{value:function(t){if("function"!=typeof this||!e(t))return!1;if(!e(this.prototype))return t instanceof this;for(;t=i(t);)if(this.prototype===t)return!0;return!1}})},function(t,n,r){var e=r(11).f,i=r(66),o=r(24),u=Function.prototype,c="name",f=Object.isExtensible||function(){return!0};c in u||r(10)&&e(u,c,{configurable:!0,get:function(){try{var t=this,n=(""+t).match(/^\s*function ([^ (]*)/)[1];return o(t,c)||!f(t)||e(t,c,i(5,n)),n}catch(t){return""}}})},function(t,n,r){var e=r(1),i=r(171),o=Math.sqrt,u=Math.acosh;e(e.S+e.F*!(u&&710==Math.floor(u(Number.MAX_VALUE))&&u(1/0)==1/0),"Math",{acosh:function(t){return(t=+t)<1?NaN:t>94906265.62425156?Math.log(t)+Math.LN2:i(t-1+o(t-1)*o(t+1))}})},function(t,n,r){function e(t){return isFinite(t=+t)&&0!=t?t<0?-e(-t):Math.log(t+Math.sqrt(t*t+1)):t}var i=r(1),o=Math.asinh;i(i.S+i.F*!(o&&1/o(0)>0),"Math",{asinh:e})},function(t,n,r){var e=r(1),i=Math.atanh;e(e.S+e.F*!(i&&1/i(-0)<0),"Math",{atanh:function(t){return 0==(t=+t)?t:Math.log((1+t)/(1-t))/2}})},function(t,n,r){var e=r(1),i=r(142);e(e.S,"Math",{cbrt:function(t){return i(t=+t)*Math.pow(Math.abs(t),1/3)}})},function(t,n,r){var e=r(1);e(e.S,"Math",{clz32:function(t){return(t>>>=0)?31-Math.floor(Math.log(t+.5)*Math.LOG2E):32}})},function(t,n,r){var e=r(1),i=Math.exp;e(e.S,"Math",{cosh:function(t){return(i(t=+t)+i(-t))/2}})},function(t,n,r){var e=r(1),i=r(141);e(e.S+e.F*(i!=Math.expm1),"Math",{expm1:i})},function(t,n,r){var e=r(1),i=r(142),o=Math.pow,u=o(2,-52),c=o(2,-23),f=o(2,127)*(2-c),a=o(2,-126),s=function(t){return t+1/u-1/u};e(e.S,"Math",{fround:function(t){var n,r,e=Math.abs(t),o=i(t);return e<a?o*s(e/a/c)*a*c:(n=(1+c/u)*e,r=n-(n-e),r>f||r!=r?o*(1/0):o*r)}})},function(t,n,r){var e=r(1),i=Math.abs;e(e.S,"Math",{hypot:function(t,n){for(var r,e,o=0,u=0,c=arguments.length,f=0;u<c;)r=i(arguments[u++]),f<r?(e=f/r,o=o*e*e+1,f=r):r>0?(e=r/f,o+=e*e):o+=r;return f===1/0?1/0:f*Math.sqrt(o)}})},function(t,n,r){var e=r(1),i=Math.imul;e(e.S+e.F*r(4)(function(){return-5!=i(4294967295,5)||2!=i.length}),"Math",{imul:function(t,n){var r=65535,e=+t,i=+n,o=r&e,u=r&i;return 0|o*u+((r&e>>>16)*u+o*(r&i>>>16)<<16>>>0)}})},function(t,n,r){var e=r(1);e(e.S,"Math",{log10:function(t){return Math.log(t)/Math.LN10}})},function(t,n,r){var e=r(1);e(e.S,"Math",{log1p:r(171)})},function(t,n,r){var e=r(1);e(e.S,"Math",{log2:function(t){return Math.log(t)/Math.LN2}})},function(t,n,r){var e=r(1);e(e.S,"Math",{sign:r(142)})},function(t,n,r){var e=r(1),i=r(141),o=Math.exp;e(e.S+e.F*r(4)(function(){return-2e-17!=!Math.sinh(-2e-17)}),"Math",{sinh:function(t){return Math.abs(t=+t)<1?(i(t)-i(-t))/2:(o(t-1)-o(-t-1))*(Math.E/2)}})},function(t,n,r){var e=r(1),i=r(141),o=Math.exp;e(e.S,"Math",{tanh:function(t){var n=i(t=+t),r=i(-t);return n==1/0?1:r==1/0?-1:(n-r)/(o(t)+o(-t))}})},function(t,n,r){var e=r(1);e(e.S,"Math",{trunc:function(t){return(t>0?Math.floor:Math.ceil)(t)}})},function(t,n,r){"use strict";var e=r(3),i=r(24),o=r(45),u=r(136),c=r(50),f=r(4),a=r(71).f,s=r(31).f,l=r(11).f,h=r(82).trim,v="Number",p=e[v],d=p,y=p.prototype,g=o(r(70)(y))==v,b="trim"in String.prototype,m=function(t){var n=c(t,!1);if("string"==typeof n&&n.length>2){n=b?n.trim():h(n,3);var r,e,i,o=n.charCodeAt(0);if(43===o||45===o){if(88===(r=n.charCodeAt(2))||120===r)return NaN}else if(48===o){switch(n.charCodeAt(1)){case 66:case 98:e=2,i=49;break;case 79:case 111:e=8,i=55;break;default:return+n}for(var u,f=n.slice(2),a=0,s=f.length;a<s;a++)if((u=f.charCodeAt(a))<48||u>i)return NaN;return parseInt(f,e)}}return+n};if(!p(" 0o1")||!p("0b1")||p("+0x1")){p=function(t){var n=arguments.length<1?0:t,r=this;return r instanceof p&&(g?f(function(){y.valueOf.call(r)}):o(r)!=v)?u(new d(m(n)),r,p):m(n)};for(var x,w=r(10)?a(d):"MAX_VALUE,MIN_VALUE,NaN,NEGATIVE_INFINITY,POSITIVE_INFINITY,EPSILON,isFinite,isInteger,isNaN,isSafeInteger,MAX_SAFE_INTEGER,MIN_SAFE_INTEGER,parseFloat,parseInt,isInteger".split(","),S=0;w.length>S;S++)i(d,x=w[S])&&!i(p,x)&&l(p,x,s(d,x));p.prototype=y,y.constructor=p,r(28)(e,v,p)}},function(t,n,r){var e=r(1);e(e.S,"Number",{EPSILON:Math.pow(2,-52)})},function(t,n,r){var e=r(1),i=r(3).isFinite;e(e.S,"Number",{isFinite:function(t){return"number"==typeof t&&i(t)}})},function(t,n,r){var e=r(1);e(e.S,"Number",{isInteger:r(168)})},function(t,n,r){var e=r(1);e(e.S,"Number",{isNaN:function(t){return t!=t}})},function(t,n,r){var e=r(1),i=r(168),o=Math.abs;e(e.S,"Number",{isSafeInteger:function(t){return i(t)&&o(t)<=9007199254740991}})},function(t,n,r){var e=r(1);e(e.S,"Number",{MAX_SAFE_INTEGER:9007199254740991})},function(t,n,r){var e=r(1);e(e.S,"Number",{MIN_SAFE_INTEGER:-9007199254740991})},function(t,n,r){var e=r(1),i=r(178);e(e.S+e.F*(Number.parseFloat!=i),"Number",{parseFloat:i})},function(t,n,r){var e=r(1),i=r(179);e(e.S+e.F*(Number.parseInt!=i),"Number",{parseInt:i})},function(t,n,r){"use strict";var e=r(1),i=r(67),o=r(159),u=r(149),c=1..toFixed,f=Math.floor,a=[0,0,0,0,0,0],s="Number.toFixed: incorrect invocation!",l="0",h=function(t,n){for(var r=-1,e=n;++r<6;)e+=t*a[r],a[r]=e%1e7,e=f(e/1e7)},v=function(t){for(var n=6,r=0;--n>=0;)r+=a[n],a[n]=f(r/t),r=r%t*1e7},p=function(){for(var t=6,n="";--t>=0;)if(""!==n||0===t||0!==a[t]){var r=String(a[t]);n=""===n?r:n+u.call(l,7-r.length)+r}return n},d=function(t,n,r){return 0===n?r:n%2==1?d(t,n-1,r*t):d(t*t,n/2,r)},y=function(t){for(var n=0,r=t;r>=4096;)n+=12,r/=4096;for(;r>=2;)n+=1,r/=2;return n};e(e.P+e.F*(!!c&&("0.000"!==8e-5.toFixed(3)||"1"!==.9.toFixed(0)||"1.25"!==1.255.toFixed(2)||"1000000000000000128"!==(0xde0b6b3a7640080).toFixed(0))||!r(4)(function(){c.call({})})),"Number",{toFixed:function(t){var n,r,e,c,f=o(this,s),a=i(t),g="",b=l;if(a<0||a>20)throw RangeError(s);if(f!=f)return"NaN";if(f<=-1e21||f>=1e21)return String(f);if(f<0&&(g="-",f=-f),f>1e-21)if(n=y(f*d(2,69,1))-69,r=n<0?f*d(2,-n,1):f/d(2,n,1),r*=4503599627370496,(n=52-n)>0){for(h(0,r),e=a;e>=7;)h(1e7,0),e-=7;for(h(d(10,e,1),0),e=n-1;e>=23;)v(1<<23),e-=23;v(1<<e),h(1,1),v(2),b=p()}else h(0,r),h(1<<-n,0),b=p()+u.call(l,a);return a>0?(c=b.length,b=g+(c<=a?"0."+u.call(l,a-c)+b:b.slice(0,c-a)+"."+b.slice(c-a))):b=g+b,b}})},function(t,n,r){"use strict";var e=r(1),i=r(4),o=r(159),u=1..toPrecision;e(e.P+e.F*(i(function(){return"1"!==u.call(1,void 0)})||!i(function(){u.call({})})),"Number",{toPrecision:function(t){var n=o(this,"Number#toPrecision: incorrect invocation!");return void 0===t?u.call(n):u.call(n,t)}})},function(t,n,r){var e=r(1);e(e.S+e.F,"Object",{assign:r(172)})},function(t,n,r){var e=r(1);e(e.S,"Object",{create:r(70)})},function(t,n,r){var e=r(1);e(e.S+e.F*!r(10),"Object",{defineProperties:r(173)})},function(t,n,r){var e=r(1);e(e.S+e.F*!r(10),"Object",{defineProperty:r(11).f})},function(t,n,r){var e=r(6),i=r(65).onFreeze;r(49)("freeze",function(t){return function(n){return t&&e(n)?t(i(n)):n}})},function(t,n,r){var e=r(30),i=r(31).f;r(49)("getOwnPropertyDescriptor",function(){return function(t,n){return i(e(t),n)}})},function(t,n,r){r(49)("getOwnPropertyNames",function(){return r(174).f})},function(t,n,r){var e=r(17),i=r(32);r(49)("getPrototypeOf",function(){return function(t){return i(e(t))}})},function(t,n,r){var e=r(6);r(49)("isExtensible",function(t){return function(n){return!!e(n)&&(!t||t(n))}})},function(t,n,r){var e=r(6);r(49)("isFrozen",function(t){return function(n){return!e(n)||!!t&&t(n)}})},function(t,n,r){var e=r(6);r(49)("isSealed",function(t){return function(n){return!e(n)||!!t&&t(n)}})},function(t,n,r){var e=r(1);e(e.S,"Object",{is:r(180)})},function(t,n,r){var e=r(17),i=r(72);r(49)("keys",function(){return function(t){return i(e(t))}})},function(t,n,r){var e=r(6),i=r(65).onFreeze;r(49)("preventExtensions",function(t){return function(n){return t&&e(n)?t(i(n)):n}})},function(t,n,r){var e=r(6),i=r(65).onFreeze;r(49)("seal",function(t){return function(n){return t&&e(n)?t(i(n)):n}})},function(t,n,r){var e=r(1);e(e.S,"Object",{setPrototypeOf:r(144).set})},function(t,n,r){"use strict";var e=r(114),i={};i[r(7)("toStringTag")]="z",i+""!="[object z]"&&r(28)(Object.prototype,"toString",function(){return"[object "+e(this)+"]"},!0)},function(t,n,r){var e=r(1),i=r(178);e(e.G+e.F*(parseFloat!=i),{parseFloat:i})},function(t,n,r){var e=r(1),i=r(179);e(e.G+e.F*(parseInt!=i),{parseInt:i})},function(t,n,r){"use strict";var e,i,o,u=r(69),c=r(3),f=r(53),a=r(114),s=r(1),l=r(6),h=r(26),v=r(68),p=r(79),d=r(146),y=r(151).set,g=r(143)(),b="Promise",m=c.TypeError,x=c.process,w=c[b],x=c.process,S="process"==a(x),_=function(){},O=!!function(){try{var t=w.resolve(1),n=(t.constructor={})[r(7)("species")]=function(t){t(_,_)};return(S||"function"==typeof PromiseRejectionEvent)&&t.then(_)instanceof n}catch(t){}}(),E=function(t,n){return t===n||t===w&&n===o},P=function(t){var n;return!(!l(t)||"function"!=typeof(n=t.then))&&n},j=function(t){return E(w,t)?new F(t):new i(t)},F=i=function(t){var n,r;this.promise=new t(function(t,e){if(void 0!==n||void 0!==r)throw m("Bad Promise constructor");n=t,r=e}),this.resolve=h(n),this.reject=h(r)},M=function(t){try{t()}catch(t){return{error:t}}},A=function(t,n){if(!t._n){t._n=!0;var r=t._c;g(function(){for(var e=t._v,i=1==t._s,o=0;r.length>o;)!function(n){var r,o,u=i?n.ok:n.fail,c=n.resolve,f=n.reject,a=n.domain;try{u?(i||(2==t._h&&I(t),t._h=1),!0===u?r=e:(a&&a.enter(),r=u(e),a&&a.exit()),r===n.promise?f(m("Promise-chain cycle")):(o=P(r))?o.call(r,c,f):c(r)):f(e)}catch(t){f(t)}}(r[o++]);t._c=[],t._n=!1,n&&!t._h&&N(t)})}},N=function(t){y.call(c,function(){var n,r,e,i=t._v;if(T(t)&&(n=M(function(){S?x.emit("unhandledRejection",i,t):(r=c.onunhandledrejection)?r({promise:t,reason:i}):(e=c.console)&&e.error&&e.error("Unhandled promise rejection",i)}),t._h=S||T(t)?2:1),t._a=void 0,n)throw n.error})},T=function(t){if(1==t._h)return!1;for(var n,r=t._a||t._c,e=0;r.length>e;)if(n=r[e++],n.fail||!T(n.promise))return!1;return!0},I=function(t){y.call(c,function(){var n;S?x.emit("rejectionHandled",t):(n=c.onrejectionhandled)&&n({promise:t,reason:t._v})})},k=function(t){var n=this;n._d||(n._d=!0,n=n._w||n,n._v=t,n._s=2,n._a||(n._a=n._c.slice()),A(n,!0))},L=function(t){var n,r=this;if(!r._d){r._d=!0,r=r._w||r;try{if(r===t)throw m("Promise can't be resolved itself");(n=P(t))?g(function(){var e={_w:r,_d:!1};try{n.call(t,f(L,e,1),f(k,e,1))}catch(t){k.call(e,t)}}):(r._v=t,r._s=1,A(r,!1))}catch(t){k.call({_w:r,_d:!1},t)}}};O||(w=function(t){v(this,w,b,"_h"),h(t),e.call(this);try{t(f(L,this,1),f(k,this,1))}catch(t){k.call(this,t)}},e=function(t){this._c=[],this._a=void 0,this._s=0,this._d=!1,this._v=void 0,this._h=0,this._n=!1},e.prototype=r(73)(w.prototype,{then:function(t,n){var r=j(d(this,w));return r.ok="function"!=typeof t||t,r.fail="function"==typeof n&&n,r.domain=S?x.domain:void 0,this._c.push(r),this._a&&this._a.push(r),this._s&&A(this,!1),r.promise},catch:function(t){return this.then(void 0,t)}}),F=function(){var t=new e;this.promise=t,this.resolve=f(L,t,1),this.reject=f(k,t,1)}),s(s.G+s.W+s.F*!O,{Promise:w}),r(81)(w,b),r(74)(b),o=r(52)[b],s(s.S+s.F*!O,b,{reject:function(t){var n=j(this);return(0,n.reject)(t),n.promise}}),s(s.S+s.F*(u||!O),b,{resolve:function(t){if(t instanceof w&&E(t.constructor,this))return t;var n=j(this);return(0,n.resolve)(t),n.promise}}),s(s.S+s.F*!(O&&r(123)(function(t){w.all(t).catch(_)})),b,{all:function(t){var n=this,r=j(n),e=r.resolve,i=r.reject,o=M(function(){var r=[],o=0,u=1;p(t,!1,function(t){var c=o++,f=!1;r.push(void 0),u++,n.resolve(t).then(function(t){f||(f=!0,r[c]=t,--u||e(r))},i)}),--u||e(r)});return o&&i(o.error),r.promise},race:function(t){var n=this,r=j(n),e=r.reject,i=M(function(){p(t,!1,function(t){n.resolve(t).then(r.resolve,e)})});return i&&e(i.error),r.promise}})},function(t,n,r){var e=r(1),i=r(26),o=r(2),u=(r(3).Reflect||{}).apply,c=Function.apply;e(e.S+e.F*!r(4)(function(){u(function(){})}),"Reflect",{apply:function(t,n,r){var e=i(t),f=o(r);return u?u(e,n,f):c.call(e,n,f)}})},function(t,n,r){var e=r(1),i=r(70),o=r(26),u=r(2),c=r(6),f=r(4),a=r(163),s=(r(3).Reflect||{}).construct,l=f(function(){function t(){}return!(s(function(){},[],t)instanceof t)}),h=!f(function(){s(function(){})});e(e.S+e.F*(l||h),"Reflect",{construct:function(t,n){o(t),u(n);var r=arguments.length<3?t:o(arguments[2]);if(h&&!l)return s(t,n,r);if(t==r){switch(n.length){case 0:return new t;case 1:return new t(n[0]);case 2:return new t(n[0],n[1]);case 3:return new t(n[0],n[1],n[2]);case 4:return new t(n[0],n[1],n[2],n[3])}var e=[null];return e.push.apply(e,n),new(a.apply(t,e))}var f=r.prototype,v=i(c(f)?f:Object.prototype),p=Function.apply.call(t,v,n);return c(p)?p:v}})},function(t,n,r){var e=r(11),i=r(1),o=r(2),u=r(50);i(i.S+i.F*r(4)(function(){Reflect.defineProperty(e.f({},1,{value:1}),1,{value:2})}),"Reflect",{defineProperty:function(t,n,r){o(t),n=u(n,!0),o(r);try{return e.f(t,n,r),!0}catch(t){return!1}}})},function(t,n,r){var e=r(1),i=r(31).f,o=r(2);e(e.S,"Reflect",{deleteProperty:function(t,n){var r=i(o(t),n);return!(r&&!r.configurable)&&delete t[n]}})},function(t,n,r){"use strict";var e=r(1),i=r(2),o=function(t){this._t=i(t),this._i=0;var n,r=this._k=[];for(n in t)r.push(n)};r(139)(o,"Object",function(){var t,n=this,r=n._k;do{if(n._i>=r.length)return{value:void 0,done:!0}}while(!((t=r[n._i++])in n._t));return{value:t,done:!1}}),e(e.S,"Reflect",{enumerate:function(t){return new o(t)}})},function(t,n,r){var e=r(31),i=r(1),o=r(2);i(i.S,"Reflect",{getOwnPropertyDescriptor:function(t,n){return e.f(o(t),n)}})},function(t,n,r){var e=r(1),i=r(32),o=r(2);e(e.S,"Reflect",{getPrototypeOf:function(t){return i(o(t))}})},function(t,n,r){function e(t,n){var r,c,s=arguments.length<3?t:arguments[2];return a(t)===s?t[n]:(r=i.f(t,n))?u(r,"value")?r.value:void 0!==r.get?r.get.call(s):void 0:f(c=o(t))?e(c,n,s):void 0}var i=r(31),o=r(32),u=r(24),c=r(1),f=r(6),a=r(2);c(c.S,"Reflect",{get:e})},function(t,n,r){var e=r(1);e(e.S,"Reflect",{has:function(t,n){return n in t}})},function(t,n,r){var e=r(1),i=r(2),o=Object.isExtensible;e(e.S,"Reflect",{isExtensible:function(t){return i(t),!o||o(t)}})},function(t,n,r){var e=r(1);e(e.S,"Reflect",{ownKeys:r(177)})},function(t,n,r){var e=r(1),i=r(2),o=Object.preventExtensions;e(e.S,"Reflect",{preventExtensions:function(t){i(t);try{return o&&o(t),!0}catch(t){return!1}}})},function(t,n,r){var e=r(1),i=r(144);i&&e(e.S,"Reflect",{setPrototypeOf:function(t,n){i.check(t,n);try{return i.set(t,n),!0}catch(t){return!1}}})},function(t,n,r){function e(t,n,r){var f,h,v=arguments.length<4?t:arguments[3],p=o.f(s(t),n);if(!p){if(l(h=u(t)))return e(h,n,r,v);p=a(0)}return c(p,"value")?!(!1===p.writable||!l(v)||(f=o.f(v,n)||a(0),f.value=r,i.f(v,n,f),0)):void 0!==p.set&&(p.set.call(v,r),!0)}var i=r(11),o=r(31),u=r(32),c=r(24),f=r(1),a=r(66),s=r(2),l=r(6);f(f.S,"Reflect",{set:e})},function(t,n,r){var e=r(3),i=r(136),o=r(11).f,u=r(71).f,c=r(122),f=r(120),a=e.RegExp,s=a,l=a.prototype,h=/a/g,v=/a/g,p=new a(h)!==h;if(r(10)&&(!p||r(4)(function(){return v[r(7)("match")]=!1,a(h)!=h||a(v)==v||"/a/i"!=a(h,"i")}))){a=function(t,n){var r=this instanceof a,e=c(t),o=void 0===n;return!r&&e&&t.constructor===a&&o?t:i(p?new s(e&&!o?t.source:t,n):s((e=t instanceof a)?t.source:t,e&&o?f.call(t):n),r?this:l,a)};for(var d=u(s),y=0;d.length>y;)!function(t){t in a||o(a,t,{configurable:!0,get:function(){return s[t]},set:function(n){s[t]=n}})}(d[y++]);l.constructor=a,a.prototype=l,r(28)(e,"RegExp",a)}r(74)("RegExp")},function(t,n,r){r(119)("match",1,function(t,n,r){return[function(r){"use strict";var e=t(this),i=void 0==r?void 0:r[n];return void 0!==i?i.call(r,e):new RegExp(r)[n](String(e))},r]})},function(t,n,r){r(119)("replace",2,function(t,n,r){return[function(e,i){"use strict";var o=t(this),u=void 0==e?void 0:e[n];return void 0!==u?u.call(e,o,i):r.call(String(o),e,i)},r]})},function(t,n,r){r(119)("search",1,function(t,n,r){return[function(r){"use strict";var e=t(this),i=void 0==r?void 0:r[n];return void 0!==i?i.call(r,e):new RegExp(r)[n](String(e))},r]})},function(t,n,r){r(119)("split",2,function(t,n,e){"use strict";var i=r(122),o=e,u=[].push,c="split",f="length",a="lastIndex";if("c"=="abbc"[c](/(b)*/)[1]||4!="test"[c](/(?:)/,-1)[f]||2!="ab"[c](/(?:ab)*/)[f]||4!="."[c](/(.?)(.?)/)[f]||"."[c](/()()/)[f]>1||""[c](/.?/)[f]){var s=void 0===/()??/.exec("")[1];e=function(t,n){var r=String(this);if(void 0===t&&0===n)return[];if(!i(t))return o.call(r,t,n);var e,c,l,h,v,p=[],d=(t.ignoreCase?"i":"")+(t.multiline?"m":"")+(t.unicode?"u":"")+(t.sticky?"y":""),y=0,g=void 0===n?4294967295:n>>>0,b=new RegExp(t.source,d+"g");for(s||(e=new RegExp("^"+b.source+"$(?!\\s)",d));(c=b.exec(r))&&!((l=c.index+c[0][f])>y&&(p.push(r.slice(y,c.index)),!s&&c[f]>1&&c[0].replace(e,function(){for(v=1;v<arguments[f]-2;v++)void 0===arguments[v]&&(c[v]=void 0)}),c[f]>1&&c.index<r[f]&&u.apply(p,c.slice(1)),h=c[0][f],y=l,p[f]>=g));)b[a]===c.index&&b[a]++;return y===r[f]?!h&&b.test("")||p.push(""):p.push(r.slice(y)),p[f]>g?p.slice(0,g):p}}else"0"[c](void 0,0)[f]&&(e=function(t,n){return void 0===t&&0===n?[]:o.call(this,t,n)});return[function(r,i){var o=t(this),u=void 0==r?void 0:r[n];return void 0!==u?u.call(r,o,i):e.call(String(o),r,i)},e]})},function(t,n,r){"use strict";r(184);var e=r(2),i=r(120),o=r(10),u="toString",c=/./[u],f=function(t){r(28)(RegExp.prototype,u,t,!0)};r(4)(function(){return"/a/b"!=c.call({source:"a",flags:"b"})})?f(function(){var t=e(this);return"/".concat(t.source,"/","flags"in t?t.flags:!o&&t instanceof RegExp?i.call(t):void 0)}):c.name!=u&&f(function(){return c.call(this)})},function(t,n,r){"use strict";r(29)("anchor",function(t){return function(n){return t(this,"a","name",n)}})},function(t,n,r){"use strict";r(29)("big",function(t){return function(){return t(this,"big","","")}})},function(t,n,r){"use strict";r(29)("blink",function(t){return function(){return t(this,"blink","","")}})},function(t,n,r){"use strict";r(29)("bold",function(t){return function(){return t(this,"b","","")}})},function(t,n,r){"use strict";var e=r(1),i=r(147)(!1);e(e.P,"String",{codePointAt:function(t){return i(this,t)}})},function(t,n,r){"use strict";var e=r(1),i=r(16),o=r(148),u="endsWith",c=""[u];e(e.P+e.F*r(134)(u),"String",{endsWith:function(t){var n=o(this,t,u),r=arguments.length>1?arguments[1]:void 0,e=i(n.length),f=void 0===r?e:Math.min(i(r),e),a=String(t);return c?c.call(n,a,f):n.slice(f-a.length,f)===a}})},function(t,n,r){"use strict";r(29)("fixed",function(t){return function(){return t(this,"tt","","")}})},function(t,n,r){"use strict";r(29)("fontcolor",function(t){return function(n){return t(this,"font","color",n)}})},function(t,n,r){"use strict";r(29)("fontsize",function(t){return function(n){return t(this,"font","size",n)}})},function(t,n,r){var e=r(1),i=r(75),o=String.fromCharCode,u=String.fromCodePoint;e(e.S+e.F*(!!u&&1!=u.length),"String",{fromCodePoint:function(t){for(var n,r=[],e=arguments.length,u=0;e>u;){if(n=+arguments[u++],i(n,1114111)!==n)throw RangeError(n+" is not a valid code point");r.push(n<65536?o(n):o(55296+((n-=65536)>>10),n%1024+56320))}return r.join("")}})},function(t,n,r){"use strict";var e=r(1),i=r(148),o="includes";e(e.P+e.F*r(134)(o),"String",{includes:function(t){return!!~i(this,t,o).indexOf(t,arguments.length>1?arguments[1]:void 0)}})},function(t,n,r){"use strict";r(29)("italics",function(t){return function(){return t(this,"i","","")}})},function(t,n,r){"use strict";var e=r(147)(!0);r(140)(String,"String",function(t){this._t=String(t),this._i=0},function(){var t,n=this._t,r=this._i;return r>=n.length?{value:void 0,done:!0}:(t=e(n,r),this._i+=t.length,{value:t,done:!1})})},function(t,n,r){"use strict";r(29)("link",function(t){return function(n){return t(this,"a","href",n)}})},function(t,n,r){var e=r(1),i=r(30),o=r(16);e(e.S,"String",{raw:function(t){for(var n=i(t.raw),r=o(n.length),e=arguments.length,u=[],c=0;r>c;)u.push(String(n[c++])),c<e&&u.push(String(arguments[c]));return u.join("")}})},function(t,n,r){var e=r(1);e(e.P,"String",{repeat:r(149)})},function(t,n,r){"use strict";r(29)("small",function(t){return function(){return t(this,"small","","")}})},function(t,n,r){"use strict";var e=r(1),i=r(16),o=r(148),u="startsWith",c=""[u];e(e.P+e.F*r(134)(u),"String",{startsWith:function(t){var n=o(this,t,u),r=i(Math.min(arguments.length>1?arguments[1]:void 0,n.length)),e=String(t);return c?c.call(n,e,r):n.slice(r,r+e.length)===e}})},function(t,n,r){"use strict";r(29)("strike",function(t){return function(){return t(this,"strike","","")}})},function(t,n,r){"use strict";r(29)("sub",function(t){return function(){return t(this,"sub","","")}})},function(t,n,r){"use strict";r(29)("sup",function(t){return function(){return t(this,"sup","","")}})},function(t,n,r){"use strict";r(82)("trim",function(t){return function(){return t(this,3)}})},function(t,n,r){"use strict";var e=r(3),i=r(24),o=r(10),u=r(1),c=r(28),f=r(65).KEY,a=r(4),s=r(126),l=r(81),h=r(76),v=r(7),p=r(182),d=r(153),y=r(206),g=r(205),b=r(138),m=r(2),x=r(30),w=r(50),S=r(66),_=r(70),O=r(174),E=r(31),P=r(11),j=r(72),F=E.f,M=P.f,A=O.f,N=e.Symbol,T=e.JSON,I=T&&T.stringify,k="prototype",L=v("_hidden"),R=v("toPrimitive"),C={}.propertyIsEnumerable,D=s("symbol-registry"),U=s("symbols"),W=s("op-symbols"),G=Object[k],B="function"==typeof N,V=e.QObject,z=!V||!V[k]||!V[k].findChild,q=o&&a(function(){return 7!=_(M({},"a",{get:function(){return M(this,"a",{value:7}).a}})).a})?function(t,n,r){var e=F(G,n);e&&delete G[n],M(t,n,r),e&&t!==G&&M(G,n,e)}:M,K=function(t){var n=U[t]=_(N[k]);return n._k=t,n},J=B&&"symbol"==typeof N.iterator?function(t){return"symbol"==typeof t}:function(t){return t instanceof N},Y=function(t,n,r){return t===G&&Y(W,n,r),m(t),n=w(n,!0),m(r),i(U,n)?(r.enumerable?(i(t,L)&&t[L][n]&&(t[L][n]=!1),r=_(r,{enumerable:S(0,!1)})):(i(t,L)||M(t,L,S(1,{})),t[L][n]=!0),q(t,n,r)):M(t,n,r)},H=function(t,n){m(t);for(var r,e=g(n=x(n)),i=0,o=e.length;o>i;)Y(t,r=e[i++],n[r]);return t},$=function(t,n){return void 0===n?_(t):H(_(t),n)},X=function(t){var n=C.call(this,t=w(t,!0));return!(this===G&&i(U,t)&&!i(W,t))&&(!(n||!i(this,t)||!i(U,t)||i(this,L)&&this[L][t])||n)},Q=function(t,n){if(t=x(t),n=w(n,!0),t!==G||!i(U,n)||i(W,n)){var r=F(t,n);return!r||!i(U,n)||i(t,L)&&t[L][n]||(r.enumerable=!0),r}},Z=function(t){for(var n,r=A(x(t)),e=[],o=0;r.length>o;)i(U,n=r[o++])||n==L||n==f||e.push(n);return e},tt=function(t){for(var n,r=t===G,e=A(r?W:x(t)),o=[],u=0;e.length>u;)!i(U,n=e[u++])||r&&!i(G,n)||o.push(U[n]);return o};B||(N=function(){if(this instanceof N)throw TypeError("Symbol is not a constructor!");var t=h(arguments.length>0?arguments[0]:void 0),n=function(r){this===G&&n.call(W,r),i(this,L)&&i(this[L],t)&&(this[L][t]=!1),q(this,t,S(1,r))};return o&&z&&q(G,t,{configurable:!0,set:n}),K(t)},c(N[k],"toString",function(){return this._k}),E.f=Q,P.f=Y,r(71).f=O.f=Z,r(116).f=X,r(125).f=tt,o&&!r(69)&&c(G,"propertyIsEnumerable",X,!0),p.f=function(t){return K(v(t))}),u(u.G+u.W+u.F*!B,{Symbol:N});for(var nt="hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),rt=0;nt.length>rt;)v(nt[rt++]);for(var nt=j(v.store),rt=0;nt.length>rt;)d(nt[rt++]);u(u.S+u.F*!B,"Symbol",{for:function(t){return i(D,t+="")?D[t]:D[t]=N(t)},keyFor:function(t){if(J(t))return y(D,t);throw TypeError(t+" is not a symbol!")},useSetter:function(){z=!0},useSimple:function(){z=!1}}),u(u.S+u.F*!B,"Object",{create:$,defineProperty:Y,defineProperties:H,getOwnPropertyDescriptor:Q,getOwnPropertyNames:Z,getOwnPropertySymbols:tt}),T&&u(u.S+u.F*(!B||a(function(){var t=N();return"[null]"!=I([t])||"{}"!=I({a:t})||"{}"!=I(Object(t))})),"JSON",{stringify:function(t){if(void 0!==t&&!J(t)){for(var n,r,e=[t],i=1;arguments.length>i;)e.push(arguments[i++]);return n=e[1],"function"==typeof n&&(r=n),!r&&b(n)||(n=function(t,n){if(r&&(n=r.call(this,t,n)),!J(n))return n}),e[1]=n,I.apply(T,e)}}}),N[k][R]||r(27)(N[k],R,N[k].valueOf),l(N,"Symbol"),l(Math,"Math",!0),l(e.JSON,"JSON",!0)},function(t,n,r){"use strict";var e=r(1),i=r(127),o=r(152),u=r(2),c=r(75),f=r(16),a=r(6),s=r(3).ArrayBuffer,l=r(146),h=o.ArrayBuffer,v=o.DataView,p=i.ABV&&s.isView,d=h.prototype.slice,y=i.VIEW,g="ArrayBuffer";e(e.G+e.W+e.F*(s!==h),{ArrayBuffer:h}),e(e.S+e.F*!i.CONSTR,g,{isView:function(t){return p&&p(t)||a(t)&&y in t}}),e(e.P+e.U+e.F*r(4)(function(){return!new h(2).slice(1,void 0).byteLength}),g,{slice:function(t,n){if(void 0!==d&&void 0===n)return d.call(u(this),t);for(var r=u(this).byteLength,e=c(t,r),i=c(void 0===n?r:n,r),o=new(l(this,h))(f(i-e)),a=new v(this),s=new v(o),p=0;e<i;)s.setUint8(p++,a.getUint8(e++));return o}}),r(74)(g)},function(t,n,r){var e=r(1);e(e.G+e.W+e.F*!r(127).ABV,{DataView:r(152).DataView})},function(t,n,r){r(55)("Float32",4,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Float64",8,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Int16",2,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Int32",4,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Int8",1,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Uint16",2,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Uint32",4,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Uint8",1,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Uint8",1,function(t){return function(n,r,e){return t(this,n,r,e)}},!0)},function(t,n,r){"use strict";var e=r(166);r(118)("WeakSet",function(t){return function(){return t(this,arguments.length>0?arguments[0]:void 0)}},{add:function(t){return e.def(this,t,!0)}},e,!1,!0)},function(t,n,r){"use strict";var e=r(1),i=r(117)(!0);e(e.P,"Array",{includes:function(t){return i(this,t,arguments.length>1?arguments[1]:void 0)}}),r(78)("includes")},function(t,n,r){var e=r(1),i=r(143)(),o=r(3).process,u="process"==r(45)(o);e(e.G,{asap:function(t){var n=u&&o.domain;i(n?n.bind(t):t)}})},function(t,n,r){var e=r(1),i=r(45);e(e.S,"Error",{isError:function(t){return"Error"===i(t)}})},function(t,n,r){var e=r(1);e(e.P+e.R,"Map",{toJSON:r(165)("Map")})},function(t,n,r){var e=r(1);e(e.S,"Math",{iaddh:function(t,n,r,e){var i=t>>>0,o=n>>>0,u=r>>>0;return o+(e>>>0)+((i&u|(i|u)&~(i+u>>>0))>>>31)|0}})},function(t,n,r){var e=r(1);e(e.S,"Math",{imulh:function(t,n){var r=65535,e=+t,i=+n,o=e&r,u=i&r,c=e>>16,f=i>>16,a=(c*u>>>0)+(o*u>>>16);return c*f+(a>>16)+((o*f>>>0)+(a&r)>>16)}})},function(t,n,r){var e=r(1);e(e.S,"Math",{isubh:function(t,n,r,e){var i=t>>>0,o=n>>>0,u=r>>>0;return o-(e>>>0)-((~i&u|~(i^u)&i-u>>>0)>>>31)|0}})},function(t,n,r){var e=r(1);e(e.S,"Math",{umulh:function(t,n){var r=65535,e=+t,i=+n,o=e&r,u=i&r,c=e>>>16,f=i>>>16,a=(c*u>>>0)+(o*u>>>16);return c*f+(a>>>16)+((o*f>>>0)+(a&r)>>>16)}})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(26),u=r(11);r(10)&&e(e.P+r(124),"Object",{__defineGetter__:function(t,n){u.f(i(this),t,{get:o(n),enumerable:!0,configurable:!0})}})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(26),u=r(11);r(10)&&e(e.P+r(124),"Object",{__defineSetter__:function(t,n){u.f(i(this),t,{set:o(n),enumerable:!0,configurable:!0})}})},function(t,n,r){var e=r(1),i=r(176)(!0);e(e.S,"Object",{entries:function(t){return i(t)}})},function(t,n,r){var e=r(1),i=r(177),o=r(30),u=r(31),c=r(131);e(e.S,"Object",{getOwnPropertyDescriptors:function(t){for(var n,r=o(t),e=u.f,f=i(r),a={},s=0;f.length>s;)c(a,n=f[s++],e(r,n));return a}})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(50),u=r(32),c=r(31).f;r(10)&&e(e.P+r(124),"Object",{__lookupGetter__:function(t){var n,r=i(this),e=o(t,!0);do{if(n=c(r,e))return n.get}while(r=u(r))}})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(50),u=r(32),c=r(31).f;r(10)&&e(e.P+r(124),"Object",{__lookupSetter__:function(t){var n,r=i(this),e=o(t,!0);do{if(n=c(r,e))return n.set}while(r=u(r))}})},function(t,n,r){var e=r(1),i=r(176)(!1);e(e.S,"Object",{values:function(t){return i(t)}})},function(t,n,r){"use strict";var e=r(1),i=r(3),o=r(52),u=r(143)(),c=r(7)("observable"),f=r(26),a=r(2),s=r(68),l=r(73),h=r(27),v=r(79),p=v.RETURN,d=function(t){return null==t?void 0:f(t)},y=function(t){var n=t._c;n&&(t._c=void 0,n())},g=function(t){return void 0===t._o},b=function(t){g(t)||(t._o=void 0,y(t))},m=function(t,n){a(t),this._c=void 0,this._o=t,t=new x(this);try{var r=n(t),e=r;null!=r&&("function"==typeof r.unsubscribe?r=function(){e.unsubscribe()}:f(r),this._c=r)}catch(n){return void t.error(n)}g(this)&&y(this)};m.prototype=l({},{unsubscribe:function(){b(this)}});var x=function(t){this._s=t};x.prototype=l({},{next:function(t){var n=this._s;if(!g(n)){var r=n._o;try{var e=d(r.next);if(e)return e.call(r,t)}catch(t){try{b(n)}finally{throw t}}}},error:function(t){var n=this._s;if(g(n))throw t;var r=n._o;n._o=void 0;try{var e=d(r.error);if(!e)throw t;t=e.call(r,t)}catch(t){try{y(n)}finally{throw t}}return y(n),t},complete:function(t){var n=this._s;if(!g(n)){var r=n._o;n._o=void 0;try{var e=d(r.complete);t=e?e.call(r,t):void 0}catch(t){try{y(n)}finally{throw t}}return y(n),t}}});var w=function(t){s(this,w,"Observable","_f")._f=f(t)};l(w.prototype,{subscribe:function(t){return new m(t,this._f)},forEach:function(t){var n=this;return new(o.Promise||i.Promise)(function(r,e){f(t);var i=n.subscribe({next:function(n){try{return t(n)}catch(t){e(t),i.unsubscribe()}},error:e,complete:r})})}}),l(w,{from:function(t){var n="function"==typeof this?this:w,r=d(a(t)[c]);if(r){var e=a(r.call(t));return e.constructor===n?e:new n(function(t){return e.subscribe(t)})}return new n(function(n){var r=!1;return u(function(){if(!r){try{if(v(t,!1,function(t){if(n.next(t),r)return p})===p)return}catch(t){if(r)throw t;return void n.error(t)}n.complete()}}),function(){r=!0}})},of:function(){for(var t=0,n=arguments.length,r=Array(n);t<n;)r[t]=arguments[t++];return new("function"==typeof this?this:w)(function(t){var n=!1;return u(function(){if(!n){for(var e=0;e<r.length;++e)if(t.next(r[e]),n)return;t.complete()}}),function(){n=!0}})}}),h(w.prototype,c,function(){return this}),e(e.G,{Observable:w}),r(74)("Observable")},function(t,n,r){var e=r(54),i=r(2),o=e.key,u=e.set;e.exp({defineMetadata:function(t,n,r,e){u(t,n,i(r),o(e))}})},function(t,n,r){var e=r(54),i=r(2),o=e.key,u=e.map,c=e.store;e.exp({deleteMetadata:function(t,n){var r=arguments.length<3?void 0:o(arguments[2]),e=u(i(n),r,!1);if(void 0===e||!e.delete(t))return!1;if(e.size)return!0;var f=c.get(n);return f.delete(r),!!f.size||c.delete(n)}})},function(t,n,r){var e=r(185),i=r(161),o=r(54),u=r(2),c=r(32),f=o.keys,a=o.key,s=function(t,n){var r=f(t,n),o=c(t);if(null===o)return r;var u=s(o,n);return u.length?r.length?i(new e(r.concat(u))):u:r};o.exp({getMetadataKeys:function(t){return s(u(t),arguments.length<2?void 0:a(arguments[1]))}})},function(t,n,r){var e=r(54),i=r(2),o=r(32),u=e.has,c=e.get,f=e.key,a=function(t,n,r){if(u(t,n,r))return c(t,n,r);var e=o(n);return null!==e?a(t,e,r):void 0};e.exp({getMetadata:function(t,n){return a(t,i(n),arguments.length<3?void 0:f(arguments[2]))}})},function(t,n,r){var e=r(54),i=r(2),o=e.keys,u=e.key;e.exp({getOwnMetadataKeys:function(t){
return o(i(t),arguments.length<2?void 0:u(arguments[1]))}})},function(t,n,r){var e=r(54),i=r(2),o=e.get,u=e.key;e.exp({getOwnMetadata:function(t,n){return o(t,i(n),arguments.length<3?void 0:u(arguments[2]))}})},function(t,n,r){var e=r(54),i=r(2),o=r(32),u=e.has,c=e.key,f=function(t,n,r){if(u(t,n,r))return!0;var e=o(n);return null!==e&&f(t,e,r)};e.exp({hasMetadata:function(t,n){return f(t,i(n),arguments.length<3?void 0:c(arguments[2]))}})},function(t,n,r){var e=r(54),i=r(2),o=e.has,u=e.key;e.exp({hasOwnMetadata:function(t,n){return o(t,i(n),arguments.length<3?void 0:u(arguments[2]))}})},function(t,n,r){var e=r(54),i=r(2),o=r(26),u=e.key,c=e.set;e.exp({metadata:function(t,n){return function(r,e){c(t,n,(void 0!==e?i:o)(r),u(e))}}})},function(t,n,r){var e=r(1);e(e.P+e.R,"Set",{toJSON:r(165)("Set")})},function(t,n,r){"use strict";var e=r(1),i=r(147)(!0);e(e.P,"String",{at:function(t){return i(this,t)}})},function(t,n,r){"use strict";var e=r(1),i=r(46),o=r(16),u=r(122),c=r(120),f=RegExp.prototype,a=function(t,n){this._r=t,this._s=n};r(139)(a,"RegExp String",function(){var t=this._r.exec(this._s);return{value:t,done:null===t}}),e(e.P,"String",{matchAll:function(t){if(i(this),!u(t))throw TypeError(t+" is not a regexp!");var n=String(this),r="flags"in f?String(t.flags):c.call(t),e=new RegExp(t.source,~r.indexOf("g")?r:"g"+r);return e.lastIndex=o(t.lastIndex),new a(e,n)}})},function(t,n,r){"use strict";var e=r(1),i=r(181);e(e.P,"String",{padEnd:function(t){return i(this,t,arguments.length>1?arguments[1]:void 0,!1)}})},function(t,n,r){"use strict";var e=r(1),i=r(181);e(e.P,"String",{padStart:function(t){return i(this,t,arguments.length>1?arguments[1]:void 0,!0)}})},function(t,n,r){"use strict";r(82)("trimLeft",function(t){return function(){return t(this,1)}},"trimStart")},function(t,n,r){"use strict";r(82)("trimRight",function(t){return function(){return t(this,2)}},"trimEnd")},function(t,n,r){r(153)("asyncIterator")},function(t,n,r){r(153)("observable")},function(t,n,r){var e=r(1);e(e.S,"System",{global:r(3)})},function(t,n,r){for(var e=r(155),i=r(28),o=r(3),u=r(27),c=r(80),f=r(7),a=f("iterator"),s=f("toStringTag"),l=c.Array,h=["NodeList","DOMTokenList","MediaList","StyleSheetList","CSSRuleList"],v=0;v<5;v++){var p,d=h[v],y=o[d],g=y&&y.prototype;if(g){g[a]||u(g,a,l),g[s]||u(g,s,d),c[d]=l;for(p in e)g[p]||i(g,p,e[p],!0)}}},function(t,n,r){var e=r(1),i=r(151);e(e.G+e.B,{setImmediate:i.set,clearImmediate:i.clear})},function(t,n,r){var e=r(3),i=r(1),o=r(121),u=r(207),c=e.navigator,f=!!c&&/MSIE .\./.test(c.userAgent),a=function(t){return f?function(n,r){return t(o(u,[].slice.call(arguments,2),"function"==typeof n?n:Function(n)),r)}:t};i(i.G+i.B+i.F*f,{setTimeout:a(e.setTimeout),setInterval:a(e.setInterval)})},function(t,n,r){r(330),r(269),r(271),r(270),r(273),r(275),r(280),r(274),r(272),r(282),r(281),r(277),r(278),r(276),r(268),r(279),r(283),r(284),r(236),r(238),r(237),r(286),r(285),r(256),r(266),r(267),r(257),r(258),r(259),r(260),r(261),r(262),r(263),r(264),r(265),r(239),r(240),r(241),r(242),r(243),r(244),r(245),r(246),r(247),r(248),r(249),r(250),r(251),r(252),r(253),r(254),r(255),r(317),r(322),r(329),r(320),r(312),r(313),r(318),r(323),r(325),r(308),r(309),r(310),r(311),r(314),r(315),r(316),r(319),r(321),r(324),r(326),r(327),r(328),r(231),r(233),r(232),r(235),r(234),r(220),r(218),r(224),r(221),r(227),r(229),r(217),r(223),r(214),r(228),r(212),r(226),r(225),r(219),r(222),r(211),r(213),r(216),r(215),r(230),r(155),r(302),r(307),r(184),r(303),r(304),r(305),r(306),r(287),r(183),r(185),r(186),r(342),r(331),r(332),r(337),r(340),r(341),r(335),r(338),r(336),r(339),r(333),r(334),r(288),r(289),r(290),r(291),r(292),r(295),r(293),r(294),r(296),r(297),r(298),r(299),r(301),r(300),r(343),r(369),r(372),r(371),r(373),r(374),r(370),r(375),r(376),r(354),r(357),r(353),r(351),r(352),r(355),r(356),r(346),r(368),r(377),r(345),r(347),r(349),r(348),r(350),r(359),r(360),r(362),r(361),r(364),r(363),r(365),r(366),r(367),r(344),r(358),r(380),r(379),r(378),t.exports=r(52)},function(t,n){function r(t,n){if("string"==typeof n)return t.insertAdjacentHTML("afterend",n);var r=t.nextSibling;return r?t.parentNode.insertBefore(n,r):t.parentNode.appendChild(n)}t.exports=r},,,,,,,,,function(t,n,r){(function(n,r){!function(n){"use strict";function e(t,n,r,e){var i=n&&n.prototype instanceof o?n:o,u=Object.create(i.prototype),c=new p(e||[]);return u._invoke=s(t,r,c),u}function i(t,n,r){try{return{type:"normal",arg:t.call(n,r)}}catch(t){return{type:"throw",arg:t}}}function o(){}function u(){}function c(){}function f(t){["next","throw","return"].forEach(function(n){t[n]=function(t){return this._invoke(n,t)}})}function a(t){function n(r,e,o,u){var c=i(t[r],t,e);if("throw"!==c.type){var f=c.arg,a=f.value;return a&&"object"==typeof a&&m.call(a,"__await")?Promise.resolve(a.__await).then(function(t){n("next",t,o,u)},function(t){n("throw",t,o,u)}):Promise.resolve(a).then(function(t){f.value=t,o(f)},u)}u(c.arg)}function e(t,r){function e(){return new Promise(function(e,i){n(t,r,e,i)})}return o=o?o.then(e,e):e()}"object"==typeof r&&r.domain&&(n=r.domain.bind(n));var o;this._invoke=e}function s(t,n,r){var e=P;return function(o,u){if(e===F)throw new Error("Generator is already running");if(e===M){if("throw"===o)throw u;return y()}for(r.method=o,r.arg=u;;){var c=r.delegate;if(c){var f=l(c,r);if(f){if(f===A)continue;return f}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(e===P)throw e=M,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);e=F;var a=i(t,n,r);if("normal"===a.type){if(e=r.done?M:j,a.arg===A)continue;return{value:a.arg,done:r.done}}"throw"===a.type&&(e=M,r.method="throw",r.arg=a.arg)}}}function l(t,n){var r=t.iterator[n.method];if(r===g){if(n.delegate=null,"throw"===n.method){if(t.iterator.return&&(n.method="return",n.arg=g,l(t,n),"throw"===n.method))return A;n.method="throw",n.arg=new TypeError("The iterator does not provide a 'throw' method")}return A}var e=i(r,t.iterator,n.arg);if("throw"===e.type)return n.method="throw",n.arg=e.arg,n.delegate=null,A;var o=e.arg;return o?o.done?(n[t.resultName]=o.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=g),n.delegate=null,A):o:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,A)}function h(t){var n={tryLoc:t[0]};1 in t&&(n.catchLoc=t[1]),2 in t&&(n.finallyLoc=t[2],n.afterLoc=t[3]),this.tryEntries.push(n)}function v(t){var n=t.completion||{};n.type="normal",delete n.arg,t.completion=n}function p(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(h,this),this.reset(!0)}function d(t){if(t){var n=t[w];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var r=-1,e=function n(){for(;++r<t.length;)if(m.call(t,r))return n.value=t[r],n.done=!1,n;return n.value=g,n.done=!0,n};return e.next=e}}return{next:y}}function y(){return{value:g,done:!0}}var g,b=Object.prototype,m=b.hasOwnProperty,x="function"==typeof Symbol?Symbol:{},w=x.iterator||"@@iterator",S=x.asyncIterator||"@@asyncIterator",_=x.toStringTag||"@@toStringTag",O="object"==typeof t,E=n.regeneratorRuntime;if(E)return void(O&&(t.exports=E));E=n.regeneratorRuntime=O?t.exports:{},E.wrap=e;var P="suspendedStart",j="suspendedYield",F="executing",M="completed",A={},N={};N[w]=function(){return this};var T=Object.getPrototypeOf,I=T&&T(T(d([])));I&&I!==b&&m.call(I,w)&&(N=I);var k=c.prototype=o.prototype=Object.create(N);u.prototype=k.constructor=c,c.constructor=u,c[_]=u.displayName="GeneratorFunction",E.isGeneratorFunction=function(t){var n="function"==typeof t&&t.constructor;return!!n&&(n===u||"GeneratorFunction"===(n.displayName||n.name))},E.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,c):(t.__proto__=c,_ in t||(t[_]="GeneratorFunction")),t.prototype=Object.create(k),t},E.awrap=function(t){return{__await:t}},f(a.prototype),a.prototype[S]=function(){return this},E.AsyncIterator=a,E.async=function(t,n,r,i){var o=new a(e(t,n,r,i));return E.isGeneratorFunction(n)?o:o.next().then(function(t){return t.done?t.value:o.next()})},f(k),k[_]="Generator",k.toString=function(){return"[object Generator]"},E.keys=function(t){var n=[];for(var r in t)n.push(r);return n.reverse(),function r(){for(;n.length;){var e=n.pop();if(e in t)return r.value=e,r.done=!1,r}return r.done=!0,r}},E.values=d,p.prototype={constructor:p,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=g,this.done=!1,this.delegate=null,this.method="next",this.arg=g,this.tryEntries.forEach(v),!t)for(var n in this)"t"===n.charAt(0)&&m.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=g)},stop:function(){this.done=!0;var t=this.tryEntries[0],n=t.completion;if("throw"===n.type)throw n.arg;return this.rval},dispatchException:function(t){function n(n,e){return o.type="throw",o.arg=t,r.next=n,e&&(r.method="next",r.arg=g),!!e}if(this.done)throw t;for(var r=this,e=this.tryEntries.length-1;e>=0;--e){var i=this.tryEntries[e],o=i.completion;if("root"===i.tryLoc)return n("end");if(i.tryLoc<=this.prev){var u=m.call(i,"catchLoc"),c=m.call(i,"finallyLoc");if(u&&c){if(this.prev<i.catchLoc)return n(i.catchLoc,!0);if(this.prev<i.finallyLoc)return n(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return n(i.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return n(i.finallyLoc)}}}},abrupt:function(t,n){for(var r=this.tryEntries.length-1;r>=0;--r){var e=this.tryEntries[r];if(e.tryLoc<=this.prev&&m.call(e,"finallyLoc")&&this.prev<e.finallyLoc){var i=e;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=n&&n<=i.finallyLoc&&(i=null);var o=i?i.completion:{};return o.type=t,o.arg=n,i?(this.method="next",this.next=i.finallyLoc,A):this.complete(o)},complete:function(t,n){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&n&&(this.next=n),A},finish:function(t){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),v(r),A}},catch:function(t){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r.tryLoc===t){var e=r.completion;if("throw"===e.type){var i=e.arg;v(r)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={iterator:d(t),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=g),A}}}("object"==typeof n?n:"object"==typeof window?window:"object"==typeof self?self:this)}).call(n,function(){return this}(),r(158))}])</script><script src="/./main.0cf68a.js"></script><script>!function(){!function(e){var t=document.createElement("script");document.getElementsByTagName("body")[0].appendChild(t),t.setAttribute("src",e)}("/slider.e37972.js")}()</script>


    
<div class="tools-col" q-class="show:isShow,hide:isShow|isFalse" q-on="click:stop(e)">
  <div class="tools-nav header-menu">
    
    
      
      
      
    
      
      
      
    
      
      
      
    
    

    <ul style="width: 70%">
    
    
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'innerArchive')"><a href="javascript:void(0)" q-class="active:innerArchive">所有文章</a></li>
      
        
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'friends')"><a href="javascript:void(0)" q-class="active:friends">友链</a></li>
      
        
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'aboutme')"><a href="javascript:void(0)" q-class="active:aboutme">关于我</a></li>
      
        
    </ul>
  </div>
  <div class="tools-wrap">
    
    	<section class="tools-section tools-section-all" q-show="innerArchive">
        <div class="search-wrap">
          <input class="search-ipt" q-model="search" type="text" placeholder="find something…">
          <i class="icon-search icon" q-show="search|isEmptyStr"></i>
          <i class="icon-close icon" q-show="search|isNotEmptyStr" q-on="click:clearChose(e)"></i>
        </div>
        <div class="widget tagcloud search-tag">
          <p class="search-tag-wording">tag:</p>
          <label class="search-switch">
            <input type="checkbox" q-on="click:toggleTag(e)" q-attr="checked:showTags">
          </label>
          <ul class="article-tag-list" q-show="showTags">
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">Lua</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">c++</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">Kubernetes</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">dashboard</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">pod</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">JAVA</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">反射</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">秋招</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">HashMap</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">Docker</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">SQL</a>
              </li>
            
            <div class="clearfix"></div>
          </ul>
        </div>
        <ul class="search-ul">
          <p q-show="jsonFail" style="padding: 20px; font-size: 12px;">
            缺失模块。<br/>1、请确保node版本大于6.2<br/>2、在博客根目录（注意不是yilia根目录）执行以下命令：<br/> npm i hexo-generator-json-content --save<br/><br/>
            3、在根目录_config.yml里添加配置：
<pre style="font-size: 12px;" q-show="jsonFail">
  jsonContent:
    meta: false
    pages: false
    posts:
      title: true
      date: true
      path: true
      text: false
      raw: false
      content: false
      slug: false
      updated: false
      comments: false
      link: false
      permalink: false
      excerpt: false
      categories: false
      tags: true
</pre>
          </p>
          <li class="search-li" q-repeat="items" q-show="isShow">
            <a q-attr="href:path|urlformat" class="search-title"><i class="icon-quo-left icon"></i><span q-text="title"></span></a>
            <p class="search-time">
              <i class="icon-calendar icon"></i>
              <span q-text="date|dateformat"></span>
            </p>
            <p class="search-tag">
              <i class="icon-price-tags icon"></i>
              <span q-repeat="tags" q-on="click:choseTag(e, name)" q-text="name|tagformat"></span>
            </p>
          </li>
        </ul>
    	</section>
    

    
    	<section class="tools-section tools-section-friends" q-show="friends">
  		
        <ul class="search-ul">
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接1</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接2</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接3</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接4</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接5</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接6</a>
            </li>
          
        </ul>
  		
    	</section>
    

    
    	<section class="tools-section tools-section-me" q-show="aboutme">
  	  	
  	  		<div class="aboutme-wrap" id="js-aboutme">很惭愧&lt;br&gt;&lt;br&gt;只做了一点微小的工作&lt;br&gt;谢谢大家</div>
  	  	
    	</section>
    
  </div>
  
</div>
    <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>
  </div>
</body>
</html>